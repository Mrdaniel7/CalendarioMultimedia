<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reproductor Musical Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <!-- YouTube IFrame API -->
  <script async src="https://www.youtube.com/iframe_api"></script>
  <style>
    /* DESIGN SYSTEM (base) */
    :root {
      --color-white:#fff; --color-black:#000;
      --color-cream-50:#fcfcf9; --color-cream-100:#ffffd;
      --color-gray-200:#f5f5f5; --color-gray-300:#a7a9a9; --color-gray-400:#777c7c;
      --color-slate-500:#626c71; --color-brown-600:#5e5240; --color-charcoal-700:#1f2121; --color-charcoal-800:#262828; --color-slate-900:#13343b;
      --color-teal-300:#32b8c6; --color-teal-400:#2da6b2; --color-teal-500:#21808d; --color-teal-600:#1d7480; --color-teal-700:#1a6873;
      --color-brown-600-rgb:94,82,64; --color-teal-500-rgb:33,128,141;
      --color-background:var(--color-cream-50); --color-surface:var(--color-cream-100); --color-text:var(--color-slate-900);
      --color-text-secondary:var(--color-slate-500); --color-primary:var(--color-teal-500); --color-primary-hover:var(--color-teal-600);
      --color-secondary:rgba(var(--color-brown-600-rgb), .12); --color-border:rgba(var(--color-brown-600-rgb), .2);
      --color-btn-primary-text:var(--color-cream-50); --color-card-border:rgba(var(--color-brown-600-rgb), .12);
      --font-family-base:"Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font-size-xs:11px; --font-size-sm:12px; --font-size-base:14px; --font-size-lg:16px; --font-size-xl:18px; --font-size-2xl:20px; --font-size-3xl:24px;
      --space-4:4px; --space-8:8px; --space-12:12px; --space-16:16px; --space-20:20px; --space-24:24px; --space-32:32px;
      --radius-sm:6px; --radius-base:10px; --radius-lg:14px;
      --shadow-sm:0 1px 3px rgba(0,0,0,.04); --shadow-md:0 6px 16px rgba(0,0,0,.08);
      --bg-image:url(''); --bg-image-dark:url('');
      --contrast-factor:1;
    }
    [data-color-scheme=dark] {
      --color-gray-400-rgb:119,124,124; --color-gray-200-rgb:245,245,245;
      --color-background:var(--color-charcoal-700); --color-surface:var(--color-charcoal-800);
      --color-text:var(--color-gray-200); --color-text-secondary:rgba(var(--color-gray-400-rgb), .78);
      --color-primary:var(--color-teal-300); --color-secondary:rgba(var(--color-gray-400-rgb), .15); --color-border:rgba(var(--color-gray-400-rgb), .3);
    }
    /* THEMES (10+) */
    /* Cada tema ajusta variables + im√°genes (libres / Unsplash) */
    [data-theme="retro"]{ --color-primary:#d97706; --color-primary-hover:#b45309; --bg-image:url('https://images.unsplash.com/photo-1519861531473-9200262188bf?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="naturaleza"]{ --color-primary:#16a34a; --color-primary-hover:#15803d; --bg-image:url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="industrial"]{ --color-primary:#6b7280; --color-primary-hover:#4b5563; --bg-image:url('https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="ciberpunk"]{ --color-primary:#a21caf; --color-primary-hover:#86198f; --bg-image:url('https://images.unsplash.com/photo-1535223289827-42f1e9919769?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="oceano"]{ --color-primary:#0284c7; --color-primary-hover:#0369a1; --bg-image:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="bosque"]{ --color-primary:#0f766e; --color-primary-hover:#115e59; --bg-image:url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="vaporwave"]{ --color-primary:#f472b6; --color-primary-hover:#ec4899; --bg-image:url('https://images.unsplash.com/photo-1520975922284-7b683d4b0f0d?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="a√±os20"]{ --color-primary:#b45309; --color-primary-hover:#92400e; --bg-image:url('https://images.unsplash.com/photo-1499363536502-87642509e31b?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="minimal"]{ --color-primary:#111827; --color-primary-hover:#0b1220; --bg-image:url('https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="ciudad"]{ --color-primary:#dc2626; --color-primary-hover:#b91c1c; --bg-image:url('https://images.unsplash.com/photo-1439405326854-014607f694d7?q=80&w=1200&auto=format&fit=crop'); }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:var(--font-family-base);background:var(--color-background);color:var(--color-text);transition:background .3s, color .3s; background-image:var(--bg-image); background-size:cover; background-position:center; background-attachment:fixed;}
    .bg-scrim{backdrop-filter: saturate(calc(1*var(--contrast-factor))) blur(0px); background:color-mix(in srgb, var(--color-background) 84%, transparent)}

    /* Layout responsive */
    .app-container{display:flex;min-height:100vh;overflow:hidden}
    .sidebar{width:280px;background:var(--color-surface);border-right:1px solid var(--color-border);padding:var(--space-24);display:flex;flex-direction:column;gap:8px}
    .sidebar-title{font-size:var(--font-size-xl);font-weight:700;margin-bottom:var(--space-16)}
    .sidebar-item{padding:var(--space-12) var(--space-16);border-radius:var(--radius-base);cursor:pointer;transition:.2s;font-size:var(--font-size-base);background:transparent;border:none;width:100%;text-align:left;color:var(--color-text-secondary)}
    .sidebar-item:hover{background:var(--color-secondary)}
    .sidebar-item.active{background:var(--color-primary);color:var(--color-btn-primary-text);font-weight:600}
    .main-content{flex:1;padding:var(--space-24);overflow-y:auto}

    /* Top header */
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-16)}
    .month-nav{display:flex;align-items:center;gap:var(--space-8)}
    .month-nav button,.icon-button{background:var(--color-secondary);border:none;border-radius:var(--radius-base);padding:var(--space-8) var(--space-12);cursor:pointer;color:var(--color-text);transition:.2s}
    .month-nav button:hover,.icon-button:hover{background:rgba(0,0,0,.08)}
    .month-title{font-size:var(--font-size-3xl);font-weight:700;min-width:250px;text-align:center}

    .view-container{display:none}
    .view-container.active{display:block}

    .search-input{width:100%;padding:var(--space-12);border:1px solid var(--color-border);border-radius:var(--radius-base);background:var(--color-surface);color:var(--color-text);margin-bottom:var(--space-12)}
    .library-filters{display:flex;gap:var(--space-8);margin-bottom:var(--space-12)}
    .library-filters select{padding:var(--space-8) var(--space-12);border:1px solid var(--color-border);border-radius:var(--radius-base);background:var(--color-surface);color:var(--color-text);cursor:pointer}

    .songs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:var(--space-16);margin-bottom:140px}
    .song-card{position:relative;display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;background:var(--color-surface);cursor:pointer;transition:transform .25s, border-color .25s; border:1px solid var(--color-card-border);overflow:visible}
    .song-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--color-primary)}
    .song-card.playing{border-color:var(--color-primary);background:var(--color-secondary)}
    .song-cover{width:100%;aspect-ratio:1;border-radius:var(--radius-base);margin-bottom:var(--space-8);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-3xl);background:var(--color-background);overflow:hidden}
    .song-cover img{width:100%;height:100%;object-fit:cover;border-radius:var(--radius-base)}
    .song-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-artist{font-size:12px;color:var(--color-text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-album{font-size:11px;color:var(--color-text-secondary);opacity:.85}
    .favorite-btn,.more-btn{position:absolute;top:8px;right:44px;background:rgba(0,0,0,.45);border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;z-index:10;color:#fff}
    .more-btn{right:8px}
    .song-type-badge{position:absolute;top:8px;left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:rgba(50,184,198,.95);border-radius:50%;font-size:20px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.3);z-index:20;border:2px solid #fff}
    [data-color-scheme=dark] .song-type-badge{background:rgba(0,0,0,.7)}
    .song-delete-btn{position:absolute;bottom:8px;right:8px;opacity:0;transition:opacity .2s;background:rgba(244,67,54,.92);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;z-index:10}
    .song-card:hover .song-delete-btn{opacity:1}

    /* Mini-player */
    .mini-player{position:fixed;bottom:0;left:280px;right:0;background:var(--color-surface);border-top:1px solid var(--color-border);padding:var(--space-12) var(--space-16);display:none;flex-direction:column;gap:var(--space-8);z-index:100}
    .mini-player.active{display:flex}
    .mini-player-top{display:flex;align-items:center;gap:var(--space-12);width:100%}
    .mini-player-cover{width:56px;height:56px;border-radius:var(--radius-base);background:var(--color-background);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-2xl);flex-shrink:0;overflow:hidden}
    .mini-player-info{flex:1;min-width:0}
    .mini-player-title{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .mini-player-artist{color:var(--color-text-secondary);font-size:var(--font-size-sm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .mini-player-controls{display:flex;gap:var(--space-8);align-items:center}
    .mini-player-btn{background:var(--color-secondary);border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;font-size:18px}
    .mini-player-btn:hover{background:rgba(0,0,0,.08)}
    .mini-player-btn.play-btn{width:48px;height:48px;background:var(--color-primary);color:var(--color-btn-primary-text)}
    .progress-container{flex:1}
    .progress-bar{width:100%;height:6px;background:var(--color-secondary);border-radius:99px;cursor:pointer;position:relative}
    .progress-bar-fill{height:100%;background:var(--color-primary);border-radius:99px;transition:width .1s linear}
    .time-display{display:flex;justify-content:space-between;font-size:var(--font-size-xs);color:var(--color-text-secondary);margin-top:4px}
    .volume-slider{width:90px;height:4px;-webkit-appearance:none;background:var(--color-secondary);border-radius:99px;cursor:pointer}
    .volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--color-primary);border-radius:50%;cursor:pointer}
    .rate-slider{width:90px;height:4px;-webkit-appearance:none;background:var(--color-secondary);border-radius:99px;cursor:pointer}

    /* YouTube panel */
    #youtube-player-container{position:fixed;bottom:116px;right:16px;width:420px;height:236px;border-radius:12px;overflow:hidden;box-shadow:0 6px 26px rgba(0,0,0,.2);z-index:999;background:#000;transition:all .3s ease}
    #youtube-player-container.youtube-hidden{width:1px;height:1px;bottom:-100px;right:-100px;opacity:0;pointer-events:none}
    #youtube-player-container.youtube-visible{opacity:1;pointer-events:auto}
    .youtube-toggle-btn-player{background:rgba(255,0,0,.1);border:2px solid #F00;color:#F00;padding:8px 12px;border-radius:8px;cursor:pointer;margin-left:12px;display:none}
    .yt-overlay-controls{position:absolute;bottom:8px;left:8px;display:flex;gap:8px;z-index:1000}
    .yt-overlay-controls button{background:rgba(0,0,0,.55);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* Calendar */
    .calendar-wrapper{display:grid;grid-template-columns: 1fr 320px;gap:16px}
    .calendar{background:var(--color-surface);border-radius:var(--radius-lg);padding:var(--space-16);border:1px solid var(--color-card-border)}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--space-8)}
    .calendar-header{text-align:center;font-weight:700;font-size:var(--font-size-sm);padding:var(--space-8);color:var(--color-text-secondary)}
    .calendar-day{aspect-ratio:1;border:2px solid transparent;border-radius:12px;padding:6px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;background:var(--color-background);position:relative}
    .calendar-day:hover{border-color:var(--color-primary);box-shadow:var(--shadow-md)}
    .calendar-day.today{border-color:var(--color-primary);font-weight:700}
    .day-number{font-size:12px;font-weight:700}
    .event-dot{position:absolute;bottom:6px;left:6px;display:flex;gap:4px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.task{background:#22c55e}
    .dot.note{background:#3b82f6}
    .dot.birthday{background:#f97316}

    .agenda{background:var(--color-surface);border:1px solid var(--color-card-border);border-radius:12px;padding:12px;max-height:70vh;overflow:auto}
    .agenda h3{font-size:16px;margin-bottom:8px}
    .agenda .event-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--color-card-border);margin-bottom:8px}
    .badge{font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid}
    .badge.task{background:#dcfce7;color:#166534;border-color:#86efac}
    .badge.note{background:#dbeafe;color:#1e40af;border-color:#93c5fd}
    .badge.birthday{background:#ffedd5;color:#9a3412;border-color:#fed7aa}

    /* Popovers / Modales */
    .popover{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .popover.active{display:flex}
    .popover-card{background:var(--color-surface);border:1px solid var(--color-card-border);border-radius:16px;padding:16px;max-width:720px;width:92%;max-height:86vh;overflow:auto}
    .popover-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .popover-header h3{font-size:18px}
    .close-button{background:none;border:none;font-size:22px;cursor:pointer;color:var(--color-text-secondary)}
    .tabs{display:flex;gap:6px;margin:8px 0 12px}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid var(--color-card-border);cursor:pointer}
    .tab.active{background:var(--color-primary);color:#fff;border-color:transparent}
    .event-form{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .form-row{display:flex;flex-direction:column;gap:4px}
    .text-input, textarea, select{width:100%;padding:8px;border:1px solid var(--color-border);border-radius:8px;background:var(--color-background);color:var(--color-text)}
    .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--color-primary);color:#fff}
    .btn-secondary{background:var(--color-secondary)}
    .events-list .row{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid var(--color-card-border);border-radius:10px;margin-bottom:6px}

    /* Visualizer */
    #viz{width:100%;height:38px;display:block}

    /* Accessibility */
    :focus-visible{outline:3px solid var(--color-primary); outline-offset:3px}

    /* Responsive: tablet & mobile */
    @media (max-width: 1024px){
      .calendar-wrapper{grid-template-columns:1fr}
      #youtube-player-container{right:12px; width:360px; height:202px}
    }
    @media (max-width: 860px){
      .sidebar{position:fixed;bottom:0;left:0;right:0;height:64px;flex-direction:row;gap:6px;align-items:center;justify-content:space-around;z-index:1000;border-top:1px solid var(--color-border);border-right:none;padding:8px}
      .sidebar-title{display:none}
      .sidebar-item{width:auto}
      .main-content{padding:16px 12px 88px}
      .mini-player{left:0}
      #youtube-player-container{bottom:180px;right:12px}
    }
  </style>
</head>
<body class="bg-scrim">
<div id="aria-live-region" aria-live="polite" class="sr-only"></div>
<div class="app-container">
  <aside class="sidebar">
    <button class="sidebar-item active" data-view="calendario" tabindex="0">üìÖ Calendario</button>
    <button class="sidebar-item" data-view="biblioteca" tabindex="0">üìö Biblioteca</button>
    <button class="sidebar-item" data-view="playlists" tabindex="0">üéß Playlists</button>
    <button class="sidebar-item" data-view="tareas" tabindex="0">‚úÖ Tareas</button>
    <button id="settings-btn" class="sidebar-item" tabindex="0">‚öôÔ∏è Ajustes</button>
    <button id="theme-toggle" class="sidebar-item" tabindex="0">üåì Tema</button>
  </aside>

  <main class="main-content">
    <header class="header">
      <div class="month-nav">
        <button id="prev-month" title="Mes anterior">‚óÄ</button>
        <h2 class="month-title" id="month-title"></h2>
        <button id="next-month" title="Mes siguiente">‚ñ∂</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" id="event-search" class="search-input" placeholder="Buscar eventos / tareas" style="max-width:260px"/>
      </div>
    </header>

    <div class="view-container active" id="calendario-view">
      <div class="calendar-wrapper">
        <div class="calendar">
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <aside class="agenda">
          <h3>üìå Agenda</h3>
          <div id="agenda-content"></div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button class="btn btn-secondary" id="btn-quick-add">‚ûï A√±adir r√°pido</button>
            <button class="btn btn-secondary" id="btn-export">‚¨áÔ∏è Exportar</button>
            <input type="file" id="import-file" accept="application/json" style="display:none" />
            <button class="btn btn-secondary" id="btn-import">‚¨ÜÔ∏è Importar</button>
          </div>
        </aside>
      </div>
    </div>

    <div class="view-container" id="biblioteca-view">
      <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-primary" id="upload-local-btn" title="Carga canciones desde tu ordenador">üíø Cargar Canci√≥n Local</button>
        <button class="btn btn-primary" id="load-folder-btn">üìÅ Cargar Carpeta</button>
        <button class="btn btn-primary" id="add-youtube-btn">‚ñ∂Ô∏è A√±adir YouTube</button>
        <input type="file" id="local-file-input" accept="audio/*" multiple style="display:none" />
        <input type="file" id="folder-input" webkitdirectory multiple accept="audio/*" style="display:none" />
      </div>
      <div class="library-filters">
        <select id="genre-filter"><option value="">Todos los g√©neros</option></select>
        <select id="mood-filter"><option value="">Todos los estados</option></select>
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="üîç Buscar..." />
      <div class="songs-grid" id="songs-grid"></div>
    </div>

    <div class="view-container" id="playlists-view">
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <input id="new-playlist-name" class="text-input" placeholder="Nueva playlist" style="max-width:260px" />
        <button class="btn btn-primary" id="create-playlist-btn">Crear</button>
        <button class="btn btn-secondary" id="btn-smart-playlists">‚ö° Smart</button>
      </div>
      <div id="playlists-list"></div>
    </div>

    <div class="view-container" id="tareas-view">
      <h3 style="margin-bottom:8px">‚úÖ Vista de Tareas (de m√°s urgentes a menos)</h3>
      <div id="tasks-view-list"></div>
    </div>

    <div class="view-container" id="favoritos-view">
      <div class="songs-grid" id="favorites-grid"></div>
    </div>
  </main>
</div>

<div class="mini-player" id="mini-player">
  <div class="mini-player-top">
    <div class="mini-player-cover" id="player-cover">üéµ</div>
    <div class="mini-player-info">
      <div class="mini-player-title" id="player-title">Sin reproducci√≥n</div>
      <div class="mini-player-artist" id="player-artist"></div>
    </div>
    <div class="mini-player-controls">
      <button class="mini-player-btn" id="prev-btn" title="Anterior">‚èÆÔ∏è</button>
      <button class="mini-player-btn play-btn" id="play-btn" title="Reproducir/Pausar">‚ñ∂Ô∏è</button>
      <button class="mini-player-btn" id="next-btn" title="Siguiente">‚è≠Ô∏è</button>
      <button class="mini-player-btn" id="shuffle-btn" style="opacity:.5" title="Aleatorio">üîÄ</button>
      <button class="mini-player-btn" id="repeat-btn" style="opacity:.5" title="Repetir">üîÅ</button>
      <button class="mini-player-btn" id="stop-player-btn" title="Detener">‚úï</button>
      <button class="youtube-toggle-btn-player" id="youtube-toggle-btn">üì∫</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="mini-player-btn" id="volume-icon">üîä</button>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70" />
      <span style="font-size:12px;color:var(--color-text-secondary)">Vel.</span>
      <input type="range" class="rate-slider" id="rate-slider" min="50" max="200" value="100" />
    </div>
  </div>
  <canvas id="viz"></canvas>
  <div class="progress-container">
    <div class="progress-bar" id="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
    <div class="time-display"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
  </div>
</div>

<audio id="audio-player"></audio>
<div id="youtube-player-container" class="youtube-hidden"></div>

<!-- Modales -->
<div class="popover" id="youtube-modal">
  <div class="popover-card" style="max-width:520px">
    <div class="popover-header"><h3 class="modal-title">üåê A√±adir desde YouTube</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div class="event-form" style="grid-template-columns:1fr 1fr">
      <div class="form-row"><label>URL:</label><input type="text" id="youtube-url" class="text-input" placeholder="https://youtube.com/watch?v=..."/></div>
      <div class="form-row"><label>T√≠tulo:</label><input type="text" id="youtube-title" class="text-input"/></div>
      <div class="form-row"><label>Artista:</label><input type="text" id="youtube-artist" class="text-input"/></div>
      <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-secondary" data-close-popover>Cancelar</button><button class="btn btn-primary" id="save-youtube-btn">Guardar</button></div>
    </div>
  </div>
</div>

<div class="popover" id="playlist-modal">
  <div class="popover-card" style="max-width:520px">
    <div class="popover-header"><h3>A√±adir a playlist</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div style="display:grid;gap:8px">
      <select id="playlist-select" class="text-input"></select>
      <div style="display:flex;gap:8px"><input id="playlist-new-name" class="text-input" placeholder="o crea una nueva"/><button class="btn btn-secondary" id="create-in-modal">Crear</button></div>
      <button class="btn btn-primary" id="confirm-add-to-playlist">A√±adir</button>
    </div>
  </div>
</div>

<div class="popover" id="settings-modal">
  <div class="popover-card">
    <div class="popover-header"><h3>‚öôÔ∏è Ajustes</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div style="display:grid;gap:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <h4>Accesibilidad</h4>
          <label><input type="checkbox" id="a11y-high-contrast"/> Alto contraste</label><br/>
          <label><input type="checkbox" id="a11y-reduce-motion"/> Reducir animaciones</label><br/>
          <label><input type="checkbox" id="a11y-large-font"/> Fuente grande</label><br/>
          <label><input type="checkbox" id="a11y-screenreader"/> Mensajes de lector</label><br/>
          <label><input type="checkbox" id="a11y-focus-visible" checked/> Resaltar foco</label>
        </div>
        <div>
          <h4>Reproducci√≥n</h4>
          <label><input type="checkbox" id="opt-autoplay-next" checked/> Auto-siguiente</label><br/>
          <label><input type="checkbox" id="opt-crossfade"/> Crossfade 1s</label><br/>
          <label><input type="checkbox" id="opt-normalize"/> Normalizar volumen (experimental)</label><br/>
          <label>Temporizador de sue√±o: <input type="number" id="opt-sleep-min" min="0" value="0" style="width:70px"/> min</label>
        </div>
      </div>
      <div>
        <h4>Tema</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <button class="btn btn-secondary" data-theme="retro">Retro</button>
          <button class="btn btn-secondary" data-theme="naturaleza">Naturaleza</button>
          <button class="btn btn-secondary" data-theme="industrial">Industrial</button>
          <button class="btn btn-secondary" data-theme="ciberpunk">Ciberpunk</button>
          <button class="btn btn-secondary" data-theme="oceano">Oc√©ano</button>
          <button class="btn btn-secondary" data-theme="bosque">Bosque</button>
          <button class="btn btn-secondary" data-theme="vaporwave">Vaporwave</button>
          <button class="btn btn-secondary" data-theme="a√±os20">A√±os 20</button>
          <button class="btn btn-secondary" data-theme="minimal">Minimal</button>
          <button class="btn btn-secondary" data-theme="ciudad">Ciudad</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// === TIPOS DE CANCIONES ===
const SONG_TYPES = { GITHUB:'github', LOCAL:'local', YOUTUBE:'youtube' };
const SONG_TYPE_ICONS = { github:'üåê', local:'üíø', youtube:'‚ñ∂Ô∏è' };
const SONG_TYPE_LABELS = { github:'GitHub', local:'Local', youtube:'YouTube' };

// === CONFIGURACI√ìN GITHUB ===
const GITHUB_CONFIG = { owner:'mrdaniel7', repo:'CalendarioMultimedia', branch:'main', musicFolder:'musica' };

// === DATOS ===
const app = {
  songs: [], currentIndex:-1, currentDate:new Date(), isPlaying:false, videoVisible:false,
  nextId:1000, shuffleMode:false, repeatMode:'none', volume:0.8, currentView:'calendario',
  genres:['Rock','Pop','Jazz','Blues','Classical','Electronic','Hip Hop','R&B','Country','Reggae','Metal','Indie','Folk','Soul','Funk','Punk','Latin','Reggaeton','Salsa','Trap','Techno','House'],
  moods:['Feliz','Triste','En√©rgico','Relajado','Rom√°ntico','Motivador','Melanc√≥lico','Nost√°lgico','Euf√≥rico','Tranquilo','Agresivo','Inspirador','Dram√°tico','Festivo'],
  calendarData:{}, events:[], playlists:[], pendingAddSongId:null,
  playCount: new Map(),
  yt:{ player:null, timer:null, duration:0 },
  options:{ autoplayNext:true, crossfade:false, normalize:false, a11y:{highContrast:false, reduceMotion:false, largeFont:false, screenreader:false, focusVisible:true} },
  audioCtx:null, analyser:null, gainNode:null, sourceNode:null
};

// Persistencia
const storage = {
  load(){ try{ const s=JSON.parse(localStorage.getItem('musicpro-state')||'{}'); if(s.events) app.events=s.events; if(s.playlists) app.playlists=s.playlists; if(s.theme) document.documentElement.setAttribute('data-theme', s.theme); if(s.options) app.options=Object.assign(app.options,s.options);}catch(e){} },
  save(){ localStorage.setItem('musicpro-state', JSON.stringify({ events:app.events, playlists:app.playlists, theme:document.documentElement.getAttribute('data-theme')||'retro', options:app.options })); }
};

// === UTILIDADES ===
const U = {
  q:id=>document.getElementById(id), qa:sel=>document.querySelectorAll(sel), on:(el,evt,fn)=>el&&el.addEventListener(evt,fn), text:(el,t)=>el&&(el.textContent=t), html:(el,h)=>el&&(el.innerHTML=h),
  show:el=>el&&(el.style.display=''), hide:el=>el&&(el.style.display='none'), addClass:(el,c)=>el&&el.classList.add(c), removeClass:(el,c)=>el&&el.classList.remove(c), toggleClass:(el,c)=>el&&el.classList.toggle(c),
  fmt:s=>{s=Math.max(0,Math.floor(s)); const m=Math.floor(s/60), sec=s%60; return `${m}:${sec.toString().padStart(2,'0')}`;},
  announce:msg=>{ if(app.options.a11y.screenreader){ const a=U.q('aria-live-region'); if(a) a.textContent=msg; } },
  dateKey:(d)=> typeof d==='string'?d:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
};

// === RENDER BIBLIOTECA ===
function renderSongs(){
  const c=U.q('songs-grid'); if(!c) return;
  const g=U.q('genre-filter').value; const m=U.q('mood-filter').value; const s=(U.q('search-input').value||'').toLowerCase();
  let arr=app.songs.filter(x=> (g? (x.genres||[]).includes(g):true) && (m? (x.moods||[]).includes(m):true) && (s? (`${x.title}`.toLowerCase().includes(s)||`${x.artist}`.toLowerCase().includes(s)):true));
  if(!arr.length){ c.innerHTML='<div class="empty-state"><div style="font-size:64px">üéµ</div><p>No hay canciones</p></div>'; return; }
  c.innerHTML = arr.map(s=>{
    const ico=SONG_TYPE_ICONS[s.type]||'üéµ', label=SONG_TYPE_LABELS[s.type]||'Desconocido';
    const cover = s.cover && (String(s.cover).startsWith('data:')||String(s.cover).startsWith('http')) ? `<img src="${s.cover}" alt="${s.title}">` : 'üéß';
    const tags = (s.genres||[]).map(g=>`<span class="badge note">${g}</span>`).join('') + (s.moods||[]).map(m=>` <span class="badge task">${m}</span>`).join('');
    return `<div class="song-card ${app.currentIndex>=0 && app.songs[app.currentIndex].id===s.id? 'playing':''}" onclick="playSong(${JSON.stringify(s.id)})">
      <div class="song-type-badge" title="${label}">${ico}</div>
      <button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${JSON.stringify(s.id)})">${s.isFavorite?'‚ù§Ô∏è':'ü§ç'}</button>
      <button class="more-btn" title="A√±adir a playlist" onclick="event.stopPropagation();openAddToPlaylist(${JSON.stringify(s.id)})">‚ûï</button>
      <div class="song-cover">${cover}</div>
      <div class="song-title">${s.title}</div>
      <div class="song-artist">${s.artist||''}</div>
      <div class="song-album">${s.album||label}</div>
      <div class="tags-flow">${tags}</div>
      <button class="song-delete-btn" onclick="event.stopPropagation();deleteSong(${JSON.stringify(s.id)})">üóëÔ∏è Eliminar</button>
    </div>`;
  }).join('');
}

function updateMiniUIFor(song){
  U.text(U.q('player-title'), song?.title||'Sin reproducci√≥n');
  U.text(U.q('player-artist'), song?.artist||'');
  const coverEl = U.q('player-cover');
  coverEl.innerHTML = song?.cover && (String(song.cover).startsWith('data:')||String(song.cover).startsWith('http')) ? `<img src="${song.cover}" style="width:100%;height:100%;object-fit:cover"/>` : 'üéµ';
}

function recordPlay(id){ app.playCount.set(id, (app.playCount.get(id)||0)+1); }

function playSong(id){
  const song = app.songs.find(s=>s.id===id); if(!song) return;
  app.currentIndex = app.songs.indexOf(song);
  const audio = U.q('audio-player');
  // detener anteriores
  stopYouTube();
  audio.pause(); audio.src='';
  U.q('mini-player').classList.add('active'); app.isPlaying=true; U.text(U.q('play-btn'),'‚è∏Ô∏è'); updateMiniUIFor(song);
  // reproducir
  if(song.type===SONG_TYPES.YOUTUBE){ playYouTube(song); }
  else if(song.type===SONG_TYPES.LOCAL && song.blob){
    const url=URL.createObjectURL(song.blob); startAudio(url);
  } else if(song.type===SONG_TYPES.GITHUB && song.fileUrl){ startAudio(song.fileUrl); }
  renderSongs(); recordPlay(song.id);
}

function startAudio(src){
  const audio=U.q('audio-player');
  if(app.options.crossfade && app.gainNode){ app.gainNode.gain.setTargetAtTime(0.0001, app.audioCtx.currentTime, 0.15); }
  audio.src=src; audio.crossOrigin='anonymous'; audio.playbackRate = (U.q('rate-slider').value||100)/100; audio.play().catch(()=>{});
  if(app.options.crossfade && app.gainNode){ setTimeout(()=>{ app.gainNode.gain.setTargetAtTime(1.0, app.audioCtx.currentTime, 0.15); }, 180); }
}

function getNextIndex(){ if(app.shuffleMode){ if(app.songs.length<=1) return app.currentIndex; let r; do{ r=Math.floor(Math.random()*app.songs.length); }while(r===app.currentIndex); return r; } return Math.min(app.currentIndex+1, app.songs.length-1); }
function getPrevIndex(){ if(app.shuffleMode){ if(app.songs.length<=1) return app.currentIndex; let r; do{ r=Math.floor(Math.random()*app.songs.length); }while(r===app.currentIndex); return r; } return Math.max(app.currentIndex-1, 0); }

// === YouTube API ===
function stopYouTube(){ try{ if(app.yt.timer){ clearInterval(app.yt.timer); app.yt.timer=null; } if(app.yt.player){ app.yt.player.stopVideo(); } }catch(e){} }
function playYouTube(song){
  const container=U.q('youtube-player-container'); container.innerHTML='';
  const wrap=document.createElement('div'); wrap.style.position='relative'; wrap.style.width='100%'; wrap.style.height='100%';
  const playerDiv=document.createElement('div'); playerDiv.id='yt-player'; wrap.appendChild(playerDiv);
  const overlay=document.createElement('div'); overlay.className='yt-overlay-controls';
  const prev=document.createElement('button'); prev.textContent='‚èÆÔ∏è'; prev.title='Anterior'; prev.onclick=()=>{ const idx=getPrevIndex(); playSong(app.songs[idx].id); };
  const playp=document.createElement('button'); playp.textContent='‚èØÔ∏è'; playp.title='Play/Pause'; playp.onclick=()=>{ const st=app.yt.player?.getPlayerState?.(); if(st===1) app.yt.player.pauseVideo(); else app.yt.player.playVideo(); };
  const next=document.createElement('button'); next.textContent='‚è≠Ô∏è'; next.title='Siguiente'; next.onclick=()=>{ const idx=getNextIndex(); playSong(app.songs[idx].id); };
  overlay.appendChild(prev); overlay.appendChild(playp); overlay.appendChild(next);
  wrap.appendChild(overlay); container.appendChild(wrap);
  setTimeout(()=>{ U.show(U.q('youtube-toggle-btn')); U.removeClass(container,'youtube-hidden'); U.addClass(container,'youtube-visible'); app.videoVisible=true; },120);
  // Crear player
  app.yt.player = new YT.Player('yt-player', { videoId: song.youtubeId, playerVars:{ autoplay:1, controls:1, rel:0, modestbranding:1, playsinline:1 },
    events:{ onReady:(e)=>{ app.yt.duration = Math.floor(e.target.getDuration()); U.text(U.q('total-time'), U.fmt(app.yt.duration)); U.text(U.q('play-btn'),'‚è∏Ô∏è');
      app.yt.timer = setInterval(()=>{
        const t = Math.floor(app.yt.player.getCurrentTime()||0); const d = Math.floor(app.yt.player.getDuration()||0)||app.yt.duration; U.text(U.q('current-time'), U.fmt(t)); U.text(U.q('total-time'), U.fmt(d)); const pct = d? (t/d*100):0; U.q('progress-fill').style.width=pct+'%';
      }, 300);
      app.isPlaying=true;
    }, onStateChange:(ev)=>{
      // 0 ended, 1 playing, 2 paused
      if(ev.data===0){ onEnded(); }
      if(ev.data===2){ U.text(U.q('play-btn'),'‚ñ∂Ô∏è'); } else if(ev.data===1){ U.text(U.q('play-btn'),'‚è∏Ô∏è'); }
    } }
  );
}

// Progress bar seek
U.on(document, 'click', (e)=>{ const bar=e.target.closest('#progress-bar'); if(!bar) return; const rect=bar.getBoundingClientRect(); const pct=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width)); const cur=app.songs[app.currentIndex]; if(!cur) return; if(cur.type===SONG_TYPES.YOUTUBE && app.yt.player){ const dur=app.yt.player.getDuration()||app.yt.duration||0; app.yt.player.seekTo(Math.floor(dur*pct), true); } else { const a=U.q('audio-player'); if(a.duration) a.currentTime=a.duration*pct; } });

function stopPlayback(){ const audio=U.q('audio-player'); audio.pause(); audio.src=''; stopYouTube(); U.text(U.q('player-title'),'Sin reproducci√≥n'); U.text(U.q('player-artist'),''); U.text(U.q('play-btn'),'‚ñ∂Ô∏è'); U.q('progress-fill').style.width='0%'; U.text(U.q('current-time'),'0:00'); U.text(U.q('total-time'),'0:00'); app.isPlaying=false; app.currentIndex=-1; U.announce('Reproducci√≥n detenida'); }

function onEnded(){ if(app.repeatMode==='one'){ playSong(app.songs[app.currentIndex].id); }
  else if(app.options.autoplayNext){ const idx=getNextIndex(); playSong(app.songs[idx].id); } }

// === PLAYLISTS ===
function openAddToPlaylist(songId){ app.pendingAddSongId=songId; refreshPlaylistSelect(); U.q('playlist-modal').classList.add('active'); }
function refreshPlaylistSelect(){ const sel=U.q('playlist-select'); if(!sel) return; if(app.playlists.length===0) app.playlists.push({id:'pl-1', name:'Favoritas', songIds:[]}); sel.innerHTML=app.playlists.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); }
function addSongToPlaylist(pid, sid){ const pl=app.playlists.find(p=>p.id===pid); if(!pl) return; if(!pl.songIds.includes(sid)) pl.songIds.push(sid); storage.save(); renderPlaylists(); U.announce('A√±adido a playlist'); }
function renderPlaylists(){ const wrap=U.q('playlists-list'); if(!wrap) return; if(!app.playlists.length){ wrap.innerHTML='<div class="empty-state">No hay playlists</div>'; return; } wrap.innerHTML = app.playlists.map(p=>{ const items=p.songIds.map(id=> app.songs.find(s=>s.id===id)).filter(Boolean); const list=items.map(s=>`<div class="song-card" style="flex-direction:row;gap:8px;align-items:center" onclick="playSong(${JSON.stringify(s.id)})"><div style="width:46px;height:46px" class="song-cover">${s.cover&&String(s.cover).startsWith('http')?`<img src='${s.cover}'/>`:'üéµ'}</div><div style="flex:1"><div class="song-title">${s.title}</div><div class="song-artist">${s.artist}</div></div><button class="song-delete-btn" onclick="event.stopPropagation();removeFromPlaylist('${p.id}', ${JSON.stringify(s.id)})">Quitar</button></div>`).join(''); return `<div style="margin-bottom:16px"><h3>üéß ${p.name} <small>(${items.length})</small></h3>${list||'<div class=empty-state>Vac√≠a</div>'}</div>`; }).join(''); }
function removeFromPlaylist(pid,sid){ const pl=app.playlists.find(p=>p.id===pid); if(!pl) return; pl.songIds=pl.songIds.filter(id=>id!==sid); storage.save(); renderPlaylists(); }

// === FAVORITOS ===
function renderFavorites(){ const c=U.q('favorites-grid'); const favs=app.songs.filter(s=>s.isFavorite); if(!favs.length){ c.innerHTML='<div class="empty-state"><div style="font-size:64px">‚≠ê</div><p>No hay favoritos</p></div>'; return; } c.innerHTML=favs.map(s=>{ const cover=s.cover && (String(s.cover).startsWith('data:')||String(s.cover).startsWith('http'))?`<img src="${s.cover}" alt="${s.title}">`:'üéµ'; return `<div class="song-card" onclick="playSong(${JSON.stringify(s.id)})"><button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${JSON.stringify(s.id)})">‚ù§Ô∏è</button><div class="song-cover">${cover}</div><div class="song-title">${s.title}</div><div class="song-artist">${s.artist}</div></div>`; }).join(''); }
function toggleFav(id){ const s=app.songs.find(x=>x.id===id); if(s){ s.isFavorite=!s.isFavorite; renderSongs(); renderFavorites(); } }

// === SUBIDAS ===
async function loadMusicFolder(){ const input=U.q('folder-input'); input.onchange=async e=>{ const files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')); for(const file of files){ await addLocalFile(file); } populateFilters(); renderSongs(); alert(`‚úÖ ${files.length} canciones cargadas de la carpeta`); }; input.click(); }
async function handleLocalFileUpload(files){ const arr=Array.from(files).filter(f=>f.type.startsWith('audio/')); if(!arr.length){ alert('‚ö†Ô∏è No hay audio'); return; } for(const f of arr){ await addLocalFile(f); } populateFilters(); renderSongs(); U.announce(`${arr.length} canciones a√±adidas`); }
async function addLocalFile(file){ const baseName=file.name.replace(/\.[^/.]+$/, ''); // evitar duplicados
  if(app.songs.some(s=> (s.title===baseName) && s.type===SONG_TYPES.LOCAL )){ console.warn('Duplicado omitido'); return; }
  const s
