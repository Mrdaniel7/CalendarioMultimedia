<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reproductor Musical Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <script async src="https://www.youtube.com/iframe_api"></script>
  <style>
    :root {
      --color-white:#fff; --color-black:#000;
      --color-cream-50:#fcfcf9; --color-cream-100:#ffffd;
      --color-gray-200:#f5f5f5; --color-gray-300:#a7a9a9; --color-gray-400:#777c7c;
      --color-slate-500:#626c71; --color-brown-600:#5e5240; --color-charcoal-700:#1f2121; --color-charcoal-800:#262828; --color-slate-900:#13343b;
      --color-teal-300:#32b8c6; --color-teal-400:#2da6b2; --color-teal-500:#21808d; --color-teal-600:#1d7480; --color-teal-700:#1a6873;
      --color-brown-600-rgb:94,82,64; --color-teal-500-rgb:33,128,141;
      --color-background:var(--color-cream-50); --color-surface:var(--color-cream-100); --color-text:var(--color-slate-900);
      --color-text-secondary:var(--color-slate-500); --color-primary:var(--color-teal-500); --color-primary-hover:var(--color-teal-600);
      --color-secondary:rgba(var(--color-brown-600-rgb), .12); --color-border:rgba(var(--color-brown-600-rgb), .2);
      --color-btn-primary-text:var(--color-cream-50); --color-card-border:rgba(var(--color-brown-600-rgb), .12);
      --font-family-base:"Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font-size-xs:11px; --font-size-sm:12px; --font-size-base:14px; --font-size-lg:16px; --font-size-xl:18px; --font-size-2xl:20px; --font-size-3xl:24px;
      --space-4:4px; --space-8:8px; --space-12:12px; --space-16:16px; --space-20:20px; --space-24:24px; --space-32:32px;
      --radius-sm:6px; --radius-base:10px; --radius-lg:14px;
      --shadow-sm:0 1px 3px rgba(0,0,0,.04); --shadow-md:0 6px 16px rgba(0,0,0,.08);
      --bg-image:url(''); --bg-image-dark:url('');
      --contrast-factor:1;
    }
    [data-color-scheme=dark] {
      --color-gray-400-rgb:119,124,124; --color-gray-200-rgb:245,245,245;
      --color-background:var(--color-charcoal-700); --color-surface:var(--color-charcoal-800);
      --color-text:var(--color-gray-200); --color-text-secondary:rgba(var(--color-gray-400-rgb), .78);
      --color-primary:var(--color-teal-300); --color-secondary:rgba(var(--color-gray-400-rgb), .15); --color-border:rgba(var(--color-gray-400-rgb), .3);
    }
    /* Themes */
    [data-theme="retro"]{ --color-primary:#d97706; --color-primary-hover:#b45309; --bg-image:url('https://images.unsplash.com/photo-1519861531473-9200262188bf?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="naturaleza"]{ --color-primary:#16a34a; --color-primary-hover:#15803d; --bg-image:url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="industrial"]{ --color-primary:#6b7280; --color-primary-hover:#4b5563; --bg-image:url('https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="ciberpunk"]{ --color-primary:#a21caf; --color-primary-hover:#86198f; --bg-image:url('https://images.unsplash.com/photo-1535223289827-42f1e9919769?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="oceano"]{ --color-primary:#0284c7; --color-primary-hover:#0369a1; --bg-image:url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="bosque"]{ --color-primary:#0f766e; --color-primary-hover:#115e59; --bg-image:url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="vaporwave"]{ --color-primary:#f472b6; --color-primary-hover:#ec4899; --bg-image:url('https://images.unsplash.com/photo-1520975922284-7b683d4b0f0d?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="a√±os20"]{ --color-primary:#b45309; --color-primary-hover:#92400e; --bg-image:url('https://images.unsplash.com/photo-1499363536502-87642509e31b?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="minimal"]{ --color-primary:#111827; --color-primary-hover:#0b1220; --bg-image:url('https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=1200&auto=format&fit=crop'); }
    [data-theme="ciudad"]{ --color-primary:#dc2626; --color-primary-hover:#b91c1c; --bg-image:url('https://images.unsplash.com/photo-1439405326854-014607f694d7?q=80&w=1200&auto=format&fit=crop'); }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:var(--font-family-base);background:var(--color-background);color:var(--color-text);transition:background .3s, color .3s; background-image:var(--bg-image); background-size:cover; background-position:center; background-attachment:fixed;}
    .bg-scrim{backdrop-filter: saturate(calc(1*var(--contrast-factor))) blur(0px); background:color-mix(in srgb, var(--color-background) 84%, transparent)}

    .app-container{display:flex;min-height:100vh;overflow:hidden}
    .sidebar{width:280px;background:var(--color-surface);border-right:1px solid var(--color-border);padding:var(--space-24);display:flex;flex-direction:column;gap:8px}
    .sidebar-title{font-size:var(--font-size-xl);font-weight:700;margin-bottom:var(--space-16)}
    .sidebar-item{padding:var(--space-12) var(--space-16);border-radius:var(--radius-base);cursor:pointer;transition:.2s;font-size:var(--font-size-base);background:transparent;border:none;width:100%;text-align:left;color:var(--color-text-secondary)}
    .sidebar-item:hover{background:var(--color-secondary)}
    .sidebar-item.active{background:var(--color-primary);color:var(--color-btn-primary-text);font-weight:600}
    .main-content{flex:1;padding:var(--space-24);overflow-y:auto}

    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-16)}
    .month-nav{display:flex;align-items:center;gap:var(--space-8)}
    .month-nav button,.icon-button{background:var(--color-secondary);border:none;border-radius:var(--radius-base);padding:var(--space-8) var(--space-12);cursor:pointer;color:var(--color-text);transition:.2s}
    .month-nav button:hover,.icon-button:hover{background:rgba(0,0,0,.08)}
    .month-title{font-size:var(--font-size-3xl);font-weight:700;min-width:250px;text-align:center}

    .view-container{display:none}
    .view-container.active{display:block}

    .search-input{width:100%;padding:var(--space-12);border:1px solid var(--color-border);border-radius:var(--radius-base);background:var(--color-surface);color:var(--color-text);margin-bottom:var(--space-12)}
    .library-filters{display:flex;gap:var(--space-8);margin-bottom:var(--space-12)}
    .library-filters select{padding:var(--space-8) var(--space-12);border:1px solid var(--color-border);border-radius:var(--radius-base);background:var(--color-surface);color:var(--color-text);cursor:pointer}

    .songs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:var(--space-16);margin-bottom:140px}
    .song-card{position:relative;display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;background:var(--color-surface);cursor:pointer;transition:transform .25s, border-color .25s; border:1px solid var(--color-card-border);overflow:visible}
    .song-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--color-primary)}
    .song-card.playing{border-color:var(--color-primary);background:var(--color-secondary)}
    .song-cover{width:100%;aspect-ratio:1;border-radius:var(--radius-base);margin-bottom:var(--space-8);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-3xl);background:var(--color-background);overflow:hidden}
    .song-cover img{width:100%;height:100%;object-fit:cover;border-radius:var(--radius-base)}
    .song-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-artist{font-size:12px;color:var(--color-text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-album{font-size:11px;color:var(--color-text-secondary);opacity:.85}
    .favorite-btn,.more-btn{position:absolute;top:8px;right:44px;background:rgba(0,0,0,.45);border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;z-index:10;color:#fff}
    .more-btn{right:8px}
    .song-type-badge{position:absolute;top:8px;left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:rgba(50,184,198,.95);border-radius:50%;font-size:20px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.3);z-index:20;border:2px solid #fff}
    [data-color-scheme=dark] .song-type-badge{background:rgba(0,0,0,.7)}
    .song-delete-btn{position:absolute;bottom:8px;right:8px;opacity:0;transition:opacity .2s;background:rgba(244,67,54,.92);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:700;z-index:10}
    .song-card:hover .song-delete-btn{opacity:1}

    .mini-player{position:fixed;bottom:0;left:280px;right:0;background:var(--color-surface);border-top:1px solid var(--color-border);padding:var(--space-12) var(--space-16);display:none;flex-direction:column;gap:var(--space-8);z-index:100}
    .mini-player.active{display:flex}
    .mini-player-top{display:flex;align-items:center;gap:var(--space-12);width:100%}
    .mini-player-cover{width:56px;height:56px;border-radius:var(--radius-base);background:var(--color-background);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-2xl);flex-shrink:0;overflow:hidden}
    .mini-player-info{flex:1;min-width:0}
    .mini-player-title{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .mini-player-artist{color:var(--color-text-secondary);font-size:var(--font-size-sm);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .mini-player-controls{display:flex;gap:var(--space-8);align-items:center}
    .mini-player-btn{background:var(--color-secondary);border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;font-size:18px}
    .mini-player-btn:hover{background:rgba(0,0,0,.08)}
    .mini-player-btn.play-btn{width:48px;height:48px;background:var(--color-primary);color:var(--color-btn-primary-text)}
    .progress-container{flex:1}
    .progress-bar{width:100%;height:6px;background:var(--color-secondary);border-radius:99px;cursor:pointer;position:relative}
    .progress-bar-fill{height:100%;background:var(--color-primary);border-radius:99px;transition:width .1s linear}
    .time-display{display:flex;justify-content:space-between;font-size:var(--font-size-xs);color:var(--color-text-secondary);margin-top:4px}
    .volume-slider{width:90px;height:4px;-webkit-appearance:none;background:var(--color-secondary);border-radius:99px;cursor:pointer}
    .volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--color-primary);border-radius:50%;cursor:pointer}
    .rate-slider{width:90px;height:4px;-webkit-appearance:none;background:var(--color-secondary);border-radius:99px;cursor:pointer}

    #youtube-player-container{position:fixed;bottom:116px;right:16px;width:420px;height:236px;border-radius:12px;overflow:hidden;box-shadow:0 6px 26px rgba(0,0,0,.2);z-index:999;background:#000;transition:all .3s ease}
    #youtube-player-container.youtube-hidden{width:1px;height:1px;bottom:-100px;right:-100px;opacity:0;pointer-events:none}
    #youtube-player-container.youtube-visible{opacity:1;pointer-events:auto}
    .youtube-toggle-btn-player{background:rgba(255,0,0,.1);border:2px solid #F00;color:#F00;padding:8px 12px;border-radius:8px;cursor:pointer;margin-left:12px;display:none}

    .calendar-wrapper{display:grid;grid-template-columns: 1fr 320px;gap:16px}
    .calendar{background:var(--color-surface);border-radius:var(--radius-lg);padding:var(--space-16);border:1px solid var(--color-card-border)}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--space-8)}
    .calendar-header{text-align:center;font-weight:700;font-size:var(--font-size-sm);padding:var(--space-8);color:var(--color-text-secondary)}
    .calendar-day{aspect-ratio:1;border:2px solid transparent;border-radius:12px;padding:6px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;background:var(--color-background);position:relative}
    .calendar-day:hover{border-color:var(--color-primary);box-shadow:var(--shadow-md)}
    .calendar-day.today{border-color:var(--color-primary);font-weight:700}
    .day-number{font-size:12px;font-weight:700}
    .event-dot{position:absolute;bottom:6px;left:6px;display:flex;gap:4px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.task{background:#22c55e}
    .dot.note{background:#3b82f6}
    .dot.birthday{background:#f97316}

    .agenda{background:var(--color-surface);border:1px solid var(--color-card-border);border-radius:12px;padding:12px;max-height:70vh;overflow:auto}
    .agenda h3{font-size:16px;margin-bottom:8px}
    .agenda .event-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--color-card-border);margin-bottom:8px}
    .badge{font-size:11px;border-radius:999px;padding:2px 8px;border:1px solid}
    .badge.task{background:#dcfce7;color:#166534;border-color:#86efac}
    .badge.note{background:#dbeafe;color:#1e40af;border-color:#93c5fd}
    .badge.birthday{background:#ffedd5;color:#9a3412;border-color:#fed7aa}

    .popover{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .popover.active{display:flex}
    .popover-card{background:var(--color-surface);border:1px solid var(--color-card-border);border-radius:16px;padding:16px;max-width:720px;width:92%;max-height:86vh;overflow:auto}
    .popover-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .popover-header h3{font-size:18px}
    .close-button{background:none;border:none;font-size:22px;cursor:pointer;color:var(--color-text-secondary)}
    .tabs{display:flex;gap:6px;margin:8px 0 12px}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid var(--color-card-border);cursor:pointer}
    .tab.active{background:var(--color-primary);color:#fff;border-color:transparent}
    .event-form{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
    .form-row{display:flex;flex-direction:column;gap:4px}
    .text-input, textarea, select{width:100%;padding:8px;border:1px solid var(--color-border);border-radius:8px;background:var(--color-background);color:var(--color-text)}
    .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--color-primary);color:#fff}
    .btn-secondary{background:var(--color-secondary)}
    .events-list .row{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid var(--color-card-border);border-radius:10px;margin-bottom:6px}

    #viz{width:100%;height:38px;display:block}
    :focus-visible{outline:3px solid var(--color-primary); outline-offset:3px}

    @media (max-width: 1024px){ .calendar-wrapper{grid-template-columns:1fr} #youtube-player-container{right:12px; width:360px; height:202px} }
    @media (max-width: 860px){ .sidebar{position:fixed;bottom:0;left:0;right:0;height:64px;flex-direction:row;gap:6px;align-items:center;justify-content:space-around;z-index:1000;border-top:1px solid var(--color-border);border-right:none;padding:8px} .sidebar-title{display:none} .sidebar-item{width:auto} .main-content{padding:16px 12px 88px} .mini-player{left:0} #youtube-player-container{bottom:180px;right:12px} }
  </style>
</head>
<body class="bg-scrim">
<div id="aria-live-region" aria-live="polite" class="sr-only"></div>
<div class="app-container">
  <aside class="sidebar">
    <button class="sidebar-item active" data-view="calendario" tabindex="0">üìÖ Calendario</button>
    <button class="sidebar-item" data-view="biblioteca" tabindex="0">üìö Biblioteca</button>
    <button class="sidebar-item" data-view="playlists" tabindex="0">üéß Playlists</button>
    <button class="sidebar-item" data-view="tareas" tabindex="0">‚úÖ Tareas</button>
    <button id="settings-btn" class="sidebar-item" tabindex="0">‚öôÔ∏è Ajustes</button>
    <button id="theme-toggle" class="sidebar-item" tabindex="0">üåì Tema</button>
  </aside>
  <main class="main-content">
    <header class="header">
      <div class="month-nav">
        <button id="prev-month" title="Mes anterior">‚óÄ</button>
        <h2 class="month-title" id="month-title"></h2>
        <button id="next-month" title="Mes siguiente">‚ñ∂</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="text" id="event-search" class="search-input" placeholder="Buscar eventos / tareas" style="max-width:260px"/>
      </div>
    </header>

    <div class="view-container active" id="calendario-view">
      <div class="calendar-wrapper">
        <div class="calendar">
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        <aside class="agenda">
          <h3>üìå Agenda</h3>
          <div id="agenda-content"></div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button class="btn btn-secondary" id="btn-quick-add">‚ûï A√±adir r√°pido</button>
            <button class="btn btn-secondary" id="btn-export">‚¨áÔ∏è Exportar</button>
            <input type="file" id="import-file" accept="application/json" style="display:none" />
            <button class="btn btn-secondary" id="btn-import">‚¨ÜÔ∏è Importar</button>
          </div>
        </aside>
      </div>
    </div>

    <div class="view-container" id="biblioteca-view">
      <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-primary" id="upload-local-btn" title="Carga canciones desde tu ordenador">üíø Cargar Canci√≥n Local</button>
        <button class="btn btn-primary" id="load-folder-btn">üìÅ Cargar Carpeta</button>
        <button class="btn btn-primary" id="add-youtube-btn">‚ñ∂Ô∏è A√±adir YouTube</button>
        <input type="file" id="local-file-input" accept="audio/*" multiple style="display:none" />
        <input type="file" id="folder-input" webkitdirectory multiple accept="audio/*" style="display:none" />
      </div>
      <div class="library-filters">
        <select id="genre-filter"><option value="">Todos los g√©neros</option></select>
        <select id="mood-filter"><option value="">Todos los estados</option></select>
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="üîç Buscar..." />
      <div class="songs-grid" id="songs-grid"></div>
    </div>

    <div class="view-container" id="playlists-view">
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
        <input id="new-playlist-name" class="text-input" placeholder="Nueva playlist" style="max-width:260px" />
        <button class="btn btn-primary" id="create-playlist-btn">Crear</button>
        <button class="btn btn-secondary" id="btn-smart-playlists">‚ö° Smart</button>
      </div>
      <div id="playlists-list"></div>
    </div>

    <div class="view-container" id="tareas-view">
      <h3 style="margin-bottom:8px">‚úÖ Vista de Tareas (de m√°s urgentes a menos)</h3>
      <div id="tasks-view-list"></div>
    </div>

    <div class="view-container" id="favoritos-view">
      <div class="songs-grid" id="favorites-grid"></div>
    </div>
  </main>
</div>

<div class="mini-player" id="mini-player">
  <div class="mini-player-top">
    <div class="mini-player-cover" id="player-cover">üéµ</div>
    <div class="mini-player-info">
      <div class="mini-player-title" id="player-title">Sin reproducci√≥n</div>
      <div class="mini-player-artist" id="player-artist"></div>
    </div>
    <div class="mini-player-controls">
      <button class="mini-player-btn" id="prev-btn" title="Anterior">‚èÆÔ∏è</button>
      <button class="mini-player-btn play-btn" id="play-btn" title="Reproducir/Pausar">‚ñ∂Ô∏è</button>
      <button class="mini-player-btn" id="next-btn" title="Siguiente">‚è≠Ô∏è</button>
      <button class="mini-player-btn" id="shuffle-btn" style="opacity:.5" title="Aleatorio">üîÄ</button>
      <button class="mini-player-btn" id="repeat-btn" style="opacity:.5" title="Repetir">üîÅ</button>
      <button class="mini-player-btn" id="stop-player-btn" title="Detener">‚úï</button>
      <button class="youtube-toggle-btn-player" id="youtube-toggle-btn">üì∫</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <button class="mini-player-btn" id="volume-icon">üîä</button>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70" />
      <span style="font-size:12px;color:var(--color-text-secondary)">Vel.</span>
      <input type="range" class="rate-slider" id="rate-slider" min="50" max="200" value="100" />
    </div>
  </div>
  <canvas id="viz"></canvas>
  <div class="progress-container">
    <div class="progress-bar" id="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
    <div class="time-display"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
  </div>
</div>

<audio id="audio-player"></audio>
<div id="youtube-player-container" class="youtube-hidden"></div>

<!-- Modales -->
<div class="popover" id="youtube-modal">
  <div class="popover-card" style="max-width:520px">
    <div class="popover-header"><h3 class="modal-title">üåê A√±adir desde YouTube</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div class="event-form" style="grid-template-columns:1fr 1fr">
      <div class="form-row"><label>URL:</label><input type="text" id="youtube-url" class="text-input" placeholder="https://youtube.com/watch?v=..."/></div>
      <div class="form-row"><label>T√≠tulo:</label><input type="text" id="youtube-title" class="text-input"/></div>
      <div class="form-row"><label>Artista:</label><input type="text" id="youtube-artist" class="text-input"/></div>
      <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-secondary" data-close-popover>Cancelar</button><button class="btn btn-primary" id="save-youtube-btn">Guardar</button></div>
    </div>
  </div>
</div>

<div class="popover" id="playlist-modal">
  <div class="popover-card" style="max-width:520px">
    <div class="popover-header"><h3>A√±adir a playlist</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div style="display:grid;gap:8px">
      <select id="playlist-select" class="text-input"></select>
      <div style="display:flex;gap:8px"><input id="playlist-new-name" class="text-input" placeholder="o crea una nueva"/><button class="btn btn-secondary" id="create-in-modal">Crear</button></div>
      <button class="btn btn-primary" id="confirm-add-to-playlist">A√±adir</button>
    </div>
  </div>
</div>

<div class="popover" id="settings-modal">
  <div class="popover-card">
    <div class="popover-header"><h3>‚öôÔ∏è Ajustes</h3><button class="close-button" data-close-popover>√ó</button></div>
    <div style="display:grid;gap:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <h4>Accesibilidad</h4>
          <label><input type="checkbox" id="a11y-high-contrast"/> Alto contraste</label><br/>
          <label><input type="checkbox" id="a11y-reduce-motion"/> Reducir animaciones</label><br/>
          <label><input type="checkbox" id="a11y-large-font"/> Fuente grande</label><br/>
          <label><input type="checkbox" id="a11y-screenreader"/> Mensajes de lector</label><br/>
          <label><input type="checkbox" id="a11y-focus-visible" checked/> Resaltar foco</label>
        </div>
        <div>
          <h4>Reproducci√≥n</h4>
          <label><input type="checkbox" id="opt-autoplay-next" checked/> Auto-siguiente</label><br/>
          <label><input type="checkbox" id="opt-crossfade"/> Crossfade 1s</label><br/>
          <label><input type="checkbox" id="opt-normalize"/> Normalizar volumen (experimental)</label><br/>
          <label>Temporizador de sue√±o: <input type="number" id="opt-sleep-min" min="0" value="0" style="width:70px"/> min</label>
        </div>
      </div>
      <div>
        <h4>Tema</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          <button class="btn btn-secondary" data-theme="retro">Retro</button>
          <button class="btn btn-secondary" data-theme="naturaleza">Naturaleza</button>
          <button class="btn btn-secondary" data-theme="industrial">Industrial</button>
          <button class="btn btn-secondary" data-theme="ciberpunk">Ciberpunk</button>
          <button class="btn btn-secondary" data-theme="oceano">Oc√©ano</button>
          <button class="btn btn-secondary" data-theme="bosque">Bosque</button>
          <button class="btn btn-secondary" data-theme="vaporwave">Vaporwave</button>
          <button class="btn btn-secondary" data-theme="a√±os20">A√±os 20</button>
          <button class="btn btn-secondary" data-theme="minimal">Minimal</button>
          <button class="btn btn-secondary" data-theme="ciudad">Ciudad</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Utils =====
const U = {
  q: id => document.getElementById(id),
  qa: sel => document.querySelectorAll(sel),
  on: (el, evt, fn) => el && el.addEventListener(evt, fn),
  text: (el, t) => el && (el.textContent = t),
  html: (el, h) => el && (el.innerHTML = h),
  announce: msg => { const a = U.q('aria-live-region'); if (a) a.textContent = msg; },
  fmt: s => { s = Math.max(0, Math.floor(s||0)); const m = Math.floor(s/60); const sec = s%60; return `${m}:${sec.toString().padStart(2,'0')}`; },
  dateKey: d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
};

// === TIPOS DE CANCIONES ===
const SONG_TYPES = { GITHUB:'github', LOCAL:'local', YOUTUBE:'youtube' };
const SONG_TYPE_ICONS = { github:'üåê', local:'üíø', youtube:'‚ñ∂Ô∏è' };
const SONG_TYPE_LABELS = { github:'GitHub', local:'Local', youtube:'YouTube' };

// === CONFIGURACI√ìN GITHUB ===
const GITHUB_CONFIG = { owner:'mrdaniel7', repo:'CalendarioMultimedia', branch:'main', musicFolder:'musica' };

// === ESTADO GLOBAL ===
const app = {
  songs: [], currentIndex:-1, currentDate:new Date(), isPlaying:false, videoVisible:false,
  nextId:1000, shuffleMode:false, repeatMode:'none', volume:0.8, currentView:'calendario',
  events:[], playlists:[], pendingAddSongId:null,
  playCount: new Map(),
  yt:{ player:null, ready:false, timer:null, duration:0 },
  options:{ autoplayNext:true, crossfade:false, normalize:false, a11y:{highContrast:false, reduceMotion:false, largeFont:false, screenreader:false, focusVisible:true} },
  audioCtx:null, analyser:null, gainNode:null, sourceNode:null
};

// ====== Storage ======
const storage = {
  save(){
    localStorage.setItem('mp_events', JSON.stringify(app.events));
    localStorage.setItem('mp_playlists', JSON.stringify(app.playlists));
    localStorage.setItem('mp_options', JSON.stringify(app.options));
    localStorage.setItem('mp_theme', document.documentElement.getAttribute('data-theme')||'retro');
  },
  load(){
    try { app.events = JSON.parse(localStorage.getItem('mp_events')||'[]'); } catch(_){}
    try { app.playlists = JSON.parse(localStorage.getItem('mp_playlists')||'[]'); } catch(_){}
    try { const opt = JSON.parse(localStorage.getItem('mp_options')||'null'); if(opt) app.options = opt; } catch(_){}
    const theme = localStorage.getItem('mp_theme')||'retro'; document.documentElement.setAttribute('data-theme', theme);
  }
};

// ====== Biblioteca / Render ======
function renderSongs(){
  const container = U.q('songs-grid'); if(!container) return;
  const genreFilter = U.q('genre-filter').value; const moodFilter = U.q('mood-filter').value; const search = U.q('search-input').value.toLowerCase();
  let list = app.songs.filter(s=>{
    if(genreFilter && !(s.genres||[]).includes(genreFilter)) return false;
    if(moodFilter && !(s.moods||[]).includes(moodFilter)) return false;
    if(search && !(s.title||'').toLowerCase().includes(search) && !(s.artist||'').toLowerCase().includes(search)) return false;
    return true;
  });
  if(!list.length){ container.innerHTML = '<div class="empty-state"><div style="font-size:64px">üéµ</div><p>No hay canciones</p></div>'; return; }
  container.innerHTML = list.map(s=>{
    const typeIcon = SONG_TYPE_ICONS[s.type]||'üéµ';
    const typeLabel = SONG_TYPE_LABELS[s.type]||'Fuente';
    const cover = s.cover ? `<img src="${s.cover}" alt="${s.title}">` : 'üéµ';
    const tags = (s.genres||[]).map(g=>`<span class="badge">${g}</span>`).join(' ') + ' ' + (s.moods||[]).map(m=>`<span class="badge">${m}</span>`).join(' ');
    return `<div class="song-card ${app.currentIndex>=0 && app.songs[app.currentIndex].id===s.id ? 'playing':''}" onclick="playSong(${s.id})">
      <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
      <button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${s.id})">${s.isFavorite?'‚ù§Ô∏è':'ü§ç'}</button>
      <button class="more-btn" title="A√±adir a playlist" onclick="event.stopPropagation();openAddToPlaylist(${s.id})">‚ûï</button>
      <div class="song-cover">${cover}</div>
      <div class="song-title">${s.title||'Desconocido'}</div>
      <div class="song-artist">${s.artist||''}</div>
      <div class="song-album">${s.album||typeLabel}</div>
      <div class="tags-flow">${tags}</div>
      <button class="song-delete-btn" onclick="event.stopPropagation();deleteSong(${s.id})">üóëÔ∏è Eliminar</button>
    </div>`;
  }).join('');
}

function toggleFav(id){ const s=app.songs.find(x=>x.id===id); if(!s) return; s.isFavorite=!s.isFavorite; renderSongs(); }

// ====== Carga de archivos locales ======
async function handleLocalFileUpload(fileList){
  const files = Array.from(fileList||[]).filter(f=> f.type.startsWith('audio/'));
  for(const file of files){
    const baseName = file.name.replace(/\.[^/.]+$/, '');
    const song = { id: app.nextId++, title: baseName, artist:'Desconocido', album:'Archivo Local', duration:0, type:SONG_TYPES.LOCAL, blob:file, cover:null, genres:[], moods:[], isFavorite:false, fileName:file.name, fileSize:file.size, mimeType:file.type, dateAdded:new Date().toISOString() };
    app.songs.push(song);
    try{ await extractMetadata(song);}catch(_){ }
    try{ await ensureCover(song);}catch(_){ }
    try{ await autoTagSong(song);}catch(_){ }
  }
  populateFilters(); renderSongs();
}

async function loadMusicFolder(){ const input=U.q('folder-input'); input.onchange = e=> handleLocalFileUpload(e.target.files); input.click(); }

// ====== Metadatos & Car√°tulas ======
async function extractMetadata(song){
  if(!song.blob || typeof jsmediatags==='undefined') return;
  return new Promise((resolve)=>{
    try{
      jsmediatags.read(song.blob, { onSuccess: tag=>{ const t=tag.tags||{}; if(t.title) song.title=t.title; if(t.artist) song.artist=t.artist; if(t.album) song.album=t.album; if(t.picture && t.picture.data && t.picture.format){ try{ const bytes=new Uint8Array(t.picture.data); const blob=new Blob([bytes],{type:t.picture.format}); song.cover=URL.createObjectURL(blob);}catch(e){} } resolve(); }, onError:()=>resolve() });
    }catch(e){ resolve(); }
  });
}

async function ensureCover(song){ if(song.cover) return; const url = await fetchCoverFromWeb(song.artist||'', song.title||'').catch(()=>null); song.cover = url || 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=400&auto=format&fit=crop'; }

async function fetchCoverFromWeb(artist, title){
  const q = encodeURIComponent(`${artist} ${title}`.trim() || artist || title); if(!q) return null;
  try{ const r = await fetch(`https://itunes.apple.com/search?term=${q}&media=music&entity=song&limit=1`); const j=await r.json(); const it=j.results&&j.results[0]; if(it && it.artworkUrl100) return it.artworkUrl100.replace('100x100bb','300x300bb'); }catch(e){}
  try{ return `https://source.unsplash.com/featured/300x300?music`; }catch(e){ return null; }
}

// ====== Auto-tag (2 g√©neros + 3 emociones) ======
async function autoTagSong(song){
  const title=(song.title||'').toLowerCase(); const artist=(song.artist||'').toLowerCase(); const hay = w => title.includes(w)||artist.includes(w);
  const genreMap={ Rock:['rock','guitar','metal','punk'], Pop:['pop','hit','love'], Jazz:['jazz','swing','blue note'], Blues:['blues'], Classical:['beethoven','mozart','bach','classical','symphony'], Electronic:['edm','electro','techno','house','trance'], 'Hip Hop':['hip hop','rap','trap'], Indie:['indie','alternative'], Reggaeton:['reggaeton'], Latin:['latino','salsa','bachata'], Soul:['soul','motown'], 'R&B':['r&b','rnb'] };
  const moodMap={ Feliz:['happy','feliz','smile','sun','summer','buena'], Triste:['sad','triste','cry','lonely'], 'En√©rgico':['power','fire','boom','fast','speed','dance','party','fiesta','rock'], Relajado:['chill','calm','lofi','relax','slow'], 'Rom√°ntico':['love','amor','kiss','heart'], Motivador:['win','rise','up','motivation','fuerza'], 'Nost√°lgico':['nostalgia','remember','old'], 'Melanc√≥lico':['melancholy','melancol'], Festivo:['party','fiesta','celebr'], Inspirador:['dream','sue√±o','hope'] };
  const gPick = new Set(); for(const [g,keys] of Object.entries(genreMap)) if(keys.some(k=>hay(k))) gPick.add(g); if(gPick.size<2) gPick.add('Pop'); if(gPick.size<2) gPick.add('Indie'); song.genres = Array.from(gPick).slice(0,2);
  const mPick=[]; for(const [m,keys] of Object.entries(moodMap)) if(keys.some(k=>hay(k))) mPick.push(m); const ensure=v=>{ if(!mPick.includes(v)) mPick.push(v); }; while(mPick.length<3){ ensure(['Feliz','Relajado','En√©rgico','Motivador','Rom√°ntico'][mPick.length%5]); } song.moods = mPick.slice(0,3);
}

function populateFilters(){ const genres=new Set(), moods=new Set(); app.songs.forEach(s=>{ (s.genres||[]).forEach(g=>genres.add(g)); (s.moods||[]).forEach(m=>moods.add(m)); }); const gf=U.q('genre-filter'), mf=U.q('mood-filter'); if(gf) gf.innerHTML='<option value="">Todos los g√©neros</option>'+Array.from(genres).sort().map(g=>`<option value="${g}">${g}</option>`).join(''); if(mf) mf.innerHTML='<option value="">Todos los estados</option>'+Array.from(moods).sort().map(m=>`<option value="${m}">${m}</option>`).join(''); }

// ====== GitHub ======
async function fetchGitHubSongs(){ try{ const apiUrl=`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.musicFolder}?ref=${GITHUB_CONFIG.branch}`; const res=await fetch(apiUrl); if(!res.ok) return []; const files=await res.json(); const exts=['.mp3','.wav','.ogg','.m4a','.flac']; const list=[]; for(const f of files){ if(f.type==='file' && exts.some(x=>f.name.toLowerCase().endsWith(x))){ const raw=`https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.musicFolder}/${f.name}`; const s={ id: app.nextId++, title:f.name.replace(/\.[^/.]+$/, ''), artist:GITHUB_CONFIG.owner, album:'GitHub', duration:0, type:SONG_TYPES.GITHUB, fileName:f.name, fileUrl:raw, cover:null, genres:[], moods:[], isFavorite:false, dateAdded:new Date().toISOString() }; await ensureCover(s); await autoTagSong(s); list.push(s);} } return list; }catch(e){ console.warn('GH err', e); return []; } }
async function loadGitHubSongs(){ const arr=await fetchGitHubSongs(); if(arr.length){ app.songs.push(...arr); populateFilters(); renderSongs(); } }

// ====== Reproductor ======
function getNextIndex(){ if(app.shuffleMode){ if(app.songs.length<=1) return app.currentIndex; let idx; do{ idx=Math.floor(Math.random()*app.songs.length);} while(idx===app.currentIndex); return idx; } const last=app.songs.length-1; if(app.currentIndex<last) return app.currentIndex+1; return app.repeatMode==='all'? 0 : last; }
function getPrevIndex(){ if(app.shuffleMode){ if(app.songs.length<=1) return app.currentIndex; let idx; do{ idx=Math.floor(Math.random()*app.songs.length);} while(idx===app.currentIndex); return idx; } if(app.currentIndex>0) return app.currentIndex-1; return app.repeatMode==='all'? app.songs.length-1 : 0; }

function updateMini(song){ U.text(U.q('player-title'), song.title||''); U.text(U.q('player-artist'), song.artist||''); const coverEl=U.q('player-cover'); if(song.cover){ coverEl.innerHTML = `<img src="${song.cover}" alt="${song.title}" style="width:100%;height:100%;object-fit:cover;border-radius:8px"/>`; } else { coverEl.textContent='üéµ'; } U.q('mini-player').classList.add('active'); }

function onEnded(){ if(app.repeatMode==='one'){ playSong(app.songs[app.currentIndex].id); return; } const next = getNextIndex(); if(next!==app.currentIndex) playSong(app.songs[next].id); }

function playSong(id){ const song = app.songs.find(s=>s.id===id); if(!song) return; app.currentIndex = app.songs.indexOf(song); updateMini(song); U.text(U.q('play-btn'),'‚è∏Ô∏è'); app.isPlaying=true; // limpiar youtube/audio
  const audio = U.q('audio-player'); audio.pause(); audio.src=''; if(app.yt.timer){ clearInterval(app.yt.timer); app.yt.timer=null; }
  U.q('youtube-player-container').innerHTML=''; U.q('youtube-player-container').classList.add('youtube-hidden'); U.q('youtube-toggle-btn').style.display='none';
  if(song.type===SONG_TYPES.YOUTUBE){ playYouTube(song); } else if(song.type===SONG_TYPES.LOCAL && song.blob){ const url = URL.createObjectURL(song.blob); audio.src=url; audio.play().catch(()=>{}); } else if(song.type===SONG_TYPES.GITHUB && song.fileUrl){ audio.src=song.fileUrl; audio.crossOrigin='anonymous'; audio.play().catch(()=>{}); }
  renderSongs(); app.playCount.set(song.id, (app.playCount.get(song.id)||0)+1); }

function playYouTube(song){ U.q('youtube-toggle-btn').style.display='inline-flex'; const container=U.q('youtube-player-container'); container.classList.remove('youtube-hidden'); container.classList.add('youtube-visible');
  function ensure(){ if(app.yt.player){ app.yt.player.loadVideoById(song.youtubeId); startYTTimer(); return; }
    app.yt.player = new YT.Player(container, { width:'100%', height:'100%', videoId:song.youtubeId, playerVars:{ autoplay:1, controls:1, rel:0, playsinline:1, modestbranding:1 }, events:{ onReady: (e)=>{ app.yt.ready=true; e.target.playVideo(); startYTTimer(); }, onStateChange: (e)=>{ if(e.data===0) onEnded(); } } });
  }
  if(window.YT && YT.Player){ ensure(); } else { window.onYouTubeIframeAPIReady = ()=>{ ensure(); }; }
}

function startYTTimer(){ if(app.yt.timer) clearInterval(app.yt.timer); app.yt.timer = setInterval(()=>{ try{ const p=app.yt.player; if(!p) return; const cur=p.getCurrentTime?.()||0; const dur=p.getDuration?.()||0; U.text(U.q('current-time'), U.fmt(cur)); U.text(U.q('total-time'), U.fmt(dur)); const pct = dur? (cur/dur*100):0; U.q('progress-fill').style.width = pct+'%'; }catch(_){} }, 250); }

// ====== Seek / Controles ======
function seekToPct(pct){ pct=Math.min(100,Math.max(0,pct)); const audio=U.q('audio-player'); const cur=app.songs[app.currentIndex]; if(!cur) return; if(cur.type===SONG_TYPES.YOUTUBE && app.yt.player){ const dur=app.yt.player.getDuration?.()||0; app.yt.player.seekTo(dur*pct/100, true); } else if(audio.duration){ audio.currentTime = audio.duration * pct/100; } }

// ====== Playlists ======
function renderPlaylists(){ const list=U.q('playlists-list'); if(!list) return; if(!app.playlists.length){ list.innerHTML='<div class="empty-state">Crea tu primera playlist</div>'; return; } list.innerHTML = app.playlists.map(p=>{ const items=p.songIds?.map(id=> app.songs.find(s=>s.id===id)).filter(Boolean)||[]; return `<div class="agenda" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><h3>üéß ${p.name}</h3><small>${items.length} canciones</small></div><div class="songs-grid">${items.map(s=>`<div class="song-card" onclick=\"playSong(${s.id})\"><div class="song-cover">${s.cover?`<img src='${s.cover}'/>`:'üéµ'}</div><div class="song-title">${s.title}</div><div class="song-artist">${s.artist||''}</div><button class="song-delete-btn" onclick=\"event.stopPropagation();removeFromPlaylist('${p.id}', ${s.id})\">Quitar</button></div>`).join('')}</div></div>`; }).join(''); }

function openAddToPlaylist(songId){ app.pendingAddSongId=songId; refreshPlaylistSelect(); U.q('playlist-modal').classList.add('active'); }
function refreshPlaylistSelect(){ const sel=U.q('playlist-select'); sel.innerHTML = app.playlists.map(p=>`<option value='${p.id}'>${p.name}</option>`).join(''); }
function addSongToPlaylist(pid, sid){ const p=app.playlists.find(x=>x.id===pid); if(!p) return; if(!p.songIds) p.songIds=[]; if(!p.songIds.includes(sid)) p.songIds.push(sid); storage.save(); renderPlaylists(); }
function removeFromPlaylist(pid, sid){ const p=app.playlists.find(x=>x.id===pid); if(!p) return; p.songIds = (p.songIds||[]).filter(id=>id!==sid); storage.save(); renderPlaylists(); }

// ====== Calendario ======
function renderCalendar(){
  const y=app.currentDate.getFullYear(); const m=app.currentDate.getMonth();
  const monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  U.text(U.q('month-title'), `${monthNames[m]} ${y}`);
  const first = new Date(y,m,1); let start = first.getDay(); start = start===0?6:start-1; // lunes
  const dim = new Date(y,m+1,0).getDate();
  const grid=U.q('calendar-grid'); grid.innerHTML='';
  const headers=['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom']; headers.forEach(h=>{ const d=document.createElement('div'); d.className='calendar-header'; d.textContent=h; grid.appendChild(d);});
  for(let i=0;i<start;i++){ const e=document.createElement('div'); e.className='calendar-day'; e.style.visibility='hidden'; grid.appendChild(e); }
  const today=new Date();
  for(let day=1; day<=dim; day++){
    const key=`${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const el=document.createElement('div'); el.className='calendar-day';
    if(y===today.getFullYear() && m===today.getMonth() && day===today.getDate()) el.classList.add('today');
    el.innerHTML = `<span class=\"day-number\">${day}</span><div class=\"event-dot\"></div>`;
    const dot=el.querySelector('.event-dot');
    const items = app.events.filter(ev=>ev.date===key);
    if(items.length){ const hasTask=items.some(ev=>ev.type==='task'), hasNote=items.some(ev=>ev.type==='note'), hasBirth=items.some(ev=>ev.type==='birthday'); if(hasTask){ const d=document.createElement('div'); d.className='dot task'; dot.appendChild(d);} if(hasNote){ const d=document.createElement('div'); d.className='dot note'; dot.appendChild(d);} if(hasBirth){ const d=document.createElement('div'); d.className='dot birthday'; dot.appendChild(d);} }
    el.addEventListener('click', ()=> openDayPopover(key));
    grid.appendChild(el);
  }
  renderAgenda();
}

function renderAgenda(){ const cont=U.q('agenda-content'); if(!cont) return; const from=new Date(); const to=new Date(from.getFullYear(), from.getMonth(), from.getDate()+30); const lst=app.events.filter(ev=> new Date(ev.date)>=new Date(from.toDateString()) && new Date(ev.date)<=to).sort((a,b)=> (new Date(a.date)-new Date(b.date))||((b.priority||1)-(a.priority||1)) ); cont.innerHTML = lst.map(ev=>`<div class=\"event-item\"><span class=\"badge ${ev.type}\">${ev.type}</span><div style=\"flex:1\"><div style=\"font-weight:700\">${ev.title}</div><small>${ev.date}${ev.time? ' ¬∑ '+ev.time:''}</small></div><button class=\"btn\" onclick=\"toggleDone('${ev.id}')\">${ev.done?'‚úÖ':'‚¨ú'}</button><button class=\"btn\" onclick=\"removeEvent('${ev.id}')\">üóëÔ∏è</button></div>`).join('') || '<div class=\"empty-state\">Sin pr√≥ximos eventos</div>'; }

function openDayPopover(dateKey){ const pop=document.createElement('div'); pop.className='popover active'; pop.innerHTML = `<div class=\"popover-card\"><div class=\"popover-header\"><h3>üìÖ ${dateKey}</h3><button class=\"close-button\" data-close-popover>√ó</button></div>
  <div class=\"tabs\"><button class=\"tab active\" data-tab=\"list\">Eventos</button><button class=\"tab\" data-tab=\"new\">Nuevo</button></div>
  <div id=\"day-list\"></div>
  <div id=\"day-new\" style=\"display:none\">
    <div class=\"event-form\">
      <div class=\"form-row\"><label>T√≠tulo</label><input id=\"ev-title\" class=\"text-input\"/></div>
      <div class=\"form-row\"><label>Hora (opcional)</label><input id=\"ev-time\" class=\"text-input\" placeholder=\"HH:MM\"/></div>
      <div class=\"form-row\"><label>Tipo</label><select id=\"ev-type\"><option value=\"task\">Tarea</option><option value=\"note\">Nota</option><option value=\"birthday\">Cumplea√±os</option></select></div>
      <div class=\"form-row\"><label>Prioridad</label><select id=\"ev-priority\"><option value=\"3\">Alta</option><option value=\"2\">Media</option><option value=\"1\">Baja</option></select></div>
    </div>
    <div style=\"display:flex;gap:8px;justify-content:flex-end\"><button class=\"btn btn-secondary\" data-close-popover>Cancelar</button><button class=\"btn btn-primary\" id=\"ev-save\">Guardar</button></div>
  </div></div>`;
  document.body.appendChild(pop);
  pop.addEventListener('click', e=>{ if(e.target.matches('[data-close-popover]')|| e.target===pop){ pop.remove(); }});
  const tabs = pop.querySelectorAll('.tab');
  tabs.forEach(t=> t.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); pop.querySelector('#day-list').style.display = (t.dataset.tab==='list')?'block':'none'; pop.querySelector('#day-new').style.display = (t.dataset.tab==='new')?'block':'none'; }));
  const listCont = pop.querySelector('#day-list');
  const renderList = ()=>{ const items=app.events.filter(ev=>ev.date===dateKey).sort((a,b)=> (b.priority||1)-(a.priority||1)); listCont.innerHTML = items.map(ev=>`<div class=\"events-list\"><div class=\"row\"><div><span class=\"badge ${ev.type}\">${ev.type}</span> <b>${ev.title}</b> ${ev.time? ' ¬∑ '+ev.time:''}</div><div><button class=\"btn\" onclick=\"toggleDone('${ev.id}', true)\">${ev.done?'‚úÖ':'‚¨ú'}</button> <button class=\"btn\" onclick=\"removeEvent('${ev.id}', true)\">üóëÔ∏è</button></div></div></div>`).join('') || '<div class=empty-state>Sin eventos</div>'; };
  renderList();
  pop.querySelector('#ev-save').addEventListener('click', ()=>{ const t=pop.querySelector('#ev-title').value.trim(); if(!t) return; const time=pop.querySelector('#ev-time').value.trim(); const type=pop.querySelector('#ev-type').value; const pr=Number(pop.querySelector('#ev-priority').value)||1; const ev={ id:'ev-'+Math.random().toString(36).slice(2), title:t, date:dateKey, time:type==='birthday'?'üéÇ':time, type, priority:pr, done:false }; app.events.push(ev); storage.save(); renderCalendar(); renderTasksView(); pop.remove(); });
}

function toggleDone(id, silent){ const ev=app.events.find(x=>x.id===id); if(!ev) return; ev.done=!ev.done; storage.save(); renderAgenda(); if(!silent) renderCalendar(); renderTasksView(); }
function removeEvent(id, silent){ app.events = app.events.filter(x=>x.id!==id); storage.save(); renderAgenda(); if(!silent) renderCalendar(); renderTasksView(); }

function renderTasksView(){ const c=U.q('tasks-view-list'); if(!c) return; const now=new Date(); const arr=[...app.events].filter(e=>e.type==='task'&&!e.done).sort((a,b)=>{ const ad=new Date(a.date), bd=new Date(b.date); const dist=d=> Math.abs((d-now)/(1000*60*60*24)); const diff=dist(ad)-dist(bd); if(diff!==0) return diff; return (b.priority||1)-(a.priority||1);}); c.innerHTML = arr.map(e=>`<div class=\"event-item\"><span class=\"badge task\">Tarea</span><div style=\"flex:1\"><div style=\"font-weight:700\">${e.title}</div><small>${e.date}${e.time? ' ¬∑ '+e.time:''}</small></div><span class=\"badge\">P${e.priority}</span><button class=\"btn\" onclick=\"toggleDone('${e.id}')\">‚úÖ</button></div>`).join('') || '<div class=empty-state>Sin tareas pendientes</div>'; }

// ====== Ajustes / Temas / Accesibilidad ======
function openSettings(){ U.q('settings-modal').classList.add('active'); }
function applyOptionsToUI(){ document.body.style.fontSize = app.options.a11y.largeFont? '16px':'14px'; document.body.style.scrollBehavior = app.options.a11y.reduceMotion? 'auto':'smooth'; document.querySelector(':root').style.setProperty('--contrast-factor', app.options.a11y.highContrast? '1.3':'1'); }
function setTheme(name){ document.documentElement.setAttribute('data-theme', name); storage.save(); }

// ====== Visualizador ======
function initAudioNodes(){ try{ app.audioCtx = app.audioCtx || new (window.AudioContext||window.webkitAudioContext)(); const audio=U.q('audio-player'); app.sourceNode = app.audioCtx.createMediaElementSource(audio); app.gainNode = app.audioCtx.createGain(); app.analyser = app.audioCtx.createAnalyser(); app.analyser.fftSize=256; app.sourceNode.connect(app.gainNode).connect(app.analyser).connect(app.audioCtx.destination); drawViz(); }catch(e){}}
function drawViz(){ const c=document.getElementById('viz'); if(!c) return; const ctx=c.getContext('2d'); const buf=new Uint8Array(128); const render=()=>{ if(!app.analyser){ requestAnimationFrame(render); return; } app.analyser.getByteFrequencyData(buf); const w=c.clientWidth, h=c.clientHeight; c.width=w; c.height=h; ctx.clearRect(0,0,w,h); const barW=w/buf.length; for(let i=0;i<buf.length;i++){ const v=buf[i]/255; const bh=v*h; ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--color-primary')||'#0aa'; ctx.fillRect(i*barW, h-bh, barW-1, bh); } requestAnimationFrame(render); }; requestAnimationFrame(render); }

// ====== Borrado canci√≥n ======
function deleteSong(id){ const s = app.songs.find(x=>x.id===id); if(!s) return; if(app.currentIndex>=0 && app.songs[app.currentIndex].id===id){ const a=U.q('audio-player'); a.pause(); a.src=''; if(app.yt.player) try{ app.yt.player.stopVideo(); }catch(_){} app.currentIndex=-1; app.isPlaying=false; } app.songs = app.songs.filter(x=>x.id!==id); populateFilters(); renderSongs(); }

// ====== YouTube modal ======
function saveYouTube(){
  const url=U.q('youtube-url').value.trim(); if(!url) return alert('URL requerida');
  const id = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^&\n?#]+)/)?.[1];
  if(!id) return alert('URL inv√°lida');
  const title = U.q('youtube-title').value.trim() || 'YouTube';
  const artist= U.q('youtube-artist').value.trim() || 'YouTube';
  const song = { id: app.nextId++, title, artist, type: SONG_TYPES.YOUTUBE, youtubeId:id, cover:`https://img.youtube.com/vi/${id}/mqdefault.jpg`, genres:[], moods:[], isFavorite:false, album:'YouTube', dateAdded:new Date().toISOString() };
  app.songs.push(song);
  autoTagSong(song);
  ensureCover(song);
  populateFilters(); renderSongs();
  document.querySelector('#youtube-modal').classList.remove('active');
}

function closePopovers(){ document.querySelectorAll('.popover.active').forEach(p=>p.classList.remove('active')); }

// ====== INIT ======
U.on(document,'DOMContentLoaded', async ()=>{
  storage.load(); applyOptionsToUI();

  // Sidebar / vistas
  U.qa('.sidebar-item[data-view]').forEach(b=> U.on(b,'click', ()=> switchView(b.getAttribute('data-view'))));
  function switchView(view){ app.currentView=view; U.qa('.sidebar-item').forEach(i=> i.classList.toggle('active', i.getAttribute('data-view')===view)); U.qa('.view-container').forEach(v=> v.classList.remove('active')); const el=U.q(view+'-view'); if(el) el.classList.add('active'); if(view==='calendario') renderCalendar(); if(view==='biblioteca') renderSongs(); if(view==='playlists') renderPlaylists(); if(view==='tareas') renderTasksView(); }

  // Meses
  U.on(U.q('prev-month'),'click', ()=>{ app.currentDate.setMonth(app.currentDate.getMonth()-1); renderCalendar(); });
  U.on(U.q('next-month'),'click', ()=>{ app.currentDate.setMonth(app.currentDate.getMonth()+1); renderCalendar(); });

  // Tema/Ajustes
  U.on(U.q('theme-toggle'),'click', ()=> document.documentElement.toggleAttribute('data-color-scheme','dark'));
  U.on(U.q('settings-btn'),'click', ()=> document.getElementById('settings-modal').classList.add('active'));
  U.qa('[data-theme]').forEach(btn=> U.on(btn,'click', ()=> setTheme(btn.dataset.theme)));
  U.qa('[data-close-popover]').forEach(x=> U.on(x,'click', ()=> x.closest('.popover').classList.remove('active')));

  // Biblioteca
  U.on(U.q('upload-local-btn'),'click', ()=> U.q('local-file-input').click());
  U.on(U.q('local-file-input'),'change', e=>{ if(e.target.files?.length){ handleLocalFileUpload(e.target.files); e.target.value=''; }});
  U.on(U.q('load-folder-btn'),'click', loadMusicFolder);
  U.on(U.q('add-youtube-btn'),'click', ()=> U.q('youtube-modal').classList.add('active'));
  U.on(U.q('save-youtube-btn'),'click', saveYouTube);
  U.on(U.q('genre-filter'),'change', renderSongs); U.on(U.q('mood-filter'),'change', renderSongs); U.on(U.q('search-input'),'input', renderSongs);

  // Mini player & audio
  U.on(U.q('play-btn'),'click', ()=>{
    const cur=app.songs[app.currentIndex]; if(!cur) return U.announce('Selecciona una canci√≥n');
    if(cur.type===SONG_TYPES.YOUTUBE && app.yt.player){ const st=app.yt.player.getPlayerState?.(); if(st===1) app.yt.player.pauseVideo(); else app.yt.player.playVideo(); return; }
    const a=U.q('audio-player'); if(app.isPlaying){ a.pause(); app.isPlaying=false; U.text(U.q('play-btn'),'‚ñ∂Ô∏è'); } else { a.play().catch(()=>{}); app.isPlaying=true; U.text(U.q('play-btn'),'‚è∏Ô∏è'); }
  });
  U.on(U.q('stop-player-btn'),'click', ()=>{ const a=U.q('audio-player'); a.pause(); a.src=''; if(app.yt.player) try{ app.yt.player.stopVideo(); }catch(_){} app.isPlaying=false; app.currentIndex=-1; U.text(U.q('player-title'),'Sin reproducci√≥n'); U.text(U.q('player-artist'),''); U.text(U.q('play-btn'),'‚ñ∂Ô∏è'); U.q('progress-fill').style.width='0%'; U.text(U.q('current-time'),'0:00'); U.text(U.q('total-time'),'0:00'); });
  U.on(U.q('prev-btn'),'click', ()=>{ if(app.currentIndex<0) return; const idx=getPrevIndex(); playSong(app.songs[idx].id); });
  U.on(U.q('next-btn'),'click', ()=>{ if(app.currentIndex<0) return; const idx=getNextIndex(); playSong(app.songs[idx].id); });
  U.on(U.q('shuffle-btn'),'click', ()=>{ app.shuffleMode=!app.shuffleMode; U.q('shuffle-btn').style.opacity = app.shuffleMode? '1':'0.5'; });
  U.on(U.q('repeat-btn'),'click', ()=>{ app.repeatMode = app.repeatMode==='none'?'all': app.repeatMode==='all'?'one':'none'; U.text(U.q('repeat-btn'), app.repeatMode==='one'?'üîÇ':'üîÅ'); U.q('repeat-btn').style.opacity = app.repeatMode==='none'?'0.5':'1'; });
  U.on(U.q('volume-slider'),'input', e=>{ app.volume=e.target.value/100; const a=U.q('audio-player'); a.volume=app.volume; U.text(U.q('volume-icon'), app.volume===0?'üîá': app.volume<0.5?'üîâ':'üîä'); });
  U.on(U.q('volume-icon'),'click', ()=>{ const slider=U.q('volume-slider'); if(app.volume>0){ slider.dataset.prev=app.volume; slider.value=0; app.volume=0; U.q('audio-player').volume=0; U.text(U.q('volume-icon'),'üîá'); } else { const prev=parseFloat(slider.dataset.prev)||0.7; slider.value=prev*100; app.volume=prev; U.q('audio-player').volume=prev; U.text(U.q('volume-icon'),'üîä'); }});
  U.on(U.q('rate-slider'),'input', e=>{ const rate=(e.target.value||100)/100; const cur=app.songs[app.currentIndex]; if(cur && cur.type===SONG_TYPES.YOUTUBE && app.yt.player){ try{ app.yt.player.setPlaybackRate(Math.min(2,Math.max(.5,rate))); }catch(_){} } else { U.q('audio-player').playbackRate=rate; } });

  // Progress bar seek
  U.on(U.q('progress-bar'),'click', e=>{ const rect=e.currentTarget.getBoundingClientRect(); const pct=(e.clientX-rect.left)/rect.width*100; seekToPct(pct); });

  // Audio element events
  const audio=U.q('audio-player'); initAudioNodes();
  U.on(audio,'play', ()=>{ U.text(U.q('play-btn'),'‚è∏Ô∏è'); app.isPlaying=true; });
  U.on(audio,'pause', ()=>{ U.text(U.q('play-btn'),'‚ñ∂Ô∏è'); app.isPlaying=false; });
  U.on(audio,'timeupdate', ()=>{ if(audio.duration){ const pct=audio.currentTime/audio.duration*100; U.q('progress-fill').style.width=pct+'%'; U.text(U.q('current-time'), U.fmt(audio.currentTime)); U.text(U.q('total-time'), U.fmt(audio.duration)); }});
  U.on(audio,'loadedmetadata', ()=>{ U.text(U.q('total-time'), U.fmt(audio.duration||0)); });
  U.on(audio,'ended', onEnded);

  // Drag & Drop
  let dragCounter=0; U.on(document,'dragenter', e=>{ e.preventDefault(); e.stopPropagation(); dragCounter++; }); U.on(document,'dragleave', e=>{ e.preventDefault(); e.stopPropagation(); dragCounter--; }); U.on(document,'dragover', e=>{ e.preventDefault(); e.stopPropagation(); }); U.on(document,'drop', e=>{ e.preventDefault(); e.stopPropagation(); dragCounter=0; if(e.dataTransfer.files?.length){ handleLocalFileUpload(e.dataTransfer.files); }});

  // Quick Add / Import / Export
  U.on(U.q('btn-quick-add'),'click', ()=> openDayPopover(U.dateKey(new Date())));
  U.on(U.q('btn-export'),'click', ()=>{ const data=JSON.stringify({events:app.events, playlists:app.playlists}); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='musicpro-backup.json'; a.click(); });
  U.on(U.q('btn-import'),'click', ()=> U.q('import-file').click());
  U.on(U.q('import-file'),'change', async e=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); const j=JSON.parse(txt); if(j.events) app.events=j.events; if(j.playlists) app.playlists=j.playlists; storage.save(); renderCalendar(); renderPlaylists(); renderTasksView(); alert('Importado'); });

  // Crear playlist
  U.on(U.q('create-playlist-btn'),'click', ()=>{ const name=U.q('new-playlist-name').value.trim(); if(!name) return; const id='pl-'+Math.random().toString(36).slice(2); app.playlists.push({id,name,songIds:[]}); storage.save(); renderPlaylists(); });
  U.on(U.q('confirm-add-to-playlist'),'click', ()=>{ const pid=U.q('playlist-select').value; if(!pid||app.pendingAddSongId==null) return; addSongToPlaylist(pid, app.pendingAddSongId); app.pendingAddSongId=null; U.q('playlist-modal').classList.remove('active'); });
  U.on(U.q('create-in-modal'),'click', ()=>{ const name=U.q('playlist-new-name').value.trim(); if(!name) return; const id='pl-'+Math.random().toString(36).slice(2); app.playlists.push({id,name,songIds:[]}); storage.save(); refreshPlaylistSelect(); });
  U.on(U.q('btn-smart-playlists'),'click', ()=>{ const recent={id:'pl-recent', name:'Recientes', songIds:[...app.songs].sort((a,b)=> new Date(b.dateAdded)-new Date(a.dateAdded)).slice(0,20).map(s=>s.id)}; const top={id:'pl-top', name:'M√°s reproducidas', songIds:[...app.songs].sort((a,b)=> (app.playCount.get(b.id)||0)-(app.playCount.get(a.id)||0)).slice(0,20).map(s=>s.id)}; const chill={id:'pl-chill', name:'Relajado', songIds: app.songs.filter(s=> (s.moods||[]).includes('Relajado')).slice(0,30).map(s=>s.id)}; app.playlists = app.playlists.filter(p=>!['pl-recent','pl-top','pl-chill'].includes(p.id)); app.playlists.push(recent,top,chill); storage.save(); renderPlaylists(); });

  // Carga inicial
  await loadGitHubSongs();
  populateFilters(); renderSongs(); renderCalendar(); renderTasksView();
});
</script>
</body>
</html>
