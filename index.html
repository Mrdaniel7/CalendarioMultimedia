<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Musical Emocional</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
    /* DESIGN SYSTEM */
    :root {
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-bg-5: rgba(147, 51, 234, 0.08);
      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --space-4: 4px;
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;
      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
    }

    [data-color-scheme="dark"] {
      --color-gray-400-rgb: 119, 124, 124;
      --color-gray-200-rgb: 245, 245, 245;
      --color-background: var(--color-charcoal-700);
      --color-surface: var(--color-charcoal-800);
      --color-text: var(--color-gray-200);
      --color-text-secondary: rgba(var(--color-gray-400-rgb), 0.7);
      --color-primary: var(--color-teal-300);
      --color-primary-hover: var(--color-teal-400);
      --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
      --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
      --color-border: rgba(var(--color-gray-400-rgb), 0.3);
      --color-btn-primary-text: var(--color-slate-900);
      --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      background-color: var(--color-background);
      color: var(--color-text);
      line-height: 1.5;
      transition: background-color var(--duration-normal), color var(--duration-normal);
    }

    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background-color: var(--color-surface);
      border-right: 1px solid var(--color-border);
      padding: var(--space-24);
      display: flex;
      flex-direction: column;
      gap: var(--space-8);
    }

    .sidebar-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      margin-bottom: var(--space-16);
      color: var(--color-text);
    }

    .sidebar-item {
      padding: var(--space-12) var(--space-16);
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: background-color var(--duration-fast);
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      font-family: var(--font-family-base);
    }

    .sidebar-item:hover {
      background-color: var(--color-secondary);
    }

    .sidebar-item.active {
      background-color: var(--color-primary);
      color: var(--color-btn-primary-text);
      font-weight: 500;
    }

    .sidebar-item:not(.active) {
      opacity: 0.7;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: var(--space-32);
      overflow-y: auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-32);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-16);
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: var(--space-12);
    }

    .month-nav button {
      background: var(--color-secondary);
      border: none;
      border-radius: var(--radius-base);
      padding: var(--space-8) var(--space-12);
      cursor: pointer;
      color: var(--color-text);
      font-size: var(--font-size-base);
      transition: background-color var(--duration-fast);
    }

    .month-nav button:hover {
      background: var(--color-secondary-hover);
    }

    .month-title {
      font-size: var(--font-size-3xl);
      font-weight: 600;
      min-width: 250px;
      text-align: center;
    }

    .header-right {
      display: flex;
      gap: var(--space-12);
    }

    .icon-button {
      background: var(--color-secondary);
      border: none;
      border-radius: var(--radius-base);
      padding: var(--space-8);
      cursor: pointer;
      color: var(--color-text);
      font-size: var(--font-size-lg);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--duration-fast);
    }

    .icon-button:hover {
      background: var(--color-secondary-hover);
    }

    /* Views Container */
    .view-container {
      display: none;
    }

    .view-container.active {
      display: block;
    }

    /* Search Bar */
    .search-container {
      margin-bottom: var(--space-24);
    }

    .search-input {
      width: 100%;
      padding: var(--space-12) var(--space-16);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      background: var(--color-surface);
      color: var(--color-text);
    }

    .search-input:focus {
      outline: 2px solid var(--color-primary);
      border-color: transparent;
    }

    /* Songs Grid */
    .songs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-16);
      margin-bottom: 100px;
    }

    .song-card {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      border-radius: 12px;
      background: var(--color-surface);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--color-card-border);
    }

    .song-card:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-color: var(--color-primary);
    }

    .song-card.playing {
      border-color: var(--color-primary);
      background: var(--color-secondary);
    }

    .song-cover {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--radius-base);
      margin-bottom: var(--space-12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-3xl);
      background: var(--color-background);
    }

    .song-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .song-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      cursor: default;
      max-width: 100%;
    }

    .song-title span {
      display: inline-block;
    }

    /* Animaci칩n de scroll para t칤tulos largos */
    .song-title.long:hover span {
      animation: scrollTextLeft 15s ease-in-out infinite;
    }

    @keyframes scrollTextLeft {
      0%, 15% {
        transform: translateX(0);
      }
      50%, 65% {
        transform: translateX(calc(-100% + 180px));
      }
      100% {
        transform: translateX(0);
      }
    }

    .song-artist {
      font-size: 12px;
      color: var(--color-text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .song-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .favorite-btn {
      position: absolute;
      top: var(--space-8);
      right: var(--space-8);
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: var(--font-size-lg);
      transition: transform var(--duration-fast);
      z-index: 10;
    }

    .favorite-btn:hover {
      transform: scale(1.15);
    }

    /* Mini Player */
    .mini-player {
      position: fixed;
      bottom: 0;
      left: 240px;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: var(--space-16) var(--space-24);
      display: none;
      flex-direction: column;
      gap: var(--space-12);
      z-index: 100;
    }

    /* Bot칩n X para detener reproductor */
    .stop-player-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 28px;
      height: 28px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      color: #666;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
      line-height: 1;
      padding: 0;
    }

    .stop-player-btn:hover {
      background: rgba(255, 0, 0, 0.15);
      color: #f44336;
      transform: scale(1.1);
    }

    .stop-player-btn:active {
      transform: scale(0.95);
    }

    [data-color-scheme="dark"] .stop-player-btn {
      background: rgba(255, 255, 255, 0.1);
      color: #999;
    }

    [data-color-scheme="dark"] .stop-player-btn:hover {
      background: rgba(255, 0, 0, 0.2);
      color: #f44336;
    }

    .mini-player.active {
      display: flex;
    }

    .mini-player-top {
      display: flex;
      align-items: center;
      gap: var(--space-16);
      width: 100%;
    }

    .mini-player-cover {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-base);
      background: var(--color-background);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-2xl);
      flex-shrink: 0;
      object-fit: cover;
      overflow: hidden;
    }

    .mini-player-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .mini-player-info {
      flex: 1;
      min-width: 0;
    }

    .mini-player-title {
      font-weight: 600;
      font-size: var(--font-size-base);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mini-player-artist {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .mini-player-controls {
      display: flex;
      gap: var(--space-8);
      align-items: center;
    }

    .mini-player-btn {
      background: var(--color-secondary);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--duration-fast);
      font-size: var(--font-size-lg);
    }

    .mini-player-btn:hover {
      background: var(--color-secondary-hover);
    }

    .mini-player-btn.play-btn {
      width: 48px;
      height: 48px;
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .mini-player-btn.play-btn:hover {
      background: var(--color-primary-hover);
    }

    .mini-player-time {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      min-width: 100px;
      text-align: center;
    }

    .progress-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--color-secondary);
      border-radius: var(--radius-full);
      cursor: pointer;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--color-primary);
      border-radius: var(--radius-full);
      transition: width 0.1s linear;
      position: relative;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: var(--color-primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity var(--duration-fast);
    }

    .progress-bar:hover .progress-bar-fill::after {
      opacity: 1;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: var(--space-8);
      min-width: 150px;
    }

    .volume-control button {
      background: transparent;
      border: none;
      padding: 0;
      width: auto;
      height: auto;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--color-secondary);
      border-radius: var(--radius-full);
      outline: none;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
    }

    .volume-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    /* Playlists */
    .playlists-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: var(--space-16);
      margin-bottom: var(--space-24);
    }

    .playlist-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .playlist-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
    }

    .playlist-card.create-new {
      border: 2px dashed var(--color-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 150px;
    }

    .playlist-icon {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-12);
    }

    .playlist-name {
      font-weight: 600;
      font-size: var(--font-size-lg);
      margin-bottom: var(--space-8);
    }

    .playlist-stats {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    /* Playlist Detail */
    .playlist-detail {
      display: none;
    }

    .playlist-detail.active {
      display: block;
    }

    .playlist-header {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      margin-bottom: var(--space-24);
      display: flex;
      align-items: center;
      gap: var(--space-20);
    }

    .back-btn {
      background: var(--color-secondary);
      border: none;
      border-radius: var(--radius-base);
      padding: var(--space-8) var(--space-16);
      cursor: pointer;
      font-size: var(--font-size-base);
      color: var(--color-text);
      transition: background var(--duration-fast);
    }

    .back-btn:hover {
      background: var(--color-secondary-hover);
    }

    .songs-list {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .song-item {
      padding: var(--space-16);
      border-bottom: 1px solid var(--color-card-border);
      display: flex;
      align-items: center;
      gap: var(--space-16);
      cursor: pointer;
      transition: background var(--duration-fast);
    }

    .song-item:last-child {
      border-bottom: none;
    }

    .song-item:hover {
      background: var(--color-secondary);
    }

    .song-item.playing {
      background: var(--color-secondary);
      border-left: 3px solid var(--color-primary);
    }

    .song-item-cover {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      background: var(--color-background);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      flex-shrink: 0;
    }

    .song-item-info {
      flex: 1;
      min-width: 0;
    }

    .song-item-title {
      font-weight: 500;
      font-size: var(--font-size-base);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-item-artist {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .song-item-duration {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      flex-shrink: 0;
    }

    .song-item-actions {
      display: flex;
      gap: var(--space-8);
      flex-shrink: 0;
    }

    .action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: var(--font-size-lg);
      padding: var(--space-4);
      transition: transform var(--duration-fast);
    }

    .action-btn:hover {
      transform: scale(1.15);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-32);
      color: var(--color-text-secondary);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: var(--space-16);
    }

    .empty-state-text {
      font-size: var(--font-size-lg);
    }

    /* Calendar */
    .calendar {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      border: 1px solid var(--color-card-border);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--space-8);
    }

    .calendar-header {
      text-align: center;
      font-weight: 600;
      font-size: var(--font-size-sm);
      padding: var(--space-12);
      color: var(--color-text-secondary);
    }

    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: var(--space-8);
      cursor: pointer;
      transition: all var(--duration-fast);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-background);
    }

    .calendar-day:hover {
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .calendar-day.other-month {
      opacity: 0.3;
      cursor: default;
    }

    .calendar-day.other-month:hover {
      transform: none;
      border-color: var(--color-border);
      box-shadow: none;
    }

    .calendar-day.today {
      border-color: var(--color-primary);
      border-width: 2px;
      font-weight: 600;
    }

    .day-number {
      font-size: var(--font-size-base);
      font-weight: 500;
    }

    .day-emotion {
      font-size: var(--font-size-2xl);
      margin-top: var(--space-4);
    }

    .day-indicator {
      position: absolute;
      bottom: 4px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--color-primary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-32);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-24);
    }

    .modal-title {
      font-size: var(--font-size-2xl);
      font-weight: 600;
    }

    .close-button {
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-button:hover {
      color: var(--color-text);
    }

    .form-group {
      margin-bottom: var(--space-24);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-8);
      font-weight: 500;
      font-size: var(--font-size-sm);
    }

    .emotion-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--space-8);
    }

    .emotion-button {
      aspect-ratio: 1;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-base);
      background: var(--color-background);
      font-size: var(--font-size-3xl);
      cursor: pointer;
      transition: all var(--duration-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emotion-button:hover {
      transform: scale(1.1);
      border-color: var(--color-primary);
    }

    .emotion-button.selected {
      border-color: var(--color-primary);
      border-width: 3px;
      background: var(--color-secondary);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-family: var(--font-family-base);
      font-size: var(--font-size-base);
      background: var(--color-background);
      color: var(--color-text);
      resize: vertical;
    }

    textarea:focus {
      outline: 2px solid var(--color-primary);
      border-color: transparent;
    }

    .modal-actions {
      display: flex;
      gap: var(--space-12);
      justify-content: flex-end;
    }

    .btn {
      padding: var(--space-12) var(--space-24);
      border-radius: var(--radius-base);
      border: none;
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background: var(--color-secondary-hover);
    }

    .btn-danger {
      background: var(--color-red-500);
      color: white;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }



    /* Skip Links */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 0;
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      padding: var(--space-12) var(--space-24);
      text-decoration: none;
      z-index: 100000;
      border-radius: 0 0 var(--radius-base) 0;
      font-weight: 600;
      transition: top var(--duration-normal);
    }

    .skip-link:focus {
      top: 0;
      outline: 3px solid var(--color-focus-ring);
      outline-offset: 2px;
    }

    /* Screen Reader Only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Accessibility Settings Panel */
    .accessibility-settings {
      max-width: 600px;
    }

    .setting-group {
      margin-bottom: var(--space-24);
      padding-bottom: var(--space-16);
      border-bottom: 1px solid var(--color-border);
    }

    .setting-group:last-of-type {
      border-bottom: none;
    }

    .setting-label {
      display: flex;
      align-items: center;
      gap: var(--space-12);
      cursor: pointer;
      font-size: var(--font-size-base);
    }

    .setting-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .setting-name {
      font-weight: 600;
      color: var(--color-text);
      font-size: var(--font-size-lg);
    }

    .setting-description {
      margin-top: var(--space-8);
      margin-left: 32px;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    /* Shortcuts List */
    .shortcuts-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .shortcuts-list li {
      padding: var(--space-12);
      margin-bottom: var(--space-8);
      background: var(--color-background);
      border-radius: var(--radius-base);
      display: flex;
      align-items: center;
      font-size: var(--font-size-base);
    }

    .shortcuts-list kbd {
      display: inline-block;
      padding: var(--space-4) var(--space-8);
      background: var(--color-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-family: var(--font-family-mono);
      font-size: var(--font-size-sm);
      font-weight: 600;
      margin-right: var(--space-12);
      min-width: 80px;
      text-align: center;
    }

    /* High Contrast Mode */
    body.high-contrast {
      --color-background: #000;
      --color-surface: #000;
      --color-text: #FFF;
      --color-text-secondary: #FFF;
      --color-primary: #FFFF00;
      --color-primary-hover: #FFFF33;
      --color-secondary: #000;
      --color-secondary-hover: #333;
      --color-border: #FFF;
      --color-card-border: #FFF;
      --color-btn-primary-text: #000;
    }

    body.high-contrast * {
      border-color: #FFF !important;
    }

    body.high-contrast button,
    body.high-contrast .btn {
      background-color: #FFFF00 !important;
      color: #000 !important;
      border: 2px solid #FFF !important;
      font-weight: 700 !important;
    }

    body.high-contrast .sidebar-item.active {
      background-color: #00FFFF !important;
      color: #000 !important;
    }

    body.high-contrast input,
    body.high-contrast select,
    body.high-contrast textarea {
      background-color: #000 !important;
      color: #FFF !important;
      border: 2px solid #FFF !important;
    }

    body.high-contrast .song-card,
    body.high-contrast .playlist-card,
    body.high-contrast .calendar-day {
      border: 2px solid #FFF !important;
    }

    /* Font Size Buttons */
    .font-size-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .font-btn {
      flex: 1;
      min-width: 100px;
      padding: 12px 16px;
      border: 2px solid var(--color-border);
      background: var(--color-background);
      color: var(--color-text);
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: all var(--duration-fast);
      font-weight: 500;
      font-family: var(--font-family-base);
    }

    .font-btn:hover {
      background: var(--color-secondary);
      border-color: var(--color-primary);
    }

    .font-btn.active {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      border-color: var(--color-primary);
      font-weight: 600;
    }

    .font-btn[data-size="small"] { font-size: 12px; }
    .font-btn[data-size="normal"] { font-size: 14px; }
    .font-btn[data-size="large"] { font-size: 16px; }
    .font-btn[data-size="xlarge"] { font-size: 18px; }

    /* Font Size Application - Using CSS Variables */
    :root {
      --base-font-size: 16px;
    }

    body {
      font-size: var(--base-font-size);
    }

    /* Font Size Classes */
    body.font-small {
      --base-font-size: 14px;
    }

    body.font-small h1 { font-size: 1.8rem; }
    body.font-small h2 { font-size: 1.5rem; }
    body.font-small h3 { font-size: 1.3rem; }
    body.font-small p, body.font-small span, body.font-small button, body.font-small .song-title, body.font-small .song-artist { font-size: 0.875rem; }

    body.font-normal {
      --base-font-size: 16px;
    }

    body.font-normal h1 { font-size: 2rem; }
    body.font-normal h2 { font-size: 1.75rem; }
    body.font-normal h3 { font-size: 1.5rem; }
    body.font-normal p, body.font-normal span, body.font-normal button { font-size: 1rem; }

    body.font-large {
      --base-font-size: 20px;
    }

    body.font-large h1 { font-size: 2.5rem; }
    body.font-large h2 { font-size: 2.2rem; }
    body.font-large h3 { font-size: 1.9rem; }
    body.font-large p, body.font-large span, body.font-large button, body.font-large .song-title, body.font-large .song-artist { font-size: 1.25rem; }

    body.font-xlarge {
      --base-font-size: 26px;
    }

    body.font-xlarge h1 { font-size: 3.2rem; }
    body.font-xlarge h2 { font-size: 2.8rem; }
    body.font-xlarge h3 { font-size: 2.4rem; }
    body.font-xlarge p, body.font-xlarge span, body.font-xlarge button, body.font-xlarge .song-title, body.font-xlarge .song-artist { font-size: 1.625rem; }

    /* Contenedor de etiquetas - dise침o compacto */
    .song-tags-section-compact {
      margin-top: 8px;
    }

    .tags-flow {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    /* Chips de etiquetas - dise침o moderno */
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px 4px 6px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: default;
      position: relative;
    }

    .tag-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Tipos de etiquetas */
    .tag-chip-genre {
      background: #E8EAF6;
      color: #3F51B5;
      border: 1px solid #C5CAE9;
    }

    .tag-chip-mood {
      background: #FCE4EC;
      color: #C2185B;
      border: 1px solid #F8BBD0;
    }

    .tag-chip-custom {
      background: #E0F2F1;
      color: #00897B;
      border: 1px solid #B2DFDB;
    }

    /* Icono en etiqueta */
    .tag-icon {
      font-size: 12px;
      line-height: 1;
      opacity: 0.8;
    }

    .tag-text {
      line-height: 1;
    }

    /* Bot칩n cerrar en etiqueta */
    .tag-close {
      background: rgba(0, 0, 0, 0.1);
      border: none;
      color: currentColor;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      line-height: 1;
      padding: 0;
      margin-left: 2px;
      opacity: 0;
      transition: all 0.2s;
    }

    .tag-chip:hover .tag-close {
      opacity: 1;
    }

    .tag-close:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    /* Bot칩n a침adir compacto */
    .tag-add-compact {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1.5px dashed #999;
      background: transparent;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }

    .tag-add-compact:hover {
      background: #F5F5F5;
      border-color: #666;
      border-style: solid;
      transform: rotate(90deg);
    }

    .add-icon {
      font-size: 14px;
      font-weight: bold;
      line-height: 1;
    }

    /* Men칰 contextual r치pido */
    .quick-add-menu {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      overflow: hidden;
      z-index: 99999;
      min-width: 180px;
      animation: menuSlideIn 0.2s ease;
      position: fixed;
    }

    @keyframes menuSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .quick-menu-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 1px solid #F0F0F0;
    }

    .quick-menu-option:last-child {
      border-bottom: none;
    }

    .quick-menu-option:hover {
      background: #F5F5F5;
    }

    .menu-icon {
      font-size: 16px;
      line-height: 1;
    }

    .menu-text {
      font-size: 13px;
      font-weight: 500;
      color: #333;
    }

    /* Modo oscuro */
    body.high-contrast .tag-chip-genre,
    [data-color-scheme="dark"] .tag-chip-genre {
      background: #283593;
      color: #C5CAE9;
      border-color: #3F51B5;
    }

    body.high-contrast .tag-chip-mood,
    [data-color-scheme="dark"] .tag-chip-mood {
      background: #880E4F;
      color: #F8BBD0;
      border-color: #C2185B;
    }

    body.high-contrast .tag-chip-custom,
    [data-color-scheme="dark"] .tag-chip-custom {
      background: #00695C;
      color: #B2DFDB;
      border-color: #00897B;
    }

    body.high-contrast .tag-add-compact,
    [data-color-scheme="dark"] .tag-add-compact {
      border-color: #666;
      color: #999;
    }

    body.high-contrast .tag-add-compact:hover,
    [data-color-scheme="dark"] .tag-add-compact:hover {
      background: #333;
      border-color: #999;
    }

    body.high-contrast .quick-add-menu,
    [data-color-scheme="dark"] .quick-add-menu {
      background: #2a2a2a;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    body.high-contrast .quick-menu-option,
    [data-color-scheme="dark"] .quick-menu-option {
      border-color: #444;
    }

    body.high-contrast .quick-menu-option:hover,
    [data-color-scheme="dark"] .quick-menu-option:hover {
      background: #333;
    }

    body.high-contrast .menu-text,
    [data-color-scheme="dark"] .menu-text {
      color: #ddd;
    }

    /* Responsive - en pantallas peque침as */
    @media (max-width: 768px) {
      .tag-chip {
        font-size: 10px;
        padding: 3px 6px 3px 5px;
      }
      
      .tag-icon {
        font-size: 11px;
      }
      
      .tag-add-compact {
        width: 20px;
        height: 20px;
      }
    }

    /* Modal para a침adir etiquetas */
    .add-tag-modal {
      max-width: 500px;
    }

    .modal-subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .predefined-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .predefined-tag-btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: 2px solid #ddd;
      background: white;
      color: #333;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      font-family: var(--font-family-base);
    }

    .predefined-tag-btn:hover {
      background: #667eea;
      border-color: #667eea;
      color: white;
      transform: translateY(-2px);
    }

    .custom-tag-input {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .custom-tag-input input {
      flex: 1;
    }

    [data-color-scheme="dark"] .predefined-tag-btn {
      background: #2a2a2a;
      border-color: #555;
      color: #ddd;
    }

    [data-color-scheme="dark"] .predefined-tag-btn:hover {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    [data-color-scheme="dark"] .modal-subtitle {
      color: #999;
    }

    /* Filters */
    .library-filters {
      display: flex;
      gap: var(--space-12);
      margin-bottom: var(--space-16);
      flex-wrap: wrap;
    }

    .library-filters select {
      padding: var(--space-8) var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-sm);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      min-width: 150px;
    }

    .library-filters select:focus {
      outline: 2px solid var(--color-primary);
      border-color: transparent;
    }

    .auto-tag-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: var(--font-size-base);
      font-weight: 600;
      border-radius: var(--radius-base);
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
      transition: all 0.3s;
    }

    .auto-tag-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
    }

    .auto-tag-btn:active {
      transform: translateY(0);
    }

    .auto-tag-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .progress-text {
      margin-top: 10px;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    /* Enhanced Focus Indicators */
    *:focus-visible {
      outline: 3px solid var(--color-primary) !important;
      outline-offset: 2px;
      box-shadow: 0 0 0 5px rgba(33, 128, 141, 0.3);
    }

    body.high-contrast *:focus-visible {
      outline: 3px solid #FFFF00 !important;
      outline-offset: 3px;
      box-shadow: 0 0 0 6px rgba(255, 255, 0, 0.5);
    }

    /* Keyboard Navigation Helpers */
    .sidebar-item,
    button,
    a,
    input,
    select,
    textarea {
      cursor: pointer;
    }

    .sidebar-item:focus,
    button:focus,
    a:focus {
      z-index: 10;
    }

    /* Accessibility Mode */
    [data-accessibility="true"] {
      font-size: 16px;
    }

    [data-accessibility="true"] .calendar-day {
      border-width: 2px;
    }

    [data-accessibility="true"] .day-emotion {
      font-size: 28px;
    }

    /* Equalizer Modal */
    .eq-modal {
      max-width: 800px;
    }

    .eq-controls {
      margin-bottom: var(--space-24);
    }

    .eq-presets {
      display: flex;
      gap: var(--space-8);
      margin-bottom: var(--space-16);
      flex-wrap: wrap;
    }

    .eq-preset-btn {
      padding: var(--space-8) var(--space-16);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-sm);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .eq-preset-btn:hover {
      background: var(--color-secondary);
      border-color: var(--color-primary);
    }

    .eq-preset-btn.active {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      border-color: var(--color-primary);
    }

    .eq-sliders {
      display: flex;
      justify-content: space-between;
      gap: var(--space-12);
      margin-bottom: var(--space-24);
      padding: var(--space-16);
      background: var(--color-background);
      border-radius: var(--radius-base);
    }

    .eq-band {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-8);
    }

    .eq-slider-container {
      height: 180px;
      display: flex;
      align-items: center;
      position: relative;
    }

    .eq-slider {
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      width: 6px;
      height: 180px;
      background: var(--color-secondary);
      border-radius: var(--radius-full);
      outline: none;
      cursor: pointer;
    }

    .eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
    }

    .eq-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .eq-value {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      min-width: 35px;
      text-align: center;
    }

    .eq-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    .eq-actions {
      display: flex;
      gap: var(--space-12);
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .eq-actions-left,
    .eq-actions-right {
      display: flex;
      gap: var(--space-12);
    }

    .folder-select-btn {
      margin-bottom: var(--space-16);
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .song-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius-base);
    }

    .song-item-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .empty-library-message {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-secondary);
    }

    .empty-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-library-message h3 {
      font-size: var(--font-size-3xl);
      margin-bottom: 15px;
      color: var(--color-text);
      font-weight: 600;
    }

    .empty-library-message p {
      font-size: var(--font-size-lg);
      line-height: 1.6;
      max-width: 500px;
      margin: 0 auto;
    }

    .load-music-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: var(--font-size-lg);
      font-weight: bold;
      border-radius: var(--radius-lg);
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }

    .load-music-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .load-music-btn:active {
      transform: translateY(0);
    }

    .load-music-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .youtube-btn {
      background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
    }

    .youtube-btn:hover {
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
    }

    /* Song type badge */
    .song-type-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 2;
    }

    [data-color-scheme="dark"] .song-type-badge {
      background: rgba(50, 50, 50, 0.95);
    }

    .youtube-add-modal {
      max-width: 600px;
    }

    .text-input {
      width: 100%;
      padding: var(--space-12) var(--space-16);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      background: var(--color-background);
      color: var(--color-text);
      font-family: var(--font-family-base);
    }

    .text-input:focus {
      outline: 2px solid var(--color-primary);
      border-color: transparent;
    }

    .input-hint {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-4);
    }

    .loading-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--color-surface);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 10000;
      min-width: 300px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--color-secondary);
      border-top: 5px solid var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-indicator p {
      font-size: var(--font-size-lg);
      color: var(--color-text);
      margin: 0;
    }

    #progress-count {
      font-weight: bold;
      color: var(--color-primary);
    }



    /* YouTube Player Container - Oculto por defecto */
    #youtube-player-container {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 480px;
      height: 270px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 1000;
      background: #000;
      transition: all 0.3s ease;
    }

    /* Estado oculto (funciona pero no se ve) */
    #youtube-player-container.youtube-hidden {
      width: 1px;
      height: 1px;
      bottom: -100px;
      right: -100px;
      opacity: 0;
      pointer-events: none;
    }

    /* Estado visible */
    #youtube-player-container.youtube-visible {
      opacity: 1;
      pointer-events: auto;
    }

    #youtube-player-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Bot칩n toggle para mostrar/ocultar video */
    #youtube-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
      z-index: 1001;
      transition: all 0.3s;
    }

    #youtube-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
    }

    #youtube-toggle-btn:active {
      transform: scale(0.95);
    }

    /* Icono cambia seg칰n estado */
    #youtube-toggle-btn::before {
      content: '游닠';
    }

    #youtube-toggle-btn.video-visible::before {
      content: '游뗻';
    }

    /* Tooltip */
    #youtube-toggle-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      white-space: nowrap;
      font-size: 12px;
      margin-bottom: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    #youtube-toggle-btn:hover::after {
      opacity: 1;
    }

    [data-color-scheme="dark"] #youtube-player-container {
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }

    .youtube-toggle-container {
      margin-top: var(--space-16);
      padding: var(--space-12);
      background: var(--color-background);
      border-radius: var(--radius-base);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }

      .main-content {
        padding: var(--space-16);
      }

      .month-title {
        font-size: var(--font-size-xl);
        min-width: 180px;
      }

      .calendar {
        padding: var(--space-16);
      }
    }
  </style>
</head>
<body>
  <!-- Skip Links -->
  <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
  <a href="#player-controls" class="skip-link">Saltar a controles del reproductor</a>
  
  <!-- ARIA Live Region for announcements -->
  <div id="aria-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
  <div class="app-container" id="main-content">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h1 class="sidebar-title">游꿧 Mi M칰sica</h1>
      <button class="sidebar-item" data-view="biblioteca" onclick="switchView('biblioteca')" aria-label="Ir a Biblioteca" tabindex="0">游닄 Biblioteca</button>
      <button class="sidebar-item" data-view="playlists" onclick="switchView('playlists')" aria-label="Ir a Playlists" tabindex="0">游꿚 Playlists</button>
      <button class="sidebar-item" data-view="favoritos" onclick="switchView('favoritos')" aria-label="Ir a Favoritos" tabindex="0">救 Favoritos</button>
      <button class="sidebar-item active" data-view="calendario" onclick="switchView('calendario')" aria-label="Ir a Calendario" aria-current="page" tabindex="0">游늰 Calendario</button>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <div class="month-nav">
            <button onclick="previousMonth()" aria-label="Mes anterior">&lt;</button>
            <h2 class="month-title" id="monthTitle"></h2>
            <button onclick="nextMonth()" aria-label="Mes siguiente">&gt;</button>
          </div>
        </div>
        <div class="header-right">
          <button class="icon-button" onclick="toggleTheme()" aria-label="Cambiar tema" title="Cambiar tema" tabindex="0">游깹</button>
          <button class="icon-button" onclick="openAccessibilityPanel()" aria-label="Configuraci칩n de accesibilidad" title="Accesibilidad" tabindex="0">鮫</button>
        </div>
      </header>

      <!-- Biblioteca View -->
      <div class="view-container" id="bibliotecaView">
        <div class="folder-select-btn" style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-primary load-music-btn" id="load-folder-btn" onclick="selectMusicFolder()">游늬 Seleccionar Carpeta de M칰sica</button>
          <button class="btn btn-primary youtube-btn" id="add-youtube-btn" onclick="openYouTubeModal()">游깷 A침adir desde YouTube</button>
          <input type="file" id="folderInput" webkitdirectory directory multiple accept="audio/*" style="display: none;" onchange="loadMusicFromFolder(event)">
        </div>
        <div class="library-filters">
          <select id="genre-filter" onchange="filterLibrary()">
            <option value="">Todos los g칠neros</option>
          </select>
          <select id="mood-filter" onchange="filterLibrary()">
            <option value="">Todos los estados</option>
          </select>
        </div>
        <div class="search-container">
          <input type="text" class="search-input" id="searchInput" placeholder="游댌 Buscar por t칤tulo o artista..." oninput="searchSongs()">
        </div>
        <div class="songs-grid" id="songsGrid"></div>
      </div>

      <!-- Playlists View -->
      <div class="view-container" id="playlistsView">
        <div class="playlists-list" id="playlistsList">
          <div class="playlists-grid" id="playlistsGrid"></div>
        </div>
        <div class="playlist-detail" id="playlistDetail"></div>
      </div>

      <!-- Favoritos View -->
      <div class="view-container" id="favoritosView">
        <div class="songs-grid" id="favoritesGrid"></div>
      </div>

      <!-- Calendario View -->
      <div class="view-container active" id="calendarioView">
      <div class="calendar">
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar days will be inserted here -->
        </div>
      </div>
      </div>
    </main>
  </div>

  <!-- Audio Element -->
  <audio id="main-audio-player" preload="metadata"></audio>

  <!-- Mini Player -->
  <div class="mini-player" id="miniPlayer" role="region" aria-label="Reproductor de m칰sica" id="player-controls">
    <button id="stop-player-btn" class="stop-player-btn" title="Detener reproducci칩n" onclick="stopPlayback()">九</button>
    <div class="mini-player-top">
      <div class="mini-player-cover" id="miniPlayerCover">游꿧</div>
      <div class="mini-player-info">
        <div class="mini-player-title" id="miniPlayerTitle">T칤tulo</div>
        <div class="mini-player-artist" id="miniPlayerArtist">Artista</div>
      </div>
      <div class="mini-player-controls">
        <button class="mini-player-btn" onclick="previousSong()" aria-label="Canci칩n anterior" tabindex="0">낉勇</button>
        <button class="mini-player-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()" aria-label="Reproducir" aria-pressed="false" tabindex="0">郊윒잺</button>
        <button class="mini-player-btn" onclick="nextSong()" aria-label="Siguiente canci칩n" tabindex="0">낈勇</button>
        <button class="mini-player-btn" onclick="toggleShuffle()" id="shuffleBtn" aria-label="Modo aleatorio" aria-pressed="false" tabindex="0">游</button>
        <button class="mini-player-btn" onclick="toggleRepeat()" id="repeatBtn" aria-label="Modo repetir" aria-pressed="false" tabindex="0">游대</button>
      </div>
      <div class="volume-control">
        <button class="mini-player-btn" onclick="toggleMute()" id="volumeIcon" aria-label="Silenciar" tabindex="0">游댉</button>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" oninput="changeVolume(this.value)" aria-label="Control de volumen" aria-valuemin="0" aria-valuemax="100" aria-valuenow="70" aria-valuetext="70%" tabindex="0">
      </div>
      <button class="mini-player-btn" onclick="openEqualizer()" aria-label="Abrir ecualizador" title="Ecualizador" tabindex="0">游꿐勇</button>
    </div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" onclick="seekTo(event)" role="progressbar" aria-label="Progreso de reproducci칩n" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0:00 de 0:00" tabindex="0">
        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
    </div>
  </div>



  <!-- Modal for Create Playlist -->
  <div class="modal" id="createPlaylistModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Nueva Playlist</h3>
        <button class="close-button" onclick="closeCreatePlaylistModal()" aria-label="Cerrar">&times;</button>
      </div>

      <form id="playlistForm" onsubmit="savePlaylist(event)">
        <div class="form-group">
          <label class="form-label" for="playlistName">Nombre de la playlist:</label>
          <input type="text" id="playlistName" class="search-input" placeholder="Ej: Mi m칰sica favorita" required style="margin-bottom: 0;">
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCreatePlaylistModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Add to Playlist -->
  <div class="modal" id="addToPlaylistModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">A침adir a Playlist</h3>
        <button class="close-button" onclick="closeAddToPlaylistModal()" aria-label="Cerrar">&times;</button>
      </div>

      <div id="playlistSelectionList" style="max-height: 300px; overflow-y: auto;"></div>

      <div class="modal-actions" style="margin-top: var(--space-16);">
        <button type="button" class="btn btn-secondary" onclick="closeAddToPlaylistModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Coming Soon -->
  <div class="modal" id="comingSoonModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="comingSoonTitle">Pr칩ximamente</h3>
        <button class="close-button" onclick="closeComingSoonModal()" aria-label="Cerrar">&times;</button>
      </div>

      <div style="padding: var(--space-16) 0;">
        <p style="font-size: var(--font-size-lg); margin-bottom: var(--space-16); color: var(--color-text);">
          La funci칩n <strong id="featureName"></strong> estar치 disponible pr칩ximamente.
        </p>
        <p style="font-size: var(--font-size-base); color: var(--color-text-secondary);">
          Estamos trabajando para traerte esta incre칤ble caracter칤stica. 춰Mantente atento a las actualizaciones!
        </p>
        <p style="font-size: var(--font-size-base); margin-top: var(--space-16); color: var(--color-text-secondary);">
          游눠 쯊ienes sugerencias? Nos encantar칤a escuchar tus ideas para mejorar esta funci칩n.
        </p>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-primary" onclick="closeComingSoonModal()">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Equalizer Modal -->
  <div class="modal" id="equalizerModal">
    <div class="modal-content eq-modal">
      <div class="modal-header">
        <h3 class="modal-title">Ecualizador 游꿐勇</h3>
        <button class="close-button" onclick="closeEqualizer()" aria-label="Cerrar">&times;</button>
      </div>

      <div class="eq-controls">
        <div class="form-label" style="margin-bottom: var(--space-12);">Presets:</div>
        <div class="eq-presets">
          <button class="eq-preset-btn" onclick="applyEQPreset('flat')">Flat</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('bass')">Bass Boost</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('treble')">Treble Boost</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('pop')">Pop</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('rock')">Rock</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('jazz')">Jazz</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('classical')">Classical</button>
          <button class="eq-preset-btn" onclick="applyEQPreset('vocal')">Vocal</button>
        </div>
      </div>

      <div class="eq-sliders">
        <div class="eq-band">
          <div class="eq-value" id="eqValue0">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider0" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(0, this.value)">
          </div>
          <div class="eq-label">32 Hz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue1">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider1" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(1, this.value)">
          </div>
          <div class="eq-label">64 Hz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue2">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider2" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(2, this.value)">
          </div>
          <div class="eq-label">125 Hz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue3">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider3" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(3, this.value)">
          </div>
          <div class="eq-label">250 Hz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue4">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider4" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(4, this.value)">
          </div>
          <div class="eq-label">500 Hz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue5">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider5" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(5, this.value)">
          </div>
          <div class="eq-label">1 kHz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue6">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider6" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(6, this.value)">
          </div>
          <div class="eq-label">2 kHz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue7">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider7" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(7, this.value)">
          </div>
          <div class="eq-label">4 kHz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue8">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider8" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(8, this.value)">
          </div>
          <div class="eq-label">8 kHz</div>
        </div>
        <div class="eq-band">
          <div class="eq-value" id="eqValue9">0 dB</div>
          <div class="eq-slider-container">
            <input type="range" class="eq-slider" id="eqSlider9" min="-12" max="12" value="0" step="0.5" orient="vertical" oninput="updateEQBand(9, this.value)">
          </div>
          <div class="eq-label">16 kHz</div>
        </div>
      </div>

      <div class="eq-actions">
        <div class="eq-actions-left">
          <button type="button" class="btn btn-secondary" onclick="resetEQ()">Restablecer</button>
        </div>
        <div class="eq-actions-right">
          <button type="button" class="btn btn-secondary" onclick="saveEQForSong()">Guardar para esta canci칩n</button>
          <button type="button" class="btn btn-primary" onclick="saveGlobalEQ()">Guardar Global</button>
        </div>
      </div>
    </div>
  </div>



  <!-- Accessibility Panel Modal -->
  <div class="modal" id="accessibilityPanel" role="dialog" aria-labelledby="accessibility-title" aria-modal="true">
    <div class="modal-content accessibility-settings">
      <div class="modal-header">
        <h3 class="modal-title" id="accessibility-title">丘뙖잺 Configuraci칩n de Accesibilidad</h3>
        <button class="close-button" onclick="closeAccessibilityPanel()" aria-label="Cerrar" tabindex="0">&times;</button>
      </div>
      
      <!-- High Contrast Mode -->
      <div class="setting-group">
        <label class="setting-label">
          <input type="checkbox" id="high-contrast-toggle" tabindex="0" />
          <span class="setting-name">游꿛 Modo de alto contraste</span>
        </label>
        <p class="setting-description">Colores negro, blanco y amarillo para mejor visibilidad</p>
      </div>
      
      <!-- Font Size -->
      <div class="setting-group">
        <label class="setting-label">
          <span class="setting-name">游늺 Tama침o de texto</span>
        </label>
        <p class="setting-description">Cambia el tama침o de todo el texto en la aplicaci칩n</p>
        <div class="font-size-buttons">
          <button class="font-btn" data-size="small">Peque침o (A)</button>
          <button class="font-btn active" data-size="normal">Normal (A)</button>
          <button class="font-btn" data-size="large">Grande (A)</button>
          <button class="font-btn" data-size="xlarge">Muy Grande (A)</button>
        </div>
      </div>
      
      <!-- Keyboard Shortcuts -->
      <div class="setting-group">
        <label class="setting-label">
          <input type="checkbox" id="keyboard-shortcuts-toggle" checked tabindex="0" />
          <span class="setting-name">꺋勇 Atajos de teclado</span>
        </label>
        <p class="setting-description">Controla la app con el teclado (Espacio=Play, Flechas=Navegar)</p>
      </div>
      
      <!-- Voice Announcements -->
      <div class="setting-group">
        <label class="setting-label">
          <input type="checkbox" id="voice-announcements-toggle" tabindex="0" />
          <span class="setting-name">游댉 Anuncios de voz</span>
        </label>
        <p class="setting-description">Lee en voz alta los cambios (reproducci칩n, cambios de secci칩n, etc)</p>
      </div>
      
      <!-- YouTube Player Visibility -->
      <div class="setting-group">
        <label class="setting-label">
          <input type="checkbox" id="show-youtube-player-toggle" tabindex="0" checked />
          <span class="setting-name">游깷 Mostrar reproductor de YouTube</span>
        </label>
        <p class="setting-description">El reproductor de YouTube aparece en la esquina inferior derecha. Desactiva esta opci칩n si prefieres solo escuchar el audio sin ver el video.</p>
      </div>
      
      <!-- Shortcuts Guide Button -->
      <button id="show-shortcuts-guide" class="btn btn-secondary" onclick="showShortcutsGuide()" style="width: 100%; margin-top: var(--space-16);" tabindex="0">
        游닀 Ver gu칤a de atajos de teclado
      </button>
      
      <div class="modal-actions">
        <button id="close-accessibility-panel" class="btn btn-primary" onclick="closeAccessibilityPanel()" tabindex="0">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts Guide Modal -->
  <div class="modal" id="shortcutsModal" role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="shortcuts-title">꺋勇 Atajos de Teclado</h3>
        <button class="close-button" onclick="closeShortcutsGuide()" aria-label="Cerrar" tabindex="0">&times;</button>
      </div>
      <div style="padding: var(--space-16) 0;">
        <ul class="shortcuts-list">
          <li><kbd>Espacio</kbd> - Play/Pausa</li>
          <li><kbd></kbd> (Flecha derecha) - Siguiente canci칩n</li>
          <li><kbd></kbd> (Flecha izquierda) - Canci칩n anterior</li>
          <li><kbd></kbd> (Flecha arriba) - Subir volumen</li>
          <li><kbd></kbd> (Flecha abajo) - Bajar volumen</li>
          <li><kbd>M</kbd> - Silenciar/Activar sonido</li>
          <li><kbd>F</kbd> - Marcar canci칩n actual como favorita</li>
          <li><kbd>L</kbd> - Ir a Biblioteca</li>
          <li><kbd>P</kbd> - Ir a Playlists</li>
          <li><kbd>C</kbd> - Ir a Calendario</li>
          <li><kbd>A</kbd> - Abrir configuraci칩n de accesibilidad</li>
          <li><kbd>?</kbd> - Mostrar esta gu칤a</li>
          <li><kbd>Esc</kbd> - Cerrar modal activo</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeShortcutsGuide()" tabindex="0">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- YouTube Add Modal -->
  <div class="modal" id="youtubeModal">
    <div class="modal-content youtube-add-modal">
      <div class="modal-header">
        <h3 class="modal-title">游깷 A침adir canci칩n desde YouTube</h3>
        <button class="close-button" onclick="closeYouTubeModal()" aria-label="Cerrar">&times;</button>
      </div>

      <form id="youtubeForm" onsubmit="saveYouTubeSong(event)">
        <div class="form-group">
          <label class="form-label" for="youtube-url-input">URL de YouTube:</label>
          <input type="text" id="youtube-url-input" class="text-input" placeholder="https://www.youtube.com/watch?v=..." required>
          <p class="input-hint">Pega el enlace del video</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="song-title-input">T칤tulo (opcional):</label>
          <input type="text" id="song-title-input" class="text-input" placeholder="Se obtendr치 autom치ticamente si lo dejas vac칤o">
          <p class="input-hint">Deja vac칤o para usar el t칤tulo del video</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="song-artist-input">Artista (opcional):</label>
          <input type="text" id="song-artist-input" class="text-input" placeholder="Se obtendr치 autom치ticamente si lo dejas vac칤o">
          <p class="input-hint">Deja vac칤o para usar el nombre del canal</p>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeYouTubeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Add Genre -->
  <div class="modal" id="add-genre-modal">
    <div class="modal-content add-tag-modal">
      <div class="modal-header">
        <h3 class="modal-title">A침adir G칠nero</h3>
        <button class="close-button" onclick="closeGenreModal()" aria-label="Cerrar">&times;</button>
      </div>
      
      <p class="modal-subtitle">Selecciona un g칠nero o crea uno nuevo</p>
      
      <div class="predefined-tags" id="genre-predefined-tags">
        <!-- Se llenar치 din치micamente -->
      </div>
      
      <div class="custom-tag-input">
        <input type="text" id="custom-genre-input" class="text-input" placeholder="O escribe un g칠nero nuevo...">
        <button id="add-custom-genre-btn" class="btn btn-primary">A침adir</button>
      </div>
      
      <div class="modal-actions">
        <button id="cancel-genre-modal" class="btn btn-secondary" onclick="closeGenreModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Add Mood -->
  <div class="modal" id="add-mood-modal">
    <div class="modal-content add-tag-modal">
      <div class="modal-header">
        <h3 class="modal-title">A침adir Emoci칩n</h3>
        <button class="close-button" onclick="closeMoodModal()" aria-label="Cerrar">&times;</button>
      </div>
      
      <p class="modal-subtitle">Selecciona una emoci칩n o crea una nueva</p>
      
      <div class="predefined-tags" id="mood-predefined-tags">
        <!-- Se llenar치 din치micamente -->
      </div>
      
      <div class="custom-tag-input">
        <input type="text" id="custom-mood-input" class="text-input" placeholder="O escribe una emoci칩n nueva...">
        <button id="add-custom-mood-btn" class="btn btn-primary">A침adir</button>
      </div>
      
      <div class="modal-actions">
        <button id="cancel-mood-modal" class="btn btn-secondary" onclick="closeMoodModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Add Custom Tag -->
  <div class="modal" id="add-custom-tag-modal">
    <div class="modal-content add-tag-modal">
      <div class="modal-header">
        <h3 class="modal-title">A침adir Etiqueta Personalizada</h3>
        <button class="close-button" onclick="closeCustomTagModal()" aria-label="Cerrar">&times;</button>
      </div>
      
      <p class="modal-subtitle">Crea tu propia etiqueta</p>
      
      <div class="custom-tag-input">
        <input type="text" id="custom-tag-input" class="text-input" placeholder="Nombre de la etiqueta...">
        <button id="add-custom-tag-btn" class="btn btn-primary">A침adir</button>
      </div>
      
      <div class="modal-actions">
        <button id="cancel-custom-tag-modal" class="btn btn-secondary" onclick="closeCustomTagModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Diary Entry -->
  <div class="modal" id="diaryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Entrada de Diario</h3>
        <button class="close-button" onclick="closeModal()" aria-label="Cerrar">&times;</button>
      </div>

      <form id="diaryForm" onsubmit="saveDiary(event)">
        <div class="form-group">
          <label class="form-label">쮺칩mo te sientes hoy?</label>
          <div class="emotion-selector">
            <button type="button" class="emotion-button" data-emotion="feliz" onclick="selectEmotion('feliz', '游땕')">游땕</button>
            <button type="button" class="emotion-button" data-emotion="triste" onclick="selectEmotion('triste', '游땩')">游땩</button>
            <button type="button" class="emotion-button" data-emotion="enojado" onclick="selectEmotion('enojado', '游')">游</button>
            <button type="button" class="emotion-button" data-emotion="emocionado" onclick="selectEmotion('emocionado', '游뱔')">游뱔</button>
            <button type="button" class="emotion-button" data-emotion="relajado" onclick="selectEmotion('relajado', '游땗')">游땗</button>
            <button type="button" class="emotion-button" data-emotion="energ칠tico" onclick="selectEmotion('energ칠tico', '丘')">丘</button>
            <button type="button" class="emotion-button" data-emotion="nost치lgico" onclick="selectEmotion('nost치lgico', '游')">游</button>
            <button type="button" class="emotion-button" data-emotion="inspirado" onclick="selectEmotion('inspirado', '九')">九</button>
            <button type="button" class="emotion-button" data-emotion="melanc칩lico" onclick="selectEmotion('melanc칩lico', '游꺊勇')">游꺊勇</button>
            <button type="button" class="emotion-button" data-emotion="festivo" onclick="selectEmotion('festivo', '游꿀')">游꿀</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="diaryText">Escribe tu diario musical:</label>
          <textarea id="diaryText" placeholder="Describe tu d칤a, las canciones que escuchaste, c칩mo te hicieron sentir..." required></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-danger" onclick="deleteDiary()" id="deleteBtn" style="display: none;">Eliminar</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Music Genres and Moods for Auto-Tagging
    const MUSIC_GENRES = [
      'Rock', 'Pop', 'Jazz', 'Blues', 'Classical', 'Electronic',
      'Hip Hop', 'R&B', 'Country', 'Reggae', 'Metal', 'Indie',
      'Folk', 'Soul', 'Funk', 'Punk', 'Alternative', 'Latin',
      'Reggaeton', 'Salsa', 'Flamenco', 'Trap', 'Techno', 'House'
    ];

    const MUSIC_MOODS = [
      'Feliz', 'Triste', 'En칠rgico', 'Relajado', 'Rom치ntico',
      'Motivador', 'Melanc칩lico', 'Nost치lgico', 'Euf칩rico',
      'Tranquilo', 'Agresivo', 'Inspirador', 'Dram치tico', 'Festivo'
    ];

    // Application state (stored in memory, not localStorage)
    let currentView = 'calendario';
    let currentDate = new Date(2025, 9, 29); // October 29, 2025
    let currentEditingDate = null;
    let currentSelectedEmotion = null;
    let currentSelectedEmoji = null;
    let settings = {
      theme: 'dark',
      accessibility: false
    };

    // Accessibility state
    let accessibilityState = {
      highContrast: false,
      fontSize: 'normal',
      keyboardShortcuts: true,
      voiceAnnouncements: false
    };

    let isMuted = false;
    let volumeBeforeMute = 0.7;

    // Web Audio API
    let audioContext = null;
    let audioElement = null;
    let audioSource = null;
    let eqFilters = [];
    let analyser = null;
    let gainNode = null;



    // EQ frequencies (10 bands)
    const eqFrequencies = [32, 64, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
    
    // EQ state
    let currentEQSettings = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    let globalEQSettings = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

    // EQ presets
    const eqPresets = {
      flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      bass: [8, 6, 4, 2, 0, 0, 0, 0, 0, 0],
      treble: [0, 0, 0, 0, 0, 0, 2, 4, 6, 8],
      pop: [2, 3, 4, 2, 0, -1, -2, -1, 2, 3],
      rock: [5, 3, -2, -3, -1, 1, 3, 4, 5, 5],
      jazz: [4, 3, 1, 2, -1, -1, 0, 1, 3, 4],
      classical: [5, 4, 3, 2, -1, -1, 0, 2, 3, 4],
      vocal: [-2, -3, -2, 1, 3, 4, 4, 3, 1, 0]
    };

    // Music library - starts empty
    let songsLibrary = [];
    
    // Load YouTube songs from memory on init (in a real app, this would be localStorage)
    let youtubeSongsCache = [];

    let playlists = [
      { id: 1, name: "Rock Cl치sico", songs: [1, 3, 5, 6, 7], createdAt: "2025-10-15" },
      { id: 2, name: "Favoritas del Momento", songs: [1, 8, 5], createdAt: "2025-10-20" },
      { id: 3, name: "Relax", songs: [4, 10], createdAt: "2025-10-25" }
    ];

    // Player state
    let currentSong = null;
    let isPlaying = false;
    let currentTime = 0;
    let currentPlaylist = [];
    let currentPlaylistIndex = 0;
    let playbackInterval = null;
    let currentPlaylistView = null;
    let currentSongForPlaylist = null;
    let shuffleMode = false;
    let repeatMode = 'none'; // 'none', 'all', 'one'
    let volume = 0.7;
    let nextSongId = 1000;

    // Diary entries
    let diaryEntries = {
      '2025-10-29': {
        mood: 'feliz',
        emoji: '游땕',
        diario: 'Hoy fue un gran d칤a de m칰sica y descubrimientos.'
      },
      '2025-10-28': {
        mood: 'triste',
        emoji: '游땩',
        diario: 'No encontr칠 la canci칩n que quer칤a, estuve algo desanimado.'
      }
    };

    // Emotion to emoji mapping
    const emotionEmojis = {
      'feliz': '游땕',
      'triste': '游땩',
      'enojado': '游',
      'emocionado': '游뱔',
      'relajado': '游땗',
      'energ칠tico': '丘',
      'nost치lgico': '游',
      'inspirado': '九',
      'melanc칩lico': '游꺊勇',
      'festivo': '游꿀'
    };

    // Initialize app
    function init() {
      applyTheme();
      applyAccessibility();
      renderCalendar();
      switchView('calendario');
      initAudioContext();
      initAccessibilityHandlers();
    }

    // Initialize accessibility event handlers
    function initAccessibilityHandlers() {
      // Initialize font size buttons
      initFontSizeButtons();
      
      // High contrast toggle
      const highContrastToggle = document.getElementById('high-contrast-toggle');
      if (highContrastToggle) {
        highContrastToggle.addEventListener('change', (e) => {
          toggleHighContrast(e.target.checked);
        });
      }
      
      // Keyboard shortcuts toggle
      const keyboardToggle = document.getElementById('keyboard-shortcuts-toggle');
      if (keyboardToggle) {
        keyboardToggle.addEventListener('change', (e) => {
          accessibilityState.keyboardShortcuts = e.target.checked;
          announce(e.target.checked ? 'Atajos de teclado activados' : 'Atajos de teclado desactivados');
        });
      }
      
      // Voice announcements toggle
      const voiceToggle = document.getElementById('voice-announcements-toggle');
      if (voiceToggle) {
        voiceToggle.addEventListener('change', (e) => {
          accessibilityState.voiceAnnouncements = e.target.checked;
          if (e.target.checked) {
            announce('Anuncios de voz activados');
          }
        });
      }
      
      // Crear bot칩n toggle para mostrar/ocultar video
      const toggleBtn = document.createElement('button');
      toggleBtn.id = 'youtube-toggle-btn';
      toggleBtn.setAttribute('data-tooltip', 'Mostrar video');
      toggleBtn.title = 'Mostrar/Ocultar video de YouTube';
      toggleBtn.style.display = 'none';
      document.body.appendChild(toggleBtn);
      
      // Estado del video
      let videoVisible = false;
      
      toggleBtn.addEventListener('click', () => {
        const container = document.getElementById('youtube-player-container');
        
        if (!container) return;
        
        videoVisible = !videoVisible;
        
        if (videoVisible) {
          // Mostrar video
          container.classList.remove('youtube-hidden');
          container.classList.add('youtube-visible');
          toggleBtn.classList.add('video-visible');
          toggleBtn.setAttribute('data-tooltip', 'Ocultar video');
          announce('Video de YouTube visible');
          console.log('游닠 Video YouTube mostrado');
        } else {
          // Ocultar video
          container.classList.remove('youtube-visible');
          container.classList.add('youtube-hidden');
          toggleBtn.classList.remove('video-visible');
          toggleBtn.setAttribute('data-tooltip', 'Mostrar video');
          announce('Video de YouTube oculto (audio contin칰a)');
          console.log('游뗻 Video YouTube oculto');
        }
      });
      
      console.log('九 Panel de accesibilidad inicializado');
    }

    // Initialize Web Audio API
    function initAudioContext() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioElement = document.getElementById('main-audio-player');
      if (!audioElement) {
        console.error('仇 Audio element not found');
        return;
      }
      audioElement.crossOrigin = 'anonymous';
      
      // Create audio source
      audioSource = audioContext.createMediaElementSource(audioElement);
      
      // Create gain node for volume
      gainNode = audioContext.createGain();
      gainNode.gain.value = volume;
      
      // Create 10 EQ filters
      eqFrequencies.forEach((freq, index) => {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = freq;
        filter.Q.value = 1;
        filter.gain.value = 0;
        eqFilters.push(filter);
      });
      
      // Create analyser
      analyser = audioContext.createAnalyser();
      
      // Connect audio graph: source -> filters -> gain -> analyser -> destination
      let previousNode = audioSource;
      eqFilters.forEach(filter => {
        previousNode.connect(filter);
        previousNode = filter;
      });
      previousNode.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioContext.destination);
      
      // Audio element events
      audioElement.addEventListener('ended', onSongEnded);
      audioElement.addEventListener('timeupdate', onTimeUpdate);
      audioElement.addEventListener('loadedmetadata', onMetadataLoaded);
      
      audioElement.addEventListener('error', (e) => {
        console.error('仇 Error de audio:', e);
        const error = audioElement.error;
        if (error) {
          console.error('C칩digo de error:', error.code);
          console.error('Mensaje:', error.message);
        }
        alert('Error al cargar el archivo de audio. Formato no soportado o archivo corrupto.');
      });
      
      audioElement.addEventListener('loadeddata', () => {
        console.log('九 Audio cargado y listo');
      });
      
      audioElement.addEventListener('playing', () => {
        console.log('郊윒잺 Audio reproduciendo');
      });
      
      audioElement.addEventListener('pause', () => {
        console.log('낒勇 Audio pausado');
      });

    }

    // View management
    function switchView(view) {
      currentView = view;
      
      // Update sidebar with ARIA attributes
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        item.removeAttribute('aria-current');
        if (item.getAttribute('data-view') === view) {
          item.classList.add('active');
          item.setAttribute('aria-current', 'page');
        }
      });
      
      // Hide all views
      document.querySelectorAll('.view-container').forEach(v => {
        v.classList.remove('active');
      });
      
      // Show current view
      const viewElement = document.getElementById(`${view}View`);
      if (viewElement) {
        viewElement.classList.add('active');
      }
      
      // Update header title
      const monthTitle = document.getElementById('monthTitle');
      const monthNav = document.querySelector('.month-nav');
      
      if (view === 'calendario') {
        monthNav.style.display = 'flex';
        renderCalendar();
      } else {
        monthNav.style.display = 'none';
        const titles = {
          'biblioteca': '游닄 Biblioteca Musical',
          'playlists': '游꿚 Mis Playlists',
          'favoritos': '救 Canciones Favoritas'
        };
        monthTitle.textContent = titles[view] || '';
      }
      
      // Render view content
      if (view === 'biblioteca') {
        renderBiblioteca();
      } else if (view === 'playlists') {
        renderPlaylists();
      } else if (view === 'favoritos') {
        renderFavoritos();
      }
    }

    // Generate procedural cover color
    function getSongCover(song) {
      if (song.cover && (song.cover.startsWith('data:') || song.cover.startsWith('http'))) {
        return `<img src="${song.cover}" alt="${song.title}">`;
      }
      const emojis = ['游꿪', '游꿗', '游꿫', '游볘', '游꿬', '游꿭', '游꿚', '游꿮', '游꿧', '游꿨', '游', '游닡'];
      return emojis[song.id % emojis.length];
    }
    
    // Fetch YouTube video info using oEmbed API
    async function fetchYouTubeTitle(videoId) {
      try {
        // API oEmbed de YouTube (p칰blica, sin autenticaci칩n)
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        
        if (!response.ok) {
          throw new Error('No se pudo obtener informaci칩n del video');
        }
        
        const data = await response.json();
        return {
          title: data.title || 'Video de YouTube',
          author: data.author_name || 'Artista desconocido',
          thumbnail: data.thumbnail_url || `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
        };
      } catch (error) {
        console.warn('丘멆잺 No se pudo obtener t칤tulo autom치tico:', error);
        return {
          title: 'Video de YouTube',
          author: 'Artista desconocido',
          thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`
        };
      }
    }
    
    // Extract YouTube video ID from URL
    function extractYouTubeId(url) {
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
        /youtube\.com\/embed\/([^&\n?#]+)/,
        /youtube\.com\/v\/([^&\n?#]+)/
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      
      return null;
    }

    // Format duration
    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Auto-Tagging Functions
    async function fetchSongInfo(artist, title) {
      try {
        // Using Last.fm API (public, no key required for basic info)
        // Note: In production, you'd use a proper API key
        const apiKey = '8a8c4b0e1cc0aba6e1d9c0f8e5e3c1f1'; // Demo key
        const url = `https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${apiKey}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(title)}&format=json`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.track) {
          const tags = data.track.toptags?.tag || [];
          return {
            genres: Array.isArray(tags) ? tags.map(t => t.name) : [],
            listeners: data.track.listeners || 0,
            playcount: data.track.playcount || 0,
            summary: data.track.wiki?.summary || ''
          };
        }
        
        return null;
      } catch (error) {
        console.warn('丘멆잺 No se pudo obtener info de Last.fm:', error);
        return null;
      }
    }

    function normalizeGenre(genre) {
      const genreLower = genre.toLowerCase();
      
      const mapping = {
        'rock': 'Rock',
        'pop': 'Pop',
        'electronic': 'Electronic',
        'hip-hop': 'Hip Hop',
        'hip hop': 'Hip Hop',
        'rap': 'Hip Hop',
        'jazz': 'Jazz',
        'blues': 'Blues',
        'metal': 'Metal',
        'heavy metal': 'Metal',
        'indie': 'Indie',
        'alternative': 'Alternative',
        'classical': 'Classical',
        'country': 'Country',
        'reggae': 'Reggae',
        'soul': 'Soul',
        'r&b': 'R&B',
        'rnb': 'R&B',
        'folk': 'Folk',
        'punk': 'Punk',
        'funk': 'Funk',
        'latin': 'Latin',
        'salsa': 'Latin',
        'reggaeton': 'Reggaeton',
        'trap': 'Trap',
        'techno': 'Techno',
        'house': 'House'
      };
      
      return mapping[genreLower] || null;
    }

    function analyzeGenres(songInfo, songTitle, artistName) {
      const detectedGenres = new Set();
      
      // 1. G칠neros de APIs externas
      if (songInfo?.genres) {
        songInfo.genres.forEach(genre => {
          const normalized = normalizeGenre(genre);
          if (normalized) detectedGenres.add(normalized);
        });
      }
      
      // 2. An치lisis por palabras clave en t칤tulo
      const titleLower = songTitle.toLowerCase();
      const genreKeywords = {
        'Rock': ['rock', 'metal', 'punk'],
        'Electronic': ['remix', 'mix', 'electro', 'edm', 'dj'],
        'Classical': ['symphony', 'concerto', 'sonata', 'opus'],
        'Hip Hop': ['rap', 'hip hop', 'trap', 'freestyle'],
        'Jazz': ['jazz', 'swing', 'bebop'],
        'Latin': ['salsa', 'bachata', 'merengue', 'cumbia', 'reggaeton'],
        'Pop': ['pop']
      };
      
      Object.entries(genreKeywords).forEach(([genre, keywords]) => {
        if (keywords.some(kw => titleLower.includes(kw))) {
          detectedGenres.add(genre);
        }
      });
      
      // 3. Si no se detect칩 nada, asignar "Pop" por defecto
      if (detectedGenres.size === 0) {
        detectedGenres.add('Pop');
      }
      
      return Array.from(detectedGenres).slice(0, 3); // M치ximo 3 g칠neros
    }

    function analyzeMoods(songInfo, genres, songTitle) {
      const detectedMoods = new Set();
      
      // 1. Emociones basadas en g칠nero
      const genreMoodMapping = {
        'Rock': ['En칠rgico', 'Motivador'],
        'Metal': ['Agresivo', 'En칠rgico'],
        'Pop': ['Feliz', 'Festivo'],
        'Jazz': ['Relajado', 'Tranquilo'],
        'Blues': ['Melanc칩lico', 'Triste'],
        'Classical': ['Tranquilo', 'Inspirador'],
        'Electronic': ['En칠rgico', 'Euf칩rico'],
        'Hip Hop': ['Motivador', 'En칠rgico'],
        'R&B': ['Rom치ntico', 'Relajado'],
        'Reggae': ['Relajado', 'Feliz'],
        'Country': ['Nost치lgico', 'Rom치ntico'],
        'Latin': ['Festivo', 'En칠rgico']
      };
      
      genres.forEach(genre => {
        const moods = genreMoodMapping[genre];
        if (moods) {
          moods.forEach(mood => detectedMoods.add(mood));
        }
      });
      
      // 2. Palabras clave en t칤tulo para emociones
      const titleLower = songTitle.toLowerCase();
      const moodKeywords = {
        'Feliz': ['happy', 'joy', 'smile', 'sunshine', 'bright', 'alegre', 'feliz'],
        'Triste': ['sad', 'cry', 'tears', 'blue', 'lonely', 'triste', 'llora'],
        'Rom치ntico': ['love', 'heart', 'kiss', 'romance', 'amor', 'coraz칩n'],
        'En칠rgico': ['power', 'energy', 'fire', 'wild', 'energ칤a', 'fuego'],
        'Relajado': ['calm', 'peace', 'relax', 'chill', 'tranquilo', 'paz'],
        'Nost치lgico': ['memory', 'yesterday', 'remember', 'old', 'recuerdo'],
        'Motivador': ['rise', 'strong', 'fight', 'win', 'motivaci칩n', 'lucha'],
        'Festivo': ['party', 'dance', 'celebrate', 'fiesta', 'bailar']
      };
      
      Object.entries(moodKeywords).forEach(([mood, keywords]) => {
        if (keywords.some(kw => titleLower.includes(kw))) {
          detectedMoods.add(mood);
        }
      });
      
      // 3. Si no hay emociones, asignar algunas por defecto
      if (detectedMoods.size === 0) {
        detectedMoods.add('Relajado');
      }
      
      return Array.from(detectedMoods).slice(0, 3); // M치ximo 3 emociones
    }

    async function autoTagSong(song) {
      console.log(`游낑勇 Auto-etiquetando: ${song.title} - ${song.artist}`);
      
      try {
        // Obtener informaci칩n de APIs externas
        const songInfo = await fetchSongInfo(song.artist, song.title);
        
        // Analizar y asignar g칠neros
        const genres = analyzeGenres(songInfo, song.title, song.artist);
        
        // Analizar y asignar emociones
        const moods = analyzeMoods(songInfo, genres, song.title);
        
        // Actualizar canci칩n
        song.genres = genres;
        song.moods = moods;
        song.autoTagged = true;
        song.taggedDate = new Date().toISOString();
        
        console.log(`九 Etiquetado completado:`, {
          title: song.title,
          genres: genres,
          moods: moods
        });
        
        return true;
        
      } catch (error) {
        console.error(`仇 Error al etiquetar: ${song.title}`, error);
        return false;
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function autoTagLibrary() {
      if (songsLibrary.length === 0) {
        alert('丘멆잺 No hay canciones en la biblioteca');
        return;
      }
      
      const confirm = window.confirm(`쯈uieres auto-etiquetar ${songsLibrary.length} canciones?\n\nEsto obtendr치 informaci칩n de internet para cada canci칩n.`);
      
      if (!confirm) return;
      
      console.log('游낑勇 Iniciando auto-etiquetado de biblioteca...');
      
      // Create loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.id = 'tagLoadingIndicator';
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <p>Etiquetando canciones... <span id="tag-progress-count">0/${songsLibrary.length}</span></p>
        <p class="progress-text">Esto puede tomar unos minutos</p>
      `;
      document.body.appendChild(loadingDiv);
      
      let tagged = 0;
      let total = songsLibrary.length;
      
      for (let i = 0; i < songsLibrary.length; i++) {
        const song = songsLibrary[i];
        
        // Solo etiquetar si no est치 ya etiquetada
        if (!song.autoTagged) {
        // const success = await autoTagSong(song);
          if (success) tagged++;
          
          // Actualizar progreso
          const progressCount = document.getElementById('tag-progress-count');
          if (progressCount) {
            progressCount.textContent = `${i + 1}/${total}`;
          }
          
          // Peque침a pausa para no saturar las APIs
          await sleep(500);
        } else {
          // Update counter even for already tagged songs
          const progressCount = document.getElementById('tag-progress-count');
          if (progressCount) {
            progressCount.textContent = `${i + 1}/${total}`;
          }
        }
      }
      
      loadingDiv.remove();
      
      // Actualizar filtros
      populateFilters();
      
      // Refresh view
      if (currentView === 'biblioteca') {
        renderBiblioteca();
      }
      
      console.log(`九 Auto-etiquetado completado: ${tagged}/${total} canciones`);
      alert(`九 Auto-etiquetado completado\n\n${tagged} de ${total} canciones etiquetadas\n\n游눠 Ahora puedes usar los filtros de g칠nero y estado de 치nimo`);
      
      announce(`Auto-etiquetado completado. ${tagged} canciones etiquetadas`);
    }

    // Auto-etiquetar canciones nuevas
    async function autoTagNewSongs() {
      console.log('游낑勇 Iniciando auto-etiquetado autom치tico...');
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <p>Etiquetando canciones autom치ticamente...</p>
        <p id="progress-count">0/${songsLibrary.length}</p>
      `;
      document.body.appendChild(loadingDiv);
      
      let tagged = 0;
      const songsToTag = songsLibrary.filter(s => !s.autoTagged);
      
      for (let i = 0; i < songsToTag.length; i++) {
        const song = songsToTag[i];
        
        // const success = await autoTagSong(song);
        // if (success) tagged++;
        
        const progressCount = document.getElementById('progress-count');
        if (progressCount) {
          const percentage = Math.round(((i + 1) / songsToTag.length) * 100);
          progressCount.textContent = `${i + 1}/${songsToTag.length} (${percentage}%)`;
        }
        
        // Pausa corta para no saturar APIs
        await sleep(300);
      }
      
      loadingDiv.remove();
      
      populateFilters();
      if (currentView === 'biblioteca') {
        renderBiblioteca(document.getElementById('searchInput').value);
      }
      
      console.log(`九 Auto-etiquetado completado: ${tagged}/${songsToTag.length} canciones`);
      
      const message = `九 Proceso completado\n\n游늬 ${songsLibrary.length} canciones cargadas\n游낑勇 Todas etiquetadas autom치ticamente\n\nLas canciones han sido analizadas y organizadas por:\n G칠neros musicales\n Estados de 치nimo\n Etiquetas autom치ticas`;
      
      alert(message);
      announce('Canciones etiquetadas autom치ticamente');
    }

    function populateFilters() {
      const genres = new Set();
      const moods = new Set();
      
      songsLibrary.forEach(song => {
        song.genres?.forEach(g => genres.add(g));
        song.moods?.forEach(m => moods.add(m));
      });
      
      const genreFilter = document.getElementById('genre-filter');
      const moodFilter = document.getElementById('mood-filter');
      
      // Clear existing options (except first)
      genreFilter.innerHTML = '<option value="">Todos los g칠neros</option>';
      moodFilter.innerHTML = '<option value="">Todos los estados</option>';
      
      Array.from(genres).sort().forEach(genre => {
        const option = document.createElement('option');
        option.value = genre;
        option.textContent = genre;
        genreFilter.appendChild(option);
      });
      
      Array.from(moods).sort().forEach(mood => {
        const option = document.createElement('option');
        option.value = mood;
        option.textContent = mood;
        moodFilter.appendChild(option);
      });
    }

    function filterLibrary() {
      const selectedGenre = document.getElementById('genre-filter').value;
      const selectedMood = document.getElementById('mood-filter').value;
      const searchTerm = document.getElementById('searchInput').value;
      
      let filtered = songsLibrary;
      
      // Apply genre filter
      if (selectedGenre) {
        filtered = filtered.filter(song => song.genres?.includes(selectedGenre));
      }
      
      // Apply mood filter
      if (selectedMood) {
        filtered = filtered.filter(song => song.moods?.includes(selectedMood));
      }
      
      // Apply search filter
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(song => 
          song.title.toLowerCase().includes(term) || 
          song.artist.toLowerCase().includes(term)
        );
      }
      
      renderFilteredLibrary(filtered);
    }

    function renderFilteredLibrary(filteredSongs) {
      const grid = document.getElementById('songsGrid');
      
      if (filteredSongs.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">游댌</div><div class="empty-state-text">No se encontraron canciones con esos filtros</div></div>';
        return;
      }
      
      grid.innerHTML = filteredSongs.map(song => {
        const typeIcon = song.type === 'youtube' ? '游깷' : '游';
        const typeLabel = song.type === 'youtube' ? 'YouTube' : 'Local';
        
        let tagsHTML = '';
        
        if (song.genres && song.genres.length > 0) {
          tagsHTML += '<div class="song-tags genres">';
          song.genres.forEach(genre => {
            tagsHTML += `<span class="tag genre-tag">${genre}</span>`;
          });
          tagsHTML += '</div>';
        }
        
        if (song.moods && song.moods.length > 0) {
          tagsHTML += '<div class="song-tags moods">';
          song.moods.forEach(mood => {
            tagsHTML += `<span class="tag mood-tag">${mood}</span>`;
          });
          tagsHTML += '</div>';
        }
        
        return `
        <div class="song-card ${currentSong && currentSong.id === song.id ? 'playing' : ''}" onclick="playSong(${song.id})">
          <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
          <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite(${song.id})">
            ${song.isFavorite ? '仇벒잺' : '游밼'}
          </button>
          <div class="song-cover">${getSongCover(song)}</div>
          <div class="song-info">
            <div class="song-title"><span>${song.title}</span></div>
            <div class="song-artist">${song.artist}</div>
            ${tagsHTML}
          </div>
          <div class="song-info" style="margin-top: 8px;">
            <span>${formatDuration(song.duration)}</span>
            <button class="action-btn" onclick="event.stopPropagation(); openAddToPlaylist(${song.id})" title="A침adir a playlist">俱</button>
          </div>
        </div>
      `;
      }).join('');
    }

    // Biblioteca view
    function renderBiblioteca(searchTerm = '') {
      const grid = document.getElementById('songsGrid');
      
      // Show empty state if no songs
      if (songsLibrary.length === 0) {
        grid.innerHTML = `
          <div class="empty-library-message">
            <div class="empty-icon">游꿧</div>
            <h3>No hay canciones en tu biblioteca</h3>
            <p>Haz clic en el bot칩n "游늬 Seleccionar Carpeta de M칰sica" para cargar tus archivos de audio.</p>
            <p style="margin-top: 20px; font-size: 14px; color: var(--color-text-secondary);">
              Formatos compatibles: MP3, M4A, WAV, OGG, FLAC
            </p>
          </div>
        `;
        return;
      }
      
      const filteredSongs = songsLibrary.filter(song => {
        if (!searchTerm) return true;
        const term = searchTerm.toLowerCase();
        return song.title.toLowerCase().includes(term) || 
               song.artist.toLowerCase().includes(term);
      });
      
      if (filteredSongs.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">游댌</div><div class="empty-state-text">No se encontraron canciones</div></div>';
        return;
      }
      
      grid.innerHTML = '';
      
      filteredSongs.forEach(song => {
        const songCard = document.createElement('div');
        songCard.className = `song-card ${currentSong && currentSong.id === song.id ? 'playing' : ''}`;
        songCard.dataset.songId = song.id;
        
        const typeIcon = song.type === 'youtube' ? '游깷' : '游';
        const typeLabel = song.type === 'youtube' ? 'YouTube' : 'Local';
        
        // HTML de etiquetas editables
        const tagsHTML = renderTagsSection(song);
        
        songCard.innerHTML = `
          <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
          <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite(${song.id})">
            ${song.isFavorite ? '仇벒잺' : '游밼'}
          </button>
          <div class="song-cover">${getSongCover(song)}</div>
          <div class="song-info">
            <div class="song-title"><span>${song.title}</span></div>
            <div class="song-artist">${song.artist}</div>
            ${tagsHTML}
          </div>
          <div class="song-info" style="margin-top: 8px;">
            <span>${formatDuration(song.duration)}</span>
            <button class="action-btn" onclick="event.stopPropagation(); openAddToPlaylist(${song.id})" title="A침adir a playlist">俱</button>
          </div>
        `;
        
        // Click en la canci칩n para reproducir (excepto en etiquetas)
        songCard.addEventListener('click', (e) => {
          if (e.target.closest('.song-tags-section') || e.target.closest('.favorite-btn') || e.target.closest('.action-btn')) {
            return;
          }
          playSong(song.id);
        });
        
        grid.appendChild(songCard);
        
        // Detectar si el t칤tulo es largo y a침adir clase 'long'
        setTimeout(() => {
          const titleEl = songCard.querySelector('.song-title');
          const span = titleEl ? titleEl.querySelector('span') : null;
          
          if (span && titleEl && span.scrollWidth > titleEl.clientWidth) {
            titleEl.classList.add('long');
          }
        }, 50);
      });
      
      console.log(`九 Biblioteca renderizada: ${filteredSongs.length} canciones`);
    }
    
    function renderTagsSection(song) {
      let html = '<div class="song-tags-section-compact">';
      
      // Combinar todas las etiquetas en una sola l칤nea con iconos
      const allTags = [];
      
      // A침adir g칠neros con icono
      if (song.genres && song.genres.length > 0) {
        song.genres.forEach(genre => {
          allTags.push({
            type: 'genre',
            value: genre,
            icon: '游꿪'
          });
        });
      }
      
      // A침adir emociones con icono
      if (song.moods && song.moods.length > 0) {
        song.moods.forEach(mood => {
          allTags.push({
            type: 'mood',
            value: mood,
            icon: '游눪'
          });
        });
      }
      
      // A침adir etiquetas personalizadas con icono
      if (song.tags && song.tags.length > 0) {
        song.tags.forEach(tag => {
          allTags.push({
            type: 'custom',
            value: tag,
            icon: '游댔'
          });
        });
      }
      
      // Renderizar todas las etiquetas
      html += '<div class="tags-flow">';
      
      allTags.forEach(tag => {
        const className = `tag-chip tag-chip-${tag.type}`;
        const removeFunc = tag.type === 'genre' ? 
          `removeTag(${song.id}, 'genre', '${tag.value}')` :
          tag.type === 'mood' ?
          `removeMood(${song.id}, '${tag.value}')` :
          `removeCustomTag(${song.id}, '${tag.value}')`;
        
        html += `
          <span class="${className}" data-tag="${tag.value}">
            <span class="tag-icon">${tag.icon}</span>
            <span class="tag-text">${tag.value}</span>
            <button class="tag-close" onclick="event.stopPropagation(); ${removeFunc}" title="Eliminar">칑</button>
          </span>
        `;
      });
      
      // Bot칩n de a침adir unificado
      html += `
        <button class="tag-add-compact" onclick="event.stopPropagation(); showQuickAddMenu(${song.id}, event)" title="A침adir etiqueta">
          <span class="add-icon">+</span>
        </button>
      `;
      
      html += '</div>';
      html += '</div>';
      
      return html;
    }

    function searchSongs() {
      filterLibrary();
    }

    // Favoritos view
    function renderFavoritos() {
      const grid = document.getElementById('favoritesGrid');
      const favoriteSongs = songsLibrary.filter(song => song.isFavorite);
      
      if (favoriteSongs.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">救</div><div class="empty-state-text">No tienes canciones favoritas a칰n</div></div>';
        return;
      }
      
      grid.innerHTML = favoriteSongs.map(song => {
        const typeIcon = song.type === 'youtube' ? '游깷' : '游';
        const typeLabel = song.type === 'youtube' ? 'YouTube' : 'Local';
        return `
        <div class="song-card ${currentSong && currentSong.id === song.id ? 'playing' : ''}" onclick="playSong(${song.id})">
          <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
          <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite(${song.id})">
            仇벒잺
          </button>
          <div class="song-cover">${getSongCover(song)}</div>
          <div class="song-title">${song.title}</div>
          <div class="song-artist">${song.artist}</div>
          <div class="song-info">
            <span>${formatDuration(song.duration)}</span>
            <button class="action-btn" onclick="event.stopPropagation(); openAddToPlaylist(${song.id})" title="A침adir a playlist">俱</button>
          </div>
        </div>
      `;
      }).join('');
    }

    // Playlists view
    function renderPlaylists() {
      document.getElementById('playlistsList').style.display = 'block';
      document.getElementById('playlistDetail').style.display = 'none';
      
      const grid = document.getElementById('playlistsGrid');
      grid.innerHTML = `
        <div class="playlist-card create-new" onclick="openCreatePlaylistModal()">
          <div class="playlist-icon">俱</div>
          <div class="playlist-name">Nueva Playlist</div>
        </div>
        ${playlists.map(playlist => {
          const songCount = playlist.songs.length;
          const totalDuration = playlist.songs.reduce((total, songId) => {
            const song = songsLibrary.find(s => s.id === songId);
            return total + (song ? song.duration : 0);
          }, 0);
          return `
            <div class="playlist-card" onclick="viewPlaylist(${playlist.id})">
              <div class="playlist-icon">游꿚</div>
              <div class="playlist-name">${playlist.name}</div>
              <div class="playlist-stats">${songCount} canciones 췅 ${formatDuration(totalDuration)}</div>
            </div>
          `;
        }).join('')}
      `;
    }

    function viewPlaylist(playlistId) {
      currentPlaylistView = playlistId;
      const playlist = playlists.find(p => p.id === playlistId);
      if (!playlist) return;
      
      document.getElementById('playlistsList').style.display = 'none';
      const detailDiv = document.getElementById('playlistDetail');
      detailDiv.style.display = 'block';
      
      const playlistSongs = playlist.songs.map(songId => songsLibrary.find(s => s.id === songId)).filter(Boolean);
      const totalDuration = playlistSongs.reduce((total, song) => total + song.duration, 0);
      
      detailDiv.innerHTML = `
        <button class="back-btn" onclick="renderPlaylists()"> Volver a Playlists</button>
        <div class="playlist-header">
          <div style="flex: 1;">
            <div class="playlist-icon" style="font-size: 48px; margin-bottom: var(--space-12);">游꿚</div>
            <h2 style="font-size: var(--font-size-3xl); margin-bottom: var(--space-8);">${playlist.name}</h2>
            <div class="playlist-stats">${playlistSongs.length} canciones 췅 ${formatDuration(totalDuration)}</div>
          </div>
          <button class="btn btn-primary" onclick="playPlaylist(${playlistId})">郊윒잺 Reproducir todo</button>
        </div>
        <div class="songs-list">
          ${playlistSongs.length === 0 ? 
            '<div class="empty-state"><div class="empty-state-icon">游꿧</div><div class="empty-state-text">Esta playlist est치 vac칤a</div></div>' :
            playlistSongs.map((song, index) => {
              const typeIcon = song.type === 'youtube' ? '游깷' : '游';
              return `
              <div class="song-item ${currentSong && currentSong.id === song.id ? 'playing' : ''}" onclick="playSongFromPlaylist(${playlistId}, ${index})">
                <div class="song-item-cover">${getSongCover(song)}</div>
                <div class="song-item-info">
                  <div class="song-item-title">${typeIcon} ${song.title}</div>
                  <div class="song-item-artist">${song.artist}</div>
                </div>
                <div class="song-item-duration">${formatDuration(song.duration)}</div>
                <div class="song-item-actions">
                  <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite(${song.id})">
                    ${song.isFavorite ? '仇벒잺' : '游밼'}
                  </button>
                  <button class="action-btn" onclick="event.stopPropagation(); removeFromPlaylist(${playlistId}, ${song.id})" title="Quitar de playlist">游딈勇</button>
                </div>
              </div>
            `;
            }).join('')
          }
        </div>
      `;
    }

    function removeFromPlaylist(playlistId, songId) {
      const playlist = playlists.find(p => p.id === playlistId);
      if (!playlist) return;
      
      playlist.songs = playlist.songs.filter(id => id !== songId);
      viewPlaylist(playlistId);
    }

    // YouTube Modal functions
    function openYouTubeModal() {
      document.getElementById('youtube-url-input').value = '';
      document.getElementById('song-title-input').value = '';
      document.getElementById('song-artist-input').value = '';
      document.getElementById('youtubeModal').classList.add('active');
      announce('Modal de a침adir desde YouTube abierta');
    }
    
    function closeYouTubeModal() {
      document.getElementById('youtubeModal').classList.remove('active');
      announce('Modal cerrada');
    }
    
    async function saveYouTubeSong(event) {
      event.preventDefault();
      
      const url = document.getElementById('youtube-url-input').value.trim();
      const titleInput = document.getElementById('song-title-input').value.trim();
      const artistInput = document.getElementById('song-artist-input').value.trim();
      
      if (!url) {
        alert('丘멆잺 Por favor ingresa una URL de YouTube');
        return;
      }
      
      const videoId = extractYouTubeId(url);
      
      if (!videoId) {
        alert('仇 URL de YouTube no v치lida. Por favor usa un formato como:\n- https://www.youtube.com/watch?v=...\n- https://youtu.be/...');
        return;
      }
      
      // Mostrar indicador de carga en el bot칩n
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '낍 Obteniendo info...';
      
      try {
        // Obtener informaci칩n del video autom치ticamente
        console.log('游댌 Obteniendo informaci칩n del video:', videoId);
        const videoInfo = await fetchYouTubeTitle(videoId);
        
        console.log('游늵 Informaci칩n obtenida de YouTube:');
        console.log('  - T칤tulo:', videoInfo.title);
        console.log('  - Autor/Canal:', videoInfo.author);
        console.log('  - Thumbnail:', videoInfo.thumbnail);
        console.log('  - Video ID:', videoId);
        
        // Usar t칤tulo y artista del input si est치n disponibles, si no usar los obtenidos
        const finalTitle = titleInput || videoInfo.title;
        const finalArtist = artistInput || videoInfo.author;
        
        if (titleInput || artistInput) {
          console.log('游닇 Usando informaci칩n personalizada del usuario');
          if (titleInput) console.log('  - T칤tulo personalizado:', titleInput);
          if (artistInput) console.log('  - Artista personalizado:', artistInput);
        } else {
          console.log('九 Usando informaci칩n autom치tica del video');
        }
        
        // Create YouTube song object
        const song = {
          id: nextSongId++,
          title: finalTitle,
          artist: finalArtist,
          album: 'YouTube',
          duration: 0,
          type: 'youtube',
          youtubeUrl: url,
          youtubeId: videoId,
          blob: null,
          fileName: null,
          cover: videoInfo.thumbnail,
          eqSettings: null,
          isFavorite: false,
          playCount: 0
        };
        
        songsLibrary.push(song);
        youtubeSongsCache.push(song);
        
        // Auto-etiquetar la canci칩n de YouTube
        console.log('游낑勇 Etiquetando autom치ticamente...');
        // await autoTagSong(song);
        
        console.log('九 Canci칩n de YouTube a침adida y etiquetada:', song.title);
        announce(`Canci칩n a침adida: ${song.title} por ${song.artist}`);
        
        populateFilters();
        
        closeYouTubeModal();
        
        // Refresh view if in biblioteca
        if (currentView === 'biblioteca') {
          renderBiblioteca(document.getElementById('searchInput').value);
        }
        
        // alert eliminado
        
      } catch (error) {
        console.error('仇 Error al a침adir canci칩n:', error);
        alert('Error al obtener informaci칩n del video. Intenta nuevamente.');
      } finally {
        // Restaurar bot칩n
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }
    
    // Player functions
    function playSong(songId, playlist = null, playlistIndex = 0) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) {
        console.error('仇 Canci칩n no encontrada:', songId);
        return;
      }
      
      console.log('游꿧 Intentando reproducir:', song.title, '| Tipo:', song.type);
      
      // Detener cualquier reproducci칩n actual
      stopYouTubeSong();
      if (audioElement) {
        audioElement.pause();
      }
      
      // Announce song change
      announce(`Reproduciendo: ${song.title} por ${song.artist}`);
      
      // Update play button aria-label
      const playBtn = document.getElementById('playPauseBtn');
      if (playBtn) {
        playBtn.setAttribute('aria-label', 'Pausar');
        playBtn.setAttribute('aria-pressed', 'true');
      }
      
      if (!audioElement) {
        console.error('仇 Elemento audio no encontrado');
        alert('Error: Reproductor de audio no disponible');
        return;
      }
      
      currentSong = song;
      currentPlaylist = playlist || [song];
      currentPlaylistIndex = playlistIndex;
      isPlaying = true;
      currentTime = 0;
      
      // Load song EQ settings or use global
      if (song.eqSettings) {
        currentEQSettings = [...song.eqSettings];
      } else {
        currentEQSettings = [...globalEQSettings];
      }
      applyEQSettings();
      
      // Load audio file
      if (song.type === 'youtube') {
        console.log('游깷 Iniciando reproducci칩n de YouTube...');
        playYouTubeSong(song);
        updateMiniPlayer();
        updatePlayerState();
        // Update UI
        if (currentView === 'biblioteca') renderBiblioteca(document.getElementById('searchInput').value);
        else if (currentView === 'favoritos') renderFavoritos();
        else if (currentView === 'playlists' && currentPlaylistView) viewPlaylist(currentPlaylistView);
        return;
      } else if (song.blob) {
        console.log('九 Cargando archivo local:', song.fileName);
        try {
          const url = URL.createObjectURL(song.blob);
          audioElement.src = url;
          
          audioElement.play().then(() => {
            console.log('九 Reproduciendo archivo local:', song.title);
            updateMiniPlayer();
            updatePlayerState();
            announce(`Reproduciendo: ${song.title}`);
          }).catch(error => {
            console.error('仇 Error al reproducir:', error);
            alert('Error al reproducir: ' + error.message);
            isPlaying = false;
            updatePlayerState();
          });
        } catch (error) {
          console.error('仇 Error creando URL:', error);
          alert('No se pudo cargar el archivo de audio');
          isPlaying = false;
          updatePlayerState();
        }
      } else if (song.url) {
        console.log('九 Cargando URL:', song.url);
        audioElement.src = song.url;
      } else {
        console.warn('丘멆잺 Canci칩n de demo sin audio real');
        audioElement.src = '';
      }
      
      // Resume audio context if suspended
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      updateMiniPlayer();
      updatePlayerState();
      
      // Play if has audio source (not YouTube)
      if ((song.blob || song.url) && song.type !== 'youtube') {
        audioElement.play().then(() => {
          console.log('九 Reproduciendo:', song.title);
        }).catch(error => {
          console.error('仇 Error al reproducir:', error);
          alert('No se pudo reproducir la canci칩n. Error: ' + error.message);
          isPlaying = false;
          updatePlayerState();
        });
      } else if (!song.blob && !song.url && song.type !== 'youtube') {
        console.log('좶잺 Simulaci칩n de reproducci칩n (demo)');
        startPlayback(); // Demo playback
      }
      
      // Update UI
      if (currentView === 'biblioteca') renderBiblioteca(document.getElementById('searchInput').value);
      else if (currentView === 'favoritos') renderFavoritos();
      else if (currentView === 'playlists' && currentPlaylistView) viewPlaylist(currentPlaylistView);
    }

    function playSongFromPlaylist(playlistId, songIndex) {
      const playlist = playlists.find(p => p.id === playlistId);
      if (!playlist) return;
      
      const playlistSongs = playlist.songs.map(id => songs.find(s => s.id === id)).filter(Boolean);
      playSong(playlistSongs[songIndex].id, playlistSongs, songIndex);
    }

    function playPlaylist(playlistId) {
      const playlist = playlists.find(p => p.id === playlistId);
      if (!playlist || playlist.songs.length === 0) return;
      
      const playlistSongs = playlist.songs.map(id => songs.find(s => s.id === id)).filter(Boolean);
      playSong(playlistSongs[0].id, playlistSongs, 0);
    }

    // Play YouTube song using iframe with correct sandbox attributes
    function playYouTubeSong(song) {
      console.log('郊윒잺 Preparando YouTube:', song.title);
      
      // Pausar reproductor HTML5 si est치 activo
      if (audioElement) {
        audioElement.pause();
        // audioElement.src = ''; // Comentado
      }
      
      // Crear o actualizar contenedor del iframe
      let youtubeContainer = document.getElementById('youtube-player-container');
      
      if (!youtubeContainer) {
        youtubeContainer = document.createElement('div');
        youtubeContainer.id = 'youtube-player-container';
        youtubeContainer.className = 'youtube-hidden'; // OCULTO POR DEFECTO
        document.body.appendChild(youtubeContainer);
      }
      
      // Limpiar contenido anterior
      youtubeContainer.innerHTML = '';
      
      // Crear iframe con tama침o real pero contenedor oculto
      const iframe = document.createElement('iframe');
      iframe.id = 'youtube-iframe';
      iframe.width = '560';
      iframe.height = '315';
      iframe.src = `https://www.youtube.com/embed/${song.youtubeId}?autoplay=1&mute=0&enablejsapi=1&controls=1`;
      iframe.frameBorder = '0';
      
      // Sandbox con permisos completos
      // iframe.setAttribute('sandbox', ...); // ELIMINADO
      iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
      iframe.allowFullscreen = true;
      
      youtubeContainer.appendChild(iframe);

const ytControls = document.createElement('div');
ytControls.id = 'youtube-custom-controls';
ytControls.style.cssText = 'background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 15px; display: flex; justify-content: center; gap: 15px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-top: 5px;';

const btnPrev = document.createElement('button');
btnPrev.innerHTML = '낉勇 Anterior';
btnPrev.style.cssText = 'padding: 12px 24px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; box-shadow: 0 4px 15px rgba(102,126,234,0.4); transition: all 0.3s ease;';
btnPrev.onclick = () => { previousSong(); };

const btnStop = document.createElement('button');
btnStop.innerHTML = '낓勇 Detener';
btnStop.style.cssText = 'padding: 12px 24px; cursor: pointer; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; box-shadow: 0 4px 15px rgba(245,87,108,0.4); transition: all 0.3s ease;';
btnStop.onclick = () => { stopPlayback(); };

const btnNext = document.createElement('button');
btnNext.innerHTML = '낈勇 Siguiente';
btnNext.style.cssText = 'padding: 12px 24px; cursor: pointer; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; box-shadow: 0 4px 15px rgba(79,172,254,0.4); transition: all 0.3s ease;';
btnNext.onclick = () => { nextSong(); };

ytControls.appendChild(btnPrev);
ytControls.appendChild(btnStop);
ytControls.appendChild(btnNext);
youtubeContainer.appendChild(ytControls);
console.log('游꿡 Controles YouTube a침adidos');
      
      // Mostrar bot칩n de toggle
      const toggleBtn = document.getElementById('youtube-toggle-btn');
      if (toggleBtn) {
        toggleBtn.style.display = 'flex';
        toggleBtn.classList.remove('video-visible');
        toggleBtn.setAttribute('data-tooltip', 'Mostrar video');
      }
      
      console.log('九 YouTube iframe creado (oculto por defecto):', song.youtubeId);
      console.log('游눠 Usa el bot칩n 游닠 en el reproductor para mostrar el video');
      
      // Verificaci칩n del iframe despu칠s de un momento
      setTimeout(() => {
        const iframe = document.getElementById('youtube-iframe');
        if (iframe) {
          console.log('九 Verificaci칩n del iframe:');
          console.log('  - Existe:', !!iframe);
          console.log('  - Src:', iframe.src);
          console.log('  - Sandbox:', iframe.getAttribute('sandbox'));
          console.log('  - Width x Height:', iframe.width, 'x', iframe.height);
          console.log('  - Container class:', youtubeContainer.className);
          console.log('游눠 El video est치 oculto. Usa el bot칩n 游닠 para verlo.');
        } else {
          console.error('仇 Iframe no se cre칩 correctamente');
        }
      }, 500);
      
      announce(`Reproduciendo desde YouTube: ${song.title}`);
      
      updateMiniPlayer();
      isPlaying = true;
      updatePlayerState();
    }
    
    // Detener YouTube
    function stopYouTubeSong() {
      const youtubeContainer = document.getElementById('youtube-player-container');
      if (youtubeContainer) {
        youtubeContainer.innerHTML = '';
        youtubeContainer.classList.remove('youtube-visible');
        youtubeContainer.classList.remove('youtube-hidden');
      }
      
      // Ocultar bot칩n toggle
      const toggleBtn = document.getElementById('youtube-toggle-btn');
      if (toggleBtn) {
        toggleBtn.style.display = 'none';
        toggleBtn.classList.remove('video-visible');
      }
      
      console.log('낓勇 YouTube detenido');
      isPlaying = false;
      updatePlayerState();
    }
    
    // Funci칩n para detener reproducci칩n completamente
    function stopPlayback() {
      console.log('낓勇 Deteniendo reproducci칩n...');
      
      // Detener audio HTML5
      const audioPlayer = document.getElementById('main-audio-player');
      if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        // audioPlayer.src = ''; // Comentado
      }
      
      // Detener YouTube
      stopYouTubeSong();
      
      // Limpiar UI del reproductor
      const miniPlayerTitle = document.getElementById('miniPlayerTitle');
      const miniPlayerArtist = document.getElementById('miniPlayerArtist');
      
      if (miniPlayerTitle) miniPlayerTitle.textContent = 'No hay canci칩n reproduci칠ndose';
      if (miniPlayerArtist) miniPlayerArtist.textContent = '';
      
      // Resetear barra de progreso
      const progressBarFill = document.getElementById('progressBarFill');
      if (progressBarFill) {
        progressBarFill.style.width = '0%';
      }
      
      const currentTimeEl = document.getElementById('currentTime');
      const totalTimeEl = document.getElementById('totalTime');
      
      if (currentTimeEl) currentTimeEl.textContent = '0:00';
      if (totalTimeEl) totalTimeEl.textContent = '0:00';
      
      // Limpiar estado
      currentSong = null;
      currentTime = 0;
      isPlaying = false;
      
      // Actualizar bot칩n play
      const playBtn = document.getElementById('playPauseBtn');
      if (playBtn) {
        playBtn.textContent = '郊윒잺';
        playBtn.setAttribute('aria-label', 'Reproducir');
        playBtn.setAttribute('aria-pressed', 'false');
      }
      
      announce('Reproducci칩n detenida');
      console.log('九 Reproducci칩n detenida completamente');
    }
    
    function togglePlayPause() {
      if (!currentSong) {
        console.warn('丘멆잺 No hay canci칩n seleccionada');
        return;
      }
      
      if (currentSong.type === 'youtube') {
        // Para YouTube, detener completamente
        const youtubeContainer = document.getElementById('youtube-player-container');
        
        if (youtubeContainer && youtubeContainer.innerHTML) {
          // Detener
          stopYouTubeSong();
          announce('YouTube detenido');
        } else {
          // Reiniciar
          playYouTubeSong(currentSong);
          announce('YouTube reproduciendo');
        }
        return;
      }
      
      // Para canciones locales
      if (!audioElement) {
        console.warn('丘멆잺 No hay elemento de audio');
        return;
      }
      
      isPlaying = !isPlaying;
      updatePlayerState();
      
      if (currentSong.blob || currentSong.url) {
        if (isPlaying) {
          console.log('郊윒잺 Play');
          audioElement.play().catch(e => {
            console.error('仇 Error al reproducir:', e);
            isPlaying = false;
            updatePlayerState();
          });
          if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume();
          }
        } else {
          console.log('낒勇 Pause');
          audioElement.pause();
        }
      } else {
        if (isPlaying) {
          startPlayback();
        } else {
          stopPlayback();
        }
      }
    }

    function previousSong() {
      if (repeatMode === 'one') {
        playSong(currentSong.id, currentPlaylist, currentPlaylistIndex);
        return;
      }
      
      if (shuffleMode) {
        const randomIndex = Math.floor(Math.random() * currentPlaylist.length);
        currentPlaylistIndex = randomIndex;
        playSong(currentPlaylist[currentPlaylistIndex].id, currentPlaylist, currentPlaylistIndex);
      } else if (currentPlaylistIndex > 0) {
        currentPlaylistIndex--;
        playSong(currentPlaylist[currentPlaylistIndex].id, currentPlaylist, currentPlaylistIndex);
      }
    }

    function nextSong() {
      if (repeatMode === 'one') {
        playSong(currentSong.id, currentPlaylist, currentPlaylistIndex);
        return;
      }
      
      if (shuffleMode) {
        const randomIndex = Math.floor(Math.random() * currentPlaylist.length);
        currentPlaylistIndex = randomIndex;
        playSong(currentPlaylist[currentPlaylistIndex].id, currentPlaylist, currentPlaylistIndex);
      } else if (currentPlaylistIndex < currentPlaylist.length - 1) {
        currentPlaylistIndex++;
        playSong(currentPlaylist[currentPlaylistIndex].id, currentPlaylist, currentPlaylistIndex);
      } else if (repeatMode === 'all') {
        currentPlaylistIndex = 0;
        playSong(currentPlaylist[currentPlaylistIndex].id, currentPlaylist, currentPlaylistIndex);
      } else {
        // End of playlist
        if (currentSong.blob) {
          audioElement.pause();
        } else {
          stopPlayback();
        }
        isPlaying = false;
        currentTime = 0;
        updatePlayerState();
        updateMiniPlayer();
      }
    }

    function onSongEnded() {
      nextSong();
    }

    function onTimeUpdate() {
      if (currentSong && currentSong.blob) {
        currentTime = Math.floor(audioElement.currentTime);
        updateProgressBar();
        updateTimeDisplay();
      }
    }

    function onMetadataLoaded() {
      if (currentSong && currentSong.blob) {
        currentSong.duration = Math.floor(audioElement.duration);
        updateMiniPlayer();
      }
    }

    function startPlayback() {
      stopPlayback();
      playbackInterval = setInterval(() => {
        if (isPlaying && currentSong && !currentSong.blob) {
          currentTime++;
          if (currentTime >= currentSong.duration) {
            nextSong();
          } else {
            updateProgressBar();
            updateTimeDisplay();
          }
        }
      }, 1000);
    }

    function stopPlayback() {
      if (playbackInterval) {
        clearInterval(playbackInterval);
        playbackInterval = null;
      }
    }

    function updateMiniPlayer() {
      if (!currentSong) return;
      
      document.getElementById('miniPlayer').classList.add('active');
      const coverHtml = getSongCover(currentSong);
      document.getElementById('miniPlayerCover').innerHTML = coverHtml;
      document.getElementById('miniPlayerTitle').textContent = currentSong.title;
      document.getElementById('miniPlayerArtist').textContent = currentSong.artist;
      updateTimeDisplay();
      updateProgressBar();
    }

    function updateProgressBar() {
      if (!currentSong) return;
      const progress = (currentTime / currentSong.duration) * 100;
      document.getElementById('progressBarFill').style.width = progress + '%';
      
      // Update ARIA attributes
      const progressBar = document.getElementById('progressBar');
      if (progressBar) {
        progressBar.setAttribute('aria-valuenow', Math.round(progress));
        progressBar.setAttribute('aria-valuetext', `${formatDuration(currentTime)} de ${formatDuration(currentSong.duration)}`);
      }
    }

    function updateTimeDisplay() {
      if (!currentSong) return;
      document.getElementById('currentTime').textContent = formatDuration(currentTime);
      document.getElementById('totalTime').textContent = formatDuration(currentSong.duration);
    }

    function updatePlayerState() {
      const playPauseBtn = document.getElementById('playPauseBtn');
      playPauseBtn.textContent = isPlaying ? '낒勇' : '郊윒잺';
      playPauseBtn.setAttribute('aria-label', isPlaying ? 'Pausar' : 'Reproducir');
      playPauseBtn.setAttribute('aria-pressed', isPlaying ? 'true' : 'false');
      
      const shuffleBtn = document.getElementById('shuffleBtn');
      shuffleBtn.style.opacity = shuffleMode ? '1' : '0.5';
      shuffleBtn.setAttribute('aria-pressed', shuffleMode ? 'true' : 'false');
      
      const repeatBtn = document.getElementById('repeatBtn');
      if (repeatMode === 'none') {
        repeatBtn.textContent = '游대';
        repeatBtn.style.opacity = '0.5';
        repeatBtn.setAttribute('aria-pressed', 'false');
        repeatBtn.setAttribute('aria-label', 'Modo repetir: desactivado');
      } else if (repeatMode === 'all') {
        repeatBtn.textContent = '游대';
        repeatBtn.style.opacity = '1';
        repeatBtn.setAttribute('aria-pressed', 'true');
        repeatBtn.setAttribute('aria-label', 'Modo repetir: todas las canciones');
      } else if (repeatMode === 'one') {
        repeatBtn.textContent = '游댁';
        repeatBtn.style.opacity = '1';
        repeatBtn.setAttribute('aria-pressed', 'true');
        repeatBtn.setAttribute('aria-label', 'Modo repetir: una canci칩n');
      }
    }

    function seekTo(event) {
      if (!currentSong) return;
      
      const progressBar = event.currentTarget;
      const rect = progressBar.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const percentage = clickX / rect.width;
      const newTime = Math.floor(percentage * currentSong.duration);
      
      currentTime = newTime;
      
      if (currentSong.blob) {
        audioElement.currentTime = newTime;
      }
      
      updateProgressBar();
      updateTimeDisplay();
    }

    function changeVolume(value) {
      volume = value / 100;
      
      // Set both audio element and gain node
      if (audioElement) {
        audioElement.volume = volume;
      }
      if (gainNode) {
        gainNode.gain.value = volume;
      }
      
      console.log('游댉 Volumen:', Math.round(volume * 100) + '%');
      
      const volumeIcon = document.getElementById('volumeIcon');
      const volumeSlider = document.getElementById('volumeSlider');
      
      if (volume === 0) {
        volumeIcon.textContent = '游댆';
        volumeIcon.setAttribute('aria-label', 'Sonido silenciado');
      } else if (volume < 0.5) {
        volumeIcon.textContent = '游댈';
        volumeIcon.setAttribute('aria-label', 'Volumen bajo');
      } else {
        volumeIcon.textContent = '游댉';
        volumeIcon.setAttribute('aria-label', 'Volumen alto');
      }
      
      if (volumeSlider) {
        volumeSlider.setAttribute('aria-valuenow', Math.round(volume * 100));
        volumeSlider.setAttribute('aria-valuetext', `${Math.round(volume * 100)}%`);
      }
    }

    function toggleShuffle() {
      shuffleMode = !shuffleMode;
      updatePlayerState();
    }

    function toggleRepeat() {
      if (repeatMode === 'none') {
        repeatMode = 'all';
      } else if (repeatMode === 'all') {
        repeatMode = 'one';
      } else {
        repeatMode = 'none';
      }
      updatePlayerState();
    }

    // Favorites
    function toggleFavorite(songId) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      song.isFavorite = !song.isFavorite;
      
      // Update current view
      if (currentView === 'biblioteca') {
        renderBiblioteca(document.getElementById('searchInput').value);
      } else if (currentView === 'favoritos') {
        renderFavoritos();
      } else if (currentView === 'playlists' && currentPlaylistView) {
        viewPlaylist(currentPlaylistView);
      }
    }

    // Playlist management
    function openCreatePlaylistModal() {
      document.getElementById('playlistName').value = '';
      document.getElementById('createPlaylistModal').classList.add('active');
    }

    function closeCreatePlaylistModal() {
      document.getElementById('createPlaylistModal').classList.remove('active');
    }

    function savePlaylist(event) {
      event.preventDefault();
      
      const name = document.getElementById('playlistName').value.trim();
      if (!name) return;
      
      const newPlaylist = {
        id: playlists.length > 0 ? Math.max(...playlists.map(p => p.id)) + 1 : 1,
        name: name,
        songs: [],
        createdAt: new Date().toISOString().split('T')[0]
      };
      
      playlists.push(newPlaylist);
      closeCreatePlaylistModal();
      renderPlaylists();
    }

    function openAddToPlaylist(songId) {
      currentSongForPlaylist = songId;
      
      const listDiv = document.getElementById('playlistSelectionList');
      listDiv.innerHTML = playlists.map(playlist => {
        const alreadyAdded = playlist.songs.includes(songId);
        return `
          <div class="song-item" onclick="${alreadyAdded ? '' : `addSongToPlaylist(${playlist.id}, ${songId})`}" style="${alreadyAdded ? 'opacity: 0.5; cursor: default;' : ''}">
            <div class="song-item-cover">游꿚</div>
            <div class="song-item-info">
              <div class="song-item-title">${playlist.name}</div>
              <div class="song-item-artist">${playlist.songs.length} canciones</div>
            </div>
            <div>${alreadyAdded ? '九 A침adida' : '俱'}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('addToPlaylistModal').classList.add('active');
    }

    function closeAddToPlaylistModal() {
      document.getElementById('addToPlaylistModal').classList.remove('active');
      currentSongForPlaylist = null;
    }

    function addSongToPlaylist(playlistId, songId) {
      const playlist = playlists.find(p => p.id === playlistId);
      if (!playlist || playlist.songs.includes(songId)) return;
      
      playlist.songs.push(songId);
      openAddToPlaylist(songId); // Refresh modal
    }

    // Theme management
    function applyTheme() {
      document.documentElement.setAttribute('data-color-scheme', settings.theme);
    }

    function toggleTheme() {
      settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
      applyTheme();
    }

    // Accessibility Panel
    function openAccessibilityPanel() {
      document.getElementById('accessibilityPanel').classList.add('active');
      announce('Panel de accesibilidad abierto');
      
      // Update checkboxes to current state
      document.getElementById('high-contrast-toggle').checked = accessibilityState.highContrast;
      document.getElementById('keyboard-shortcuts-toggle').checked = accessibilityState.keyboardShortcuts;
      document.getElementById('voice-announcements-toggle').checked = accessibilityState.voiceAnnouncements;
      
      // Update font size buttons
      document.querySelectorAll('.font-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-size') === accessibilityState.fontSize) {
          btn.classList.add('active');
        }
      });
    }

    function closeAccessibilityPanel() {
      document.getElementById('accessibilityPanel').classList.remove('active');
      announce('Panel de accesibilidad cerrado');
    }

    // Initialize font size buttons
    function initFontSizeButtons() {
      const buttons = document.querySelectorAll('.font-btn');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const size = btn.getAttribute('data-size');
          
          // Update active button
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Apply font size
          setFontSize(size);
        });
      });
    }

    // Apply font size
    function setFontSize(size) {
      console.log('游댟 Cambiando tama침o de texto a:', size);
      
      accessibilityState.fontSize = size;
      
      // Remove all font size classes
      document.body.classList.remove('font-small', 'font-normal', 'font-large', 'font-xlarge');
      
      // Add new class
      document.body.classList.add(`font-${size}`);
      
      // Apply to CSS variable
      document.documentElement.style.setProperty('--base-font-size', getFontSizeValue(size));
      
      announce(`Tama침o de texto cambiado a ${getSizeName(size)}`);
    }

    function getFontSizeValue(size) {
      const sizes = {
        'small': '14px',
        'normal': '16px',
        'large': '20px',
        'xlarge': '26px'
      };
      return sizes[size] || '16px';
    }

    function getSizeName(size) {
      const names = {
        'small': 'peque침o',
        'normal': 'normal',
        'large': 'grande',
        'xlarge': 'muy grande'
      };
      return names[size] || 'normal';
    }

    // High Contrast Mode
    function toggleHighContrast(enabled) {
      accessibilityState.highContrast = enabled;
      
      if (enabled) {
        document.body.classList.add('high-contrast');
        announce('Modo de alto contraste activado');
      } else {
        document.body.classList.remove('high-contrast');
        announce('Modo de alto contraste desactivado');
      }
    }

    // Keyboard Shortcuts
    function toggleKeyboardShortcuts(enabled) {
      accessibilityState.keyboardShortcuts = enabled;
      
      if (enabled) {
        announce('Atajos de teclado activados');
      } else {
        announce('Atajos de teclado desactivados');
      }
    }

    // Voice Announcements
    function toggleVoiceAnnouncements(enabled) {
      accessibilityState.voiceAnnouncements = enabled;
      
      if (enabled) {
        announce('Anuncios de voz activados');
      } else {
        // Don't announce when disabling
        console.log('游닉 Anuncios de voz desactivados');
      }
    }

    // Announce function for screen readers and voice
    function announce(message, priority = 'polite') {
      // Create or update ARIA live region
      let liveRegion = document.getElementById('aria-live-region');
      if (!liveRegion) {
        liveRegion = document.createElement('div');
        liveRegion.id = 'aria-live-region';
        liveRegion.setAttribute('aria-live', priority);
        liveRegion.setAttribute('aria-atomic', 'true');
        liveRegion.className = 'sr-only';
        document.body.appendChild(liveRegion);
      }
      
      // Update the live region
      liveRegion.textContent = message;
      
      // Voice announcement if enabled
      if (accessibilityState.voiceAnnouncements && 'speechSynthesis' in window) {
        // Cancel any ongoing speech
        speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'es-ES';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        speechSynthesis.speak(utterance);
      }
      
      console.log('游닉 Anuncio:', message);
    }

    // Shortcuts Guide
    function showShortcutsGuide() {
      document.getElementById('shortcutsModal').classList.add('active');
      announce('Gu칤a de atajos de teclado abierta');
    }

    function closeShortcutsGuide() {
      document.getElementById('shortcutsModal').classList.remove('active');
      announce('Gu칤a de atajos de teclado cerrada');
    }

    // Mute function
    function toggleMute() {
      isMuted = !isMuted;
      
      if (isMuted) {
        volumeBeforeMute = volume;
        volume = 0;
        if (audioElement) audioElement.volume = 0;
        if (gainNode) gainNode.gain.value = 0;
        document.getElementById('volumeIcon').textContent = '游댆';
        document.getElementById('volumeSlider').value = 0;
        announce('Sonido silenciado');
      } else {
        volume = volumeBeforeMute;
        if (audioElement) audioElement.volume = volume;
        if (gainNode) gainNode.gain.value = volume;
        document.getElementById('volumeSlider').value = volume * 100;
        changeVolume(volume * 100);
        announce('Sonido activado');
      }
    }

    // Accessibility
    function applyAccessibility() {
      document.documentElement.setAttribute('data-accessibility', settings.accessibility);
    }

    function toggleAccessibility() {
      settings.accessibility = !settings.accessibility;
      applyAccessibility();
    }

    // Calendar rendering
    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      // Update month title
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                         'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      document.getElementById('monthTitle').textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayOfWeek = firstDay.getDay();

      // Get previous month's last days
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Day headers
      const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.textContent = day;
        grid.appendChild(header);
      });

      // Previous month days
      for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const dayEl = createDayElement(day, true, year, month - 1);
        grid.appendChild(dayEl);
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = createDayElement(day, false, year, month);
        grid.appendChild(dayEl);
      }

      // Next month days
      const remainingCells = 42 - (startDayOfWeek + daysInMonth);
      for (let day = 1; day <= remainingCells; day++) {
        const dayEl = createDayElement(day, true, year, month + 1);
        grid.appendChild(dayEl);
      }
    }

    function createDayElement(day, isOtherMonth, year, month) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      
      if (isOtherMonth) {
        dayEl.classList.add('other-month');
      }

      // Check if it's today
      const today = new Date();
      if (!isOtherMonth && 
          day === today.getDate() && 
          month === today.getMonth() && 
          year === today.getFullYear()) {
        dayEl.classList.add('today');
      }

      // Day number
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      dayNumber.textContent = day;
      dayEl.appendChild(dayNumber);

      // Check for diary entry
      if (!isOtherMonth) {
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const entry = diaryEntries[dateKey];
        
        if (entry) {
          // Show emotion emoji
          const emotionEl = document.createElement('div');
          emotionEl.className = 'day-emotion';
          emotionEl.textContent = entry.emoji || emotionEmojis[entry.mood] || '游땕';
          dayEl.appendChild(emotionEl);

          // Show indicator
          const indicator = document.createElement('div');
          indicator.className = 'day-indicator';
          dayEl.appendChild(indicator);
        }

        // Add click handler
        dayEl.onclick = () => openDiaryModal(year, month, day);
      }

      return dayEl;
    }

    // Navigation
    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    // Modal management
    function openDiaryModal(year, month, day) {
      const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      currentEditingDate = dateKey;
      
      const entry = diaryEntries[dateKey];
      
      // Update modal title
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                         'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      document.getElementById('modalTitle').textContent = `${day} de ${monthNames[month]} ${year}`;
      
      // Reset form
      document.getElementById('diaryText').value = '';
      currentSelectedEmotion = null;
      currentSelectedEmoji = null;
      
      // Remove all selected classes
      document.querySelectorAll('.emotion-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // If entry exists, populate form
      if (entry) {
        document.getElementById('diaryText').value = entry.diario || '';
        currentSelectedEmotion = entry.mood;
        currentSelectedEmoji = entry.emoji;
        
        // Select the emotion button
        const emotionBtn = document.querySelector(`[data-emotion="${entry.mood}"]`);
        if (emotionBtn) {
          emotionBtn.classList.add('selected');
        }
        
        document.getElementById('deleteBtn').style.display = 'inline-block';
      } else {
        document.getElementById('deleteBtn').style.display = 'none';
      }
      
      // Show modal
      document.getElementById('diaryModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('diaryModal').classList.remove('active');
      currentEditingDate = null;
      currentSelectedEmotion = null;
      currentSelectedEmoji = null;
    }

    function selectEmotion(emotion, emoji) {
      currentSelectedEmotion = emotion;
      currentSelectedEmoji = emoji;
      
      // Update visual selection
      document.querySelectorAll('.emotion-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    }

    function saveDiary(event) {
      event.preventDefault();
      
      if (!currentEditingDate) return;
      
      const diaryText = document.getElementById('diaryText').value.trim();
      
      if (!currentSelectedEmotion) {
        alert('Por favor selecciona una emoci칩n');
        return;
      }
      
      if (!diaryText) {
        alert('Por favor escribe algo en tu diario');
        return;
      }
      
      // Save entry
      diaryEntries[currentEditingDate] = {
        mood: currentSelectedEmotion,
        emoji: currentSelectedEmoji,
        diario: diaryText
      };
      
      // Close modal and refresh calendar
      closeModal();
      renderCalendar();
    }

    function deleteDiary() {
      if (!currentEditingDate) return;
      
      if (confirm('쮼st치s seguro de que quieres eliminar esta entrada?')) {
        delete diaryEntries[currentEditingDate];
        closeModal();
        renderCalendar();
      }
    }



    // Folder selection and file loading
    async function selectMusicFolder() {
      const btn = document.getElementById('load-folder-btn');
      
      // Disable button during loading
      btn.disabled = true;
      btn.textContent = '낍 Cargando...';
      
      try {
        // Try File System Access API first (Chrome/Edge)
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          await loadFilesFromDirectoryHandle(dirHandle);
        } else {
          // Fallback to input webkitdirectory
          document.getElementById('folderInput').click();
        }
      } catch (error) {
        console.error('仇 Error al cargar carpeta:', error);
        
        if (error.name === 'AbortError') {
          console.log('좶잺 Usuario cancel칩 la selecci칩n');
        }
      } finally {
        // Re-enable button
        btn.disabled = false;
        btn.textContent = '游늬 Seleccionar Carpeta de M칰sica';
      }
    }

    async function loadFilesFromDirectoryHandle(dirHandle) {
      const audioFiles = [];
      
      for await (const entry of dirHandle.values()) {
        if (entry.kind === 'file') {
          const file = await entry.getFile();
          if (file.type.startsWith('audio/')) {
            audioFiles.push(file);
          }
        }
      }
      
      await processMusicFiles(audioFiles);
    }

    function loadMusicFromFolder(event) {
      const files = Array.from(event.target.files).filter(file => file.type.startsWith('audio/'));
      processMusicFiles(files);
    }

    async function processMusicFiles(files) {
      console.log(`游늬 Procesando ${files.length} archivos...`);
      
      // Create loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-indicator';
      loadingDiv.id = 'musicLoadingIndicator';
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <p>Cargando canciones... <span id="progress-count">0/${files.length}</span></p>
      `;
      document.body.appendChild(loadingDiv);
      
      // Clear existing library
      songsLibrary = [];
      let processed = 0;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // Only process audio files
        if (!file.type.startsWith('audio/')) {
          console.log('낈勇 Saltando archivo no-audio:', file.name);
          continue;
        }
        
        try {
          const songData = await extractMetadata(file);
          const song = {
            id: nextSongId++,
            title: songData.title || file.name.replace(/\.[^/.]+$/, ''),
            artist: songData.artist || 'Artista Desconocido',
            album: songData.album || '츼lbum Desconocido',
            duration: songData.duration || 0,
            genre: songData.genre || 'Desconocido',
            type: 'local',
            blob: file,
            cover: songData.cover || null,
            fileName: file.name,
            youtubeUrl: null,
            youtubeId: null,
            eqSettings: null,
            isFavorite: false,
            playCount: 0,
            genres: [],
            moods: [],
            tags: [],
            autoTagged: false,
            taggedDate: null
          };
          
          songsLibrary.push(song);
          processed++;
          
          // Update progress counter
          const progressCount = document.getElementById('progress-count');
          if (progressCount) {
            progressCount.textContent = `${processed}/${files.length}`;
          }
          
          console.log(`九 ${processed}/${files.length}: ${song.title}`);
          
          // If no cover from metadata, try iTunes API (async, don't wait)
          if (!song.cover) {
            searchCoverArt(song.title, song.artist).then(coverUrl => {
              if (coverUrl) {
                song.cover = coverUrl;
                if (currentView === 'biblioteca') {
                  renderBiblioteca(document.getElementById('searchInput').value);
                }
              }
            });
          }
        } catch (error) {
          console.error('仇 Error procesando archivo:', file.name, error);
        }
      }
      
      // Remove loading indicator
      loadingDiv.remove();
      
      console.log(`九 Total de canciones cargadas: ${songsLibrary.length}`);
      
      // Show success alert
      if (songsLibrary.length === 0) {
        alert('丘멆잺 No se encontraron archivos de audio en la carpeta seleccionada.');
      } else {
        alert(`九 Se cargaron ${songsLibrary.length} canciones correctamente.`);
        
        // Auto-etiquetar todas las canciones reci칠n a침adidas
        // autoTagNewSongs();
      }
      
      // Populate filters and render biblioteca
      populateFilters();
      if (currentView === 'biblioteca') {
        renderBiblioteca(document.getElementById('searchInput').value);
      }
    }

    function extractMetadata(file) {
      return new Promise((resolve, reject) => {
        // Use jsmediatags to extract metadata
        window.jsmediatags.read(file, {
          onSuccess: (tag) => {
            const tags = tag.tags;
            const metadata = {
              title: tags.title || null,
              artist: tags.artist || null,
              album: tags.album || null,
              genre: tags.genre || null,
              duration: 0,
              cover: null
            };
            
            // Extract cover art
            if (tags.picture) {
              const picture = tags.picture;
              const base64String = (picture.data && Array.isArray(picture.data)) ? picture.data.reduce((acc, byte) => acc + String.fromCharCode(byte), '') : '';
              metadata.cover = `data:${picture.format};base64,${btoa(base64String)}`;
            }
            
            // Get duration using Audio element
            const audio = new Audio();
            audio.src = URL.createObjectURL(file);
            audio.addEventListener('loadedmetadata', () => {
              metadata.duration = Math.floor(audio.duration);
              URL.revokeObjectURL(audio.src);
              resolve(metadata);
            });
            audio.addEventListener('error', () => {
              URL.revokeObjectURL(audio.src);
              resolve(metadata);
            });
          },
          onError: (error) => {
            console.warn('Metadata extraction error:', error);
            // Still try to get duration
            const audio = new Audio();
            audio.src = URL.createObjectURL(file);
            audio.addEventListener('loadedmetadata', () => {
              const duration = Math.floor(audio.duration);
              URL.revokeObjectURL(audio.src);
              resolve({ duration });
            });
            audio.addEventListener('error', () => {
              URL.revokeObjectURL(audio.src);
              resolve({});
            });
          }
        });
      });
    }

    async function searchCoverArt(title, artist) {
      try {
        const searchTerm = encodeURIComponent(`${title} ${artist}`);
        const response = await fetch(`https://itunes.apple.com/search?term=${searchTerm}&entity=song&limit=1`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          // Get higher resolution artwork
          const artworkUrl = data.results[0].artworkUrl100;
          return artworkUrl.replace('100x100', '600x600');
        }
        return null;
      } catch (error) {
        console.error('iTunes API error:', error);
        return null;
      }
    }

    // Equalizer functions
    function openEqualizer() {
      if (!currentSong) {
        alert('Por favor, reproduce una canci칩n primero');
        return;
      }
      
      // Load current EQ settings into sliders
      currentEQSettings.forEach((value, index) => {
        document.getElementById(`eqSlider${index}`).value = value;
        document.getElementById(`eqValue${index}`).textContent = value >= 0 ? `+${value} dB` : `${value} dB`;
      });
      
      document.getElementById('equalizerModal').classList.add('active');
    }

    function closeEqualizer() {
      document.getElementById('equalizerModal').classList.remove('active');
    }

    function updateEQBand(bandIndex, value) {
      const numValue = parseFloat(value);
      currentEQSettings[bandIndex] = numValue;
      
      // Update display
      document.getElementById(`eqValue${bandIndex}`).textContent = numValue >= 0 ? `+${numValue} dB` : `${numValue} dB`;
      
      // Apply to audio filter
      if (eqFilters[bandIndex]) {
        eqFilters[bandIndex].gain.value = numValue;
      }
    }

    function applyEQSettings() {
      currentEQSettings.forEach((value, index) => {
        if (eqFilters[index]) {
          eqFilters[index].gain.value = value;
        }
      });
    }

    function applyEQPreset(presetName) {
      const preset = eqPresets[presetName];
      if (!preset) return;
      
      currentEQSettings = [...preset];
      
      // Update sliders and apply
      currentEQSettings.forEach((value, index) => {
        document.getElementById(`eqSlider${index}`).value = value;
        document.getElementById(`eqValue${index}`).textContent = value >= 0 ? `+${value} dB` : `${value} dB`;
        if (eqFilters[index]) {
          eqFilters[index].gain.value = value;
        }
      });
      
      // Highlight active preset
      document.querySelectorAll('.eq-preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function resetEQ() {
      applyEQPreset('flat');
    }

    function saveGlobalEQ() {
      globalEQSettings = [...currentEQSettings];
      alert('Configuraci칩n de ecualizador global guardada');
    }

    function saveEQForSong() {
      if (!currentSong) return;
      
      currentSong.eqSettings = [...currentEQSettings];
      alert(`Configuraci칩n de ecualizador guardada para "${currentSong.title}"`);
    }

    // Coming Soon modal functions
    function showComingSoon(featureName) {
      document.getElementById('featureName').textContent = featureName;
      document.getElementById('comingSoonModal').classList.add('active');
    }

    function closeComingSoonModal() {
      document.getElementById('comingSoonModal').classList.remove('active');
    }

    // Close modals on outside click
    document.getElementById('diaryModal').addEventListener('click', (e) => {
      if (e.target.id === 'diaryModal') {
        closeModal();
      }
    });

    document.getElementById('comingSoonModal').addEventListener('click', (e) => {
      if (e.target.id === 'comingSoonModal') {
        closeComingSoonModal();
      }
    });

    document.getElementById('createPlaylistModal').addEventListener('click', (e) => {
      if (e.target.id === 'createPlaylistModal') {
        closeCreatePlaylistModal();
      }
    });

    document.getElementById('addToPlaylistModal').addEventListener('click', (e) => {
      if (e.target.id === 'addToPlaylistModal') {
        closeAddToPlaylistModal();
      }
    });

    document.getElementById('equalizerModal').addEventListener('click', (e) => {
      if (e.target.id === 'equalizerModal') {
        closeEqualizer();
      }
    });
    
    document.getElementById('youtubeModal').addEventListener('click', (e) => {
      if (e.target.id === 'youtubeModal') {
        closeYouTubeModal();
      }
    });

    // Keyboard Shortcuts Handler
    document.addEventListener('keydown', (e) => {
      // Don't trigger if in input field
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        // Allow Escape to close modals even in inputs
        if (e.key === 'Escape') {
          closeAllModals();
        }
        return;
      }
      
      // Check if keyboard shortcuts are enabled
      if (!accessibilityState.keyboardShortcuts) return;
      
      // Handle keyboard shortcuts
      switch(e.key) {
        case ' ': // Space - Play/Pause
          e.preventDefault();
          togglePlayPause();
          break;
        case 'ArrowRight': // Next song
          e.preventDefault();
          nextSong();
          announce('Siguiente canci칩n');
          break;
        case 'ArrowLeft': // Previous song
          e.preventDefault();
          previousSong();
          announce('Canci칩n anterior');
          break;
        case 'ArrowUp': // Volume up
          e.preventDefault();
          adjustVolume(10);
          break;
        case 'ArrowDown': // Volume down
          e.preventDefault();
          adjustVolume(-10);
          break;
        case 'm':
        case 'M':
          e.preventDefault();
          toggleMute();
          break;
        case 'f':
        case 'F':
          e.preventDefault();
          if (currentSong) {
            toggleFavorite(currentSong.id);
            announce(currentSong.isFavorite ? 'A침adido a favoritos' : 'Quitado de favoritos');
          }
          break;
        case 'l':
        case 'L':
          e.preventDefault();
          switchView('biblioteca');
          announce('Vista de Biblioteca');
          break;
        case 'p':
        case 'P':
          e.preventDefault();
          switchView('playlists');
          announce('Vista de Playlists');
          break;
        case 'c':
        case 'C':
          e.preventDefault();
          switchView('calendario');
          announce('Vista de Calendario');
          break;
        case 'a':
        case 'A':
          e.preventDefault();
          openAccessibilityPanel();
          break;
        case '?':
          e.preventDefault();
          showShortcutsGuide();
          break;
        case 'Escape':
          closeAllModalsAndMenus();
          break;
      }
    });

    // Volume adjustment helper
    function adjustVolume(delta) {
      const volumeSlider = document.getElementById('volumeSlider');
      let newVolume = parseInt(volumeSlider.value) + delta;
      newVolume = Math.max(0, Math.min(100, newVolume));
      volumeSlider.value = newVolume;
      changeVolume(newVolume);
      announce(`Volumen: ${newVolume}%`);
    }

    // Close all modals helper
    function closeAllModals() {
      closeModal();
      closeCreatePlaylistModal();
      closeAddToPlaylistModal();
      closeComingSoonModal();
      closeEqualizer();
      closeAccessibilityPanel();
      closeShortcutsGuide();
      closeYouTubeModal();
      closeGenreModal();
      closeMoodModal();
      closeCustomTagModal();
    }
    
    // Close all modals and context menus
    function closeAllModalsAndMenus() {
      closeAllModals();
      
      // Tambi칠n cerrar men칰 contextual si est치 abierto
      const menu = document.querySelector('.quick-add-menu');
      if (menu) menu.remove();
    }
    
    // Tag Management Functions
    let currentSongForTag = null;
    let currentTagType = null;
    
    // Mostrar men칰 contextual al hacer clic en +
    window.showQuickAddMenu = function(songId, event) {
      event.stopPropagation();
      
      // Eliminar men칰 anterior si existe
      const existingMenu = document.querySelector('.quick-add-menu');
      if (existingMenu) existingMenu.remove();
      
      currentSongForTag = songId;
      
      // Crear men칰 contextual
      const menu = document.createElement('div');
      menu.className = 'quick-add-menu';
      menu.dataset.songId = songId;
      
      menu.innerHTML = `
        <div class="quick-menu-option" onclick="openAddGenreModal(${songId})">
          <span class="menu-icon">游꿪</span>
          <span class="menu-text">A침adir g칠nero</span>
        </div>
        <div class="quick-menu-option" onclick="openAddMoodModal(${songId})">
          <span class="menu-icon">游눪</span>
          <span class="menu-text">A침adir emoci칩n</span>
        </div>
        <div class="quick-menu-option" onclick="openAddCustomTagModal(${songId})">
          <span class="menu-icon">游댔</span>
          <span class="menu-text">A침adir etiqueta</span>
        </div>
      `;
      
      // Obtener posici칩n del bot칩n +
      const button = event.target.closest('.tag-add-compact');
      const buttonRect = button.getBoundingClientRect();
      
      // A침adir al DOM
      document.body.appendChild(menu);
      
      // Funci칩n para posicionar el men칰
      function positionMenu() {
        const newButtonRect = button.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();
        
        let top = newButtonRect.bottom + 5;
        let left = newButtonRect.left;
        
        // Ajustar si se sale por la derecha
        if (left + menuRect.width > window.innerWidth) {
          left = window.innerWidth - menuRect.width - 10;
        }
        
        // Ajustar si se sale por abajo
        if (top + menuRect.height > window.innerHeight) {
          top = newButtonRect.top - menuRect.height - 5;
        }
        
        menu.style.top = `${top}px`;
        menu.style.left = `${left}px`;
      }
      
      // Posicionar inicialmente
      positionMenu();
      
      // Actualizar posici칩n al hacer scroll
      const mainContent = document.querySelector('.main-content');
      const scrollContainer = mainContent || window;
      
      function updatePosition() {
        // Verificar si el bot칩n sigue visible
        const rect = button.getBoundingClientRect();
        if (rect.top < 0 || rect.bottom > window.innerHeight || 
            rect.left < 0 || rect.right > window.innerWidth) {
          menu.remove();
          if (scrollContainer === mainContent) {
            scrollContainer.removeEventListener('scroll', updatePosition);
          } else {
            window.removeEventListener('scroll', updatePosition);
          }
          return;
        }
        positionMenu();
      }
      
      if (scrollContainer === mainContent) {
        scrollContainer.addEventListener('scroll', updatePosition);
      } else {
        window.addEventListener('scroll', updatePosition);
      }
      
      // Cerrar al hacer clic fuera
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target) && !button.contains(e.target)) {
            menu.remove();
            if (scrollContainer === mainContent) {
              scrollContainer.removeEventListener('scroll', updatePosition);
            } else {
              window.removeEventListener('scroll', updatePosition);
            }
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 100);
    };
    
    // Funciones para abrir modales que cierran el men칰 contextual
    window.openAddGenreModal = function(songId) {
      // Cerrar men칰 contextual
      const menu = document.querySelector('.quick-add-menu');
      if (menu) menu.remove();
      
      currentSongForTag = songId;
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      showGenreModal(song);
    };

    window.openAddMoodModal = function(songId) {
      // Cerrar men칰 contextual
      const menu = document.querySelector('.quick-add-menu');
      if (menu) menu.remove();
      
      currentSongForTag = songId;
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      showMoodModal(song);
    };

    window.openAddCustomTagModal = function(songId) {
      // Cerrar men칰 contextual
      const menu = document.querySelector('.quick-add-menu');
      if (menu) menu.remove();
      
      currentSongForTag = songId;
      const modal = document.getElementById('add-custom-tag-modal');
      modal.classList.add('active');
      document.getElementById('custom-tag-input').value = '';
      document.getElementById('custom-tag-input').focus();
      announce('Modal de a침adir etiqueta personalizada abierta');
    };
    
    // Mostrar modal para a침adir g칠nero o emoci칩n
    window.showAddTagModal = function(songId, type) {
      // Cerrar cualquier modal abierto
      closeAllModalsAndMenus();
      
      currentSongForTag = songId;
      currentTagType = type;
      
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      if (type === 'genre') {
        showGenreModal(song);
      } else if (type === 'mood') {
        showMoodModal(song);
      }
    };
    
    function showGenreModal(song) {
      // Cerrar otros modales primero
      closeAllModalsAndMenus();
      
      const modal = document.getElementById('add-genre-modal');
      const predefinedContainer = document.getElementById('genre-predefined-tags');
      
      predefinedContainer.innerHTML = '';
      
      // Mostrar g칠neros disponibles (excluyendo los que ya tiene)
      MUSIC_GENRES.forEach(genre => {
        if (!song.genres || !song.genres.includes(genre)) {
          const btn = document.createElement('button');
          btn.className = 'predefined-tag-btn';
          btn.textContent = genre;
          btn.onclick = () => addGenreToSong(currentSongForTag, genre);
          predefinedContainer.appendChild(btn);
        }
      });
      
      modal.classList.add('active');
      document.getElementById('custom-genre-input').value = '';
      announce('Modal de a침adir g칠nero abierta');
    }
    
    function showMoodModal(song) {
      // Cerrar otros modales primero
      closeAllModalsAndMenus();
      
      const modal = document.getElementById('add-mood-modal');
      const predefinedContainer = document.getElementById('mood-predefined-tags');
      
      predefinedContainer.innerHTML = '';
      
      // Mostrar emociones disponibles (excluyendo las que ya tiene)
      MUSIC_MOODS.forEach(mood => {
        if (!song.moods || !song.moods.includes(mood)) {
          const btn = document.createElement('button');
          btn.className = 'predefined-tag-btn';
          btn.textContent = mood;
          btn.onclick = () => addMoodToSong(currentSongForTag, mood);
          predefinedContainer.appendChild(btn);
        }
      });
      
      modal.classList.add('active');
      document.getElementById('custom-mood-input').value = '';
      announce('Modal de a침adir emoci칩n abierta');
    }
    

    
    // A침adir g칠nero
    function addGenreToSong(songId, genre) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      if (!song.genres) song.genres = [];
      
      if (!song.genres.includes(genre)) {
        song.genres.push(genre);
        renderBiblioteca(document.getElementById('searchInput').value);
        announce(`G칠nero "${genre}" a침adido`);
        console.log(`九 G칠nero a침adido: ${genre} a "${song.title}"`);
      }
      
      closeGenreModal();
    }
    
    // A침adir emoci칩n
    function addMoodToSong(songId, mood) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      if (!song.moods) song.moods = [];
      
      if (!song.moods.includes(mood)) {
        song.moods.push(mood);
        renderBiblioteca(document.getElementById('searchInput').value);
        announce(`Emoci칩n "${mood}" a침adida`);
        console.log(`九 Emoci칩n a침adida: ${mood} a "${song.title}"`);
      }
      
      closeMoodModal();
    }
    
    // A침adir etiqueta personalizada
    function addCustomTagToSong(songId, tag) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      if (!song.tags) song.tags = [];
      
      if (!song.tags.includes(tag)) {
        song.tags.push(tag);
        renderBiblioteca(document.getElementById('searchInput').value);
        announce(`Etiqueta "${tag}" a침adida`);
        console.log(`九 Etiqueta a침adida: ${tag} a "${song.title}"`);
      }
      
      closeCustomTagModal();
    }
    
    // Eliminar g칠nero
    window.removeTag = function(songId, type, value) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song) return;
      
      if (type === 'genre' && song.genres) {
        song.genres = song.genres.filter(g => g !== value);
        renderBiblioteca(document.getElementById('searchInput').value);
        announce(`G칠nero "${value}" eliminado`);
        console.log(`仇 G칠nero eliminado: ${value}`);
      }
    };
    
    // Eliminar emoci칩n
    window.removeMood = function(songId, mood) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song || !song.moods) return;
      
      song.moods = song.moods.filter(m => m !== mood);
      renderBiblioteca(document.getElementById('searchInput').value);
      announce(`Emoci칩n "${mood}" eliminada`);
      console.log(`仇 Emoci칩n eliminada: ${mood}`);
    };
    
    // Eliminar etiqueta personalizada
    window.removeCustomTag = function(songId, tag) {
      const song = songsLibrary.find(s => s.id === songId);
      if (!song || !song.tags) return;
      
      song.tags = song.tags.filter(t => t !== tag);
      renderBiblioteca(document.getElementById('searchInput').value);
      announce(`Etiqueta "${tag}" eliminada`);
      console.log(`仇 Etiqueta eliminada: ${tag}`);
    };
    
    // Cerrar modales
    function closeGenreModal() {
      document.getElementById('add-genre-modal').classList.remove('active');
      announce('Modal cerrada');
    }
    
    function closeMoodModal() {
      document.getElementById('add-mood-modal').classList.remove('active');
      announce('Modal cerrada');
    }
    
    function closeCustomTagModal() {
      document.getElementById('add-custom-tag-modal').classList.remove('active');
      announce('Modal cerrada');
    }
    
    // Event listeners para modales de etiquetas
    document.addEventListener('DOMContentLoaded', () => {
      // G칠nero personalizado
      const addCustomGenreBtn = document.getElementById('add-custom-genre-btn');
      if (addCustomGenreBtn) {
        addCustomGenreBtn.addEventListener('click', () => {
          const input = document.getElementById('custom-genre-input');
          const genre = input.value.trim();
          
          if (genre) {
            addGenreToSong(currentSongForTag, genre);
          }
        });
      }
      
      // Emoci칩n personalizada
      const addCustomMoodBtn = document.getElementById('add-custom-mood-btn');
      if (addCustomMoodBtn) {
        addCustomMoodBtn.addEventListener('click', () => {
          const input = document.getElementById('custom-mood-input');
          const mood = input.value.trim();
          
          if (mood) {
            addMoodToSong(currentSongForTag, mood);
          }
        });
      }
      
      // Etiqueta personalizada
      const addCustomTagBtn = document.getElementById('add-custom-tag-btn');
      if (addCustomTagBtn) {
        addCustomTagBtn.addEventListener('click', () => {
          const input = document.getElementById('custom-tag-input');
          const tag = input.value.trim();
          
          if (tag) {
            addCustomTagToSong(currentSongForTag, tag);
          }
        });
      }
      
      // Enter para a침adir
      const customGenreInput = document.getElementById('custom-genre-input');
      if (customGenreInput) {
        customGenreInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('add-custom-genre-btn').click();
          }
        });
      }
      
      const customMoodInput = document.getElementById('custom-mood-input');
      if (customMoodInput) {
        customMoodInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('add-custom-mood-btn').click();
          }
        });
      }
      
      const customTagInput = document.getElementById('custom-tag-input');
      if (customTagInput) {
        customTagInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('add-custom-tag-btn').click();
          }
        });
      }
      
      // Close modals on outside click
      document.getElementById('add-genre-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-genre-modal') {
          closeGenreModal();
        }
      });
      
      document.getElementById('add-mood-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-mood-modal') {
          closeMoodModal();
        }
      });
      
      document.getElementById('add-custom-tag-modal').addEventListener('click', (e) => {
        if (e.target.id === 'add-custom-tag-modal') {
          closeCustomTagModal();
        }
      });
    });
    
    // Initialize tag event listeners after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTagEventListeners);
    } else {
      initTagEventListeners();
    }
    
    function initTagEventListeners() {
      console.log('九 Tag management system initialized');
    }

    // Focus trap for modals
    function trapFocus(e, container) {
      const focusableElements = container.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusableElements.length === 0) return;
      
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            lastElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastElement) {
            firstElement.focus();
            e.preventDefault();
          }
        }
      }
    }

    // Add focus trap to modals
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('keydown', (e) => {
        trapFocus(e, modal);
      });
    });

    // Initialize on load
    init();


      // ===== CARGA AUTOM츼TICA DE M칔SICA =====
      async function loadMusicFromFolder() {
        try {
          console.log('游늭 Intentando cargar manifest.json...');
          const response = await fetch('./musica/manifest.json');

          if (!response.ok) {
            console.warn('丘멆잺 manifest.json no encontrado:', response.status);
            return;
          }

          const manifest = await response.json();
          console.log(`游늬 ${manifest.songs.length} canciones en manifest.json`);

          for (const filename of manifest.songs) {
            const song = {
              id: Date.now() + Math.random(),
              title: filename.replace(/\.mp3$/, '').replace(/_/g, ' '),
              artist: 'Artista Desconocido',
              album: 'M칰sica Local',
              duration: 0,
              type: 'local',
              url: `./musica/${filename}`,
              fileName: filename,
              isFavorite: false,
              playCount: 0,
              genre: 'Desconocido',
              mood: 'neutral',
              tags: ['local'],
              genres: [],
              moods: [],
              autoTagged: false
            };

            songsLibrary.push(song);
            console.log(`九 A침adida: ${song.title}`);
          }

          if (typeof populateFilters === 'function') populateFilters();
          if (typeof renderBiblioteca === 'function') renderBiblioteca();
          if (typeof saveData === 'function') saveData();

          console.log(`九 Total cargadas: ${manifest.songs.length} canciones`);

        } catch (error) {
          console.error('仇 Error al cargar:', error);
        }
      }

      // Ejecutar despu칠s de que TODO est칠 listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(loadMusicFromFolder, 2000);
        });
      } else {
        setTimeout(loadMusicFromFolder, 2000);
      }

      </script>
</body>
</html>
