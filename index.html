<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproductor Musical Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
/* DESIGN SYSTEM */
:root {
  --color-white: #fff; --color-black: #000; --color-cream-50: #fcfcf9;
  --color-gray-200: #f5f5f5; --color-gray-300: #a7a9a9; --color-slate-500: #626c71;
  --color-brown-600: #5e5240; --color-charcoal-700: #1f2121; --color-charcoal-800: #262828;
  --color-slate-900: #13343b; --color-teal-300: #32b8c6; --color-teal-500: #21808d;
  --color-teal-600: #1d7480; --color-red-400: #ff5459; --color-orange-400: #e68161;
  --color-brown-600-rgb: 94, 82, 64; --color-teal-500-rgb: 33, 128, 141;
  --color-background: var(--color-cream-50); --color-surface: #f0f0f0;
  --color-text: var(--color-slate-900); --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500); --color-primary-hover: var(--color-teal-600);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --font-family-base: "Inter", -apple-system, sans-serif; --font-size-xs: 11px;
  --font-size-sm: 12px; --font-size-base: 14px; --font-size-lg: 16px;
  --font-size-xl: 18px; --space-4: 4px; --space-8: 8px; --space-12: 12px;
  --space-16: 16px; --space-20: 20px; --space-24: 24px; --radius-sm: 6px;
  --radius-md: 10px; --radius-lg: 14px; --shadow-md: 0 4px 6px rgba(0,0,0,.07);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-family-base); background: var(--color-background);
  color: var(--color-text); font-size: var(--font-size-base); overflow-x: hidden; }

.app-container { display: grid; grid-template-columns: 220px 1fr;
  grid-template-rows: auto 1fr auto; height: 100vh; gap: 0; }
.sidebar { grid-column: 1; grid-row: 1 / 3; background: var(--color-surface);
  border-right: 1px solid var(--color-border); padding: var(--space-16);
  overflow-y: auto; }
.topbar { grid-column: 2; grid-row: 1; background: var(--color-white);
  border-bottom: 1px solid var(--color-border); padding: var(--space-16) var(--space-24);
  display: flex; align-items: center; gap: var(--space-12); height: 60px; }
.main-content { grid-column: 2; grid-row: 2; overflow-y: auto;
  padding: var(--space-24); }
.mini-player { grid-column: 1 / 3; grid-row: 3; background: var(--color-charcoal-800);
  color: var(--color-white); padding: var(--space-12) var(--space-20);
  display: none; align-items: center; gap: var(--space-16);
  box-shadow: 0 -4px 12px rgba(0,0,0,.2); }
.mini-player.active { display: flex; }

.sidebar-item { width: 100%; padding: var(--space-8) var(--space-12);
  border: none; background: transparent; color: var(--color-text);
  text-align: left; font-size: var(--font-size-sm); border-radius: var(--radius-sm);
  cursor: pointer; transition: 0.15s ease; }
.sidebar-item:hover { background: var(--color-secondary); }
.sidebar-item.active { background: var(--color-primary);
  color: var(--color-white); font-weight: 500; }

.btn { padding: var(--space-8) var(--space-16); border: none;
  border-radius: var(--radius-sm); cursor: pointer; font-size: var(--font-size-sm);
  font-weight: 500; transition: 0.15s ease; }
.btn-primary { background: var(--color-primary); color: var(--color-white); }
.btn-primary:hover { background: var(--color-primary-hover); }
.btn-secondary { background: var(--color-secondary); color: var(--color-text); }

.song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: var(--space-16); }
.song-card { background: var(--color-white); border: 1px solid var(--color-border);
  border-radius: var(--radius-md); padding: var(--space-12); cursor: pointer;
  transition: 0.15s ease; position: relative; }
.song-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.song-card-cover { width: 100%; aspect-ratio: 1;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(245, 158, 11, 0.1));
  border-radius: var(--radius-sm); display: flex; align-items: center;
  justify-content: center; font-size: 32px; margin-bottom: var(--space-8); }
.song-card-title { font-size: var(--font-size-sm); font-weight: 600;
  margin-bottom: var(--space-4); overflow: hidden; text-overflow: ellipsis;
  white-space: nowrap; }
.song-card-artist { font-size: var(--font-size-xs); color: var(--color-text-secondary);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.song-type-badge { position: absolute; top: var(--space-8); right: var(--space-8);
  padding: 2px 6px; border-radius: var(--radius-sm); font-size: 10px; font-weight: 600; }
.song-type-badge.cloud { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
.song-type-badge.local { background: rgba(245, 158, 11, 0.15); color: #d97706; }
.song-type-badge.youtube { background: rgba(239, 68, 68, 0.15); color: #dc2626; }

.player-info { flex: 1; min-width: 0; }
.player-title { font-size: var(--font-size-base); font-weight: 600;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.player-artist { font-size: var(--font-size-xs); color: var(--color-gray-300);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.player-controls { display: flex; align-items: center; gap: var(--space-12); }
.player-btn { background: rgba(255,255,255,0.1); border: none; color: var(--color-white);
  padding: var(--space-8) var(--space-12); border-radius: var(--radius-sm);
  cursor: pointer; font-size: var(--font-size-base); transition: 0.15s ease; }
.player-btn:hover { background: rgba(255,255,255,0.2); }
.player-btn.active { background: var(--color-primary); }
.progress-container { flex: 2; display: flex; align-items: center; gap: var(--space-8); }
.progress-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.2);
  border-radius: 999px; cursor: pointer; position: relative; }
.progress-fill { height: 100%; background: var(--color-primary);
  border-radius: 999px; }
.time-display { font-size: var(--font-size-xs); color: var(--color-gray-300);
  min-width: 40px; }

.modal { display: none; position: fixed; top: 0; left: 0; width: 100%;
  height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;
  align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: var(--color-white); border-radius: var(--radius-lg);
  width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
  box-shadow: 0 10px 20px rgba(0,0,0,.1); }
.modal-header { padding: var(--space-20); border-bottom: 1px solid var(--color-border);
  display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: var(--font-size-xl); font-weight: 600; }
.close-button { background: transparent; border: none; font-size: 20px;
  cursor: pointer; color: var(--color-text-secondary); }
.modal-body { padding: var(--space-20); }
.modal-footer { padding: var(--space-20); border-top: 1px solid var(--color-border);
  display: flex; justify-content: flex-end; gap: var(--space-12); }

.form-group { margin-bottom: var(--space-16); }
.form-label { display: block; font-size: var(--font-size-sm); font-weight: 500;
  margin-bottom: var(--space-4); }
.text-input { width: 100%; padding: var(--space-8) var(--space-12);
  border: 1px solid var(--color-border); border-radius: var(--radius-sm);
  font-size: var(--font-size-sm); }
.text-input:focus { outline: none; border-color: var(--color-primary); }

.view-container { display: none; }
.view-container.active { display: block; }

.playlist-item { background: var(--color-white); border: 1px solid var(--color-border);
  border-radius: var(--radius-md); padding: var(--space-16); margin-bottom: var(--space-12);
  cursor: pointer; transition: 0.15s ease; }
.playlist-item:hover { box-shadow: var(--shadow-md); }
.playlist-name { font-size: var(--font-size-lg); font-weight: 600;
  margin-bottom: var(--space-4); }
.playlist-count { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.playlist-song-item { padding: var(--space-8); background: var(--color-gray-200);
  border-radius: var(--radius-sm); display: flex; justify-content: space-between;
  align-items: center; margin-bottom: var(--space-8); }

.context-menu { position: fixed; background: var(--color-white);
  border: 1px solid var(--color-border); border-radius: var(--radius-md);
  box-shadow: 0 10px 25px rgba(0,0,0,.1); padding: var(--space-4);
  z-index: 1001; display: none; min-width: 200px; }
.context-menu.active { display: block; }
.context-menu-item { padding: var(--space-8) var(--space-12); border: none;
  background: transparent; width: 100%; text-align: left;
  font-size: var(--font-size-sm); cursor: pointer; border-radius: var(--radius-sm);
  display: flex; align-items: center; gap: var(--space-8); }
.context-menu-item:hover { background: var(--color-secondary); }

#youtube-player-container { position: fixed; bottom: 100px; right: 20px;
  width: 480px; height: 270px; opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease; z-index: 100; border-radius: var(--radius-md);
  overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,.2); }
#youtube-player-container.visible { opacity: 1; pointer-events: auto; }

  </style>
</head>
<body>

<div class="app-container">

  <div class="sidebar">
    <div style="margin-bottom: var(--space-24);">
      <button class="sidebar-item active" data-view="songs">üéµ Canciones</button>
      <button class="sidebar-item" data-view="playlists">üéß Playlists</button>
      <button class="sidebar-item" data-view="favorites">‚≠ê Favoritos</button>
    </div>
    <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" id="add-local-btn">üìÅ A√±adir Local</button>
    <button class="btn btn-primary" style="width: 100%;" id="add-youtube-btn">‚ñ∂Ô∏è YouTube</button>
  </div>

  <div class="topbar">
    <input type="text" class="text-input" id="search-input" placeholder="Buscar canciones..." style="flex: 1; max-width: 400px;">
  </div>

  <div class="main-content">
    <div class="view-container active" id="songs-view">
      <div class="song-grid" id="songs-list"></div>
    </div>

    <div class="view-container" id="playlists-view">
      <button class="btn btn-primary" style="margin-bottom: 16px;" id="create-playlist-btn">‚ûï Nueva Playlist</button>
      <div id="playlists-list"></div>
    </div>

    <div class="view-container" id="favorites-view">
      <div class="song-grid" id="favorites-list"></div>
    </div>
  </div>

  <div class="mini-player" id="mini-player">
    <div class="player-info">
      <div class="player-title" id="player-title">Sin canci√≥n</div>
      <div class="player-artist" id="player-artist">-</div>
    </div>
    <div class="player-controls">
      <button class="player-btn" id="shuffle-btn" title="Aleatorio">üîÄ</button>
      <button class="player-btn" id="prev-btn">‚èÆÔ∏è</button>
      <button class="player-btn" id="play-btn">‚ñ∂Ô∏è</button>
      <button class="player-btn" id="next-btn">‚è≠Ô∏è</button>
      <button class="player-btn" id="youtube-toggle-btn" style="display: none;">üì∫</button>
    </div>
    <div class="progress-container">
      <span class="time-display" id="current-time">0:00</span>
      <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <span class="time-display" id="duration-time">0:00</span>
    </div>
    <div style="display: flex; align-items: center; gap: var(--space-8);">
      <span>üîä</span>
      <input type="range" id="volume-slider" min="0" max="100" value="70" style="width: 80px;">
    </div>
  </div>

  <audio id="audio-player"></audio>
  <div id="youtube-player-container"></div>

</div>

<!-- MODALES -->
<div class="modal" id="youtube-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üåê A√±adir desde YouTube</h3>
      <button class="close-button" onclick="closeModal('youtube-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">URL de YouTube:</label>
        <input type="text" id="youtube-url" class="text-input" placeholder="https://youtube.com/watch?v=...">
      </div>
      <div class="form-group">
        <label class="form-label">T√≠tulo:</label>
        <input type="text" id="youtube-title" class="text-input">
      </div>
      <div class="form-group">
        <label class="form-label">Artista:</label>
        <input type="text" id="youtube-artist" class="text-input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('youtube-modal')">Cancelar</button>
      <button class="btn btn-primary" id="save-youtube-btn">Guardar</button>
    </div>
  </div>
</div>

<div class="modal" id="create-playlist-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">‚ûï Nueva Playlist</h3>
      <button class="close-button" onclick="closeModal('create-playlist-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre:</label>
        <input type="text" id="playlist-name" class="text-input" placeholder="Mi playlist">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('create-playlist-modal')">Cancelar</button>
      <button class="btn btn-primary" id="save-playlist-btn">Crear</button>
    </div>
  </div>
</div>

<div class="modal" id="view-playlist-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="playlist-modal-title">Playlist</h3>
      <button class="close-button" onclick="closeModal('view-playlist-modal')">&times;</button>
    </div>
    <div class="modal-body">
      <div id="playlist-modal-songs"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('view-playlist-modal')">Cerrar</button>
      <button class="btn btn-primary" id="play-playlist-btn">‚ñ∂Ô∏è Reproducir</button>
    </div>
  </div>
</div>

<div class="context-menu" id="context-menu">
  <button class="context-menu-item" id="ctx-add-to-playlist">üéß A√±adir a playlist</button>
  <button class="context-menu-item" id="ctx-toggle-fav">‚≠ê Favorito</button>
  <div style="height: 1px; background: var(--color-border); margin: 4px 0;"></div>
  <button class="context-menu-item" id="ctx-delete">üóëÔ∏è Eliminar</button>
</div>

<div class="context-menu" id="playlist-submenu"></div>

<script>
// ============ UTILITIES ============
const U = {
  q: id => document.getElementById(id),
  formatTime: sec => {
    if (!sec || isNaN(sec)) return '0:00';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  }
};

function openModal(id) { U.q(id).classList.add('active'); }
function closeModal(id) { U.q(id).classList.remove('active'); }

// ============ APP STATE ============
const app = {
  songs: [],
  playlists: [],
  currentSong: null,
  currentIndex: 0,
  isPlaying: false,
  isShuffleMode: false,
  shuffleQueue: [],
  currentPlaylist: null,
  youtubePlayer: null,
  contextSongId: null
};

// ============ LOAD/SAVE ============
function saveData() {
  const data = {
    songs: app.songs.map(s => ({
      id: s.id, name: s.name, title: s.title, artist: s.artist,
      album: s.album, genre: s.genre, type: s.type, url: s.url, favorite: s.favorite
    })),
    playlists: app.playlists
  };
  localStorage.setItem('musicAppData', JSON.stringify(data));
}

function loadData() {
  const saved = localStorage.getItem('musicAppData');
  if (saved) {
    const data = JSON.parse(saved);
    app.songs = data.songs || [];
    app.playlists = data.playlists || [];
  }
}

async function loadMusicFolder() {
  try {
    const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
    for await (const entry of handle.values()) {
      if (entry.kind === 'file' && /\.(mp3|wav|ogg)$/i.test(entry.name)) {
        const existing = app.songs.find(s => s.name === entry.name && s.type === 'local');
        if (!existing) {
          const file = await entry.getFile();
          const song = {
            id: Date.now() + Math.random(),
            name: entry.name,
            title: entry.name.replace(/\.(mp3|wav|ogg)$/i, ''),
            artist: 'Desconocido',
            album: '',
            genre: '',
            type: 'local',
            blob: file,
            favorite: false
          };
          await extractMetadata(song);
          app.songs.push(song);
        }
      }
    }
    saveData();
    renderSongs();
  } catch (e) {
    console.log('Selecci√≥n de carpeta cancelada');
  }
}

async function extractMetadata(song) {
  if (!song.blob) return;
  return new Promise((resolve) => {
    jsmediatags.read(song.blob, {
      onSuccess: (tag) => {
        if (tag.tags.title) song.title = tag.tags.title;
        if (tag.tags.artist) song.artist = tag.tags.artist;
        if (tag.tags.album) song.album = tag.tags.album;
        if (tag.tags.genre) song.genre = tag.tags.genre;
        resolve();
      },
      onError: () => resolve()
    });
  });
}

// ============ RENDER ============
function renderSongs() {
  const container = U.q('songs-list');
  const searchTerm = U.q('search-input').value.toLowerCase();
  const filtered = app.songs.filter(s =>
    !searchTerm || s.title.toLowerCase().includes(searchTerm) || s.artist.toLowerCase().includes(searchTerm)
  );

  container.innerHTML = filtered.map(s => `
    <div class="song-card" data-id="${s.id}" oncontextmenu="showContextMenu(event, ${s.id}); return false;">
      <div class="song-type-badge ${s.type}">${s.type === 'cloud' ? '‚òÅÔ∏è' : s.type === 'local' ? 'üíø' : '‚ñ∂Ô∏è'}</div>
      <div class="song-card-cover">${s.favorite ? '‚≠ê' : 'üéµ'}</div>
      <div class="song-card-title" title="${s.title}">${s.title}</div>
      <div class="song-card-artist" title="${s.artist}">${s.artist}</div>
    </div>
  `).join('');

  container.querySelectorAll('.song-card').forEach(card => {
    card.addEventListener('click', () => playSong(parseInt(card.dataset.id)));
  });
}

function renderFavorites() {
  const container = U.q('favorites-list');
  const favs = app.songs.filter(s => s.favorite);

  if (favs.length === 0) {
    container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 40px;">No hay favoritos</p>';
    return;
  }

  container.innerHTML = favs.map(s => `
    <div class="song-card" data-id="${s.id}" oncontextmenu="showContextMenu(event, ${s.id}); return false;">
      <div class="song-type-badge ${s.type}">${s.type === 'cloud' ? '‚òÅÔ∏è' : s.type === 'local' ? 'üíø' : '‚ñ∂Ô∏è'}</div>
      <div class="song-card-cover">‚≠ê</div>
      <div class="song-card-title" title="${s.title}">${s.title}</div>
      <div class="song-card-artist" title="${s.artist}">${s.artist}</div>
    </div>
  `).join('');

  container.querySelectorAll('.song-card').forEach(card => {
    card.addEventListener('click', () => playSong(parseInt(card.dataset.id)));
  });
}

function renderPlaylists() {
  const container = U.q('playlists-list');

  if (app.playlists.length === 0) {
    container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center; padding: 40px;">Sin playlists</p>';
    return;
  }

  container.innerHTML = app.playlists.map(pl => `
    <div class="playlist-item" data-id="${pl.id}">
      <div class="playlist-name">üéß ${pl.name}</div>
      <div class="playlist-count">${pl.songs.length} canciones</div>
    </div>
  `).join('');

  container.querySelectorAll('.playlist-item').forEach(item => {
    item.addEventListener('click', () => viewPlaylist(parseInt(item.dataset.id)));
  });
}

function viewPlaylist(playlistId) {
  const playlist = app.playlists.find(pl => pl.id === playlistId);
  if (!playlist) return;

  app.currentPlaylist = playlist;
  U.q('playlist-modal-title').textContent = `üéß ${playlist.name}`;

  const container = U.q('playlist-modal-songs');
  if (playlist.songs.length === 0) {
    container.innerHTML = '<p style="color: var(--color-text-secondary);">Playlist vac√≠a</p>';
  } else {
    container.innerHTML = playlist.songs.map(songId => {
      const song = app.songs.find(s => s.id === songId);
      if (!song) return '';
      return `
        <div class="playlist-song-item">
          <div>
            <div style="font-weight: 600;">${song.title}</div>
            <div style="font-size: 12px; color: var(--color-text-secondary);">${song.artist}</div>
          </div>
          <button class="player-btn" onclick="playSong(${song.id})">‚ñ∂Ô∏è</button>
        </div>
      `;
    }).join('');
  }

  openModal('view-playlist-modal');
}

// ============ PLAYBACK ============
function playSong(id) {
  const song = app.songs.find(s => s.id === id);
  if (!song) return;

  app.currentSong = song;
  app.currentIndex = app.songs.indexOf(song);

  const audio = U.q('audio-player');
  audio.pause();
  audio.src = '';
  U.q('youtube-player-container').innerHTML = '';
  U.q('youtube-toggle-btn').style.display = 'none';

  U.q('player-title').textContent = song.title;
  U.q('player-artist').textContent = song.artist;
  U.q('play-btn').textContent = '‚è∏Ô∏è';
  U.q('mini-player').classList.add('active');
  app.isPlaying = true;

  if (song.type === 'youtube') {
    playYouTube(song);
  } else if (song.type === 'local' && song.blob) {
    const url = URL.createObjectURL(song.blob);
    audio.src = url;
    audio.play().catch(e => console.error('Error:', e));
  } else if (song.type === 'cloud' && song.url) {
    audio.src = song.url;
    audio.play().catch(e => console.error('Error:', e));
  }
}

function playYouTube(song) {
  const container = U.q('youtube-player-container');
  const videoId = extractYouTubeVideoId(song.url);
  if (!videoId) {
    alert('URL de YouTube inv√°lida');
    return;
  }

  container.innerHTML = '';
  const iframe = document.createElement('iframe');
  iframe.width = '100%';
  iframe.height = '100%';
  iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0&enablejsapi=1`;
  iframe.frameBorder = '0';
  iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
  iframe.allowFullscreen = true;

  container.appendChild(iframe);
  container.classList.add('visible');
  U.q('youtube-toggle-btn').style.display = 'block';

  // Cargar API de YouTube
  if (!window.YT) {
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
  }

  window.onYouTubeIframeAPIReady = () => {
    app.youtubePlayer = new YT.Player(iframe, {
      events: {
        'onStateChange': onYouTubePlayerStateChange
      }
    });
  };
}

function onYouTubePlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    playNext();
  }
}

function extractYouTubeVideoId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?/]+)/,
    /^([a-zA-Z0-9_-]{11})$/
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}

function togglePlayPause() {
  if (!app.currentSong) return;

  const audio = U.q('audio-player');

  if (app.currentSong.type === 'youtube') {
    if (app.youtubePlayer && app.youtubePlayer.getPlayerState) {
      const state = app.youtubePlayer.getPlayerState();
      if (state === YT.PlayerState.PLAYING) {
        app.youtubePlayer.pauseVideo();
        app.isPlaying = false;
        U.q('play-btn').textContent = '‚ñ∂Ô∏è';
      } else {
        app.youtubePlayer.playVideo();
        app.isPlaying = true;
        U.q('play-btn').textContent = '‚è∏Ô∏è';
      }
    }
  } else {
    if (app.isPlaying) {
      audio.pause();
      app.isPlaying = false;
      U.q('play-btn').textContent = '‚ñ∂Ô∏è';
    } else {
      audio.play().catch(e => console.error('Error:', e));
      app.isPlaying = true;
      U.q('play-btn').textContent = '‚è∏Ô∏è';
    }
  }
}

function playNext() {
  if (app.songs.length === 0) return;

  if (app.isShuffleMode) {
    if (app.shuffleQueue.length === 0) {
      app.shuffleQueue = [...Array(app.songs.length).keys()];
      for (let i = app.shuffleQueue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [app.shuffleQueue[i], app.shuffleQueue[j]] = [app.shuffleQueue[j], app.shuffleQueue[i]];
      }
    }
    const nextIndex = app.shuffleQueue.pop();
    const nextSong = app.songs[nextIndex];
    if (nextSong) playSong(nextSong.id);
  } else {
    app.currentIndex = (app.currentIndex + 1) % app.songs.length;
    const nextSong = app.songs[app.currentIndex];
    if (nextSong) playSong(nextSong.id);
  }
}

function playPrevious() {
  if (app.songs.length === 0) return;

  if (app.isShuffleMode) {
    const randomIndex = Math.floor(Math.random() * app.songs.length);
    const randomSong = app.songs[randomIndex];
    if (randomSong) playSong(randomSong.id);
  } else {
    app.currentIndex = (app.currentIndex - 1 + app.songs.length) % app.songs.length;
    const prevSong = app.songs[app.currentIndex];
    if (prevSong) playSong(prevSong.id);
  }
}

function toggleShuffle() {
  app.isShuffleMode = !app.isShuffleMode;
  const btn = U.q('shuffle-btn');
  btn.classList.toggle('active');
  U.q('shuffle-btn').style.background = app.isShuffleMode ? 'var(--color-primary)' : 'rgba(255,255,255,0.1)';
  app.shuffleQueue = [];
  console.log('üîÄ Shuffle:', app.isShuffleMode ? 'ON' : 'OFF');
}

function createPlaylist() {
  const name = U.q('playlist-name').value.trim();
  if (!name) {
    alert('Ingresa un nombre para la playlist');
    return;
  }

  app.playlists.push({ id: Date.now(), name: name, songs: [] });
  saveData();
  renderPlaylists();
  closeModal('create-playlist-modal');
  U.q('playlist-name').value = '';
  alert('Playlist creada');
}

function addSongToPlaylist(songId, playlistId) {
  const playlist = app.playlists.find(pl => pl.id === playlistId);
  if (!playlist) return;

  if (!playlist.songs.includes(songId)) {
    playlist.songs.push(songId);
    saveData();
    alert('Canci√≥n a√±adida a la playlist');
  } else {
    alert('La canci√≥n ya est√° en esta playlist');
  }
  hideContextMenu();
}

// ============ CONTEXT MENU ============
function showContextMenu(event, songId) {
  event.preventDefault();
  app.contextSongId = songId;

  const menu = U.q('context-menu');
  menu.classList.add('active');
  menu.style.left = event.pageX + 'px';
  menu.style.top = event.pageY + 'px';

  const song = app.songs.find(s => s.id === songId);
  if (song) {
    U.q('ctx-toggle-fav').textContent = song.favorite ? '‚òÖ Quitar de favoritos' : '‚≠ê A√±adir a favoritos';
  }
}

function hideContextMenu() {
  U.q('context-menu').classList.remove('active');
  U.q('playlist-submenu').classList.remove('active');
}

function showPlaylistSubmenu(event) {
  if (app.playlists.length === 0) {
    alert('Crea una playlist primero');
    return;
  }

  const submenu = U.q('playlist-submenu');
  const list = U.q('playlist-submenu');
  list.innerHTML = app.playlists.map(pl =>
    `<button class="context-menu-item" onclick="addSongToPlaylist(${app.contextSongId}, ${pl.id})">üéß ${pl.name}</button>`
  ).join('');

  const rect = event.target.getBoundingClientRect();
  submenu.classList.add('active');
  submenu.style.left = (rect.right + 5) + 'px';
  submenu.style.top = rect.top + 'px';
}

function toggleFav(id) {
  const song = app.songs.find(s => s.id === id);
  if (song) {
    song.favorite = !song.favorite;
    saveData();
    renderSongs();
    renderFavorites();
    hideContextMenu();
  }
}

function deleteSong(id) {
  if (!confirm('¬øEliminar canci√≥n?')) return;
  app.songs = app.songs.filter(s => s.id !== id);
  app.playlists.forEach(pl => {
    pl.songs = pl.songs.filter(sid => sid !== id);
  });
  saveData();
  renderSongs();
  renderFavorites();
  hideContextMenu();
}

function switchView(view) {
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));

  document.querySelector(`[data-view="${view}"]`).classList.add('active');
  U.q(`${view}-view`).classList.add('active');

  if (view === 'favorites') renderFavorites();
  if (view === 'playlists') renderPlaylists();
}

// ============ EVENT LISTENERS ============
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  renderSongs();

  // Sidebar
  document.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('click', () => switchView(item.dataset.view));
  });

  // Search
  U.q('search-input').addEventListener('input', renderSongs);

  // Player
  U.q('play-btn').addEventListener('click', togglePlayPause);
  U.q('next-btn').addEventListener('click', playNext);
  U.q('prev-btn').addEventListener('click', playPrevious);
  U.q('shuffle-btn').addEventListener('click', toggleShuffle);

  // Volume
  U.q('volume-slider').addEventListener('input', (e) => {
    U.q('audio-player').volume = e.target.value / 100;
  });

  // Progress bar
  U.q('progress-bar').addEventListener('click', (e) => {
    const audio = U.q('audio-player');
    if (app.currentSong && app.currentSong.type !== 'youtube') {
      const rect = e.currentTarget.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      audio.currentTime = percent * audio.duration;
    }
  });

  // Audio
  const audio = U.q('audio-player');
  audio.addEventListener('timeupdate', () => {
    if (app.currentSong && app.currentSong.type !== 'youtube') {
      const percent = (audio.currentTime / audio.duration) * 100;
      U.q('progress-fill').style.width = percent + '%';
      U.q('current-time').textContent = U.formatTime(audio.currentTime);
      U.q('duration-time').textContent = U.formatTime(audio.duration);
    }
  });

  audio.addEventListener('ended', playNext);

  // Add local
  U.q('add-local-btn').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'audio/*';
    input.onchange = async (e) => {
      for (const file of e.target.files) {
        const song = {
          id: Date.now() + Math.random(),
          name: file.name,
          title: file.name.replace(/\.(mp3|wav|ogg)$/i, ''),
          artist: 'Desconocido',
          album: '',
          genre: '',
          type: 'local',
          blob: file,
          favorite: false
        };
        await extractMetadata(song);
        app.songs.push(song);
      }
      saveData();
      renderSongs();
    };
    input.click();
  });

  // Add YouTube
  U.q('add-youtube-btn').addEventListener('click', () => openModal('youtube-modal'));

  U.q('save-youtube-btn').addEventListener('click', () => {
    const url = U.q('youtube-url').value.trim();
    const title = U.q('youtube-title').value.trim();
    const artist = U.q('youtube-artist').value.trim();

    if (!url || !title) {
      alert('Completa URL y T√≠tulo');
      return;
    }

    const song = {
      id: Date.now() + Math.random(),
      name: title,
      title: title,
      artist: artist || 'Desconocido',
      album: '',
      genre: '',
      type: 'youtube',
      url: url,
      favorite: false
    };

    app.songs.push(song);
    saveData();
    renderSongs();
    closeModal('youtube-modal');
    U.q('youtube-url').value = '';
    U.q('youtube-title').value = '';
    U.q('youtube-artist').value = '';
    alert('Video a√±adido a la librer√≠a');
  });

  // Playlists
  U.q('create-playlist-btn').addEventListener('click', () => openModal('create-playlist-modal'));
  U.q('save-playlist-btn').addEventListener('click', createPlaylist);
  U.q('play-playlist-btn').addEventListener('click', () => {
    if (!app.currentPlaylist || app.currentPlaylist.songs.length === 0) return;
    playSong(app.currentPlaylist.songs[0]);
    closeModal('view-playlist-modal');
  });

  // Context menu
  U.q('ctx-add-to-playlist').addEventListener('click', showPlaylistSubmenu);
  U.q('ctx-toggle-fav').addEventListener('click', () => toggleFav(app.contextSongId));
  U.q('ctx-delete').addEventListener('click', () => deleteSong(app.contextSongId));

  // YouTube toggle
  U.q('youtube-toggle-btn').addEventListener('click', () => {
    const container = U.q('youtube-player-container');
    container.classList.toggle('visible');
  });

  // Hide context menu on click elsewhere
  document.addEventListener('click', hideContextMenu);
});

</script>

</body>
</html>
