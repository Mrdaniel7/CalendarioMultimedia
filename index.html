<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Reproductor Musical Pro</title>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
Â  <style>
/* DESIGN SYSTEM COMPACTO */
:root {
Â  --color-white: #fff; --color-black: #000; --color-cream-50: #fcfcf9; --color-cream-100: #ffffd; --color-gray-200: #f5f5f5;
Â  --color-gray-300: #a7a9a9; --color-gray-400: #777c7c; --color-slate-500: #626c71; --color-brown-600: #5e5240;
Â  --color-charcoal-700: #1f2121; --color-charcoal-800: #262828; --color-slate-900: #13343b; --color-teal-300: #32b8c6;
Â  --color-teal-400: #2da6b2; --color-teal-500: #21808d; --color-teal-600: #1d7480; --color-teal-700: #1a6873;
Â  --color-red-400: #ff5459; --color-red-500: #c0152f; --color-orange-400: #e68161; --color-orange-500: #a84b2f;
Â  --color-brown-600-rgb: 94, 82, 64; --color-teal-500-rgb: 33, 128, 141; --color-slate-900-rgb: 19, 52, 59;
Â  --color-bg-1: rgba(59, 130, 246, 0.08); --color-bg-2: rgba(245, 158, 11, 0.08); --color-bg-3: rgba(34, 197, 94, 0.08);
Â  --color-background: var(--color-cream-50); --color-surface: var(--color-cream-100); --color-text: var(--color-slate-900);
Â  --color-text-secondary: var(--color-slate-500); --color-primary: var(--color-teal-500); --color-primary-hover: var(--color-teal-600);
Â  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12); --color-border: rgba(var(--color-brown-600-rgb), 0.2);
Â  --color-btn-primary-text: var(--color-cream-50); --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
Â  --font-family-base: "FKGroteskNeue", "Inter", -apple-system, sans-serif; --font-size-xs: 11px; --font-size-sm: 12px;
Â  --font-size-base: 14px; --font-size-lg: 16px; --font-size-xl: 18px; --font-size-2xl: 20px; --font-size-3xl: 24px;
Â  --space-4: 4px; --space-8: 8px; --space-12: 12px; --space-16: 16px; --space-20: 20px; --space-24: 24px; --space-32: 32px;
Â  --radius-sm: 6px; --radius-base: 8px; --radius-lg: 12px; --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.04);
}
[data-color-scheme="dark"] {
Â  --color-gray-400-rgb: 119, 124, 124; --color-gray-200-rgb: 245, 245, 245; --color-background: var(--color-charcoal-700);
Â  --color-surface: var(--color-charcoal-800); --color-text: var(--color-gray-200); --color-text-secondary: rgba(var(--color-gray-400-rgb), 0.7);
Â  --color-primary: var(--color-teal-300); --color-secondary: rgba(var(--color-gray-400-rgb), 0.15); --color-border: rgba(var(--color-gray-400-rgb), 0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-family-base); background: var(--color-background); color: var(--color-text); transition: 0.3s; }
.app-container { display: flex; height: 100vh; overflow: hidden; }
.sidebar { width: 240px; background: var(--color-surface); border-right: 1px solid var(--color-border); padding: var(--space-24); display: flex; flex-direction: column; }
.sidebar-title { font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--space-16); }
.sidebar-item { padding: var(--space-12) var(--space-16); border-radius: var(--radius-base); cursor: pointer; transition: 0.2s; font-size: var(--font-size-base); background: transparent; border: none; width: 100%; text-align: left; color: var(--color-text-secondary); }
.sidebar-item:hover { background: var(--color-secondary); }
.sidebar-item.active { background: var(--color-primary); color: var(--color-btn-primary-text); font-weight: 500; }
.main-content { flex: 1; padding: var(--space-32); overflow-y: auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-32); }
.month-nav { display: flex; align-items: center; gap: var(--space-12); }
.month-nav button, .icon-button, .btn-today { background: var(--color-secondary); border: none; border-radius: var(--radius-base); padding: var(--space-8) var(--space-12); cursor: pointer; color: var(--color-text); transition: 0.2s; font-size: 14px; }
.month-nav button:hover, .icon-button:hover, .btn-today:hover { background: rgba(var(--color-brown-600-rgb), 0.2); }
.month-title { font-size: var(--font-size-3xl); font-weight: 600; min-width: 250px; text-align: center; }
.view-container { display: none; }
.view-container.active { display: block; }
.search-input { width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); margin-bottom: var(--space-16); }
.songs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-16); margin-bottom: 100px; }
.song-card { position: relative; display: flex; flex-direction: column; gap: 8px; padding: 12px; border-radius: 12px; background: var(--color-surface); cursor: pointer; transition: all 0.3s; border: 1px solid var(--color-card-border); overflow: visible; }
.song-card:hover { background: var(--color-secondary); transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); }
.song-card.playing { border-color: var(--color-primary); background: var(--color-secondary); }
.song-cover { width: 100%; aspect-ratio: 1; border-radius: var(--radius-base); margin-bottom: var(--space-12); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-3xl); background: var(--color-background); }
.song-cover img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-base); }
.song-info { flex: 1; min-width: 0; }
.song-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-artist { font-size: 12px; color: var(--color-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-type-badge { position: absolute; top: 8px; left: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(50,184,198,0.95); border-radius: 50%; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 20; border: 2px solid white; }
[data-color-scheme="dark"] .song-type-badge { background: rgba(0,0,0,0.7); }
.song-card-actions { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
.song-card:hover .song-card-actions { opacity: 1; }
.song-card-btn { background: rgba(0,0,0,0.6); border: none; color: white; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
.song-card-btn.delete-btn { background: rgba(244,67,54,0.9); }
.song-card-btn.delete-btn:hover { background: rgba(244,67,54,1); }
.song-card-btn.playlist-btn { background: rgba(50,184,198,0.9); }
.song-card-btn.playlist-btn:hover { background: rgba(50,184,198,1); }
.favorite-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10; }
.mini-player { position: fixed; bottom: 0; left: 240px; right: 0; background: var(--color-surface); border-top: 1px solid var(--color-border); padding: var(--space-16) var(--space-24); display: none; flex-direction: column; gap: var(--space-12); z-index: 100; }
.mini-player.active { display: flex; }
.mini-player-top { display: flex; align-items: center; gap: var(--space-16); width: 100%; }
.mini-player-cover { width: 56px; height: 56px; border-radius: var(--radius-base); background: var(--color-background); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-2xl); flex-shrink: 0; }
.mini-player-info { flex: 1; min-width: 0; }
.mini-player-title { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mini-player-artist { color: var(--color-text-secondary); font-size: var(--font-size-sm); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mini-player-controls { display: flex; gap: var(--space-8); align-items: center; }
.mini-player-btn { background: var(--color-secondary); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 18px; }
.mini-player-btn:hover { background: rgba(var(--color-brown-600-rgb), 0.25); }
.mini-player-btn.play-btn { width: 48px; height: 48px; background: var(--color-primary); color: var(--color-btn-primary-text); }
.progress-container { flex: 1; }
.progress-bar { width: 100%; height: 6px; background: var(--color-secondary); border-radius: 99px; cursor: pointer; position: relative; }
.progress-bar-fill { height: 100%; background: var(--color-primary); border-radius: 99px; transition: width 0.1s linear; }
.time-display { display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: 4px; }
.volume-slider { width: 80px; height: 4px; -webkit-appearance: none; background: var(--color-secondary); border-radius: 99px; cursor: pointer; }
.volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--color-primary); border-radius: 50%; cursor: pointer; }
.calendar { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-24); border: 1px solid var(--color-card-border); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--space-8); }
.calendar-header { text-align: center; font-weight: 600; font-size: var(--font-size-sm); padding: var(--space-12); color: var(--color-text-secondary); }
.calendar-day { position: relative; aspect-ratio: 1; border: 2px solid transparent; border-radius: 12px; padding: var(--space-8); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--color-background); }
.calendar-day:hover { border-color: var(--color-primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
.calendar-day.has-emotion { border-width: 3px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.calendar-day.today { border-color: var(--color-primary); font-weight: 600; }
.day-number { font-size: 14px; font-weight: 600; }
.day-emoji { font-size: 24px; margin-top: 4px; }
.event-dot { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--color-red-400); border-radius: 50%; }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-32); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-md); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24); }
.modal-title { font-size: var(--font-size-2xl); font-weight: 600; }
.close-button { background: none; border: none; font-size: var(--font-size-2xl); cursor: pointer; color: var(--color-text-secondary); padding: 0; width: 32px; height: 32px; }
.form-group { margin-bottom: var(--space-24); }
.form-label { display: block; margin-bottom: var(--space-8); font-weight: 500; font-size: var(--font-size-sm); }
.text-input, textarea, select.text-input { width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-background); color: var(--color-text); font-family: var(--font-family-base); }
textarea { min-height: 120px; resize: vertical; }
.btn { padding: var(--space-12) var(--space-24); border-radius: var(--radius-base); border: none; font-size: var(--font-size-base); font-weight: 500; cursor: pointer; transition: 0.2s; }
.btn-primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
.btn-primary:hover { background: var(--color-primary-hover); }
.btn-secondary { background: var(--color-secondary); color: var(--color-text); }
.btn-danger { background: var(--color-red-400); color: var(--color-white); }
.btn-danger:hover { background: var(--color-red-500); }
.tags-flow { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 16px; font-size: 11px; font-weight: 500; border: 1px solid; }
.tag-chip-genre { background: #E8EAF6; color: #3F51B5; border-color: #C5CAE9; }
.tag-chip-mood { background: #FCE4EC; color: #C2185B; border-color: #F8BBD0; }
.tag-chip-custom { background: #E0F2F1; color: #00897B; border-color: #B2DFDB; }
.tag-close { background: rgba(0,0,0,0.1); border: none; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; font-size: 11px; padding: 0; }
.tag-add-compact { width: 24px; height: 24px; border: 1.5px dashed #999; border-radius: 50%; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.empty-state { text-align: center; padding: 40px; color: var(--color-text-secondary); }
.stop-player-btn { position: absolute; top: 10px; left: 10px; width: 28px; height: 28px; background: rgba(0,0,0,0.1); border: none; border-radius: 50%; color: #666; font-size: 16px; cursor: pointer; z-index: 10; }
.stop-player-btn:hover { background: rgba(255,0,0,0.15); color: #f44336; }
#youtube-player-container { position: fixed; bottom: 100px; right: 20px; width: 400px; height: 225px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 999; background: #000; transition: all 0.3s ease; }
#youtube-player-div { width: 100%; height: 100%; }
#youtube-player-container.youtube-hidden { width: 1px; height: 1px; bottom: -100px; right: -100px; opacity: 0; pointer-events: none; }
#youtube-player-container.youtube-visible { opacity: 1; pointer-events: auto; }
.youtube-toggle-btn-player { background: rgba(255,0,0,0.1); border: 2px solid #FF0000; color: #FF0000; padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-left: 15px; display: none; }
.loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-surface); padding: 40px; border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; z-index: 10000; }
.upload-section { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
.btn-upload { background: var(--color-teal-500); color: var(--color-btn-primary-text); border: none; padding: 10px 16px; border-radius: var(--radius-base); cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: var(--font-size-base); }
.btn-upload:hover { background: var(--color-teal-600); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(50,184,198,0.3); }
[data-color-scheme="dark"] .btn-upload { background: var(--color-teal-300); color: var(--color-slate-900); }
[data-color-scheme="dark"] .btn-upload:hover { background: var(--color-teal-400); }
.drag-drop-zone { border: 2px dashed var(--color-border); border-radius: var(--radius-lg); padding: 20px; text-align: center; color: var(--color-text-secondary); transition: all 0.2s; display: none; }
.drag-drop-zone.drag-over { border-color: var(--color-primary); background: var(--color-secondary); color: var(--color-text); }
.song-album { font-size: 11px; color: var(--color-text-secondary); margin-top: 4px; opacity: 0.8; }
.spinner { width: 50px; height: 50px; border: 5px solid var(--color-secondary); border-top: 5px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
.library-filters { display: flex; gap: var(--space-12); margin-bottom: var(--space-16); }
.library-filters select { padding: var(--space-8) var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); cursor: pointer; }
/* Nuevos estilos Calendario y Tareas */
.day-details-section { margin-bottom: var(--space-20); }
.day-details-title { font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-12); padding-bottom: var(--space-8); border-bottom: 1px solid var(--color-border); }
.day-event-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-12) 0; border-bottom: 1px solid var(--color-secondary); }
.day-event-item:last-child { border-bottom: none; }
.day-event-info .title { font-weight: 500; }
.day-event-info .details { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.day-event-info .deadline { font-size: var(--font-size-xs); color: var(--color-red-500); font-weight: 600; }
.event-actions { display: flex; gap: var(--space-8); }
.event-delete-btn { font-size: 12px; padding: 6px; background: var(--color-secondary); border: none; border-radius: 6px; cursor: pointer; }
.event-delete-btn:hover { background: var(--color-red-400); color: var(--color-white); }
.form-group.hidden { display: none; }
.importance-label { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.importance-label-1 { background: #E8F5E9; color: #388E3C; }
.importance-label-2 { background: #FFF3E0; color: #F57C00; }
.importance-label-3 { background: #FFEBEE; color: #D32F2F; }
.task-list-item { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-16); margin-bottom: var(--space-16); display: flex; justify-content: space-between; align-items: flex-start; }
.task-info .title { font-size: var(--font-size-lg); font-weight: 600; }
.task-info .details { color: var(--color-text-secondary); margin: var(--space-8) 0; }
.task-meta { text-align: right; }
.task-meta .deadline { font-weight: 600; color: var(--color-red-500); }
/* Playlists */
.playlist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--space-16); }
.playlist-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-16); text-align: center; cursor: pointer; transition: 0.2s; }
.playlist-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); }
.playlist-card-icon { font-size: 48px; }
.playlist-card-title { font-weight: 600; margin-top: var(--space-12); }
.playlist-modal-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: var(--space-16); }
.playlist-modal-item { padding: var(--space-12); cursor: pointer; border-bottom: 1px solid var(--color-secondary); }
.playlist-modal-item:hover { background: var(--color-secondary); }
.playlist-modal-item:last-child { border-bottom: none; }
Â  </style>
</head>
<body>
<div id="aria-live-region" aria-live="polite" class="sr-only"></div>

<div class="app-container">
Â  <aside class="sidebar">
Â  Â  <h1 class="sidebar-title">ğŸµ Mi MÃºsica</h1>
Â  Â  <button class="sidebar-item active" data-view="calendario" tabindex="0">ğŸ“… Calendario</button>
Â  Â  <button class="sidebar-item" data-view="tasks" tabindex="0">âœ”ï¸ Tareas</button>
Â  Â  <button class="sidebar-item" data-view="biblioteca" tabindex="0">ğŸ“š Biblioteca</button>
Â  Â  <button class="sidebar-item" data-view="playlists" tabindex="0">ğŸ§ Playlists</button>
Â  Â  <button class="sidebar-item" data-view="favoritos" tabindex="0">â­ Favoritos</button>
Â  Â  <button id="theme-toggle" class="sidebar-item" style="margin-top: auto;" tabindex="0">ğŸŒ“ Tema</button>
Â  </aside>

Â  <main class="main-content">
Â  Â  <header class="header">
Â  Â  Â  <div class="month-nav">
Â  Â  Â  Â  <button id="prev-month">â—€</button>
Â  Â  Â  Â  <h2 class="month-title" id="month-title"></h2>
Â  Â  Â  Â  <button id="next-month">â–¶</button>
Â  Â  Â  Â  <button id="today-btn" class="btn-today" style="margin-left: 16px;">Hoy</button>
Â  Â  Â  </div>
Â  Â  Â  <button class="icon-button" id="settings-btn" title="ConfiguraciÃ³n">âš™ï¸</button>
Â  Â  </header>

Â  Â  <div class="view-container active" id="calendario-view">
Â  Â  Â  <div class="calendar">
Â  Â  Â  Â  <div class="calendar-grid" id="calendar-grid"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="view-container" id="tasks-view">
Â  Â  Â  <h2 style="margin-bottom: 24px;">Tareas Pendientes</h2>
Â  Â  Â  <div id="tasks-list"></div>
Â  Â  </div>

Â  Â  <div class="view-container" id="biblioteca-view">
Â  Â  Â  <div class="upload-section">
Â  Â  Â  Â  <button class="btn-upload" id="upload-local-btn" title="Carga canciones desde tu ordenador">ğŸ’¿ Cargar CanciÃ³n Local</button>
Â  Â  Â  Â  <button class="btn btn-primary" id="load-folder-btn">ğŸ“ Cargar Carpeta</button>
Â  Â  Â  Â  <button class="btn btn-primary" id="add-youtube-btn">â–¶ï¸ AÃ±adir YouTube</button>
Â  Â  Â  Â  <input type="file" id="local-file-input" accept="audio/*" multiple style="display: none;">
Â  Â  Â  Â  <input type="file" id="folder-input" webkitdirectory multiple accept="audio/*" style="display: none;">
Â  Â  Â  </div>
Â  Â  Â  <div class="drag-drop-zone" id="drag-drop-zone">
Â  Â  Â  Â  <div style="font-size: 48px; margin-bottom: 12px;">ğŸµ</div>
Â  Â  Â  Â  <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Arrastra archivos aquÃ­</div>
Â  Â  Â  Â  <div style="font-size: 12px;">o usa el botÃ³n "Cargar CanciÃ³n Local"</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="library-filters">
Â  Â  Â  Â  <select id="genre-filter"><option value="">Todos los gÃ©neros</option></select>
Â  Â  Â  Â  <select id="mood-filter"><option value="">Todos los estados</option></select>
Â  Â  Â  </div>
Â  Â  Â  <input type="text" class="search-input" id="search-input" placeholder="ğŸ” Buscar...">
Â  Â  Â  <div class="songs-grid" id="songs-grid"></div>
Â  Â  </div>

Â  Â  <div class="view-container" id="playlists-view">
Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
Â  Â  Â  Â  <h2>Playlists</h2>
Â  Â  Â  Â  <button class="btn btn-primary" id="create-playlist-btn">Crear Playlist</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="playlist-grid" id="playlists-list"></div>
Â  Â  </div>

Â  Â  <div class="view-container" id="favoritos-view">
Â  Â  Â  <div class="songs-grid" id="favorites-grid"></div>
Â  Â  </div>
Â  </main>
</div>

<div class="mini-player" id="mini-player">
Â  <button id="stop-player-btn" class="stop-player-btn" title="Detener">âœ•</button>
Â  <div class="mini-player-top">
Â  Â  <div class="mini-player-cover" id="player-cover">ğŸµ</div>
Â  Â  <div class="mini-player-info">
Â  Â  Â  <div class="mini-player-title" id="player-title">Sin reproducciÃ³n</div>
Â  Â  Â  <div class="mini-player-artist" id="player-artist"></div>
Â  Â  </div>
Â  Â  <div class="mini-player-controls">
Â  Â  Â  <button class="mini-player-btn" id="prev-btn">â®ï¸</button>
Â  Â  Â  <button class="mini-player-btn play-btn" id="play-btn">â–¶ï¸</button>
Â  Â  Â  <button class="mini-player-btn" id="next-btn">â­ï¸</button>
Â  Â  Â  <button class="mini-player-btn" id="shuffle-btn" style="opacity: 0.5">ğŸ”€</button>
Â  Â  Â  <button class="mini-player-btn" id="repeat-btn" style="opacity: 0.5">ğŸ”</button>
Â  Â  Â  <button class="youtube-toggle-btn-player" id="youtube-toggle-btn">ğŸ“º</button>
Â  Â  </div>
Â  Â  <div style="display: flex; align-items: center; gap: 8px;">
Â  Â  Â  <button class="mini-player-btn" id="volume-icon">ğŸ”Š</button>
Â  Â  Â  <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
Â  Â  </div>
Â  </div>
Â  <div class="progress-container">
Â  Â  <div class="progress-bar" id="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
Â  Â  <div class="time-display"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
Â  </div>
</div>

<audio id="audio-player"></audio>
<div id="youtube-player-container" class="youtube-hidden"><div id="youtube-player-div"></div></div>

<div class="modal" id="youtube-modal">
Â  <div class="modal-content">
Â  Â  <div class="modal-header"><h3 class="modal-title">ğŸŒ AÃ±adir desde YouTube</h3><button class="close-button" onclick="U.closeModal('youtube-modal')">&times;</button></div>
Â  Â  <div class="form-group"><label class="form-label">URL:</label><input type="text" id="youtube-url" class="text-input" placeholder="https://youtube.com/watch?v=..."></div>
Â  Â  <div class="form-group"><label class="form-label">TÃ­tulo:</label><input type="text" id="youtube-title" class="text-input"></div>
Â  Â  <div class="form-group"><label class="form-label">Artista:</label><input type="text" id="youtube-artist" class="text-input"></div>
Â  Â  <div style="display: flex; gap: 12px; justify-content: flex-end;"><button class="btn btn-secondary" onclick="U.closeModal('youtube-modal')">Cancelar</button><button class="btn btn-primary" id="save-youtube-btn">Guardar</button></div>
Â  </div>
</div>

<div class="modal" id="day-details-modal">
Â  <div class="modal-content">
Â  Â  <div class="modal-header">
Â  Â  Â  <h3 class="modal-title" id="day-details-title">Detalles del DÃ­a</h3>
Â  Â  Â  <button class="close-button" onclick="U.closeModal('day-details-modal')">&times;</button>
Â  Â  </div>
Â  Â  <div id="day-details-body">
Â  Â  Â  <div class="day-details-section">
Â  Â  Â  Â  <h4 class="day-details-title">ğŸµ EmociÃ³n Musical</h4>
Â  Â  Â  Â  <div id="day-details-emotion" style="font-size: 18px; display: flex; align-items: center; gap: 12px;"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="day-details-section">
Â  Â  Â  Â  <h4 class="day-details-title">âœ”ï¸ Tareas</h4>
Â  Â  Â  Â  <div id="day-details-tasks"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="day-details-section">
Â  Â  Â  Â  <h4 class="day-details-title">ğŸ“ Notas</h4>
Â  Â  Â  Â  <div id="day-details-notes"></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="day-details-section">
Â  Â  Â  Â  <h4 class="day-details-title">ğŸ‚ CumpleaÃ±os</h4>
Â  Â  Â  Â  <div id="day-details-birthdays"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
Â  Â  Â  <button class="btn btn-secondary" onclick="U.closeModal('day-details-modal')">Cerrar</button>
Â  Â  Â  <button class="btn btn-primary" id="add-event-btn">AÃ±adir Evento</button>
Â  Â  </div>
Â  </div>
</div>

<div class="modal" id="event-form-modal">
Â  <div class="modal-content">
Â  Â  <div class="modal-header">
Â  Â  Â  <h3 class="modal-title" id="event-form-title">Nuevo Evento</h3>
Â  Â  Â  <button class="close-button" onclick="U.closeModal('event-form-modal')">&times;</button>
Â  Â  </div>
Â  Â  <input type="hidden" id="event-form-date">
Â  Â  <input type="hidden" id="event-form-id">
Â  Â  <div class="form-group">
Â  Â  Â  <label class="form-label" for="event-form-type">Tipo de Evento</label>
Â  Â  Â  <select id="event-form-type" class="text-input">
Â  Â  Â  Â  <option value="task">âœ”ï¸ Tarea</option>
Â  Â  Â  Â  <option value="note">ğŸ“ Nota</option>
Â  Â  Â  Â  <option value="birthday">ğŸ‚ CumpleaÃ±os</option>
Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  <label class="form-label" for="event-form-title">TÃ­tulo</label>
Â  Â  Â  <input type="text" id="event-form-title-input" class="text-input">
Â  Â  </div>
Â  Â  <div class="form-group form-group-task form-group-note">
Â  Â  Â  <label class="form-label" for="event-form-details">Detalles</label>
Â  Â  Â  <textarea id="event-form-details" class="text-input"></textarea>
Â  Â  </div>
Â  Â  <div class="form-group form-group-task">
Â  Â  Â  <label class="form-label" for="event-form-deadline">Fecha LÃ­mite (Opcional)</label>
Â  Â  Â  <input type="date" id="event-form-deadline" class="text-input">
Â  Â  </div>
Â  Â  <div class="form-group form-group-task">
Â  Â  Â  <label class="form-label" for="event-form-importance">Importancia</label>
Â  Â  Â  <select id="event-form-importance" class="text-input">
Â  Â  Â  Â  <option value="1">Baja</option>
Â  Â  Â  Â  <option value="2">Media</option>
Â  Â  Â  Â  <option value="3">Alta</option>
Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div style="display: flex; gap: 12px; justify-content: flex-end;">
Â  Â  Â  <button class="btn btn-secondary" onclick="U.closeModal('event-form-modal')">Cancelar</button>
Â  Â  Â  <button class="btn btn-primary" id="save-event-btn">Guardar</button>
Â  Â  </div>
Â  </div>
</div>

<div class="modal" id="playlist-modal">
Â  <div class="modal-content">
Â  Â  <div class="modal-header"><h3 class="modal-title">AÃ±adir a Playlist</h3><button class="close-button" onclick="U.closeModal('playlist-modal')">&times;</button></div>
Â  Â  <input type="hidden" id="playlist-modal-song-id">
Â  Â  <div class="playlist-modal-list" id="playlist-modal-list">
Â  Â  Â  Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  <label class="form-label">O crear nueva playlist:</label>
Â  Â  Â  <input type="text" id="new-playlist-name" class="text-input" placeholder="Nombre de la nueva playlist...">
Â  Â  </div>
Â  Â  <div style="display: flex; gap: 12px; justify-content: flex-end;">
Â  Â  Â  <button class="btn btn-secondary" onclick="U.closeModal('playlist-modal')">Cancelar</button>
Â  Â  Â  <button class="btn btn-primary" id="create-and-add-playlist-btn">Crear y AÃ±adir</button>
Â  Â  </div>
Â  </div>
</div>

<script>
// === TIPOS DE CANCIONES ===
const SONG_TYPES = { GITHUB: 'github', LOCAL: 'local', YOUTUBE: 'youtube' };
const SONG_TYPE_ICONS = { [SONG_TYPES.GITHUB]: 'ğŸŒ', [SONG_TYPES.LOCAL]: 'ğŸ’¿', [SONG_TYPES.YOUTUBE]: 'â–¶ï¸' };
const SONG_TYPE_LABELS = { [SONG_TYPES.GITHUB]: 'GitHub', [SONG_TYPES.LOCAL]: 'Local', [SONG_TYPES.YOUTUBE]: 'YouTube' };

// === CONFIGURACIÃ“N GITHUB ===
const GITHUB_CONFIG = {
Â  owner: 'mrdaniel7',
Â  repo: 'CalendarioMultimedia',
Â  branch: 'main',
Â  musicFolder: 'musica'
};

// === CANCIONES DE DEMOSTRACIÃ“N PRECARGADAS ===
const DEMO_SONGS = [
Â  {
Â  Â  id: 'demo-1',
Â  Â  title: 'Feeling Good',
Â  Â  artist: 'Nina Simone',
Â  Â  album: 'Demo',
Â  Â  type: 'local',
Â  Â  cover: 'ğŸ’¿',
Â  Â  genres: ['Jazz', 'Soul'],
Â  Â  moods: ['Feliz', 'EnÃ©rgico'],
Â  Â  isFavorite: false
Â  },
Â  {
Â  Â  id: 'demo-2',
Â  Â  title: 'Beethoven - Fur Elise',
Â  Â  artist: 'Ludwig van Beethoven',
Â  Â  album: 'Demo',
Â  Â  type: 'local',
Â  Â  cover: 'ğŸ’¿',
Â  Â  genres: ['Classical'],
Â  Â  moods: ['Tranquilo', 'Elegante'],
Â  Â  isFavorite: false
Â  }
];

const loadDemoSongs = () => {
Â  console.log('ğŸ“š Cargando canciones de demostraciÃ³n');
Â  app.songs.push(...DEMO_SONGS);
Â  console.log(`âœ… ${DEMO_SONGS.length} canciones demo cargadas`);
};

// === FUNCIÃ“N PARA CARGAR CANCIONES DE GITHUB ===
const fetchGitHubSongs = async () => {
Â  try {
Â  Â  const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.musicFolder}?ref=${GITHUB_CONFIG.branch}`;
Â  Â  console.log('ğŸŒ Buscando canciones en GitHub:', apiUrl);
Â  Â  const response = await fetch(apiUrl);
Â  Â  if (!response.ok) {
Â  Â  Â  console.warn('âš ï¸ No se encontrÃ³ carpeta de mÃºsica en GitHub');
Â  Â  Â  return [];
Â  Â  }
Â  Â  const files = await response.json();
Â  Â  const gitHubSongs = [];
Â  Â  const audioExtensions = ['.mp3', '.wav', '.flac', '.ogg', '.m4a'];
Â  Â  for (const file of files) {
Â  Â  Â  if (file.type === 'file' && audioExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
Â  Â  Â  Â  const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.musicFolder}/${file.name}`;
Â  Â  Â  Â  const song = {
Â  Â  Â  Â  Â  id: app.nextId++,
Â  Â  Â  Â  Â  title: file.name.replace(/\.[^/.]+$/, ''),
Â  Â  Â  Â  Â  artist: GITHUB_CONFIG.owner,
Â  Â  Â  Â  Â  album: 'GitHub Repository',
Â  Â  Â  Â  Â  duration: 0,
Â  Â  Â  Â  Â  type: SONG_TYPES.GITHUB,
Â  Â  Â  Â  Â  fileName: file.name,
Â  Â  Â  Â  Â  fileUrl: rawUrl,
Â  Â  Â  Â  Â  fileSize: file.size,
Â  Â  Â  Â  Â  cover: 'ğŸŒ',
Â  Â  Â  Â  Â  genres: [],
Â  Â  Â  Â  Â  moods: [],
Â  Â  Â  Â  Â  isFavorite: false,
Â  Â  Â  Â  Â  dateAdded: new Date().toISOString()
Â  Â  Â  Â  };
Â  Â  Â  Â  console.log('âœ… CanciÃ³n GitHub encontrada:', song.title);
Â  Â  Â  Â  gitHubSongs.push(song);
Â  Â  Â  }
Â  Â  }
Â  Â  console.log(`ğŸ“Š Total canciones en GitHub: ${gitHubSongs.length}`);
Â  Â  return gitHubSongs;
Â  } catch (error) {
Â  Â  console.error('âŒ Error obteniendo canciones de GitHub:', error);
Â  Â  return [];
Â  }
};

const loadGitHubSongs = async () => {
Â  const gitHubSongs = await fetchGitHubSongs();
Â  if (gitHubSongs.length > 0) {
Â  Â  app.songs.push(...gitHubSongs);
Â  Â  console.log(`ğŸŒ ${gitHubSongs.length} canciones cargadas de GitHub`);
Â  }
Â  return gitHubSongs;
};

// === DATOS CENTRALIZADOS ===
const app = {
Â  songs: [], currentIndex: -1, currentDate: new Date(2025, 9, 29), isPlaying: false, videoVisible: false,
Â  nextId: 1000, shuffleMode: false, repeatMode: 'none', volume: 0.7, currentView: 'calendario',
Â  genres: ['Rock','Pop','Jazz','Blues','Classical','Electronic','Hip Hop','R&B','Country','Reggae','Metal','Indie','Folk','Soul','Funk','Punk','Latin','Reggaeton','Salsa','Trap','Techno','House'],
Â  moods: ['Feliz','Triste','EnÃ©rgico','Relajado','RomÃ¡ntico','Motivador','MelancÃ³lico','NostÃ¡lgico','EufÃ³rico','Tranquilo','Agresivo','Inspirador','DramÃ¡tico','Festivo'],
Â  calendarData: {
Â  Â  '2025-01-01': {mood:'EufÃ³rico',emoji:'ğŸ†',color:'#FFD700',songs:15,time:60},'2025-01-05': {mood:'Motivador',emoji:'ğŸ’ª',color:'#FF4500',songs:10,time:42},'2025-01-10': {mood:'Feliz',emoji:'ğŸ˜ƒ',color:'#FFD700',songs:12,time:48},'2025-01-15': {mood:'Relajado',emoji:'ğŸŒ¿',color:'#4ECDC4',songs:8,time:35},'2025-01-20': {mood:'EnÃ©rgico',emoji:'âš¡',color:'#FF6B35',songs:14,time:55},'2025-01-25': {mood:'Tranquilo',emoji:'â˜®ï¸',color:'#90EE90',songs:6,time:28},'2025-01-30': {mood:'NostÃ¡lgico',emoji:'ğŸ“»',color:'#CD853F',songs:9,time:38},'2025-02-02': {mood:'RomÃ¡ntico',emoji:'â¤ï¸',color:'#FF69B4',songs:11,time:45},'2025-02-08': {mood:'Feliz',emoji:'ğŸ˜Š',color:'#FFD700',songs:13,time:52},'2025-02-14': {mood:'RomÃ¡ntico',emoji:'ğŸ’•',color:'#FF69B4',songs:18,time:72},'2025-02-18': {mood:'MelancÃ³lico',emoji:'ğŸŒ§ï¸',color:'#708090',songs:7,time:30},'2025-02-22': {mood:'EnÃ©rgico',emoji:'ğŸ”¥',color:'#FF4500',songs:15,time:60},'2025-03-03': {mood:'Motivador',emoji:'ğŸš€',color:'#FF4500',songs:12,time:48},'2025-03-08': {mood:'Feliz',emoji:'ğŸŒ¸',color:'#FFD700',songs:14,time:56},'2025-03-12': {mood:'EnÃ©rgico',emoji:'âš¡',color:'#FF6B35',songs:16,time:64},'2025-03-17': {mood:'Festivo',emoji:'ğŸ€',color:'#228B22',songs:20,time:80},'2025-03-22': {mood:'Relajado',emoji:'ğŸŒŠ',color:'#4ECDC4',songs:9,time:36},'2025-04-01': {mood:'Feliz',emoji:'ğŸ˜†',color:'#FFD700',songs:13,time:52},'2025-04-06': {mood:'Relajado',emoji:'ğŸŒ¿',color:'#4ECDC4',songs:10,time:40},'2025-04-12': {mood:'RomÃ¡ntico',emoji:'ğŸŒ¹',color:'#FF69B4',songs:12,time:48},'2025-04-18': {mood:'EnÃ©rgico',emoji:'ğŸ’¥',color:'#FF6B35',songs:15,time:60},'2025-05-01': {mood:'Festivo',emoji:'ğŸŒº',color:'#FF1493',songs:19,time:76},'2025-05-10': {mood:'Feliz',emoji:'â˜€ï¸',color:'#FFD700',songs:16,time:64},'2025-05-15': {mood:'RomÃ¡ntico',emoji:'ğŸ’',color:'#FF69B4',songs:13,time:52},'2025-05-20': {mood:'Relajado',emoji:'ğŸƒ',color:'#4ECDC4',songs:9,time:36},'2025-06-02': {mood:'Festivo',emoji:'ğŸ–ï¸',color:'#00CED1',songs:18,time:72},'2025-06-07': {mood:'Feliz',emoji:'ğŸ˜',color:'#FFD700',songs:14,time:56},'2025-06-12': {mood:'Relajado',emoji:'ğŸŒŠ',color:'#4ECDC4',songs:11,time:44},'2025-06-17': {mood:'EnÃ©rgico',emoji:'ğŸ”¥',color:'#FF6B35',songs:16,time:64},'2025-07-04': {mood:'Festivo',emoji:'ğŸ†',color:'#FF4500',songs:22,time:88},'2025-07-09': {mood:'Feliz',emoji:'ğŸŒ',color:'#FFD700',songs:15,time:60},'2025-07-14': {mood:'Festivo',emoji:'ğŸ‡«ğŸ‡·',color:'#0055A4',songs:20,time:80},'2025-07-19': {mood:'Relajado',emoji:'ğŸï¸',color:'#4ECDC4',songs:10,time:40},'2025-08-03': {mood:'Relajado',emoji:'ğŸŒŠ',color:'#4ECDC4',songs:12,time:48},'2025-08-08': {mood:'Feliz',emoji:'â˜€ï¸',color:'#FFD700',songs:14,time:56},'2025-08-13': {mood:'EnÃ©rgico',emoji:'ğŸ”¥',color:'#FF6B35',songs:15,time:60},'2025-08-18': {mood:'RomÃ¡ntico',emoji:'ğŸŒ…',color:'#FF69B4',songs:11,time:44},'2025-09-03': {mood:'EnÃ©rgico',emoji:'ğŸ’¥',color:'#FF6B35',songs:13,time:52},'2025-09-07': {mood:'Feliz',emoji:'â˜€ï¸',color:'#FFD700',songs:12,time:48},'2025-09-12': {mood:'Relajado',emoji:'ğŸŒŠ',color:'#4ECDC4',songs:10,time:40},'2025-09-15': {mood:'Motivador',emoji:'ğŸ¯',color:'#FF4500',songs:14,time:56},'2025-10-01': {mood:'Feliz',emoji:'ğŸ˜ƒ',color:'#FFD700',songs:12,time:48},'2025-10-03': {mood:'EnÃ©rgico',emoji:'âš¡',color:'#FF6B35',songs:15,time:60},'2025-10-05': {mood:'Relajado',emoji:'ğŸŒ¿',color:'#4ECDC4',songs:10,time:40},'2025-10-07': {mood:'RomÃ¡ntico',emoji:'â¤ï¸',color:'#FF69B4',songs:13,time:52},'2025-10-09': {mood:'Triste',emoji:'ğŸ˜¢',color:'#6495ED',songs:8,time:32},'2025-10-12': {mood:'Motivador',emoji:'ğŸ’ª',color:'#FF4500',songs:14,time:56},'2025-10-14': {mood:'Festivo',emoji:'ğŸ‰',color:'#9370DB',songs:16,time:64},'2all-10-16': {mood:'NostÃ¡lgico',emoji:'ğŸ“»',color:'#CD853F',songs:9,time:36},'2025-10-18': {mood:'Tranquilo',emoji:'â˜®ï¸',color:'#90EE90',songs:7,time:28},'2025-10-20': {mood:'EufÃ³rico',emoji:'ğŸ¤©',color:'#FFD700',songs:17,time:68},'2025-10-22': {mood:'MelancÃ³lico',emoji:'ğŸŒ§ï¸',color:'#708090',songs:8,time:32},'2025-10-24': {mood:'Inspirador',emoji:'âœ¨',color:'#DDA0DD',songs:11,time:44},'2025-10-26': {mood:'EnÃ©rgico',emoji:'ğŸ”¥',color:'#FF4500',songs:15,time:60},'2025-10-28': {mood:'Feliz',emoji:'ğŸ˜Š',color:'#FFD700',songs:12,time:48},'2025-10-30': {mood:'Festivo',emoji:'ğŸƒ',color:'#FF8C00',songs:18,time:72},'2025-11-02': {mood:'Relajado',emoji:'ğŸƒ',color:'#4ECDC4',songs:10,time:40},'2025-11-05': {mood:'Motivador',emoji:'ğŸš€',color:'#FF4500',songs:14,time:56},'2025-11-08': {mood:'RomÃ¡ntico',emoji:'ğŸ’•',color:'#FF69B4',songs:12,time:48},'2025-11-11': {mood:'Tranquilo',emoji:'ğŸ§˜',color:'#90EE90',songs:8,time:32}
Â  },
Â  audioCtx: null, audioSrc: null, eqFilters: [], gainNode: null,
Â  ytPlayer: null, // Guardar la instancia del reproductor de YouTube
Â  playlists: [], // Guardar playlists
Â  nextPlaylistId: 1,
};

// === UTILIDADES ===
const U = {
Â  q: id => document.getElementById(id),
Â  qa: sel => document.querySelectorAll(sel),
Â  on: (el, evt, fn) => el?.addEventListener(evt, fn),
Â  text: (el, txt) => el && (el.textContent = txt),
Â  html: (el, h) => el && (el.innerHTML = h),
Â  show: el => el && (el.style.display = 'block'), // Cambiado para 'block'
Â  hide: el => el && (el.style.display = 'none'),
Â  addClass: (el, cls) => el?.classList.add(cls),
Â  removeClass: (el, cls) => el?.classList.remove(cls),
Â  toggleClass: (el, cls) => el?.classList.toggle(cls),
Â  fmt: s => { const m = Math.floor(s/60), sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; },
Â  announce: msg => { const a = U.q('aria-live-region'); if(a) a.textContent = msg; },
Â  closeModal: id => U.removeClass(U.q(id), 'active'),
Â  openModal: id => U.addClass(U.q(id), 'active')
};

// === LÃ“GICA DE REPRODUCTOR (Fix Shuffle/Repeat/YT) ===

function playSong(id) {
Â  const song = app.songs.find(s => s.id === id);
Â  if (!song) return;
Â Â 
Â  app.currentIndex = app.songs.indexOf(song);
Â Â 
Â  // LIMPIAR REPRODUCTOR ANTERIOR
Â  const audio = U.q('audio-player');
Â  audio.pause();
Â  audio.src = '';
Â Â 
Â  // Destruir reproductor de YouTube anterior
Â  if (app.ytPlayer) {
Â  Â  app.ytPlayer.destroy();
Â  Â  app.ytPlayer = null;
Â  }
Â  U.hide(U.q('youtube-toggle-btn'));
Â Â 
Â  // ACTUALIZAR UI
Â  U.text(U.q('player-title'), song.title);
Â  U.text(U.q('player-artist'), song.artist);
Â  U.text(U.q('play-btn'), 'â¸ï¸');
Â  U.q('mini-player').classList.add('active');
Â  app.isPlaying = true;
Â Â 
Â  console.log('â–¶ï¸ Reproduciendo:', song.title, '| Tipo:', song.type);
Â Â 
Â  // REPRODUCIR SEGÃšN TIPO
Â  if (song.type === 'youtube') {
Â  Â  playYouTube(song);
Â  } else if (song.type === 'local' && song.blob) {
Â  Â  try {
Â  Â  Â  const url = URL.createObjectURL(song.blob);
Â  Â  Â  audio.src = url;
Â  Â  Â  audio.crossOrigin = 'anonymous';
Â  Â  Â  audio.play().catch(e => { U.announce('Error: ' + e.message); console.error('Error al reproducir:', e); });
Â  Â  } catch (e) {
Â  Â  Â  U.announce('Error al reproducir archivo'); console.error(e);
Â  Â  }
Â  } else if (song.type === 'github' && song.fileUrl) {
Â  Â  console.log('ğŸŒ Reproduciendo desde GitHub:', song.fileUrl);
Â  Â  try {
Â  Â  Â  audio.src = song.fileUrl;
Â  Â  Â  audio.crossOrigin = 'anonymous';
Â  Â  Â  audio.play().catch(e => { U.announce('Error: ' + e.message); console.error('Error reproduciendo GitHub:', e); });
Â  Â  } catch (e) {
Â  Â  Â  U.announce('Error al reproducir desde GitHub'); console.error(e);
Â  Â  }
Â  }
Â Â 
Â  renderSongs();
}

function playYouTube(song) {
Â  // Asegurarse que el contenedor estÃ© limpio
Â  U.q('youtube-player-div').innerHTML = '';
Â Â 
Â  if (typeof YT === 'undefined' || !YT.Player) {
Â  Â  console.error('âŒ API de YouTube no cargada');
Â  Â  U.announce('Error al cargar API de YouTube');
Â  Â  return;
Â  }
Â Â 
Â  app.ytPlayer = new YT.Player('youtube-player-div', {
Â  Â  height: '100%',
Â  Â  width: '100%',
Â  Â  videoId: song.youtubeId,
Â  Â  playerVars: {
Â  Â  Â  'autoplay': 1, 'controls': 1, 'modestbranding': 1, 'rel': 0, 'fs': 0, 'playsinline': 1
Â  Â  },
Â  Â  events: {
Â  Â  Â  'onReady': () => {
Â  Â  Â  Â  console.log('â–¶ï¸ YouTube listo:', song.title);
Â  Â  Â  Â  U.show(U.q('youtube-toggle-btn'));
Â  Â  Â  Â  // Sincronizar volumen
Â  Â  Â  Â  app.ytPlayer.setVolume(app.volume * 100);
Â  Â  Â  },
Â  Â  Â  'onStateChange': onPlayerStateChange
Â  Â  }
Â  });
}

// Handler global para eventos de YouTube
function onPlayerStateChange(event) {
Â  if (event.data == YT.PlayerState.ENDED) {
Â  Â  console.log('YouTube video ended');
Â  Â  playNextSong();
Â  }
}

function playNextSong() {
Â  if (app.songs.length === 0) return;
Â Â 
Â  // 1. Repetir una canciÃ³n
Â  if (app.repeatMode === 'one') {
Â  Â  playSong(app.songs[app.currentIndex].id);
Â  Â  return;
Â  }
Â Â 
Â  // 2. Modo Aleatorio (Shuffle)
Â  if (app.shuffleMode) {
Â  Â  let nextIndex = app.currentIndex;
Â  Â  if (app.songs.length > 1) {
Â  Â  Â  while (nextIndex === app.currentIndex) {
Â  Â  Â  Â  nextIndex = Math.floor(Math.random() * app.songs.length);
Â  Â  Â  }
Â  Â  }
Â  Â  playSong(app.songs[nextIndex].id);
Â  Â  return;
Â  }
Â Â 
Â  // 3. Modo Normal / Repetir Todo
Â  let nextIndex = app.currentIndex + 1;
Â Â 
Â  // Si llega al final
Â  if (nextIndex >= app.songs.length) {
Â  Â  if (app.repeatMode === 'all') {
Â  Â  Â  nextIndex = 0; // Volver al inicio
Â  Â  } else {
Â  Â  Â  // No repetir, detener
Â  Â  Â  stopPlayback();
Â  Â  Â  return;
Â  Â  }
Â  }
Â Â 
Â  playSong(app.songs[nextIndex].id);
}

function playPrevSong() {
Â  if (app.songs.length === 0) return;
Â Â 
Â  // 1. Repetir una canciÃ³n (ir al inicio)
Â  if (app.repeatMode === 'one') {
Â  Â  playSong(app.songs[app.currentIndex].id);
Â  Â  return;
Â  }
Â Â 
Â  // 2. Modo Aleatorio (Shuffle)
Â  if (app.shuffleMode) {
Â  Â  playNextSong(); // En aleatorio, "anterior" es lo mismo que "siguiente"
Â  Â  return;
Â  }
Â Â 
Â  // 3. Modo Normal
Â  let prevIndex = app.currentIndex - 1;
Â Â 
Â  if (prevIndex < 0) {
Â  Â  if (app.repeatMode === 'all') {
Â  Â  Â  prevIndex = app.songs.length - 1; // Ir al final
Â  Â  } else {
Â  Â  Â  prevIndex = 0; // Quedarse en la primera
Â  Â  }
Â  }
Â Â 
Â  playSong(app.songs[prevIndex].id);
}

function stopPlayback() {
Â  const audio = U.q('audio-player');
Â  audio.pause();
Â  audio.src = '';
Â Â 
Â  if (app.ytPlayer) {
Â  Â  app.ytPlayer.destroy();
Â  Â  app.ytPlayer = null;
Â  }
Â  U.hide(U.q('youtube-toggle-btn'));
Â Â 
Â  U.text(U.q('player-title'), 'Sin reproducciÃ³n');
Â  U.text(U.q('player-artist'), '');
Â  U.text(U.q('play-btn'), 'â–¶ï¸');
Â  U.q('progress-fill').style.width = '0%';
Â  U.text(U.q('current-time'), '0:00');
Â  U.text(U.q('total-time'), '0:00');
Â Â 
Â  app.isPlaying = false;
Â  app.currentIndex = -1;
Â  U.announce('ReproducciÃ³n detenida');
Â  console.log('âœ… ReproducciÃ³n detenida');
Â  renderSongs();
}

function togglePlayPause() {
Â  if (app.currentIndex < 0) {
Â  Â  if (app.songs.length > 0) playSong(app.songs[0].id); // Reproducir la primera si no hay nada
Â  Â  else U.announce('No hay canciones en la biblioteca');
Â  Â  return;
Â  }
Â Â 
Â  const song = app.songs[app.currentIndex];
Â Â 
Â  if (app.isPlaying) {
Â  Â  // PAUSAR
Â  Â  if (song.type === 'local' || song.type === 'github') {
Â  Â  Â  U.q('audio-player').pause();
Â  Â  } else if (song.type === 'youtube' && app.ytPlayer) {
Â  Â  Â  app.ytPlayer.pauseVideo();
Â  Â  }
Â  Â  app.isPlaying = false;
Â  Â  U.text(U.q('play-btn'), 'â–¶ï¸');
Â  } else {
Â  Â  // REANUDAR
Â  Â  if (song.type === 'local' || song.type === 'github') {
Â  Â  Â  U.q('audio-player').play().catch(e => console.error(e));
Â  Â  } else if (song.type === 'youtube' && app.ytPlayer) {
Â  Â  Â  app.ytPlayer.playVideo();
Â  Â  }
Â  Â  app.isPlaying = true;
Â  Â  U.text(U.q('play-btn'), 'â¸ï¸');
Â  }
}

// === FUNCIONES DE BIBLIOTECA ===

function renderSongs() {
Â  const container = U.q('songs-grid');
Â  if (!container) return;
Â  const genreFilter = U.q('genre-filter').value;
Â  const moodFilter = U.q('mood-filter').value;
Â  const searchTerm = U.q('search-input').value.toLowerCase();
Â  let filtered = app.songs.filter(s => {
Â  Â  if (genreFilter && (!s.genres || !s.genres.includes(genreFilter))) return false;
Â  Â  if (moodFilter && (!s.moods || !s.moods.includes(moodFilter))) return false;
Â  Â  if (searchTerm && !s.title.toLowerCase().includes(searchTerm) && !s.artist.toLowerCase().includes(searchTerm)) return false;
Â  Â  return true;
Â  });
Â  if (filtered.length === 0) {
Â  Â  container.innerHTML = '<div class="empty-state"><div style="font-size: 64px;">ğŸµ</div><p>No hay canciones</p></div>';
Â  Â  return;
Â  }
Â  container.innerHTML = filtered.map(s => {
Â  Â  const typeIcon = SONG_TYPE_ICONS[s.type] || 'ğŸµ';
Â  Â  const typeLabel = SONG_TYPE_LABELS[s.type] || 'Desconocido';
Â  Â  const cover = s.cover && (s.cover.startsWith('data:') || s.cover.startsWith('http')) ? `<img src="${s.cover}" alt="${s.title}">` : ['ğŸ¸','ğŸ¤','ğŸ¹','ğŸ¥','ğŸº','ğŸ»','ğŸ§'][s.id % 7];
Â  Â  const tags = (s.genres || []).map(g => `<span class="tag-chip tag-chip-genre">${g}</span>`).join('') + (s.moods || []).map(m => `<span class="tag-chip tag-chip-mood">${m}</span>`).join('');
Â  Â  const album = s.album || typeLabel;
Â  Â  return `<div class="song-card ${app.currentIndex >= 0 && app.songs[app.currentIndex].id === s.id ? 'playing' : ''}" onclick="playSong(${s.id})">
Â  Â  Â  <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
Â  Â  Â  <button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${s.id})">${s.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}</button>
Â  Â  Â  <div class="song-cover">${cover}</div>
Â  Â  Â  <div class="song-title">${s.title}</div>
Â  Â  Â  <div class="song-artist">${s.artist}</div>
Â  Â  Â  <div class="song-album">${album}</div>
Â  Â  Â  <div class="tags-flow">${tags}</div>
Â  Â  Â  <div class="song-card-actions">
Â  Â  Â  Â  <button class="song-card-btn playlist-btn" onclick="event.stopPropagation();showPlaylistModal(${s.id})" title="AÃ±adir a playlist">â•</button>
Â  Â  Â  Â  <button class="song-card-btn delete-btn" onclick="event.stopPropagation();deleteSong(${s.id})" title="Eliminar">ğŸ—‘ï¸</button>
Â  Â  Â  </div>
Â  Â  </div>`;
Â  }).join('');
}

function toggleFav(id) {
Â  const song = app.songs.find(s => s.id === id);
Â  if (song) { song.isFavorite = !song.isFavorite; renderSongs(); if (app.currentView === 'favoritos') renderFavorites(); }
}

function renderFavorites() {
Â  const container = U.q('favorites-grid');
Â  const favs = app.songs.filter(s => s.isFavorite);
Â  if (favs.length === 0) {
Â  Â  container.innerHTML = '<div class="empty-state"><div style="font-size: 64px;">â­</div><p>No hay favoritos</p></div>';
Â  Â  return;
Â  }
Â  container.innerHTML = favs.map(s => {
Â  Â  const cover = s.cover && (s.cover.startsWith('data:') || s.cover.startsWith('http')) ? `<img src="${s.cover}" alt="${s.title}">` : ['ğŸ¸','ğŸ¤','ğŸ¹','ğŸ¥'][s.id % 4];
Â  Â  const typeIcon = SONG_TYPE_ICONS[s.type] || 'ğŸµ';
Â  Â  const typeLabel = SONG_TYPE_LABELS[s.type] || 'Desconocido';
Â  Â  return `<div class="song-card" onclick="playSong(${s.id})">
Â  Â  Â  <div class="song-type-badge" title="${typeLabel}">${typeIcon}</div>
Â  Â  Â  <button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${s.id})">â¤ï¸</button>
Â  Â  Â  <div class="song-cover">${cover}</div>
Â  Â  Â  <div class="song-title">${s.title}</div>
Â  Â  Â  <div class="song-artist">${s.artist}</div>
Â  Â  </div>`;
Â  }).join('');
}

function deleteSong(id) {
Â  const song = app.songs.find(s => s.id === id);
Â  if (!song) return;
Â  if (!confirm(`Â¿Eliminar "${song.title}"?`)) return;
Â Â 
Â  if (app.currentIndex >= 0 && app.songs[app.currentIndex].id === id) {
Â  Â  stopPlayback();
Â  }
Â Â 
Â  app.songs = app.songs.filter(s => s.id !== id);
Â Â 
Â  // Ajustar currentIndex si es necesario
Â  if (app.currentIndex >= app.songs.length) {
Â  Â  app.currentIndex = app.songs.length - 1;
Â  }
Â Â 
Â  console.log('ğŸ—‘ï¸ CanciÃ³n eliminada:', song.title);
Â  U.announce(`CanciÃ³n eliminada: ${song.title}`);
Â  populateFilters();
Â  renderSongs();
Â  if (app.currentView === 'favoritos') renderFavorites();
}

// === LÃ“GICA DE CALENDARIO Y TAREAS ===

function initCalendarData() {
Â  // Asegurarse de que cada entrada tenga un array de eventos
Â  for (const key in app.calendarData) {
Â  Â  if (!app.calendarData[key].events) {
Â  Â  Â  app.calendarData[key].events = [];
Â  Â  }
Â  }
Â  // AÃ±adir eventos de ejemplo
Â  if (app.calendarData['2025-10-29']) {
Â  Â  app.calendarData['2025-10-29'].events = [
Â  Â  Â  { id: 1, type: 'task', title: 'Terminar proyecto', details: 'Revisar el cÃ³digo', importance: 3, deadline: '2025-10-31' },
Â  Â  Â  { id: 2, type: 'note', title: 'Idea app', details: 'Una app de mÃºsica y calendario' }
Â  Â  ];
Â  }
Â  if (app.calendarData['2025-10-30']) {
Â  Â  app.calendarData['2025-10-30'].events = [
Â  Â  Â  { id: 3, type: 'birthday', title: 'CumpleaÃ±os de Ana' }
Â  Â  ];
Â  }
}

function renderCalendar() {
Â  const year = app.currentDate.getFullYear();
Â  const month = app.currentDate.getMonth();
Â  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
Â  U.text(U.q('month-title'), `${monthNames[month]} ${year}`);
Â  const firstDay = new Date(year, month, 1).getDay() === 0 ? 6 : new Date(year, month, 1).getDay() - 1;
Â  const daysInMonth = new Date(year, month + 1, 0).getDate();
Â  const today = new Date();
Â  const grid = U.q('calendar-grid');
Â  grid.innerHTML = '';
Â  const dayHeaders = ['Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b','Dom'];
Â  dayHeaders.forEach(d => { const h = document.createElement('div'); h.className = 'calendar-header'; h.textContent = d; grid.appendChild(h); });
Â  for (let i = 0; i < firstDay; i++) { const e = document.createElement('div'); e.className = 'calendar-day'; grid.appendChild(e); }
Â Â 
Â  for (let day = 1; day <= daysInMonth; day++) {
Â  Â  const dayEl = document.createElement('div');
Â  Â  dayEl.className = 'calendar-day';
Â  Â  const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
Â  Â Â 
Â  Â  // Asegurarse que el dÃ­a existe en los datos
Â  Â  if (!app.calendarData[dateKey]) {
Â  Â  Â  app.calendarData[dateKey] = { events: [] };
Â  Â  }
Â  Â Â 
Â  Â  const dayData = app.calendarData[dateKey];
Â  Â  dayEl.innerHTML = `<span class="day-number">${day}</span>`;
Â  Â Â 
Â  Â  if (dayData.emoji) {
Â  Â  Â  dayEl.classList.add('has-emotion');
Â  Â  Â  dayEl.innerHTML += `<span class="day-emoji">${dayData.emoji}</span>`;
Â  Â  Â  dayEl.style.borderColor = dayData.color;
Â  Â  }
Â  Â Â 
Â  Â  if (dayData.events && dayData.events.length > 0) {
Â  Â  Â  dayEl.innerHTML += `<div class="event-dot"></div>`;
Â  Â  }
Â  Â Â 
Â  Â  dayEl.onclick = () => showDayDetailsModal(dateKey);
Â  Â Â 
Â  Â  if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
Â  Â  Â  dayEl.classList.add('today');
Â  Â  }
Â  Â  grid.appendChild(dayEl);
Â  }
}

function showDayDetailsModal(dateKey) {
Â  const [year, month, day] = dateKey.split('-');
Â  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
Â  U.text(U.q('day-details-title'), `${parseInt(day)} de ${monthNames[parseInt(month)-1]} ${year}`);
Â Â 
Â  const dayData = app.calendarData[dateKey];
Â  if (!dayData) { console.error('No data for key', dateKey); return; }
Â Â 
Â  // EmociÃ³n
Â  if (dayData.emoji) {
Â  Â  U.html(U.q('day-details-emotion'), `<span style="font-size: 24px;">${dayData.emoji}</span> <strong>${dayData.mood}</strong> (${dayData.songs} canciones)`);
Â  } else {
Â  Â  U.html(U.q('day-details-emotion'), `<span style="color: var(--color-text-secondary);">Sin datos de mÃºsica</span>`);
Â  }
Â Â 
Â  // Eventos
Â  const renderEvent = (e) => {
Â  Â  let details = `<div class="day-event-info"><div class="title">${e.title}</div>`;
Â  Â  if (e.details) details += `<div class="details">${e.details}</div>`;
Â  Â  if (e.type === 'task' && e.deadline) details += `<div class="deadline">Vence: ${e.deadline}</div>`;
Â  Â  details += `</div>`;
Â  Â  return `<div class="day-event-item">
Â  Â  Â  ${details}
Â  Â  Â  <div class="event-actions">
Â  Â  Â  Â  <button class="event-delete-btn" onclick="deleteEvent('${dateKey}', ${e.id})">ğŸ—‘ï¸</button>
Â  Â  Â  </div>
Â  Â  </div>`;
Â  };
Â Â 
Â  const tasks = dayData.events.filter(e => e.type === 'task');
Â  const notes = dayData.events.filter(e => e.type === 'note');
Â  const bdays = dayData.events.filter(e => e.type === 'birthday');
Â Â 
Â  U.html(U.q('day-details-tasks'), tasks.length ? tasks.map(renderEvent).join('') : '<p style="font-size: 14px; color: var(--color-text-secondary);">No hay tareas</p>');
Â  U.html(U.q('day-details-notes'), notes.length ? notes.map(renderEvent).join('') : '<p style="font-size: 14px; color: var(--color-text-secondary);">No hay notas</p>');
Â  U.html(U.q('day-details-birthdays'), bdays.length ? bdays.map(renderEvent).join('') : '<p style="font-size: 14px; color: var(--color-text-secondary);">No hay cumpleaÃ±os</p>');
Â Â 
Â  U.q('add-event-btn').onclick = () => showEventForm(dateKey);
Â  U.openModal('day-details-modal');
}

function showEventForm(dateKey, eventId = null) {
Â  U.closeModal('day-details-modal');
Â Â 
Â  U.q('event-form-date').value = dateKey;
Â  U.q('event-form-id').value = eventId || '';
Â Â 
Â  if (eventId) {
Â  Â  // Editar (No implementado en este snippet, se deja como "nuevo")
Â  Â  U.text(U.q('event-form-title'), 'Editar Evento');
Â  Â  // ... (lÃ³gica para precargar datos) ...
Â  } else {
Â  Â  // Nuevo
Â  Â  U.text(U.q('event-form-title'), 'Nuevo Evento');
Â  Â  U.q('event-form-type').value = 'task';
Â  Â  U.q('event-form-title-input').value = '';
Â  Â  U.q('event-form-details').value = '';
Â  Â  U.q('event-form-deadline').value = '';
Â  Â  U.q('event-form-importance').value = '1';
Â  }
Â Â 
Â  // Mostrar/ocultar campos segÃºn el tipo
Â  const typeSelect = U.q('event-form-type');
Â  const updateFormFields = () => {
Â  Â  const type = typeSelect.value;
Â  Â  U.qa('.form-group-task').forEach(el => type === 'task' ? U.show(el) : U.hide(el));
Â  Â  U.qa('.form-group-note').forEach(el => type === 'note' ? U.show(el) : U.hide(el));
Â  };
Â  typeSelect.onchange = updateFormFields;
Â  updateFormFields();
Â Â 
Â  U.openModal('event-form-modal');
}

function saveEvent() {
Â  const dateKey = U.q('event-form-date').value;
Â  const eventId = U.q('event-form-id').value;
Â  const type = U.q('event-form-type').value;
Â  const title = U.q('event-form-title-input').value;
Â Â 
Â  if (!title) { alert('El tÃ­tulo es obligatorio'); return; }
Â Â 
Â  const event = {
Â  Â  id: eventId ? parseInt(eventId) : Date.now(),
Â  Â  type: type,
Â  Â  title: title,
Â  Â  details: U.q('event-form-details').value,
Â  Â  deadline: U.q('event-form-deadline').value,
Â  Â  importance: parseInt(U.q('event-form-importance').value)
Â  };
Â Â 
Â  const dayData = app.calendarData[dateKey];
Â  if (!dayData) { console.error('No data for key', dateKey); return; }
Â Â 
Â  if (eventId) {
Â  Â  // Actualizar (No implementado, se aÃ±ade como nuevo)
Â  Â  dayData.events.push(event);
Â  } else {
Â  Â  dayData.events.push(event);
Â  }
Â Â 
Â  U.closeModal('event-form-modal');
Â  renderCalendar();
Â  showDayDetailsModal(dateKey); // Re-abrir modal del dÃ­a
Â  if (app.currentView === 'tasks') renderTasksView(); // Actualizar vista de tareas
}

function deleteEvent(dateKey, eventId) {
Â  if (!confirm('Â¿Seguro que quieres eliminar este evento?')) return;
Â  const dayData = app.calendarData[dateKey];
Â  if (dayData) {
Â  Â  dayData.events = dayData.events.filter(e => e.id !== eventId);
Â  }
Â  renderCalendar();
Â  showDayDetailsModal(dateKey); // Refrescar modal
Â  if (app.currentView === 'tasks') renderTasksView(); // Actualizar vista de tareas
}

function renderTasksView() {
Â  const container = U.q('tasks-list');
Â  let allTasks = [];
Â Â 
Â  for (const dateKey in app.calendarData) {
Â  Â  const dayData = app.calendarData[dateKey];
Â  Â  if (dayData.events && dayData.events.length > 0) {
Â  Â  Â  dayData.events.forEach(event => {
Â  Â  Â  Â  if (event.type === 'task') {
Â  Â  Â  Â  Â  allTasks.push({ ...event, dateKey: dateKey });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  }
Â  }
Â Â 
Â  // Ordenar: 1. Por fecha lÃ­mite (los que tienen) 2. Por importancia
Â  allTasks.sort((a, b) => {
Â  Â  if (a.deadline && b.deadline) {
Â  Â  Â  return new Date(a.deadline) - new Date(b.deadline);
Â  Â  }
Â  Â  if (a.deadline) return -1; // 'a' tiene fecha lÃ­mite, va primero
Â  Â  if (b.deadline) return 1; Â // 'b' tiene fecha lÃ­mite, va primero
Â  Â  return b.importance - a.importance; // Si no hay fechas, por importancia
Â  });
Â Â 
Â  if (allTasks.length === 0) {
Â  Â  container.innerHTML = '<div class="empty-state">âœ”ï¸<p>No hay tareas pendientes</p></div>';
Â  Â  return;
Â  }
Â Â 
Â  const importanceLabels = { 1: 'Baja', 2: 'Media', 3: 'Alta' };
Â  container.innerHTML = allTasks.map(task => `
Â  Â  <div class="task-list-item">
Â  Â  Â  <div class="task-info">
Â  Â  Â  Â  <div class="title">${task.title}</div>
Â  Â  Â  Â  <div class="details">${task.details || 'Sin detalles'}</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="task-meta">
Â  Â  Â  Â  <div class="importance-label importance-label-${task.importance}">
Â  Â  Â  Â  Â  ${importanceLabels[task.importance]}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  ${task.deadline ? `<div class="deadline">Vence: ${task.deadline}</div>` : ''}
Â  Â  Â  Â  <div style="font-size: 12px; margin-top: 8px;">(${task.dateKey})</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  `).join('');
}

// === LÃ“GICA DE PLAYLISTS ===

function renderPlaylistsView() {
Â  const container = U.q('playlists-list');
Â  if (app.playlists.length === 0) {
Â  Â  container.innerHTML = '<div class="empty-state">ğŸ§<p>No has creado playlists</p></div>';
Â  Â  return;
Â  }
Â Â 
Â  container.innerHTML = app.playlists.map(p => `
Â  Â  <div class="playlist-card" onclick="playPlaylist(${p.id})">
Â  Â  Â  <div class="playlist-card-icon">ğŸµ</div>
Â  Â  Â  <div class="playlist-card-title">${p.name}</div>
Â  Â  Â  <div style="font-size: 12px; color: var(--color-text-secondary);">${p.songIds.length} canciones</div>
Â  Â  </div>
Â  `).join('');
}

function createPlaylist(name) {
Â  if (!name || name.trim() === '') {
Â  Â  name = prompt('Nombre de la nueva playlist:');
Â  Â  if (!name || name.trim() === '') return null;
Â  }
Â  const newPlaylist = {
Â  Â  id: app.nextPlaylistId++,
Â  Â  name: name,
Â  Â  songIds: []
Â  };
Â  app.playlists.push(newPlaylist);
Â  console.log('Playlist creada:', newPlaylist);
Â  if (app.currentView === 'playlists') renderPlaylistsView();
Â  return newPlaylist;
}

function showPlaylistModal(songId) {
Â  U.q('playlist-modal-song-id').value = songId;
Â  const list = U.q('playlist-modal-list');
Â  if (app.playlists.length === 0) {
Â  Â  list.innerHTML = '<p style="padding: 12px; color: var(--color-text-secondary);">No hay playlists. Crea una abajo.</p>';
Â  } else {
Â  Â  list.innerHTML = app.playlists.map(p =>
Â  Â  Â  `<div class="playlist-modal-item" onclick="addSongToPlaylist(${p.id})">${p.name}</div>`
Â  Â  ).join('');
Â  }
Â  U.openModal('playlist-modal');
}

function addSongToPlaylist(playlistId) {
Â  const songId = parseInt(U.q('playlist-modal-song-id').value);
Â  const playlist = app.playlists.find(p => p.id === playlistId);
Â  const song = app.songs.find(s => s.id === songId);
Â Â 
Â  if (playlist && song) {
Â  Â  if (playlist.songIds.includes(songId)) {
Â  Â  Â  alert(`"${song.title}" ya estÃ¡ en la playlist "${playlist.name}"`);
Â  Â  } else {
Â  Â  Â  playlist.songIds.push(songId);
Â  Â  Â  U.announce(`AÃ±adido a ${playlist.name}`);
Â  Â  Â  console.log('AÃ±adido a playlist:', song.title, playlist.name);
Â  Â  }
Â  Â  U.closeModal('playlist-modal');
Â  } else {
Â  Â  console.error('No se encontrÃ³ playlist o canciÃ³n');
Â  }
}

function createAndAddPlaylist() {
Â  const name = U.q('new-playlist-name').value;
Â  if (!name || name.trim() === '') {
Â  Â  alert('Ingresa un nombre para la playlist');
Â  Â  return;
Â  }
Â  const newPlaylist = createPlaylist(name);
Â  if (newPlaylist) {
Â  Â  addSongToPlaylist(newPlaylist.id);
Â  Â  U.q('new-playlist-name').value = '';
Â  }
}

function playPlaylist(playlistId) {
Â  // (Opcional) Esta funciÃ³n podrÃ­a reproducir la playlist
Â  alert('Reproducir playlist (funciÃ³n no implementada)');
}

// === FUNCIONES DE NAVEGACIÃ“N Y VISTAS ===

function switchView(view) {
Â  app.currentView = view;
Â  U.qa('.sidebar-item').forEach(item => {
Â  Â  U.removeClass(item, 'active');
Â  Â  if (item.getAttribute('data-view') === view) U.addClass(item, 'active');
Â  });
Â  U.qa('.view-container').forEach(v => U.removeClass(v, 'active'));
Â  const viewEl = U.q(view + '-view');
Â  if (viewEl) U.addClass(viewEl, 'active');
Â Â 
Â  // Renderizar la vista correspondiente
Â  if (view === 'calendario') renderCalendar();
Â  else if (view === 'biblioteca') renderSongs();
Â  else if (view === 'favoritos') renderFavorites();
Â  else if (view === 'tasks') renderTasksView();
Â  else if (view === 'playlists') renderPlaylistsView();
}

// === CARGA DE ARCHIVOS Y METADATOS ===

async function loadMusicFolder() {
Â  const input = U.q('folder-input');
Â  input.onchange = async e => {
Â  Â  const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
Â  Â  console.log(`ğŸ“ Procesando carpeta con ${files.length} archivos...`);
Â  Â  for (const file of files) {
Â  Â  Â  const song = {
Â  Â  Â  Â  id: app.nextId++, title: file.name.replace(/\.[^/.]+$/, ''), artist: 'Desconocido', duration: 0, type: SONG_TYPES.LOCAL, blob: file, cover: 'ğŸ’¿', genres: [], moods: [], isFavorite: false, album: 'Archivo Local', fileName: file.name, dateAdded: new Date().toISOString()
Â  Â  Â  };
Â  Â  Â  app.songs.push(song);
Â  Â  Â  await autoTagSong(song);
Â  Â  Â  extractMetadata(song).catch(e => console.warn('Error en metadatos:', e));
Â  Â  Â  console.log('âœ… CanciÃ³n de carpeta aÃ±adida:', song.title);
Â  Â  }
Â  Â  populateFilters();
Â  Â  renderSongs();
Â  Â  console.log(`âœ… Total canciones: ${app.songs.length}`);
Â  Â  alert(`âœ… ${files.length} canciones cargadas de la carpeta`);
Â  };
Â  input.click();
}

async function handleLocalFileUpload(files) {
Â  const fileArray = Array.from(files).filter(f => f.type.startsWith('audio/'));
Â  if (fileArray.length === 0) { alert('âš ï¸ No se encontraron archivos de audio'); return; }
Â  console.log(`ğŸ“ Procesando ${fileArray.length} archivos...`);
Â  for (const file of fileArray) {
Â  Â  const song = {
Â  Â  Â  id: app.nextId++, title: file.name.replace(/\.[^/.]+$/, ''), artist: 'Desconocido', duration: 0, type: SONG_TYPES.LOCAL, blob: file, cover: 'ğŸ’¿', genres: [], moods: [], isFavorite: false, album: 'Archivo Local', fileName: file.name, fileSize: file.size, mimeType: file.type, dateAdded: new Date().toISOString()
Â  Â  };
Â  Â  app.songs.push(song);
Â  Â  await autoTagSong(song);
Â  Â  extractMetadata(song).catch(e => console.warn('Error en metadatos:', e));
Â  Â  console.log('âœ… CanciÃ³n local aÃ±adida:', song.title);
Â  }
Â  populateFilters();
Â  renderSongs();
Â  U.announce(`${fileArray.length} canciones aÃ±adidas`);
Â  console.log(`âœ… Total canciones en biblioteca: ${app.songs.length}`);
}

async function extractMetadata(song) {
Â  if (!song.blob || typeof jsmediatags === 'undefined') return;
Â  try {
Â  Â  await new Promise((resolve, reject) => {
Â  Â  Â  jsmediatags.read(song.blob, {
Â  Â  Â  Â  onSuccess: (tag) => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const tags = tag.tags || {};
Â  Â  Â  Â  Â  Â  if (tags.title) song.title = tags.title;
Â  Â  Â  Â  Â  Â  if (tags.artist) song.artist = tags.artist;
Â  Â  Â  Â  Â  Â  if (tags.album) song.album = tags.album;
Â  Â  Â  Â  Â  Â  if (tags.picture) {
Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const pic = tags.picture;
Â  Â  Â  Â  Â  Â  Â  Â  if (pic.data && pic.format) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const byteArray = new Uint8Array(pic.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([byteArray], { type: pic.format });
Â  Â  Â  Â  Â  Â  Â  Â  Â  song.cover = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } catch (picError) { console.warn('âš ï¸ Error procesando imagen:', picError); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log('ğŸµ Metadatos extraÃ­dos:', song.title);
Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  } catch (innerError) { console.error('âŒ Error procesando metadatos:', innerError); resolve(); }
Â  Â  Â  Â  },
Â  Â  Â  Â  onError: (error) => { console.warn('âš ï¸ No se pudieron extraer metadatos:', error); resolve(); }
Â  Â  Â  });
Â  Â  });
Â  } catch (error) { console.warn('âš ï¸ Error extrayendo metadatos:', error); }
}

async function autoTagSong(song) {
Â  const title = song.title.toLowerCase();
Â  const keywords = { Rock: ['rock','guitar'], Pop: ['pop'], Jazz: ['jazz'], Electronic: ['electronic','edm'], 'Hip Hop': ['hip','hop','rap'] };
Â  Object.entries(keywords).forEach(([genre, words]) => { if (words.some(w => title.includes(w))) song.genres.push(genre); });
Â  if (song.genres.length === 0) song.genres.push('Pop');
Â  if (title.includes('happy') || title.includes('feliz')) song.moods.push('Feliz');
Â  else if (title.includes('sad')) song.moods.push('Triste');
Â  else song.moods.push('Relajado');
}

function populateFilters() {
Â  const genres = new Set(), moods = new Set();
Â  app.songs.forEach(s => { s.genres?.forEach(g => genres.add(g)); s.moods?.forEach(m => moods.add(m)); });
Â  const gf = U.q('genre-filter'), mf = U.q('mood-filter');
Â  gf.innerHTML = '<option value="">Todos los gÃ©neros</option>' + Array.from(genres).sort().map(g => `<option value="${g}">${g}</option>`).join('');
Â  mf.innerHTML = '<option value="">Todos los estados</option>' + Array.from(moods).sort().map(m => `<option value="${m}">${m}</option>`).join('');
}

async function saveYouTube() {
Â  const url = U.q('youtube-url').value.trim();
Â  if (!url) return alert('âš ï¸ Ingresa una URL');
Â  const videoId = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^&\\n?#]+)/)?.[1];
Â  if (!videoId) return alert('âŒ URL invÃ¡lida');
Â  const title = U.q('youtube-title').value.trim() || 'Video de YouTube';
Â  const artist = U.q('youtube-artist').value.trim() || 'YouTube';
Â  const song = { id: app.nextId++, title, artist, type: SONG_TYPES.YOUTUBE, youtubeId: videoId, cover: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`, genres: ['Pop'], moods: ['Feliz'], isFavorite: false, album: 'YouTube' };
Â  app.songs.push(song);
Â  U.closeModal('youtube-modal');
Â  U.q('youtube-url').value = '';
Â  U.q('youtube-title').value = '';
Â  U.q('youtube-artist').value = '';
Â  populateFilters();
Â  renderSongs();
Â  alert('âœ… CanciÃ³n de YouTube aÃ±adida');
}

// === INICIALIZACIÃ“N Y EVENT LISTENERS ===

// Cargar la API de IFrame de YouTube
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// Esta funciÃ³n es llamada por la API de YouTube cuando estÃ¡ lista
function onYouTubeIframeAPIReady() {
Â  console.log('âœ… API de YouTube cargada');
Â  // No hacer nada aquÃ­, el reproductor se crea en playYouTube()
}

U.on(document, 'DOMContentLoaded', async () => {
Â  console.log('ğŸš€ Iniciando aplicaciÃ³n...');
Â Â 
Â  try {
Â  Â  loadDemoSongs();
Â  Â  initCalendarData(); // Inicializar datos del calendario
Â  Â  console.log(`ğŸ“š Canciones demo cargadas: ${app.songs.length}`);
Â  Â  populateFilters();
Â  Â  renderSongs();
Â  Â  console.log('âœ… Biblioteca inicial renderizada');
Â  Â Â 
Â  Â  try {
Â  Â  Â  const gitHubSongs = await loadGitHubSongs();
Â  Â  Â  if (gitHubSongs && gitHubSongs.length > 0) {
Â  Â  Â  Â  console.log(`ğŸŒ Canciones de GitHub cargadas: ${gitHubSongs.length}`);
Â  Â  Â  Â  populateFilters();
Â  Â  Â  Â  renderSongs();
Â  Â  Â  }
Â  Â  } catch (e) { console.warn('âš ï¸ Error cargando canciones de GitHub:', e); }
Â  Â Â 
Â  Â  console.log(`ğŸ“Š TOTAL CANCIONES EN BIBLIOTECA: ${app.songs.length}`);
Â Â 
Â  } catch (error) { console.error('âŒ Error al inicializar:', error); }
Â Â 
Â  // --- Listeners de NavegaciÃ³n ---
Â  U.qa('.sidebar-item').forEach(item => U.on(item, 'click', e => {
Â  Â  const view = e.target.getAttribute('data-view');
Â  Â  if (view) switchView(view);
Â  }));
Â  U.on(U.q('prev-month'), 'click', () => { app.currentDate.setMonth(app.currentDate.getMonth() - 1); renderCalendar(); });
Â  U.on(U.q('next-month'), 'click', () => { app.currentDate.setMonth(app.currentDate.getMonth() + 1); renderCalendar(); });
Â  U.on(U.q('today-btn'), 'click', () => { app.currentDate = new Date(); renderCalendar(); });
Â  U.on(U.q('theme-toggle'), 'click', () => {
Â  Â  const scheme = document.documentElement.getAttribute('data-color-scheme');
Â  Â  document.documentElement.setAttribute('data-color-scheme', scheme === 'dark' ? 'light' : 'dark');
Â  });

Â  // --- Listeners de Carga de Archivos ---
Â  U.on(U.q('upload-local-btn'), 'click', () => U.q('local-file-input').click());
Â  U.on(U.q('local-file-input'), 'change', e => {
Â  Â  if (e.target.files.length > 0) { handleLocalFileUpload(e.target.files); e.target.value = ''; }
Â  });
Â  U.on(U.q('load-folder-btn'), 'click', loadMusicFolder);
Â  U.on(U.q('add-youtube-btn'), 'click', () => U.openModal('youtube-modal'));
Â  U.on(U.q('save-youtube-btn'), 'click', saveYouTube);
Â Â 
Â  // --- Listeners Drag & Drop ---
Â  let dragCounter = 0;
Â  U.on(document, 'dragenter', e => { e.preventDefault(); e.stopPropagation(); dragCounter++;
Â  Â  if (app.currentView === 'biblioteca') { const z = U.q('drag-drop-zone'); if(z){ z.style.display = 'block'; U.addClass(z, 'drag-over'); }}
Â  });
Â  U.on(document, 'dragleave', e => { e.preventDefault(); e.stopPropagation(); dragCounter--;
Â  Â  if (dragCounter === 0) { const z = U.q('drag-drop-zone'); if(z) U.removeClass(z, 'drag-over'); }
Â  });
Â  U.on(document, 'dragover', e => { e.preventDefault(); e.stopPropagation(); });
Â  U.on(document, 'drop', e => { e.preventDefault(); e.stopPropagation(); dragCounter = 0;
Â  Â  const z = U.q('drag-drop-zone'); if(z) { U.removeClass(z, 'drag-over'); z.style.display = 'none'; }
Â  Â  if (e.dataTransfer.files && e.dataTransfer.files.length > 0) { handleLocalFileUpload(e.dataTransfer.files); }
Â  });

Â  // --- Listeners del Reproductor ---
Â  U.on(U.q('play-btn'), 'click', togglePlayPause);
Â  U.on(U.q('stop-player-btn'), 'click', stopPlayback);
Â  U.on(U.q('prev-btn'), 'click', playPrevSong);
Â  U.on(U.q('next-btn'), 'click', playNextSong);
Â  U.on(U.q('shuffle-btn'), 'click', () => { app.shuffleMode = !app.shuffleMode; U.q('shuffle-btn').style.opacity = app.shuffleMode ? '1' : '0.5'; U.announce(app.shuffleMode ? 'Aleatorio activado' : 'Aleatorio desactivado'); });
id="repeat-btn"'), 'click', () => {
Â  Â  app.repeatMode = app.repeatMode === 'none' ? 'all' : app.repeatMode === 'all' ? 'one' : 'none';
Â  Â  U.text(U.q('repeat-btn'), app.repeatMode === 'one' ? 'ğŸ”‚' : 'ğŸ”');
Â  Â  U.q('repeat-btn').style.opacity = app.repeatMode === 'none' ? '0.5' : '1';
Â  Â  U.announce(app.repeatMode === 'one' ? 'Repetir una' : app.repeatMode === 'all' ? 'Repetir todo' : 'No repetir');
Â  });
Â  U.on(U.q('volume-slider'), 'input', e => {
Â  Â  app.volume = e.target.value / 100;
Â  Â  U.q('audio-player').volume = app.volume;
Â  Â  if (app.ytPlayer && app.ytPlayer.setVolume) app.ytPlayer.setVolume(app.volume * 100);
Â  Â  U.text(U.q('volume-icon'), app.volume === 0 ? 'ğŸ”‡' : app.volume < 0.5 ? 'ğŸ”‰' : 'ğŸ”Š');
Â  });
Â  U.q('audio-player').volume = app.volume;
Â  U.on(U.q('volume-icon'), 'click', () => {
Â  Â  const slider = U.q('volume-slider');
Â  Â  if (app.volume > 0) { slider.dataset.prev = app.volume; slider.value = 0; app.volume = 0; }
Â  Â  else { const prev = parseFloat(slider.dataset.prev) || 0.7; slider.value = prev * 100; app.volume = prev; }
Â  Â  U.q('audio-player').volume = app.volume;
Â  Â  if (app.ytPlayer && app.ytPlayer.setVolume) app.ytPlayer.setVolume(app.volume * 100);
Â  Â  U.text(U.q('volume-icon'), app.volume === 0 ? 'ğŸ”‡' : 'ğŸ”Š');
Â  });
Â  U.on(U.q('youtube-toggle-btn'), 'click', () => {
Â  Â  const c = U.q('youtube-player-container');
Â  Â  app.videoVisible = !app.videoVisible;
Â  Â  U.toggleClass(c, 'youtube-hidden', !app.videoVisible); U.toggleClass(c, 'youtube-visible', app.videoVisible);
Â  Â  U.text(U.q('youtube-toggle-btn'), app.videoVisible ? 'ğŸ™ˆ' : 'ğŸ“º');
Â  });

Â  // --- Listeners de Filtros y BÃºsqueda ---
Â  U.on(U.q('genre-filter'), 'change', renderSongs);
Â  U.on(U.q('mood-filter'), 'change', renderSongs);
Â  U.on(U.q('search-input'), 'input', renderSongs);

Â  // --- Listeners del <audio> ---
Â  const audio = U.q('audio-player');
Â  U.on(audio, 'timeupdate', () => {
Â  Â  if (audio.duration) {
Â  Â  Â  U.q('progress-fill').style.width = ((audio.currentTime / audio.duration) * 100) + '%';
Â  Â  Â  U.text(U.q('current-time'), U.fmt(audio.currentTime));
Â  Â  Â  U.text(U.q('total-time'), U.fmt(audio.duration));
Â  Â  }
Â  });
Â  U.on(audio, 'loadedmetadata', () => { U.text(U.q('total-time'), U.fmt(audio.duration)); });
Â  U.on(audio, 'ended', playNextSong); // Usar la nueva funciÃ³n
Â  U.on(audio, 'error', (e) => {
Â  Â  console.error('âŒ Error de audio:', e);
Â  Â  if(audio.error) console.error('CÃ³digo:', audio.error.code);
Â  });
Â Â 
Â  // --- Listeners de Modales ---
Â  U.on(U.q('save-event-btn'), 'click', saveEvent);
Â  U.on(U.q('create-playlist-btn'), 'click', () => createPlaylist());
Â  U.on(U.q('create-and-add-playlist-btn'), 'click', createAndAddPlaylist);
Â Â 
Â  // --- Renderizado Final ---
Â  document.documentElement.setAttribute('data-color-scheme', 'dark');
Â  renderCalendar();
});
</script>
</body>
</html>
