<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reproductor Musical Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
/* DESIGN SYSTEM COMPACTO */
:root {
  --color-white: #fff; --color-black: #000; --color-cream-50: #fcfcf9; --color-cream-100: #ffffd; --color-gray-200: #f5f5f5;
  --color-gray-300: #a7a9a9; --color-gray-400: #777c7c; --color-slate-500: #626c71; --color-brown-600: #5e5240;
  --color-charcoal-700: #1f2121; --color-charcoal-800: #262828; --color-slate-900: #13343b; --color-teal-300: #32b8c6;
  --color-teal-400: #2da6b2; --color-teal-500: #21808d; --color-teal-600: #1d7480; --color-teal-700: #1a6873;
  --color-red-400: #ff5459; --color-red-500: #c0152f; --color-orange-400: #e68161; --color-orange-500: #a84b2f;
  --color-brown-600-rgb: 94, 82, 64; --color-teal-500-rgb: 33, 128, 141; --color-slate-900-rgb: 19, 52, 59;
  --color-bg-1: rgba(59, 130, 246, 0.08); --color-bg-2: rgba(245, 158, 11, 0.08); --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-background: var(--color-cream-50); --color-surface: var(--color-cream-100); --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500); --color-primary: var(--color-teal-500); --color-primary-hover: var(--color-teal-600);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12); --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50); --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --font-family-base: "FKGroteskNeue", "Inter", -apple-system, sans-serif; --font-size-xs: 11px; --font-size-sm: 12px;
  --font-size-base: 14px; --font-size-lg: 16px; --font-size-xl: 18px; --font-size-2xl: 20px; --font-size-3xl: 24px;
  --space-4: 4px; --space-8: 8px; --space-12: 12px; --space-16: 16px; --space-20: 20px; --space-24: 24px; --space-32: 32px;
  --radius-sm: 6px; --radius-base: 8px; --radius-lg: 12px; --shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.04);
}
[data-color-scheme="dark"] {
  --color-gray-400-rgb: 119, 124, 124; --color-gray-200-rgb: 245, 245, 245; --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800); --color-text: var(--color-gray-200); --color-text-secondary: rgba(var(--color-gray-400-rgb), 0.7);
  --color-primary: var(--color-teal-300); --color-secondary: rgba(var(--color-gray-400-rgb), 0.15); --color-border: rgba(var(--color-gray-400-rgb), 0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-family-base); background: var(--color-background); color: var(--color-text); transition: 0.3s; }
.app-container { display: flex; height: 100vh; overflow: hidden; }
.sidebar { width: 240px; background: var(--color-surface); border-right: 1px solid var(--color-border); padding: var(--space-24); display: flex; flex-direction: column; }
.sidebar-title { font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--space-16); }
.sidebar-item { padding: var(--space-12) var(--space-16); border-radius: var(--radius-base); cursor: pointer; transition: 0.2s; font-size: var(--font-size-base); background: transparent; border: none; width: 100%; text-align: left; color: var(--color-text-secondary); }
.sidebar-item:hover { background: var(--color-secondary); }
.sidebar-item.active { background: var(--color-primary); color: var(--color-btn-primary-text); font-weight: 500; }
.main-content { flex: 1; padding: var(--space-32); overflow-y: auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-32); }
.month-nav { display: flex; align-items: center; gap: var(--space-12); }
.month-nav button, .icon-button { background: var(--color-secondary); border: none; border-radius: var(--radius-base); padding: var(--space-8) var(--space-12); cursor: pointer; color: var(--color-text); transition: 0.2s; }
.month-nav button:hover, .icon-button:hover { background: rgba(var(--color-brown-600-rgb), 0.2); }
.month-title { font-size: var(--font-size-3xl); font-weight: 600; min-width: 250px; text-align: center; }
.view-container { display: none; }
.view-container.active { display: block; }
.search-input { width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); margin-bottom: var(--space-16); }
.songs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-16); margin-bottom: 100px; }
.song-card { position: relative; display: flex; flex-direction: column; gap: 8px; padding: 12px; border-radius: 12px; background: var(--color-surface); cursor: pointer; transition: all 0.3s; border: 1px solid var(--color-card-border); overflow: visible; }
.song-card:hover { background: var(--color-secondary); transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--color-primary); }
.song-card.playing { border-color: var(--color-primary); background: var(--color-secondary); }
.song-cover { width: 100%; aspect-ratio: 1; border-radius: var(--radius-base); margin-bottom: var(--space-12); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-3xl); background: var(--color-background); }
.song-cover img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-base); }
.song-info { flex: 1; min-width: 0; }
.song-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-artist { font-size: 12px; color: var(--color-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.favorite-btn { position: absolute; top: 8px; right: 44px; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; z-index: 10; }
.song-type-badge { position: absolute; top: 8px; left: 8px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(50,184,198,0.95); border-radius: 50%; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 20; border: 2px solid white; }
[data-color-scheme="dark"] .song-type-badge { background: rgba(0,0,0,0.7); }
.song-delete-btn { position: absolute; bottom: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; background: rgba(244,67,54,0.9); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; z-index: 10; }
.song-card:hover .song-delete-btn { opacity: 1; }
.song-delete-btn:hover { background: rgba(244,67,54,1); transform: scale(1.05); }
.mini-player { position: fixed; bottom: 0; left: 240px; right: 0; background: var(--color-surface); border-top: 1px solid var(--color-border); padding: var(--space-16) var(--space-24); display: none; flex-direction: column; gap: var(--space-12); z-index: 100; }
.mini-player.active { display: flex; }
.mini-player-top { display: flex; align-items: center; gap: var(--space-16); width: 100%; }
.mini-player-cover { width: 56px; height: 56px; border-radius: var(--radius-base); background: var(--color-background); display: flex; align-items: center; justify-content: center; font-size: var(--font-size-2xl); flex-shrink: 0; }
.mini-player-info { flex: 1; min-width: 0; }
.mini-player-title { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mini-player-artist { color: var(--color-text-secondary); font-size: var(--font-size-sm); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.mini-player-controls { display: flex; gap: var(--space-8); align-items: center; }
.mini-player-btn { background: var(--color-secondary); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 18px; }
.mini-player-btn:hover { background: rgba(var(--color-brown-600-rgb), 0.25); }
.mini-player-btn.play-btn { width: 48px; height: 48px; background: var(--color-primary); color: var(--color-btn-primary-text); }
.progress-container { flex: 1; }
.progress-bar { width: 100%; height: 6px; background: var(--color-secondary); border-radius: 99px; cursor: pointer; position: relative; }
.progress-bar-fill { height: 100%; background: var(--color-primary); border-radius: 99px; transition: width 0.1s linear; }
.time-display { display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: 4px; }
.volume-slider { width: 80px; height: 4px; -webkit-appearance: none; background: var(--color-secondary); border-radius: 99px; cursor: pointer; }
.volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--color-primary); border-radius: 50%; cursor: pointer; }
.calendar { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-24); border: 1px solid var(--color-card-border); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--space-8); }
.calendar-header { text-align: center; font-weight: 600; font-size: var(--font-size-sm); padding: var(--space-12); color: var(--color-text-secondary); }
.calendar-day { aspect-ratio: 1; border: 2px solid transparent; border-radius: 12px; padding: var(--space-8); cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--color-background); }
.calendar-day:hover { border-color: var(--color-primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
.calendar-day.has-emotion { border-width: 3px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.calendar-day.today { border-color: var(--color-primary); font-weight: 600; }
.day-number { font-size: 14px; font-weight: 600; }
.day-emoji { font-size: 24px; margin-top: 4px; }
.modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-32); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-md); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24); }
.modal-title { font-size: var(--font-size-2xl); font-weight: 600; }
.close-button { background: none; border: none; font-size: var(--font-size-2xl); cursor: pointer; color: var(--color-text-secondary); padding: 0; width: 32px; height: 32px; }
.form-group { margin-bottom: var(--space-24); }
.form-label { display: block; margin-bottom: var(--space-8); font-weight: 500; font-size: var(--font-size-sm); }
.text-input, textarea { width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-background); color: var(--color-text); font-family: var(--font-family-base); }
textarea { min-height: 120px; resize: vertical; }
.btn { padding: var(--space-12) var(--space-24); border-radius: var(--radius-base); border: none; font-size: var(--font-size-base); font-weight: 500; cursor: pointer; transition: 0.2s; }
.btn-primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
.btn-primary:hover { background: var(--color-primary-hover); }
.btn-secondary { background: var(--color-secondary); color: var(--color-text); }
.tags-flow { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 16px; font-size: 11px; font-weight: 500; border: 1px solid; }
.tag-chip-genre { background: #E8EAF6; color: #3F51B5; border-color: #C5CAE9; }
.tag-chip-mood { background: #FCE4EC; color: #C2185B; border-color: #F8BBD0; }
.tag-chip-custom { background: #E0F2F1; color: #00897B; border-color: #B2DFDB; }
.tag-close { background: rgba(0,0,0,0.1); border: none; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; font-size: 11px; padding: 0; }
.tag-add-compact { width: 24px; height: 24px; border: 1.5px dashed #999; border-radius: 50%; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.empty-state { text-align: center; padding: 40px; color: var(--color-text-secondary); }
.stop-player-btn { position: absolute; top: 10px; left: 10px; width: 28px; height: 28px; background: rgba(0,0,0,0.1); border: none; border-radius: 50%; color: #666; font-size: 16px; cursor: pointer; z-index: 10; }
.stop-player-btn:hover { background: rgba(255,0,0,0.15); color: #f44336; }
#youtube-player-container { position: fixed; bottom: 100px; right: 20px; width: 400px; height: 225px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 999; background: #000; transition: all 0.3s ease; }
#youtube-player-container.youtube-hidden { width: 1px; height: 1px; bottom: -100px; right: -100px; opacity: 0; pointer-events: none; }
#youtube-player-container.youtube-visible { opacity: 1; pointer-events: auto; }
.youtube-toggle-btn-player { background: rgba(255,0,0,0.1); border: 2px solid #FF0000; color: #FF0000; padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-left: 15px; display: none; }
.loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--color-surface); padding: 40px; border-radius: var(--radius-lg); box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; z-index: 10000; }
.upload-section { display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
.btn-upload { background: var(--color-teal-500); color: var(--color-btn-primary-text); border: none; padding: 10px 16px; border-radius: var(--radius-base); cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: var(--font-size-base); }
.btn-upload:hover { background: var(--color-teal-600); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(50,184,198,0.3); }
[data-color-scheme="dark"] .btn-upload { background: var(--color-teal-300); color: var(--color-slate-900); }
[data-color-scheme="dark"] .btn-upload:hover { background: var(--color-teal-400); }
.drag-drop-zone { border: 2px dashed var(--color-border); border-radius: var(--radius-lg); padding: 20px; text-align: center; color: var(--color-text-secondary); transition: all 0.2s; display: none; }
.drag-drop-zone.drag-over { border-color: var(--color-primary); background: var(--color-secondary); color: var(--color-text); }
.song-album { font-size: 11px; color: var(--color-text-secondary); margin-top: 4px; opacity: 0.8; }
.spinner { width: 50px; height: 50px; border: 5px solid var(--color-secondary); border-top: 5px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); }
.library-filters { display: flex; gap: var(--space-12); margin-bottom: var(--space-16); }
.library-filters select { padding: var(--space-8) var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-surface); color: var(--color-text); cursor: pointer; }
  </style>
</head>
<body>
<div id="aria-live-region" aria-live="polite" class="sr-only"></div>
<div class="app-container">
  <aside class="sidebar">
    <h1 class="sidebar-title">üéµ Mi M√∫sica</h1>
    <button class="sidebar-item active" data-view="calendario" tabindex="0">üìÖ Calendario</button>
    <button class="sidebar-item" data-view="biblioteca" tabindex="0">üìö Biblioteca</button>
    <button class="sidebar-item" data-view="playlists" tabindex="0">üéß Playlists</button>
    <button class="sidebar-item" data-view="favoritos" tabindex="0">‚≠ê Favoritos</button>
    <button id="theme-toggle" class="sidebar-item" style="margin-top: auto;" tabindex="0">üåì Tema</button>
  </aside>
  <main class="main-content">
    <header class="header">
      <div class="month-nav">
        <button id="prev-month">‚óÄ</button>
        <h2 class="month-title" id="month-title"></h2>
        <button id="next-month">‚ñ∂</button>
      </div>
      <button class="icon-button" id="settings-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
    </header>
    <div class="view-container active" id="calendario-view">
      <div class="calendar">
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>
    </div>
    <div class="view-container" id="biblioteca-view">
      <div class="upload-section">
        <button class="btn-upload" id="upload-local-btn" title="Carga canciones desde tu ordenador">üíø Cargar Canci√≥n Local</button>
        <button class="btn btn-primary" id="load-folder-btn">üìÅ Cargar Carpeta</button>
        <button class="btn btn-primary" id="add-youtube-btn">‚ñ∂Ô∏è A√±adir YouTube</button>
        <input type="file" id="local-file-input" accept="audio/*" multiple style="display: none;">
        <input type="file" id="folder-input" webkitdirectory multiple accept="audio/*" style="display: none;">
      </div>
      <div class="drag-drop-zone" id="drag-drop-zone">
        <div style="font-size: 48px; margin-bottom: 12px;">üéµ</div>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Arrastra archivos aqu√≠</div>
        <div style="font-size: 12px;">o usa el bot√≥n "Cargar Canci√≥n Local"</div>
      </div>
      <div class="library-filters">
        <select id="genre-filter"><option value="">Todos los g√©neros</option></select>
        <select id="mood-filter"><option value="">Todos los estados</option></select>
      </div>
      <input type="text" class="search-input" id="search-input" placeholder="üîç Buscar...">
      <div class="songs-grid" id="songs-grid"></div>
    </div>
    <div class="view-container" id="playlists-view">
      <div id="playlists-list"></div>
    </div>
    <div class="view-container" id="favoritos-view">
      <div class="songs-grid" id="favorites-grid"></div>
    </div>
  </main>
</div>
<div class="mini-player" id="mini-player">
  <button id="stop-player-btn" class="stop-player-btn" title="Detener">‚úï</button>
  <div class="mini-player-top">
    <div class="mini-player-cover" id="player-cover">üéµ</div>
    <div class="mini-player-info">
      <div class="mini-player-title" id="player-title">Sin reproducci√≥n</div>
      <div class="mini-player-artist" id="player-artist"></div>
    </div>
    <div class="mini-player-controls">
      <button class="mini-player-btn" id="prev-btn">‚èÆÔ∏è</button>
      <button class="mini-player-btn play-btn" id="play-btn">‚ñ∂Ô∏è</button>
      <button class="mini-player-btn" id="next-btn">‚è≠Ô∏è</button>
      <button class="mini-player-btn" id="shuffle-btn" style="opacity: 0.5">üîÄ</button>
      <button class="mini-player-btn" id="repeat-btn" style="opacity: 0.5">üîÅ</button>
      <button class="youtube-toggle-btn-player" id="youtube-toggle-btn">üì∫</button>
    </div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <button class="mini-player-btn" id="volume-icon">üîä</button>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="70">
    </div>
  </div>
  <div class="progress-container">
    <div class="progress-bar" id="progress-bar"><div class="progress-bar-fill" id="progress-fill"></div></div>
    <div class="time-display"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
  </div>
</div>
<audio id="audio-player"></audio>
<div id="youtube-player-container" class="youtube-hidden"></div>
<div class="modal" id="youtube-modal">
  <div class="modal-content">
    <div class="modal-header"><h3 class="modal-title">üåê A√±adir desde YouTube</h3><button class="close-button" onclick="U.closeModal('youtube-modal')">&times;</button></div>
    <div class="form-group"><label class="form-label">URL:</label><input type="text" id="youtube-url" class="text-input" placeholder="https://youtube.com/watch?v=..."></div>
    <div class="form-group"><label class="form-label">T√≠tulo:</label><input type="text" id="youtube-title" class="text-input"></div>
    <div class="form-group"><label class="form-label">Artista:</label><input type="text" id="youtube-artist" class="text-input"></div>
    <div style="display: flex; gap: 12px; justify-content: flex-end;"><button class="btn btn-secondary" onclick="U.closeModal('youtube-modal')">Cancelar</button><button class="btn btn-primary" id="save-youtube-btn">Guardar</button></div>
  </div>
</div>
<script>
// === TIPOS DE CANCIONES ===
const SONG_TYPES = { GITHUB: 'github', LOCAL: 'local', YOUTUBE: 'youtube' };
const SONG_TYPE_ICONS = { [SONG_TYPES.GITHUB]: 'üåê', [SONG_TYPES.LOCAL]: 'üíø', [SONG_TYPES.YOUTUBE]: '‚ñ∂Ô∏è' };
const SONG_TYPE_LABELS = { [SONG_TYPES.GITHUB]: 'GitHub', [SONG_TYPES.LOCAL]: 'Local', [SONG_TYPES.YOUTUBE]: 'YouTube' };

// === CONFIGURACI√ìN GITHUB ===
const GITHUB_CONFIG = {
  owner: 'mrdaniel7',
  repo: 'CalendarioMultimedia',
  branch: 'main',
  musicFolder: 'musica'
};

// === FUNCI√ìN PARA CARGAR CANCIONES DE GITHUB ===
const fetchGitHubSongs = async () => {
  try {
    const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.musicFolder}?ref=${GITHUB_CONFIG.branch}`;
    
    console.log('üåê Buscando canciones en GitHub:', apiUrl);
    
    const response = await fetch(apiUrl);
    
    if (!response.ok) {
      console.warn('‚ö†Ô∏è No se encontr√≥ carpeta de m√∫sica en GitHub');
      return [];
    }
    
    const files = await response.json();
    const gitHubSongs = [];
    
    const audioExtensions = ['.mp3', '.wav', '.flac', '.ogg', '.m4a'];
    
    for (const file of files) {
      if (file.type === 'file' && audioExtensions.some(ext => file.name.toLowerCase().endsWith(ext))) {
        const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.musicFolder}/${file.name}`;
        
        const song = {
          id: app.nextId++,
          title: file.name.replace(/\.[^/.]+$/, ''),
          artist: GITHUB_CONFIG.owner,
          album: 'GitHub Repository',
          duration: 0,
          type: SONG_TYPES.GITHUB,
          fileName: file.name,
          fileUrl: rawUrl,
          fileSize: file.size,
          cover: 'üåê',
          genres: [],
          moods: [],
          isFavorite: false,
          dateAdded: new Date().toISOString()
        };
        
        console.log('‚úÖ Canci√≥n GitHub encontrada:', song.title);
        gitHubSongs.push(song);
      }
    }
    
    console.log(`üìä Total canciones en GitHub: ${gitHubSongs.length}`);
    return gitHubSongs;
    
  } catch (error) {
    console.error('‚ùå Error obteniendo canciones de GitHub:', error);
    return [];
  }
};

const loadGitHubSongs = async () => {
  const gitHubSongs = await fetchGitHubSongs();
  if (gitHubSongs.length > 0) {
    app.songs.push(...gitHubSongs);
    console.log(`üåê ${gitHubSongs.length} canciones cargadas de GitHub`);
  }
  return gitHubSongs;
};

// === DATOS CENTRALIZADOS ===
const app = {
  songs: [], currentIndex: -1, currentDate: new Date(2025, 9, 29), isPlaying: false, videoVisible: false,
  nextId: 1000, shuffleMode: false, repeatMode: 'none', volume: 0.7, currentView: 'calendario',
  genres: ['Rock','Pop','Jazz','Blues','Classical','Electronic','Hip Hop','R&B','Country','Reggae','Metal','Indie','Folk','Soul','Funk','Punk','Latin','Reggaeton','Salsa','Trap','Techno','House'],
  moods: ['Feliz','Triste','En√©rgico','Relajado','Rom√°ntico','Motivador','Melanc√≥lico','Nost√°lgico','Euf√≥rico','Tranquilo','Agresivo','Inspirador','Dram√°tico','Festivo'],
  calendarData: {
    '2025-01-01': {mood:'Euf√≥rico',emoji:'üéÜ',color:'#FFD700',songs:15,time:60},'2025-01-05': {mood:'Motivador',emoji:'üí™',color:'#FF4500',songs:10,time:42},'2025-01-10': {mood:'Feliz',emoji:'üòÉ',color:'#FFD700',songs:12,time:48},'2025-01-15': {mood:'Relajado',emoji:'üåø',color:'#4ECDC4',songs:8,time:35},'2025-01-20': {mood:'En√©rgico',emoji:'‚ö°',color:'#FF6B35',songs:14,time:55},'2025-01-25': {mood:'Tranquilo',emoji:'‚òÆÔ∏è',color:'#90EE90',songs:6,time:28},'2025-01-30': {mood:'Nost√°lgico',emoji:'üìª',color:'#CD853F',songs:9,time:38},'2025-02-02': {mood:'Rom√°ntico',emoji:'‚ù§Ô∏è',color:'#FF69B4',songs:11,time:45},'2025-02-08': {mood:'Feliz',emoji:'üòä',color:'#FFD700',songs:13,time:52},'2025-02-14': {mood:'Rom√°ntico',emoji:'üíï',color:'#FF69B4',songs:18,time:72},'2025-02-18': {mood:'Melanc√≥lico',emoji:'üåßÔ∏è',color:'#708090',songs:7,time:30},'2025-02-22': {mood:'En√©rgico',emoji:'üî•',color:'#FF4500',songs:15,time:60},'2025-03-03': {mood:'Motivador',emoji:'üöÄ',color:'#FF4500',songs:12,time:48},'2025-03-08': {mood:'Feliz',emoji:'üå∏',color:'#FFD700',songs:14,time:56},'2025-03-12': {mood:'En√©rgico',emoji:'‚ö°',color:'#FF6B35',songs:16,time:64},'2025-03-17': {mood:'Festivo',emoji:'üçÄ',color:'#228B22',songs:20,time:80},'2025-03-22': {mood:'Relajado',emoji:'üåä',color:'#4ECDC4',songs:9,time:36},'2025-04-01': {mood:'Feliz',emoji:'üòÜ',color:'#FFD700',songs:13,time:52},'2025-04-06': {mood:'Relajado',emoji:'üåø',color:'#4ECDC4',songs:10,time:40},'2025-04-12': {mood:'Rom√°ntico',emoji:'üåπ',color:'#FF69B4',songs:12,time:48},'2025-04-18': {mood:'En√©rgico',emoji:'üí•',color:'#FF6B35',songs:15,time:60},'2025-05-01': {mood:'Festivo',emoji:'üå∫',color:'#FF1493',songs:19,time:76},'2025-05-10': {mood:'Feliz',emoji:'‚òÄÔ∏è',color:'#FFD700',songs:16,time:64},'2025-05-15': {mood:'Rom√°ntico',emoji:'üíê',color:'#FF69B4',songs:13,time:52},'2025-05-20': {mood:'Relajado',emoji:'üçÉ',color:'#4ECDC4',songs:9,time:36},'2025-06-02': {mood:'Festivo',emoji:'üèñÔ∏è',color:'#00CED1',songs:18,time:72},'2025-06-07': {mood:'Feliz',emoji:'üòé',color:'#FFD700',songs:14,time:56},'2025-06-12': {mood:'Relajado',emoji:'üåä',color:'#4ECDC4',songs:11,time:44},'2025-06-17': {mood:'En√©rgico',emoji:'üî•',color:'#FF6B35',songs:16,time:64},'2025-07-04': {mood:'Festivo',emoji:'üéÜ',color:'#FF4500',songs:22,time:88},'2025-07-09': {mood:'Feliz',emoji:'üåû',color:'#FFD700',songs:15,time:60},'2025-07-14': {mood:'Festivo',emoji:'üá´üá∑',color:'#0055A4',songs:20,time:80},'2025-07-19': {mood:'Relajado',emoji:'üèùÔ∏è',color:'#4ECDC4',songs:10,time:40},'2025-08-03': {mood:'Relajado',emoji:'üåä',color:'#4ECDC4',songs:12,time:48},'2025-08-08': {mood:'Feliz',emoji:'‚òÄÔ∏è',color:'#FFD700',songs:14,time:56},'2025-08-13': {mood:'En√©rgico',emoji:'üî•',color:'#FF6B35',songs:15,time:60},'2025-08-18': {mood:'Rom√°ntico',emoji:'üåÖ',color:'#FF69B4',songs:11,time:44},'2025-09-03': {mood:'En√©rgico',emoji:'üí•',color:'#FF6B35',songs:13,time:52},'2025-09-07': {mood:'Feliz',emoji:'‚òÄÔ∏è',color:'#FFD700',songs:12,time:48},'2025-09-12': {mood:'Relajado',emoji:'üåä',color:'#4ECDC4',songs:10,time:40},'2025-09-15': {mood:'Motivador',emoji:'üéØ',color:'#FF4500',songs:14,time:56},'2025-10-01': {mood:'Feliz',emoji:'üòÉ',color:'#FFD700',songs:12,time:48},'2025-10-03': {mood:'En√©rgico',emoji:'‚ö°',color:'#FF6B35',songs:15,time:60},'2025-10-05': {mood:'Relajado',emoji:'üåø',color:'#4ECDC4',songs:10,time:40},'2025-10-07': {mood:'Rom√°ntico',emoji:'‚ù§Ô∏è',color:'#FF69B4',songs:13,time:52},'2025-10-09': {mood:'Triste',emoji:'üò¢',color:'#6495ED',songs:8,time:32},'2025-10-12': {mood:'Motivador',emoji:'üí™',color:'#FF4500',songs:14,time:56},'2025-10-14': {mood:'Festivo',emoji:'üéâ',color:'#9370DB',songs:16,time:64},'2025-10-16': {mood:'Nost√°lgico',emoji:'üìª',color:'#CD853F',songs:9,time:36},'2025-10-18': {mood:'Tranquilo',emoji:'‚òÆÔ∏è',color:'#90EE90',songs:7,time:28},'2025-10-20': {mood:'Euf√≥rico',emoji:'ü§©',color:'#FFD700',songs:17,time:68},'2025-10-22': {mood:'Melanc√≥lico',emoji:'üåßÔ∏è',color:'#708090',songs:8,time:32},'2025-10-24': {mood:'Inspirador',emoji:'‚ú®',color:'#DDA0DD',songs:11,time:44},'2025-10-26': {mood:'En√©rgico',emoji:'üî•',color:'#FF4500',songs:15,time:60},'2025-10-28': {mood:'Feliz',emoji:'üòä',color:'#FFD700',songs:12,time:48},'2025-10-30': {mood:'Festivo',emoji:'üéÉ',color:'#FF8C00',songs:18,time:72},'2025-11-02': {mood:'Relajado',emoji:'üçÉ',color:'#4ECDC4',songs:10,time:40},'2025-11-05': {mood:'Motivador',emoji:'üöÄ',color:'#FF4500',songs:14,time:56},'2025-11-08': {mood:'Rom√°ntico',emoji:'üíï',color:'#FF69B4',songs:12,time:48},'2025-11-11': {mood:'Tranquilo',emoji:'üßò',color:'#90EE90',songs:8,time:32}
  },
  audioCtx: null, audioSrc: null, eqFilters: [], gainNode: null
};

// === UTILIDADES ===
const U = {
  q: id => document.getElementById(id),
  qa: sel => document.querySelectorAll(sel),
  on: (el, evt, fn) => el?.addEventListener(evt, fn),
  text: (el, txt) => el && (el.textContent = txt),
  html: (el, h) => el && (el.innerHTML = h),
  show: el => el && (el.style.display = ''),
  hide: el => el && (el.style.display = 'none'),
  addClass: (el, cls) => el?.classList.add(cls),
  removeClass: (el, cls) => el?.classList.remove(cls),
  toggleClass: (el, cls) => el?.classList.toggle(cls),
  fmt: s => { const m = Math.floor(s/60), sec = s%60; return `${m}:${sec.toString().padStart(2,'0')}`; },
  announce: msg => { const a = U.q('aria-live-region'); if(a) a.textContent = msg; },
  closeModal: id => U.removeClass(U.q(id), 'active')
};

// === FUNCIONES PRINCIPALES ===
function renderSongs() {
  const container = U.q('songs-grid');
  if (!container) return;
  const genreFilter = U.q('genre-filter').value;
  const moodFilter = U.q('mood-filter').value;
  const searchTerm = U.q('search-input').value.toLowerCase();
  let filtered = app.songs.filter(s => {
    if (genreFilter && (!s.genres || !s.genres.includes(genreFilter))) return false;
    if (moodFilter && (!s.moods || !s.moods.includes(moodFilter))) return false;
    if (searchTerm && !s.title.toLowerCase().includes(searchTerm) && !s.artist.toLowerCase().includes(searchTerm)) return false;
    return true;
  });
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div style="font-size: 64px;">üéµ</div><p>No hay canciones</p></div>';
    return;
  }
  container.innerHTML = filtered.map(s => {
    const typeIcon = SONG_TYPE_ICONS[s.type] || 'üéµ';
    const typeLabel = SONG_TYPE_LABELS[s.type] || 'Desconocido';
    const cover = s.cover && (s.cover.startsWith('data:') || s.cover.startsWith('http')) ? `<img src="${s.cover}" alt="${s.title}">` : ['üé∏','üé§','üéπ','ü•Å','üé∫','üéª','üéß'][s.id % 7];
    const tags = (s.genres || []).map(g => `<span class="tag-chip tag-chip-genre">${g}</span>`).join('') + (s.moods || []).map(m => `<span class="tag-chip tag-chip-mood">${m}</span>`).join('');
    const album = s.album || typeLabel;
    return `<div class="song-card ${app.currentIndex >= 0 && app.songs[app.currentIndex].id === s.id ? 'playing' : ''}" onclick="playSong(${s.id})"><div class="song-type-badge" title="${typeLabel}">${typeIcon}</div><button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${s.id})">${s.isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button><div class="song-cover">${cover}</div><div class="song-title">${s.title}</div><div class="song-artist">${s.artist}</div><div class="song-album">${album}</div><div class="tags-flow">${tags}</div><button class="song-delete-btn" onclick="event.stopPropagation();deleteSong(${s.id})" title="Eliminar">üóëÔ∏è Eliminar</button></div>`;
  }).join('');
}

function playSong(id) {
  const song = app.songs.find(s => s.id === id);
  if (!song) return;
  
  app.currentIndex = app.songs.indexOf(song);
  
  // LIMPIAR REPRODUCTOR ANTERIOR
  const audio = U.q('audio-player');
  audio.pause();
  audio.src = '';
  U.q('youtube-player-container').innerHTML = '';
  U.hide(U.q('youtube-toggle-btn'));
  
  // ACTUALIZAR UI
  U.text(U.q('player-title'), song.title);
  U.text(U.q('player-artist'), song.artist);
  U.text(U.q('play-btn'), '‚è∏Ô∏è');
  U.q('mini-player').classList.add('active');
  app.isPlaying = true;
  
  console.log('‚ñ∂Ô∏è Reproduciendo:', song.title, '| Tipo:', song.type);
  
  // REPRODUCIR SEG√öN TIPO
  if (song.type === 'youtube') {
    playYouTube(song);
  } else if (song.type === 'local' && song.blob) {
    try {
      const url = URL.createObjectURL(song.blob);
      audio.src = url;
      audio.crossOrigin = 'anonymous';
      audio.play().catch(e => {
        U.announce('Error: ' + e.message);
        console.error('Error al reproducir:', e);
      });
    } catch (e) {
      U.announce('Error al reproducir archivo');
      console.error(e);
    }
  } else if (song.type === 'github' && song.fileUrl) {
    // Reproducir desde GitHub
    console.log('üåê Reproduciendo desde GitHub:', song.fileUrl);
    try {
      audio.src = song.fileUrl;
      audio.crossOrigin = 'anonymous';
      audio.play().catch(e => {
        U.announce('Error al reproducir desde GitHub: ' + e.message);
        console.error('Error reproduciendo GitHub:', e);
      });
    } catch (e) {
      U.announce('Error al reproducir desde GitHub');
      console.error(e);
    }
  }
  
  renderSongs();
}

function playYouTube(song) {
  const container = U.q('youtube-player-container');
  container.innerHTML = '';
  
  const iframe = document.createElement('iframe');
  iframe.id = 'youtube-iframe-' + song.id;
  iframe.src = `https://www.youtube.com/embed/${song.youtubeId}?autoplay=1&controls=1&modestbranding=1&rel=0&fs=0&playsinline=1`;
  iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-presentation allow-forms allow-popups');
  iframe.setAttribute('allow', 'autoplay; encrypted-media; gyroscope; picture-in-picture; web-share');
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.border = 'none';
  iframe.style.borderRadius = '8px';
  iframe.allow = 'autoplay';
  
  container.appendChild(iframe);
  
  console.log('‚ñ∂Ô∏è YouTube reproduciendo:', song.title);
  
  // Mostrar bot√≥n de video
  setTimeout(() => {
    U.show(U.q('youtube-toggle-btn'));
  }, 100);
}

function stopPlayback() {
  // Detener audio local
  const audio = U.q('audio-player');
  audio.pause();
  audio.src = '';
  
  // Limpiar YouTube
  const container = U.q('youtube-player-container');
  container.innerHTML = '';
  U.hide(U.q('youtube-toggle-btn'));
  
  // Resetear UI
  U.text(U.q('player-title'), 'Sin reproducci√≥n');
  U.text(U.q('player-artist'), '');
  U.text(U.q('play-btn'), '‚ñ∂Ô∏è');
  U.q('progress-fill').style.width = '0%';
  U.text(U.q('current-time'), '0:00');
  U.text(U.q('total-time'), '0:00');
  
  app.isPlaying = false;
  app.currentIndex = -1;
  
  U.announce('Reproducci√≥n detenida');
  console.log('‚úÖ Reproducci√≥n detenida');
}

function renderCalendar() {
  const year = app.currentDate.getFullYear();
  const month = app.currentDate.getMonth();
  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  U.text(U.q('month-title'), `${monthNames[month]} ${year}`);
  const firstDay = new Date(year, month, 1).getDay() === 0 ? 6 : new Date(year, month, 1).getDay() - 1;
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();
  const grid = U.q('calendar-grid');
  grid.innerHTML = '';
  const dayHeaders = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
  dayHeaders.forEach(d => { const h = document.createElement('div'); h.className = 'calendar-header'; h.textContent = d; grid.appendChild(h); });
  for (let i = 0; i < firstDay; i++) { const e = document.createElement('div'); e.className = 'calendar-day'; grid.appendChild(e); }
  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const emotion = app.calendarData[dateKey];
    if (emotion) {
      dayEl.classList.add('has-emotion');
      dayEl.innerHTML = `<span class="day-number">${day}</span><span class="day-emoji">${emotion.emoji}</span>`;
      dayEl.style.borderColor = emotion.color;
      dayEl.onclick = () => showDayDetails(year, month, day, emotion);
    } else {
      dayEl.innerHTML = `<span class="day-number">${day}</span>`;
    }
    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
      dayEl.classList.add('today');
    }
    grid.appendChild(dayEl);
  }
}

function showDayDetails(year, month, day, emotion) {
  const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  alert(`üìÖ ${day} de ${monthNames[month]} ${year}\n\n${emotion.emoji} ${emotion.mood}\n\nüéµ ${emotion.songs} canciones\n‚è±Ô∏è ${emotion.time} min`);
}

function toggleFav(id) {
  const song = app.songs.find(s => s.id === id);
  if (song) { song.isFavorite = !song.isFavorite; renderSongs(); }
}

function switchView(view) {
  app.currentView = view;
  U.qa('.sidebar-item').forEach(item => {
    U.removeClass(item, 'active');
    if (item.getAttribute('data-view') === view) U.addClass(item, 'active');
  });
  U.qa('.view-container').forEach(v => U.removeClass(v, 'active'));
  const viewEl = U.q(view + '-view');
  if (viewEl) U.addClass(viewEl, 'active');
  if (view === 'calendario') renderCalendar();
  else if (view === 'biblioteca') renderSongs();
  else if (view === 'favoritos') renderFavorites();
}

function renderFavorites() {
  const container = U.q('favorites-grid');
  const favs = app.songs.filter(s => s.isFavorite);
  if (favs.length === 0) {
    container.innerHTML = '<div class="empty-state"><div style="font-size: 64px;">‚≠ê</div><p>No hay favoritos</p></div>';
    return;
  }
  container.innerHTML = favs.map(s => {
    const cover = s.cover && (s.cover.startsWith('data:') || s.cover.startsWith('http')) ? `<img src="${s.cover}" alt="${s.title}">` : ['üé∏','üé§','üéπ','ü•Å'][s.id % 4];
    return `<div class="song-card" onclick="playSong(${s.id})"><button class="favorite-btn" onclick="event.stopPropagation();toggleFav(${s.id})">‚ù§Ô∏è</button><div class="song-cover">${cover}</div><div class="song-title">${s.title}</div><div class="song-artist">${s.artist}</div></div>`;
  }).join('');
}

async function loadMusicFolder() {
  const input = U.q('folder-input');
  input.onchange = async e => {
    const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
    for (const file of files) {
      const song = {
        id: app.nextId++, title: file.name.replace(/\.[^/.]+$/, ''), artist: 'Desconocido',
        duration: 0, type: SONG_TYPES.LOCAL, blob: file, cover: null, genres: [], moods: [], isFavorite: false,
        album: 'Archivo Local', fileName: file.name
      };
      app.songs.push(song);
      await autoTagSong(song);
      await extractMetadata(song);
    }
    populateFilters();
    renderSongs();
    alert(`‚úÖ ${files.length} canciones cargadas`);
  };
  input.click();
}

async function handleLocalFileUpload(files) {
  const fileArray = Array.from(files).filter(f => f.type.startsWith('audio/'));
  if (fileArray.length === 0) {
    alert('‚ö†Ô∏è No se encontraron archivos de audio');
    return;
  }
  for (const file of fileArray) {
    const song = {
      id: app.nextId++, title: file.name.replace(/\.[^/.]+$/, ''), artist: 'Desconocido',
      duration: 0, type: SONG_TYPES.LOCAL, blob: file, cover: 'üíø', genres: [], moods: [], isFavorite: false,
      album: 'Archivo Local', fileName: file.name, fileSize: file.size, mimeType: file.type
    };
    app.songs.push(song);
    await autoTagSong(song);
    await extractMetadata(song);
    console.log('‚úÖ Canci√≥n local a√±adida:', song.title);
  }
  populateFilters();
  renderSongs();
  U.announce(`${fileArray.length} canciones a√±adidas`);
  alert(`‚úÖ ${fileArray.length} canciones a√±adidas a la biblioteca`);
}

async function extractMetadata(song) {
  if (!song.blob || typeof jsmediatags === 'undefined') return;
  try {
    await new Promise((resolve, reject) => {
      jsmediatags.read(song.blob, {
        onSuccess: (tag) => {
          if (tag.tags.title) song.title = tag.tags.title;
          if (tag.tags.artist) song.artist = tag.tags.artist;
          if (tag.tags.album) song.album = tag.tags.album;
          if (tag.tags.picture) {
            const pic = tag.tags.picture;
            const base64 = pic.data.reduce((acc, byte) => acc + String.fromCharCode(byte), '');
            song.cover = `data:${pic.format};base64,${btoa(base64)}`;
          }
          console.log('üéµ Metadatos extra√≠dos:', song.title);
          resolve();
        },
        onError: (error) => {
          console.warn('‚ö†Ô∏è No se pudieron extraer metadatos:', error);
          resolve();
        }
      });
    });
  } catch (error) {
    console.warn('‚ö†Ô∏è Error extrayendo metadatos:', error);
  }
}

function deleteSong(id) {
  const song = app.songs.find(s => s.id === id);
  if (!song) return;
  if (!confirm(`¬øEliminar "${song.title}"?`)) return;
  
  // Si es la canci√≥n actual, detener reproducci√≥n
  if (app.currentIndex >= 0 && app.songs[app.currentIndex].id === id) {
    stopPlayback();
  }
  
  // Eliminar del array
  app.songs = app.songs.filter(s => s.id !== id);
  
  console.log('üóëÔ∏è Canci√≥n eliminada:', song.title);
  U.announce(`Canci√≥n eliminada: ${song.title}`);
  populateFilters();
  renderSongs();
}

async function autoTagSong(song) {
  const title = song.title.toLowerCase();
  const keywords = { Rock: ['rock','guitar'], Pop: ['pop'], Jazz: ['jazz'], Electronic: ['electronic','edm'], 'Hip Hop': ['hip','hop','rap'] };
  Object.entries(keywords).forEach(([genre, words]) => { if (words.some(w => title.includes(w))) song.genres.push(genre); });
  if (song.genres.length === 0) song.genres.push('Pop');
  if (title.includes('happy') || title.includes('feliz')) song.moods.push('Feliz');
  else if (title.includes('sad')) song.moods.push('Triste');
  else song.moods.push('Relajado');
}

function populateFilters() {
  const genres = new Set(), moods = new Set();
  app.songs.forEach(s => { s.genres?.forEach(g => genres.add(g)); s.moods?.forEach(m => moods.add(m)); });
  const gf = U.q('genre-filter'), mf = U.q('mood-filter');
  gf.innerHTML = '<option value="">Todos los g√©neros</option>' + Array.from(genres).sort().map(g => `<option value="${g}">${g}</option>`).join('');
  mf.innerHTML = '<option value="">Todos los estados</option>' + Array.from(moods).sort().map(m => `<option value="${m}">${m}</option>`).join('');
}

async function saveYouTube() {
  const url = U.q('youtube-url').value.trim();
  if (!url) return alert('‚ö†Ô∏è Ingresa una URL');
  const videoId = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^&\\n?#]+)/)?.[1];
  if (!videoId) return alert('‚ùå URL inv√°lida');
  const title = U.q('youtube-title').value.trim() || 'Video de YouTube';
  const artist = U.q('youtube-artist').value.trim() || 'YouTube';
  const song = { id: app.nextId++, title, artist, type: SONG_TYPES.YOUTUBE, youtubeId: videoId, cover: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`, genres: ['Pop'], moods: ['Feliz'], isFavorite: false, album: 'YouTube' };
  app.songs.push(song);
  U.closeModal('youtube-modal');
  U.q('youtube-url').value = '';
  U.q('youtube-title').value = '';
  U.q('youtube-artist').value = '';
  populateFilters();
  renderSongs();
  alert('‚úÖ Canci√≥n de YouTube a√±adida');
}

// === EVENT LISTENERS ===
U.on(document, 'DOMContentLoaded', async () => {
  console.log('üöÄ Iniciando aplicaci√≥n...');
  
  // Cargar canciones de GitHub al inicio
  try {
    await loadGitHubSongs();
    populateFilters();
    renderSongs();
  } catch (e) {
    console.warn('‚ö†Ô∏è Error cargando canciones de GitHub:', e);
  }
  
  U.qa('.sidebar-item').forEach(item => U.on(item, 'click', e => {
    const view = e.target.getAttribute('data-view');
    if (view) switchView(view);
  }));
  U.on(U.q('prev-month'), 'click', () => { app.currentDate.setMonth(app.currentDate.getMonth() - 1); renderCalendar(); });
  U.on(U.q('next-month'), 'click', () => { app.currentDate.setMonth(app.currentDate.getMonth() + 1); renderCalendar(); });
  U.on(U.q('theme-toggle'), 'click', () => {
    const scheme = document.documentElement.getAttribute('data-color-scheme');
    document.documentElement.setAttribute('data-color-scheme', scheme === 'dark' ? 'light' : 'dark');
  });
  U.on(U.q('upload-local-btn'), 'click', () => U.q('local-file-input').click());
  U.on(U.q('local-file-input'), 'change', e => {
    if (e.target.files.length > 0) {
      handleLocalFileUpload(e.target.files);
      e.target.value = '';
    }
  });
  U.on(U.q('load-folder-btn'), 'click', loadMusicFolder);
  U.on(U.q('add-youtube-btn'), 'click', () => U.addClass(U.q('youtube-modal'), 'active'));
  U.on(U.q('save-youtube-btn'), 'click', saveYouTube);
  
  // Drag & Drop support
  let dragCounter = 0;
  U.on(document, 'dragenter', e => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter++;
    if (app.currentView === 'biblioteca') {
      const zone = U.q('drag-drop-zone');
      if (zone) { zone.style.display = 'block'; U.addClass(zone, 'drag-over'); }
    }
  });
  U.on(document, 'dragleave', e => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter--;
    if (dragCounter === 0) {
      const zone = U.q('drag-drop-zone');
      if (zone) U.removeClass(zone, 'drag-over');
    }
  });
  U.on(document, 'dragover', e => {
    e.preventDefault();
    e.stopPropagation();
  });
  U.on(document, 'drop', e => {
    e.preventDefault();
    e.stopPropagation();
    dragCounter = 0;
    const zone = U.q('drag-drop-zone');
    if (zone) { U.removeClass(zone, 'drag-over'); zone.style.display = 'none'; }
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      handleLocalFileUpload(e.dataTransfer.files);
    }
  });
  U.on(U.q('play-btn'), 'click', () => {
    const audio = U.q('audio-player');
    
    // Si no hay canci√≥n seleccionada
    if (app.currentIndex < 0) {
      U.announce('Selecciona una canci√≥n primero');
      return;
    }
    
    const currentSong = app.songs[app.currentIndex];
    
    if (app.isPlaying) {
      // PAUSAR
      if (currentSong.type === 'local' || currentSong.type === 'github') {
        audio.pause();
        app.isPlaying = false;
        U.text(U.q('play-btn'), '‚ñ∂Ô∏è');
      } else if (currentSong.type === 'youtube') {
        U.announce('‚ö†Ô∏è Controles de YouTube limitados. Usa el bot√≥n Stop (‚úï) para detener.');
      }
    } else {
      // REANUDAR
      if (currentSong.type === 'local' || currentSong.type === 'github') {
        audio.play().catch(e => {
          U.announce('Error: ' + e.message);
          console.error('Error al reproducir:', e);
        });
        app.isPlaying = true;
        U.text(U.q('play-btn'), '‚è∏Ô∏è');
      } else if (currentSong.type === 'youtube') {
        U.announce('YouTube ya est√° reproduci√©ndose');
      }
    }
  });
  U.on(U.q('stop-player-btn'), 'click', stopPlayback);
  U.on(U.q('prev-btn'), 'click', () => { if (app.currentIndex > 0) playSong(app.songs[app.currentIndex - 1].id); });
  U.on(U.q('next-btn'), 'click', () => { if (app.currentIndex < app.songs.length - 1) playSong(app.songs[app.currentIndex + 1].id); });
  U.on(U.q('shuffle-btn'), 'click', () => { app.shuffleMode = !app.shuffleMode; U.q('shuffle-btn').style.opacity = app.shuffleMode ? '1' : '0.5'; });
  U.on(U.q('repeat-btn'), 'click', () => {
    app.repeatMode = app.repeatMode === 'none' ? 'all' : app.repeatMode === 'all' ? 'one' : 'none';
    U.text(U.q('repeat-btn'), app.repeatMode === 'one' ? 'üîÇ' : 'üîÅ');
    U.q('repeat-btn').style.opacity = app.repeatMode === 'none' ? '0.5' : '1';
  });
  U.on(U.q('volume-slider'), 'input', e => {
    app.volume = e.target.value / 100;
    const audioEl = U.q('audio-player');
    if (audioEl) audioEl.volume = app.volume;
    U.text(U.q('volume-icon'), app.volume === 0 ? 'üîá' : app.volume < 0.5 ? 'üîâ' : 'üîä');
  });
  
  // Establecer volumen inicial
  const audioEl = U.q('audio-player');
  if (audioEl) audioEl.volume = app.volume;
  U.on(U.q('volume-icon'), 'click', () => {
    const slider = U.q('volume-slider');
    if (app.volume > 0) { slider.dataset.prev = app.volume; slider.value = 0; U.q('audio-player').volume = 0; app.volume = 0; U.text(U.q('volume-icon'), 'üîá'); }
    else { const prev = parseFloat(slider.dataset.prev) || 0.7; slider.value = prev * 100; U.q('audio-player').volume = prev; app.volume = prev; U.text(U.q('volume-icon'), 'üîä'); }
  });
  U.on(U.q('youtube-toggle-btn'), 'click', () => {
    const container = U.q('youtube-player-container');
    app.videoVisible = !app.videoVisible;
    if (app.videoVisible) { U.removeClass(container, 'youtube-hidden'); U.addClass(container, 'youtube-visible'); U.text(U.q('youtube-toggle-btn'), 'üôà'); }
    else { U.removeClass(container, 'youtube-visible'); U.addClass(container, 'youtube-hidden'); U.text(U.q('youtube-toggle-btn'), 'üì∫'); }
  });
  U.on(U.q('genre-filter'), 'change', renderSongs);
  U.on(U.q('mood-filter'), 'change', renderSongs);
  U.on(U.q('search-input'), 'input', renderSongs);
  const audio = U.q('audio-player');
  
  U.on(audio, 'play', () => {
    U.text(U.q('play-btn'), '‚è∏Ô∏è');
    console.log('‚ñ∂Ô∏è Audio playing');
  });
  
  U.on(audio, 'pause', () => {
    U.text(U.q('play-btn'), '‚ñ∂Ô∏è');
    console.log('‚è∏Ô∏è Audio paused');
  });
  
  U.on(audio, 'timeupdate', () => {
    if (audio.duration) {
      const pct = (audio.currentTime / audio.duration) * 100;
      U.q('progress-fill').style.width = pct + '%';
      U.text(U.q('current-time'), U.fmt(Math.floor(audio.currentTime)));
      U.text(U.q('total-time'), U.fmt(Math.floor(audio.duration)));
    }
  });
  
  U.on(audio, 'loadedmetadata', () => {
    const mins = Math.floor(audio.duration / 60);
    const secs = Math.floor(audio.duration % 60);
    U.text(U.q('total-time'), `${mins}:${String(secs).padStart(2, '0')}`);
    console.log('‚úÖ Audio metadata loaded:', U.fmt(Math.floor(audio.duration)));
  });
  
  U.on(audio, 'error', (e) => {
    console.error('‚ùå Error de audio:', e);
    if (audio.error) {
      console.error('C√≥digo de error:', audio.error.code);
      const errorMessages = {
        1: 'MEDIA_ERR_ABORTED: Carga abortada',
        2: 'MEDIA_ERR_NETWORK: Error de red',
        3: 'MEDIA_ERR_DECODE: Error de decodificaci√≥n',
        4: 'MEDIA_ERR_SRC_NOT_SUPPORTED: Formato no soportado o src vac√≠o'
      };
      const msg = errorMessages[audio.error.code] || 'Error desconocido';
      console.error('Mensaje:', msg);
      if (audio.error.code !== 4 || audio.src) {
        U.announce('Error al reproducir: ' + msg);
      }
    }
  });
  U.on(U.q('audio-player'), 'ended', () => {
    if (app.repeatMode === 'one') playSong(app.songs[app.currentIndex].id);
    else if (app.currentIndex < app.songs.length - 1) playSong(app.songs[app.currentIndex + 1].id);
    else if (app.repeatMode === 'all') playSong(app.songs[0].id);
  });
  document.documentElement.setAttribute('data-color-scheme', 'dark');
  renderCalendar();
});
</script>
</body>
</html>
