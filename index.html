<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Calendario Multimedia</title>

<!-- Metadatos ID3 locales -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

<style>
:root{
  --bg:#0f172a; --surface:#111827; --surface-2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
  --primary:#22d3ee; --primary-2:#06b6d4; --border:#1f2937;
  --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:var(--bg); color:var(--text)}

.app{display:flex; min-height:100vh}
.sidebar{width:240px; background:var(--surface); border-right:1px solid var(--border); padding:16px; display:flex; flex-direction:column; gap:8px; position:sticky; top:0; height:100vh}
.sidebar h1{margin:6px 0 12px; font-size:18px}
.nav-btn{padding:10px 12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); border-radius:10px; cursor:pointer; text-align:left}
.nav-btn.active{outline:2px solid var(--primary)}
.main{flex:1; padding:16px}
.header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px}
.month-nav{display:flex; gap:8px; align-items:center}
.btn{padding:8px 12px; border:1px solid var(--border); background:var(--surface-2); color:var(--text); border-radius:10px; cursor:pointer}
.btn.primary{background:var(--primary); color:#06252b; border-color:transparent}
.input{padding:10px 12px; border:1px solid var(--border); background:var(--surface); color:var(--text); border-radius:10px}
.panel{background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow)}

.view{display:none}
.view.active{display:block}

.calendar{padding:12px}
.cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
.cal-head{padding:8px; text-align:center; color:var(--muted); font-weight:600}
.cal-day{background:var(--surface-2); border:1px solid var(--border); border-radius:10px; height:110px; padding:8px; position:relative; cursor:pointer}
.cal-day.today{outline:3px solid var(--primary)}
.dotwrap{position:absolute; left:8px; bottom:8px; display:flex; gap:6px}
.dot{width:8px; height:8px; border-radius:999px}
.dot.task{background:#22c55e}.dot.note{background:#3b82f6}.dot.birthday{background:#f97316}

.grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px}
.card{background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:10px}
.cover{width:100%; aspect-ratio:1; border-radius:10px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center}
.cover img{width:100%; height:100%; object-fit:cover}
.title{font-weight:700; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.subtitle{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

.mini{position:fixed; left:240px; right:0; bottom:0; background:var(--surface); border-top:1px solid var(--border); padding:10px 12px; display:none; flex-direction:column; gap:6px; z-index:20}
.mini.active{display:flex}
.mini-top{display:flex; align-items:center; gap:10px}
.prog{height:8px; background:var(--surface-2); border-radius:999px; overflow:hidden; cursor:pointer}
.prog>div{height:8px; background:var(--primary); width:0}

#yt-container{position:fixed; right:16px; bottom:116px; width:420px; height:236px; background:#000; border-radius:12px; overflow:hidden; box-shadow:var(--shadow); opacity:0; pointer-events:none; transform:scale(.96); transition:.2s}
#yt-container.visible{opacity:1; pointer-events:auto; transform:scale(1)}

@media (max-width: 980px){
  .app{flex-direction:column}
  .sidebar{position:relative; height:auto; width:auto; flex-direction:row; gap:8px; align-items:center}
  .mini{left:0}
}
@media (max-width: 420px){
  #yt-container{width:340px; height:191px; right:8px}
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <h1>Calendario Multimedia</h1>
    <button class="nav-btn active" data-view="cal">ğŸ“… Calendario</button>
    <button class="nav-btn" data-view="lib">ğŸ“š Biblioteca</button>
    <button class="nav-btn" data-view="pls">ğŸ§ Playlists</button>
    <button class="nav-btn" data-view="fav">â­ Favoritos</button>
  </aside>

  <main class="main">
    <div class="header">
      <div class="month-nav">
        <button class="btn" id="prev-month">â—€</button>
        <h3 id="month-title" style="margin:0">â€”</h3>
        <button class="btn" id="next-month">â–¶</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" id="btn-upload">ğŸ’¿ Cargar</button>
        <button class="btn" id="btn-folder">ğŸ“ Carpeta</button>
        <button class="btn" id="btn-yt">â–¶ï¸ YouTube</button>
        <input type="file" id="file-upload" accept="audio/*" multiple hidden>
        <input type="file" id="folder-upload" webkitdirectory multiple accept="audio/*" hidden>
      </div>
    </div>

    <!-- CALENDARIO -->
    <section class="view active" id="view-cal">
      <div class="panel calendar">
        <div class="cal-grid" id="cal-grid"></div>
      </div>
    </section>

    <!-- BIBLIOTECA -->
    <section class="view" id="view-lib">
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
        <select id="f-genre" class="input"><option value="">Todos los gÃ©neros</option></select>
        <select id="f-mood" class="input"><option value="">Todos los estados</option></select>
        <input id="f-search" class="input" placeholder="ğŸ” Buscar por tÃ­tulo o artista"/>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <!-- PLAYLISTS -->
    <section class="view" id="view-pls">
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
        <input id="new-pls" class="input" placeholder="Nueva playlist"/>
        <button class="btn primary" id="create-pls">Crear</button>
      </div>
      <div id="pls-list" class="grid"></div>
    </section>

    <!-- FAVORITOS -->
    <section class="view" id="view-fav">
      <div class="grid" id="fav-grid"></div>
    </section>
  </main>
</div>

<!-- MINI PLAYER -->
<div class="mini" id="mini">
  <div class="mini-top">
    <div class="cover" style="width:56px;height:56px" id="p-cover">ğŸµ</div>
    <div style="flex:1;min-width:0">
      <div id="p-title" class="title">Sin reproducciÃ³n</div>
      <div id="p-artist" class="subtitle"></div>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="btn" id="prev">â®ï¸</button>
      <button class="btn primary" id="play">â–¶ï¸</button>
      <button class="btn" id="next">â­ï¸</button>
      <button class="btn" id="shuffle" title="Aleatorio">ğŸ”€</button>
      <button class="btn" id="repeat" title="Repetir">ğŸ”</button>
      <button class="btn" id="stop">âœ•</button>
      <span id="vol-ico">ğŸ”Š</span>
      <input type="range" id="vol" min="0" max="100" value="70">
      <button class="btn" id="yt-toggle" title="Mostrar/Ocultar vÃ­deo">ğŸ“º</button>
    </div>
  </div>
  <div class="prog" id="progress"><div id="bar"></div></div>
  <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted)">
    <span id="tcur">0:00</span><span id="ttot">0:00</span>
  </div>
</div>

<audio id="audio"></audio>
<div id="yt-container"></div>

<!-- Modal YouTube muy simple -->
<div id="yt-modal" class="panel" style="position:fixed;left:50%;transform:translateX(-50%);top:90px;display:none;z-index:30;max-width:680px;width:92%; padding:14px">
  <h3 style="margin:6px 0 12px">AÃ±adir desde YouTube</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px; margin-bottom:8px">
    <input id="yt-title" class="input" placeholder="TÃ­tulo (opcional)"/>
    <input id="yt-artist" class="input" placeholder="Artista (opcional)"/>
    <input id="yt-url" class="input" style="grid-column:1/-1" placeholder="https://youtube.com/watch?v=..."/>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" id="yt-cancel">Cancelar</button>
    <button class="btn primary" id="yt-save">Guardar</button>
  </div>
</div>

<script>
/* ===== Estado bÃ¡sico ===== */
const U = { q:s=>document.querySelector(s), qa:s=>document.querySelectorAll(s), fmt:s=>{s=Math.max(0,s||0); const m=Math.floor(s/60), sec=Math.floor(s%60); return m+':'+String(sec).padStart(2,'0'); } };
const state = {
  view:'cal',
  songs: JSON.parse(localStorage.getItem('songs')||'[]'),
  playlists: JSON.parse(localStorage.getItem('playlists')||'[]'),
  favorites: JSON.parse(localStorage.getItem('favorites')||'[]'),
  idx: -1,
  shuffle: false,
  repeat: 'none',
  volume: 0.7,
  currentDate: new Date(),
  events: {}, // solo para dots del calendario (estÃ¡tico simple)
  yt: { iframe:null, id:null, visible:false }
};

function persist(){ localStorage.setItem('songs', JSON.stringify(state.songs.map(({blob,...rest})=>rest))); localStorage.setItem('playlists', JSON.stringify(state.playlists)); localStorage.setItem('favorites', JSON.stringify(state.favorites)); }

/* ===== NavegaciÃ³n ===== */
U.qa('.nav-btn').forEach(b=>b.addEventListener('click',e=>{
  U.qa('.nav-btn').forEach(x=>x.classList.remove('active'));
  e.currentTarget.classList.add('active');
  const v = e.currentTarget.getAttribute('data-view');
  switchView(v);
}));
function switchView(v){
  state.view=v;
  U.qa('.view').forEach(vw=>vw.classList.remove('active'));
  U.q('#view-'+v).classList.add('active');
  if(v==='cal') renderCalendar();
  if(v==='lib') renderSongs();
  if(v==='pls') renderPlaylists();
  if(v==='fav') renderFavorites();
}

/* ===== Calendario simple (sin romper) ===== */
U.q('#prev-month').addEventListener('click',()=>{ state.currentDate.setMonth(state.currentDate.getMonth()-1); renderCalendar(); });
U.q('#next-month').addEventListener('click',()=>{ state.currentDate.setMonth(state.currentDate.getMonth()+1); renderCalendar(); });

function renderCalendar(){
  const year = state.currentDate.getFullYear();
  const month = state.currentDate.getMonth();
  const monthTitle = state.currentDate.toLocaleString('es-ES', {month:'long', year:'numeric'});
  U.q('#month-title').textContent = monthTitle.charAt(0).toUpperCase() + monthTitle.slice(1);

  const firstDay = new Date(year, month, 1);
  const start = (firstDay.getDay()+6)%7;
  const daysInMonth = new Date(year, month+1, 0).getDate();

  const grid = U.q('#cal-grid');
  grid.innerHTML = '';
  ['Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b','Dom'].forEach(h=>{
    const hd=document.createElement('div'); hd.className='cal-head'; hd.textContent=h; grid.appendChild(hd);
  });
  for(let i=0;i<start;i++){ const ph=document.createElement('div'); ph.className='cal-day'; ph.style.visibility='hidden'; grid.appendChild(ph); }

  const today = new Date();
  for(let d=1; d<=daysInMonth; d++){
    const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div'); cell.className='cal-day';
    if(today.getFullYear()===year && today.getMonth()===month && today.getDate()===d) cell.classList.add('today');
    cell.innerHTML = `<div style="font-weight:700">${d}</div><div class="dotwrap"></div>`;
    const dots=cell.querySelector('.dotwrap');
    const ev = state.events[key]||{task:false,note:false,birthday:false};
    if(ev.task) dots.appendChild(dot('task'));
    if(ev.note) dots.appendChild(dot('note'));
    if(ev.birthday) dots.appendChild(dot('birthday'));
    cell.addEventListener('click',()=>alert(`ğŸ“… ${key}`));
    grid.appendChild(cell);
  }
}
function dot(cls){ const e=document.createElement('div'); e.className='dot '+cls; return e; }

/* ===== GitHub songs (se cargan aunque no aÃ±adas locales) ===== */
const GITHUB = { owner:'mrdaniel7', repo:'CalendarioMultimedia', branch:'main', folder:'musica' };
async function fetchGitHubSongs(){
  try{
    const api=`https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${GITHUB.folder}?ref=${GITHUB.branch}`;
    const r=await fetch(api);
    if(!r.ok) return [];
    const files=await r.json();
    const audioExt=['.mp3','.wav','.ogg','.flac','.m4a'];
    return files.filter(f=>f.type==='file' && audioExt.some(ext=>f.name.toLowerCase().endsWith(ext))).map(f=>{
      const title=f.name.replace(/\.[^/.]+$/,'');
      const fileUrl=`https://raw.githubusercontent.com/${GITHUB.owner}/${GITHUB.repo}/${GITHUB.branch}/${GITHUB.folder}/${f.name}`;
      return { id: Date.now()+Math.random(), title, artist:GITHUB.owner, album:'GitHub', type:'github', fileUrl, cover:null, genres:[], moods:[] };
    });
  }catch{ return []; }
}

/* ===== Portadas robustas ===== */
function fallbackCover(song){
  // si es YouTube, miniatura del vÃ­deo
  if(song.youtubeId) return `https://img.youtube.com/vi/${song.youtubeId}/mqdefault.jpg`;
  // Unsplash por tema
  const tag = (song.artist||'music')+' '+(song.title||'album');
  return `https://source.unsplash.com/featured/512x512?${encodeURIComponent(tag)}`;
}
async function tryImproveCover(song){
  if(song.cover) return;
  // Intenta localizar miniatura de YouTube (Piped/Inv)
  const q=((song.artist||'')+' '+(song.title||'')).trim();
  if(q){
    const y1=await getYTThumb(`https://piped.video/api/v1/search?q=${encodeURIComponent(q)}&region=ES&type=video`);
    if(y1){ song.cover=y1; return; }
    const y2=await getYTThumb(`https://yt.artemislena.eu/api/v1/search?q=${encodeURIComponent(q)}`);
    if(y2){ song.cover=y2; return; }
  }
  song.cover = fallbackCover(song);
}
async function getYTThumb(url){
  try{ const r=await fetch(url); if(!r.ok) return null; const j=await r.json(); const v=j?.[0]; const id=v?.videoId || (v?.url? (v.url.split('/watch?v=')[1]||'').split('&')[0] : null); if(!id) return null; return `https://img.youtube.com/vi/${id}/mqdefault.jpg`; }catch{return null;}
}

/* ===== Autoetiquetado simple (2 gÃ©neros + 3 emociones) ===== */
function autoTag(song){
  const src=[song.title||'', song.artist||'', song.album||''].join(' ').toLowerCase();
  const has=(...w)=>w.some(x=>src.includes(x));
  const genres=[];
  if(has('rock','guitar','metal','punk')) genres.push('Rock');
  if(has('pop','hit')) genres.push('Pop');
  if(has('jazz','swing','sax')) genres.push('Jazz');
  if(has('classical','orchestra','piano','beethoven','mozart','bach','sonata')) genres.push('Classical');
  if(has('edm','techno','house','trance','electro','synth')) genres.push('Electronic');
  if(has('hip hop','rap','trap')) genres.push('Hip Hop');
  if(genres.length<2){ ['Pop','Electronic','Rock','Indie'].some(g=>{ if(!genres.includes(g)) genres.push(g); return genres.length>=2; }); }
  song.genres=genres.slice(0,2);

  const moods=[]; 
  if(has('happy','feliz','summer')) moods.push('Feliz');
  if(has('sad','triste')) moods.push('Triste');
  if(has('chill','lofi','relax','calm')) moods.push('Relajado');
  if(has('party','fast','boom','dance')) moods.push('EnÃ©rgico');
  if(has('love','amor','romance')) moods.push('RomÃ¡ntico');
  while(moods.length<3){ ['Feliz','Relajado','EnÃ©rgico','Motivador','RomÃ¡ntico'].some(m=>{ if(!moods.includes(m)) moods.push(m); return moods.length>=3; }); }
  song.moods=moods.slice(0,3);
}

/* ===== Reproductor ===== */
const audio = U.q('#audio');
audio.volume = state.volume;
U.q('#vol').value = Math.round(state.volume*100);
U.q('#vol').addEventListener('input',e=>{
  state.volume = e.target.value/100;
  audio.volume = state.volume;
  U.q('#vol-ico').textContent = state.volume===0?'ğŸ”‡':(state.volume<.5?'ğŸ”‰':'ğŸ”Š');
});
function setMini(on){ U.q('#mini').classList.toggle('active',!!on); }
function updateMini(s){
  U.q('#p-title').textContent = s?.title || 'Sin reproducciÃ³n';
  U.q('#p-artist').textContent = s?.artist || '';
  const c=U.q('#p-cover'); c.innerHTML='';
  const img=new Image(); img.alt=s?.title||'';
  img.src = s?.cover || fallbackCover(s||{});
  img.onerror = ()=>{ img.src = fallbackCover(s||{}); };
  c.appendChild(img);
}
function playIndex(i){
  if(i<0 || i>=state.songs.length) return;
  // Limpia YouTube si estaba
  stopYouTube();
  audio.pause(); audio.src='';

  state.idx=i;
  const s=state.songs[i];
  updateMini(s); setMini(true);

  if(s.type==='youtube'){
    // VÃ­deo minimizado por defecto; controles propios de YouTube
    ensureYouTube(s.youtubeId);
    U.q('#play').textContent='â¸ï¸';
  } else {
    audio.src = s.blob ? URL.createObjectURL(s.blob) : (s.fileUrl||'');
    audio.play().then(()=>{ U.q('#play').textContent='â¸ï¸'; }).catch(()=>{});
  }
  renderSongs(); renderFavorites();
}
function nextTrack(){
  if(state.shuffle){
    let n; do{ n=Math.floor(Math.random()*state.songs.length); } while(n===state.idx && state.songs.length>1);
    playIndex(n); return;
  }
  if(state.idx<state.songs.length-1) playIndex(state.idx+1);
  else if(state.repeat==='all') playIndex(0);
}
U.q('#play').addEventListener('click',()=>{
  const s=state.songs[state.idx]; if(!s) return;
  if(s.type==='youtube'){ // no controlamos play/pause, solo ocultar/mostrar
    // simple: si iframe estÃ¡, ocultar/mostrar
    U.q('#yt-toggle').click();
  }else{
    if(audio.paused){ audio.play(); U.q('#play').textContent='â¸ï¸'; }
    else { audio.pause(); U.q('#play').textContent='â–¶ï¸'; }
  }
});
U.q('#prev').addEventListener('click',()=>{ const i=state.idx<=0?state.songs.length-1:state.idx-1; playIndex(i); });
U.q('#next').addEventListener('click',nextTrack);
U.q('#shuffle').addEventListener('click',()=>{ state.shuffle=!state.shuffle; U.q('#shuffle').style.borderColor=state.shuffle?'var(--primary)':'var(--border)'; });
U.q('#repeat').addEventListener('click',()=>{ state.repeat=state.repeat==='none'?'all':state.repeat==='all'?'one':'none'; U.q('#repeat').textContent=state.repeat==='one'?'ğŸ”‚':'ğŸ”'; });
U.q('#stop').addEventListener('click',()=>{ audio.pause(); audio.src=''; stopYouTube(); state.idx=-1; setMini(false); U.q('#bar').style.width='0%'; U.q('#tcur').textContent='0:00'; U.q('#ttot').textContent='0:00'; });
U.q('#progress').addEventListener('click',e=>{
  const rect=e.currentTarget.getBoundingClientRect(); const pct=Math.min(1,Math.max(0,(e.clientX-rect.left)/rect.width));
  if(audio.duration){ audio.currentTime=audio.duration*pct; }
});
audio.addEventListener('timeupdate',()=>{ if(audio.duration){ U.q('#bar').style.width=(audio.currentTime/audio.duration*100)+'%'; U.q('#tcur').textContent=U.fmt(audio.currentTime); U.q('#ttot').textContent=U.fmt(audio.duration); }});
audio.addEventListener('loadedmetadata',()=>{ if(audio.duration) U.q('#ttot').textContent=U.fmt(audio.duration); });
audio.addEventListener('ended',()=>{ if(state.repeat==='one'){ playIndex(state.idx); } else nextTrack(); });

/* ===== YouTube simple (iframe) ===== */
function ensureYouTube(id){
  if(!id) return;
  const box=U.q('#yt-container');
  box.innerHTML = `<iframe id="yt-iframe" width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1&controls=1&modestbranding=1&rel=0&playsinline=1" allow="autoplay; encrypted-media" frameborder="0"></iframe>`;
  box.classList.remove('visible'); // minimizado por defecto
  state.yt.iframe = box.querySelector('#yt-iframe');
  state.yt.id = id;
}
function stopYouTube(){
  const box=U.q('#yt-container');
  box.innerHTML=''; box.classList.remove('visible'); state.yt={iframe:null,id:null,visible:false};
}
U.q('#yt-toggle').addEventListener('click',()=>{
  state.yt.visible=!state.yt.visible;
  U.q('#yt-container').classList.toggle('visible', state.yt.visible);
  U.q('#yt-toggle').textContent = state.yt.visible?'ğŸ™ˆ':'ğŸ“º';
});

/* ===== Biblioteca ===== */
const exts=['.mp3','.wav','.ogg','.m4a','.flac'];
U.q('#btn-upload').addEventListener('click',()=>U.q('#file-upload').click());
U.q('#btn-folder').addEventListener('click',()=>U.q('#folder-upload').click());
U.q('#file-upload').addEventListener('change',e=>handleFiles(e.target.files));
U.q('#folder-upload').addEventListener('change',e=>handleFiles(e.target.files));
U.q('#btn-yt').addEventListener('click',()=>{ U.q('#yt-modal').style.display='block'; });
U.q('#yt-cancel').addEventListener('click',()=>{ U.q('#yt-modal').style.display='none'; });

U.q('#yt-save').addEventListener('click',async()=>{
  const url=(U.q('#yt-url').value||'').trim(); const id=url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([^&\n?#]+)/)?.[1];
  if(!id) return alert('URL invÃ¡lida');
  // si no se indican, se toma del propio vÃ­deo con oEmbed
  let title = (U.q('#yt-title').value||'').trim();
  let artist = (U.q('#yt-artist').value||'').trim();
  if(!title || !artist){
    try{ const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`); if(r.ok){ const j=await r.json(); if(!title) title=j.title||'YouTube'; if(!artist) artist=j.author_name||'YouTube'; } }catch{}
  }
  const s={ id:Date.now(), title:title||'YouTube', artist:artist||'YouTube', type:'youtube', youtubeId:id, cover:null, genres:[], moods:[], album:'YouTube' };
  autoTag(s);
  await tryImproveCover(s);
  if(!s.cover) s.cover=fallbackCover(s);
  state.songs.push(s); persist(); renderSongs();
  U.q('#yt-modal').style.display='none'; U.q('#yt-url').value=''; U.q('#yt-title').value=''; U.q('#yt-artist').value='';
});

async function handleFiles(files){
  const arr=[...files].filter(f=>exts.some(x=>f.name.toLowerCase().endsWith(x)));
  for(const f of arr){
    const s={ id:Date.now()+Math.random(), title:f.name.replace(/\.[^/.]+$/,''), artist:'Desconocido', album:'Archivo Local', type:'local', blob:f, cover:null, genres:[], moods:[] };
    // portada por metadatos
    await new Promise(res=>{
      jsmediatags.read(f,{ onSuccess:tag=>{
        const t=tag.tags||{};
        if(t.title) s.title=t.title;
        if(t.artist) s.artist=t.artist;
        if(t.album) s.album=t.album;
        if(t.picture && t.picture.data && t.picture.format){
          try{
            const bytes=new Uint8Array(t.picture.data);
            const blob=new Blob([bytes],{type:t.picture.format});
            s.cover = URL.createObjectURL(blob);
          }catch{}
        }
        res();
      }, onError:()=>res() });
    });
    autoTag(s);
    if(!s.cover) await tryImproveCover(s);
    if(!s.cover) s.cover = fallbackCover(s);
    state.songs.push(s);
  }
  persist(); renderSongs();
}

/* ===== Render biblioteca / filtros ===== */
U.q('#f-genre').addEventListener('change',renderSongs);
U.q('#f-mood').addEventListener('change',renderSongs);
U.q('#f-search').addEventListener('input',renderSongs);

function renderSongs(){
  const wrap=U.q('#grid'); if(!wrap) return;
  const gf=U.q('#f-genre').value, mf=U.q('#f-mood').value, q=(U.q('#f-search').value||'').toLowerCase();
  const list = state.songs.filter(s=>{
    const okG = !gf || (s.genres||[]).includes(gf);
    const okM = !mf || (s.moods||[]).includes(mf);
    const okQ = !q || (s.title||'').toLowerCase().includes(q) || (s.artist||'').toLowerCase().includes(q);
    return okG && okM && okQ;
  });
  wrap.innerHTML = list.length? list.map(s=>{
    const playing=(state.idx>=0 && state.songs[state.idx].id===s.id)?'outline:3px solid var(--primary);':'';
    return `<div class="card" style="${playing}" data-id="${s.id}">
      <div class="cover">
        <img src="${s.cover||fallbackCover(s)}" alt="${s.title}" onerror="this.onerror=null;this.src='${fallbackCover(s)}'">
      </div>
      <div class="title">${s.title}</div>
      <div class="subtitle">${s.artist||''}</div>
      <div class="subtitle">${(s.genres||[]).join(', ')} Â· ${(s.moods||[]).join(', ')}</div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn primary" data-play>â–¶ï¸</button>
        <button class="btn" data-add>â• Playlist</button>
        <button class="btn" data-fav>${state.favorites.includes(s.id)?'â¤ï¸':'ğŸ¤'}</button>
        <button class="btn" data-del>ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('') : '<div class="panel" style="padding:16px">No hay canciones</div>';

  wrap.querySelectorAll('[data-play]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const i=state.songs.findIndex(x=>x.id===id); playIndex(i);
  }));
  wrap.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const i=state.songs.findIndex(x=>x.id===id);
    if(i>=0){ if(state.idx===i) U.q('#stop').click(); state.songs.splice(i,1); persist(); renderSongs(); renderFavorites(); }
  }));
  wrap.querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const name=prompt('Nombre de la playlist'); if(!name) return;
    let p=state.playlists.find(x=>x.name===name); if(!p){ p={name,ids:[],cover:null}; state.playlists.push(p); }
    if(!p.ids.includes(id)) p.ids.push(id); persist(); renderPlaylists();
  }));
  wrap.querySelectorAll('[data-fav]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const i=state.favorites.indexOf(id);
    if(i>=0) state.favorites.splice(i,1); else state.favorites.push(id); persist(); renderSongs(); renderFavorites();
  }));

  populateFilters();
}
function populateFilters(){
  const gset=new Set(), mset=new Set();
  state.songs.forEach(s=>{ (s.genres||[]).forEach(x=>gset.add(x)); (s.moods||[]).forEach(x=>mset.add(x)); });
  U.q('#f-genre').innerHTML='<option value="">Todos los gÃ©neros</option>'+[...gset].sort().map(g=>`<option>${g}</option>`).join('');
  U.q('#f-mood').innerHTML ='<option value="">Todos los estados</option>'+[...mset].sort().map(m=>`<option>${m}</option>`).join('');
}

/* ===== Playlists / Favoritos ===== */
function renderPlaylists(){
  const wrap=U.q('#pls-list');
  wrap.innerHTML = state.playlists.length ? state.playlists.map(p=>{
    const first=state.songs.find(s=>p.ids.includes(s.id));
    const cover=p.cover || first?.cover || 'https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=400&auto=format&fit=crop';
    return `<div class="card">
      <div class="cover"><img src="${cover}" alt="${p.name}" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=400&auto=format&fit=crop'"></div>
      <div class="title">${p.name}</div>
      <div class="subtitle">${p.ids.length} canciones</div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn" data-open="${p.name}">Abrir</button>
        <button class="btn" data-del="${p.name}">Eliminar</button>
      </div>
    </div>`;
  }).join('') : '<div class="panel" style="padding:16px">No hay playlists</div>';

  wrap.querySelectorAll('[data-open]').forEach(b=>b.addEventListener('click',e=>{
    const name=e.currentTarget.getAttribute('data-open');
    const p=state.playlists.find(x=>x.name===name); if(!p||!p.ids.length) return;
    const idx=state.songs.findIndex(s=>s.id===p.ids[0]); if(idx>=0) playIndex(idx);
  }));
  wrap.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',e=>{
    const name=e.currentTarget.getAttribute('data-del');
    state.playlists=state.playlists.filter(p=>p.name!==name); persist(); renderPlaylists();
  }));
}
function renderFavorites(){
  const wrap=U.q('#fav-grid'); if(!wrap) return;
  const list=state.songs.filter(s=>state.favorites.includes(s.id));
  wrap.innerHTML = list.length? list.map(s=>`
    <div class="card" data-id="${s.id}">
      <div class="cover"><img src="${s.cover||fallbackCover(s)}" alt="${s.title}" onerror="this.onerror=null;this.src='${fallbackCover(s)}'"></div>
      <div class="title">${s.title}</div>
      <div class="subtitle">${s.artist||''}</div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn primary" data-play>â–¶ï¸</button>
        <button class="btn" data-unfav>ğŸ’”</button>
      </div>
    </div>`).join('') : '<div class="panel" style="padding:16px">Sin favoritos</div>';

  wrap.querySelectorAll('[data-play]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const i=state.songs.findIndex(x=>x.id===id); playIndex(i);
  }));
  wrap.querySelectorAll('[data-unfav]').forEach(b=>b.addEventListener('click',e=>{
    const id=Number(e.currentTarget.closest('.card').dataset.id);
    const i=state.favorites.indexOf(id);
    if(i>=0) state.favorites.splice(i,1); persist(); renderFavorites(); renderSongs();
  }));
}

/* ===== Bootstrap ===== */
(async function init(){
  // Carga GitHub al arrancar (aunque no subas locales)
  try{
    const gh = await fetchGitHubSongs();
    const existing=new Set(state.songs.map(s=>s.type+'|'+(s.fileUrl||s.youtubeId||s.title)));
    for(const s of gh){
      const key=s.type+'|'+(s.fileUrl||s.youtubeId||s.title);
      if(!existing.has(key)){
        autoTag(s);
        await tryImproveCover(s);
        if(!s.cover) s.cover=fallbackCover(s);
        state.songs.push(s);
      }
    }
    persist();
  }catch{}
  // Render inicial
  renderCalendar(); renderSongs(); renderPlaylists(); renderFavorites();

  // Volumen inicial
  audio.volume = state.volume;

  // Atajos teclado
  document.addEventListener('keydown',e=>{
    if(e.code==='Space' && document.activeElement===document.body){ e.preventDefault(); U.q('#play').click(); }
    if(e.code==='ArrowRight' && state.idx>=0){ e.preventDefault(); U.q('#next').click(); }
    if(e.code==='ArrowLeft' && state.idx>=0){ e.preventDefault(); U.q('#prev').click(); }
  });
})();
</script>
</body>
</html>
